# Aury Boot ç”¨æˆ·å¼€å‘æ‰‹å†Œ

æ¬¢è¿ä½¿ç”¨ Aury Bootï¼è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸ºæ„å»ºç°ä»£åŒ–ã€é«˜æ€§èƒ½å¾®æœåŠ¡è€Œè®¾è®¡çš„ Python åŸºç¡€è®¾æ–½æ¡†æ¶ã€‚

## ç›®å½•ï¼ˆå¿«é€Ÿå¼€å§‹ï¼‰

> ğŸ“– **è¯¦ç»†æ–‡æ¡£**ï¼šæœ¬ç›®å½•ä¸‹è¿˜æœ‰æ›´è¯¦ç»†çš„æŠ€æœ¯æŒ‡å—

1. [ç®€ä»‹](#1-ç®€ä»‹) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[01-intro-detailed.md](./01-intro-detailed.md)
2. [å¿«é€Ÿä¸Šæ‰‹ï¼ˆè„šæ‰‹æ¶ï¼‰](#2-å¿«é€Ÿä¸Šæ‰‹è„šæ‰‹æ¶) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[25-scaffold-guide.md](./25-scaffold-guide.md)
3. [å¿«é€Ÿä¸Šæ‰‹ï¼ˆæ‰‹åŠ¨ï¼‰](#3-å¿«é€Ÿä¸Šæ‰‹æ‰‹åŠ¨) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[02-installation-guide.md](./02-installation-guide.md)
4. [æœåŠ¡å™¨è¿è¡Œ](#4-æœåŠ¡å™¨è¿è¡Œ) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[03-server-deployment.md](./03-server-deployment.md)
5. [é¡¹ç›®ç»“æ„](#5-é¡¹ç›®ç»“æ„) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[04-project-structure.md](./04-project-structure.md)
6. [é…ç½®](#6-é…ç½®) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[05-configuration-advanced.md](./05-configuration-advanced.md)
7. [ä¾èµ–æ³¨å…¥](#7-ä¾èµ–æ³¨å…¥) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[06-di-container-complete.md](./06-di-container-complete.md)
8. [ä¸­é—´ä»¶å’Œç»„ä»¶](#8-ä¸­é—´ä»¶å’Œç»„ä»¶) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[07-middleware-guide.md](./07-middleware-guide.md) / [08-components-detailed.md](./08-components-detailed.md)
9. [HTTP æ¥å£](#9-http-æ¥å£) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[09-http-advanced.md](./09-http-advanced.md) ï¼ˆIngress/Egress è¯¦è§£ï¼‰
10. [é”™è¯¯å¤„ç†](#10-é”™è¯¯å¤„ç†) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[10-error-handling-guide.md](./10-error-handling-guide.md)
11. [äº‹åŠ¡ç®¡ç†](#11-äº‹åŠ¡ç®¡ç†) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[11-transaction-management.md](./11-transaction-management.md)
12. [æ•°æ®åº“](#12-æ•°æ®åº“) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[12-database-complete.md](./12-database-complete.md)
13. [ç¼“å­˜](#13-ç¼“å­˜) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[13-caching-advanced.md](./13-caching-advanced.md)
14. [å¼‚æ­¥ä»»åŠ¡](#14-å¼‚æ­¥ä»»åŠ¡) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[14-async-tasks-guide.md](./14-async-tasks-guide.md)
15. [äº‹ä»¶é©±åŠ¨](#15-äº‹ä»¶é©±åŠ¨) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[15-events-driven.md](./15-events-driven.md)
16. [å®šæ—¶è°ƒåº¦](#16-å®šæ—¶è°ƒåº¦) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[16-scheduler-guide.md](./16-scheduler-guide.md)
17. [RPC ä¸æœåŠ¡å‘ç°](#17-rpc-ä¸æœåŠ¡å‘ç°) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[17-rpc-microservices.md](./17-rpc-microservices.md)
18. [WebSocket](#18-websocket) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[18-websocket-guide.md](./18-websocket-guide.md)
19. [å¯¹è±¡å­˜å‚¨](#19-å¯¹è±¡å­˜å‚¨) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[19-storage-guide.md](./19-storage-guide.md)
20. [å›½é™…åŒ–](#20-å›½é™…åŒ–) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[20-i18n-guide.md](./20-i18n-guide.md)
21. [æ•°æ®åº“è¿ç§»](#21-æ•°æ®åº“è¿ç§») - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[21-migration-guide.md](./21-migration-guide.md)
22. [æ—¥å¿—ç³»ç»Ÿ](#22-æ—¥å¿—ç³»ç»Ÿ) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[22-logging-complete.md](./22-logging-complete.md)
23. [CLI å‘½ä»¤](#23-cli-å‘½ä»¤) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[24-cli-commands.md](./24-cli-commands.md)
24. [æœ€ä½³å®è·µ](#24-æœ€ä½³å®è·µ) - æŸ¥çœ‹è¯¦ç»†ç‰ˆï¼š[23-best-practices.md](./23-best-practices.md)

---

## 1. ç®€ä»‹

Aury Boot æ˜¯ FastAPI çš„å¢å¼ºå±‚ï¼Œæä¾›å¾®æœåŠ¡å¼€å‘æ‰€éœ€çš„"ç”µæ± "ï¼š

- **ç»Ÿä¸€çš„ç»„ä»¶ç®¡ç†**ï¼šç”Ÿå‘½å‘¨æœŸè‡ªåŠ¨ç®¡ç†ï¼ˆæ•°æ®åº“ã€ç¼“å­˜ã€ä»»åŠ¡ç­‰ï¼‰
- **æ ‡å‡†åŒ–æ¶æ„**ï¼šDomain/Infrastructure åˆ†ç¦»ï¼ŒRepository æ¨¡å¼
- **å¾®æœåŠ¡èƒ½åŠ›**ï¼šæœåŠ¡å‘ç°ã€RPCã€åˆ†å¸ƒå¼äº‹ä»¶æ€»çº¿å¼€ç®±å³ç”¨

---

## 2. å¿«é€Ÿä¸Šæ‰‹ï¼ˆè„šæ‰‹æ¶ï¼‰

> ğŸ“– **æ¨èæ–¹å¼**ï¼šä½¿ç”¨è„šæ‰‹æ¶å¿«é€Ÿåˆ›å»ºé¡¹ç›®ï¼Œè¯¦è§ [25-scaffold-guide.md](./25-scaffold-guide.md)

```bash
# 1. åˆ›å»ºé¡¹ç›®ç›®å½•å¹¶åˆå§‹åŒ–
mkdir my-service && cd my-service
uv init . --name my_service --no-package --python 3.13

# 2. ï¼ˆå¯é€‰ï¼‰é…ç½®æ¸…åæºä»¥åŠ é€Ÿå®‰è£…
# åœ¨ pyproject.toml ä¸­æ·»åŠ ä»¥ä¸‹é…ç½®
cat >> pyproject.toml << EOF

[tool.uv]
index-url = "https://pypi.tuna.tsinghua.edu.cn/simple"
EOF

# 3. å®‰è£…æ¡†æ¶
uv add "aury-boot[recommended]"

# 4. åˆå§‹åŒ–è„šæ‰‹æ¶
aury init                 # äº¤äº’å¼æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼Œä¼šè¯¢é—®é…ç½®é€‰é¡¹
aury init -y              # è·³è¿‡äº¤äº’ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
aury init my_package      # ä½¿ç”¨é¡¶å±‚åŒ…ç»“æ„
aury init --docker        # åŒæ—¶ç”Ÿæˆ Docker é…ç½®

# 5. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env é…ç½®æ•°æ®åº“è¿æ¥

# 6. ç”Ÿæˆ CRUD ä»£ç 
aury generate crud user email:str:unique age:int? status:str=active

# 7. ç”Ÿæˆå¹¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
aury migrate make -m "initial"
aury migrate up

# 8. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
aury server dev
```

> **æ³¨æ„**ï¼š`init` ä¼šè¦†ç›– `uv init` åˆ›å»ºçš„é»˜è®¤ `main.py`ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸ºã€‚

è®¿é—® http://localhost:8000/docs æŸ¥çœ‹ API æ–‡æ¡£ã€‚

### ï¼ˆå¯é€‰ï¼‰å¯ç”¨ç®¡ç†åå° Admin Console

æ¡†æ¶æä¾›å¯é€‰çš„ SQLAdmin ç®¡ç†åå°æ‰©å±•ï¼Œé»˜è®¤è·¯å¾„ï¼š`/api/admin-console`ï¼Œé€‚åˆç”Ÿäº§å¿«é€Ÿæ­å»ºåå°ç®¡ç†èƒ½åŠ›ã€‚

```bash
# å®‰è£…æ‰©å±•ä¾èµ–
uv add "aury-boot[admin]"

# åœ¨ .env ä¸­å¯ç”¨å¹¶è®¾ç½® basic è®¤è¯
ADMIN_ENABLED=true
ADMIN_PATH=/api/admin-console
ADMIN_AUTH_MODE=basic
ADMIN_AUTH_SECRET_KEY=CHANGE_ME_TO_A_RANDOM_SECRET
ADMIN_AUTH_BASIC_USERNAME=admin
ADMIN_AUTH_BASIC_PASSWORD=change_me
```

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š`http://localhost:8000/api/admin-console`

### å­—æ®µè¯­æ³•è¯´æ˜

```bash
# æ ¼å¼: name:type:modifiers
# ç±»å‹: str, text, int, bigint, float, decimal, bool, datetime, date, time, json
# ä¿®é¥°ç¬¦: ? (å¯ç©º), unique, index, =é»˜è®¤å€¼

# ç¤ºä¾‹
aury generate crud article title:str(200) content:text status:str=draft
aury generate crud product name:str:unique price:decimal stock:int=0

# äº¤äº’å¼æ¨¡å¼
aury generate crud user -i
```

---

## 3. å¿«é€Ÿä¸Šæ‰‹ï¼ˆæ‰‹åŠ¨ï¼‰

### å®‰è£…

```bash
# æ¨èï¼šPostgreSQL + Redis + ä»»åŠ¡é˜Ÿåˆ— + è°ƒåº¦å™¨
uv add "aury-boot[recommended]"

# æˆ–æŒ‰éœ€ç»„åˆ
uv add "aury-boot[postgres,redis]"
```

### Hello World

```python
from aury.boot.application.app.base import FoundationApp
from aury.boot.application.config import BaseConfig
from aury.boot.application.server import run_app
from aury.boot.application.interfaces.egress import BaseResponse

class AppConfig(BaseConfig):
    pass

app = FoundationApp(
    title="My Service",
    version="0.1.0",
    config=AppConfig()
)

@app.get("/")
def hello():
    return BaseResponse(code=200, message="Hello", data={"message": "Hello AUM!"})

if __name__ == "__main__":
    run_app(app, host="0.0.0.0", port=8000)
```

### è¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
aury server dev

# ç”Ÿäº§æ¨¡å¼ï¼ˆå¤šè¿›ç¨‹ï¼‰
aury server prod
```

---

## 4. æœåŠ¡å™¨è¿è¡Œ

### CLI å‘½ä»¤ï¼ˆæ¨èï¼‰

```bash
# å¼€å‘æ¨¡å¼ï¼ˆçƒ­é‡è½½ï¼‰
aury server dev

# ç”Ÿäº§æ¨¡å¼ï¼ˆå¤šè¿›ç¨‹ï¼‰
aury server prod
```

> ğŸ“– **è¯¦ç»†é…ç½®**ï¼šå‚è€ƒ [03-server-deployment.md](./03-server-deployment.md)

---

## 5. é¡¹ç›®ç»“æ„

```
my_service/
â”œâ”€â”€ main.py                 # åº”ç”¨å…¥å£
â”œâ”€â”€ config.py               # é…ç½®
â”œâ”€â”€ alembic.ini             # Alembic é…ç½®
â”œâ”€â”€ .env.example            # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ api/                    # API è·¯ç”±
â”‚   â”œâ”€â”€ users.py
â”‚   â””â”€â”€ orders.py
â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ user_service.py
â”‚   â””â”€â”€ order_service.py
â”œâ”€â”€ models/                 # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ order.py
â”œâ”€â”€ repositories/           # æ•°æ®è®¿é—®
â”‚   â”œâ”€â”€ user_repository.py
â”‚   â””â”€â”€ order_repository.py
â”œâ”€â”€ schemas/                # Pydantic æ¨¡å‹
â”‚   â”œâ”€â”€ user.py
â”‚   â””â”€â”€ order.py
â”œâ”€â”€ migrations/             # æ•°æ®åº“è¿ç§»
â”‚   â”œâ”€â”€ env.py
â”‚   â”œâ”€â”€ script.py.mako
â”‚   â””â”€â”€ versions/
â”œâ”€â”€ tests/                  # æµ‹è¯•
â”‚   â””â”€â”€ conftest.py
â”œâ”€â”€ pyproject.toml
â””â”€â”€ README.md
```

**åˆ†å±‚è¯´æ˜**ï¼š
- `api/`ï¼šHTTP è¯·æ±‚å¤„ç†
- `services/`ï¼šä¸šåŠ¡é€»è¾‘
- `models/`ï¼šSQLAlchemy æ¨¡å‹
- `repositories/`ï¼šæ•°æ®è®¿é—®
- `schemas/`ï¼šè¯·æ±‚/å“åº”åºåˆ—åŒ–

---

## 6. é…ç½®

### ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰

```bash
# æœåŠ¡å™¨
SERVER_HOST=0.0.0.0
SERVER_PORT=8000

# æ•°æ®åº“
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb
DATABASE_POOL_SIZE=10

# ç¼“å­˜
CACHE_TYPE=redis
CACHE_REDIS_URL=redis://localhost:6379/0

# ä»»åŠ¡é˜Ÿåˆ—
TASK_BROKER_URL=redis://localhost:6379/0

# æ—¥å¿—
LOG_LEVEL=INFO
LOG_DIR=log
```

### è‡ªå®šä¹‰é…ç½®

```python
from aury.boot.application.config import BaseConfig
from pydantic import Field

class MyConfig(BaseConfig):
    my_feature: bool = Field(default=True)
```

> ğŸ“– **è¯¦ç»†é…ç½®**ï¼šå‚è€ƒ [05-configuration-advanced.md](./05-configuration-advanced.md)

---

## 7. ä¾èµ–æ³¨å…¥

Kit æä¾›ä¼ä¸šçº§ **DI å®¹å™¨**

| ç”Ÿå‘½å‘¨æœŸ | è¯´æ˜ | åœºæ™¯ |
|---------|------|------|
| **SINGLETON** | åº”ç”¨ç”Ÿå‘½å‘¨æœŸå”¯ä¸€ | æ•°æ®åº“ã€ç¼“å­˜ã€é…ç½® |
| **SCOPED** | è¯·æ±‚èŒƒå›´å†…å”¯ä¸€ | æ•°æ®åº“ä¼šè¯ |
| **TRANSIENT** | æ¯æ¬¡åˆ›å»ºæ–°å®ä¾‹ | æœåŠ¡ã€å·¥å…·ç±» |

### å¿«é€Ÿå¼€å§‹

```python
from aury.boot.infrastructure.di import Container

container = Container.get_instance()

# æ³¨å†Œ
container.register_singleton(DatabaseManager)
container.register_transient(UserService)

# è§£æ
service = container.resolve(UserService)
```

> ğŸ“– **æ·±å…¥å­¦ä¹ **ï¼šå‚è€ƒ [06-di-container-complete.md](./06-di-container-complete.md)

---

## 8. ä¸­é—´ä»¶å’Œç»„ä»¶

Kit å°†åŠŸèƒ½å•å…ƒåˆ†ä¸ºä¸¤ç±»ï¼š
- **ä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰**ï¼šå¤„ç† HTTP è¯·æ±‚æ‹¦æˆª
- **ç»„ä»¶ï¼ˆComponentï¼‰**ï¼šç®¡ç†åŸºç¡€è®¾æ–½ç”Ÿå‘½å‘¨æœŸ

### å†…ç½®ä¸­é—´ä»¶

```python
from aury.boot.application.app.middlewares import (
    RequestLoggingMiddleware,  # HTTP è¯·æ±‚æ—¥å¿—
    CORSMiddleware,            # CORS è·¨åŸŸ
)
```

### å†…ç½®ç»„ä»¶

```python
from aury.boot.application.app.components import (
    DatabaseComponent,        # æ•°æ®åº“
    CacheComponent,           # ç¼“å­˜
    TaskComponent,            # å¼‚æ­¥ä»»åŠ¡
    SchedulerComponent,       # å®šæ—¶è°ƒåº¦
    MigrationComponent,       # æ•°æ®åº“è¿ç§»
)
```

### è‡ªå®šä¹‰ç»„ä»¶

```python
from aury.boot.application.app.base import Component, FoundationApp

class MyComponent(Component):
    name = "my_component"
    enabled = True
    depends_on = ["cache"]
    
    async def setup(self, app: FoundationApp, config):
        print("åˆå§‹åŒ–...")
    
    async def teardown(self, app: FoundationApp):
        print("æ¸…ç†...")
```

### æ³¨å†Œä¸­é—´ä»¶å’Œç»„ä»¶

```python
class MyApp(FoundationApp):
    middlewares = [
        RequestLoggingMiddleware,
        CORSMiddleware,
    ]
    components = [
        DatabaseComponent,
        CacheComponent,
        MyComponent,
    ]

app = MyApp(config=config)
```

> ğŸ“– **æ·±å…¥å­¦ä¹ **ï¼šå‚è€ƒ [07-middleware-guide.md](./07-middleware-guide.md) å’Œ [08-components-detailed.md](./08-components-detailed.md)

---

## 9. HTTP æ¥å£

### è¯·æ±‚æ¨¡å‹ï¼ˆIngressï¼‰

```python
from aury.boot.application.interfaces.ingress import (
    BaseRequest,
    PaginationRequest
)
from pydantic import EmailStr, Field

class UserCreateRequest(BaseRequest):
    username: str = Field(..., min_length=3, max_length=50)
    email: EmailStr
    password: str = Field(..., min_length=8)
```

### ç»Ÿä¸€å“åº”æ ¼å¼ï¼ˆEgressï¼‰

```python
from aury.boot.application.interfaces.egress import (
    BaseResponse,
    PaginationResponse,
    Pagination,
)

# å•ä¸ªèµ„æº
return BaseResponse(code=200, message="æˆåŠŸ", data=user)

# åˆ—è¡¨å“åº”
pagination = Pagination(total=100, items=users, page=1, size=20)
return PaginationResponse(code=200, message="è·å–æˆåŠŸ", data=pagination)
```

### è·¯ç”±ç¤ºä¾‹

```python
from fastapi import APIRouter, Depends
from aury.boot.infrastructure.di import Container
from aury.boot.application.interfaces.egress import BaseResponse

router = APIRouter()
container = Container.get_instance()

def get_user_service():
    return container.resolve(UserService)

@router.post("/users")
async def create_user(
    request: UserCreateRequest,
    service: UserService = Depends(get_user_service)
):
    user = await service.create(request)
    return BaseResponse(code=200, message="åˆ›å»ºæˆåŠŸ", data=user)
```

> ğŸ“– **æ·±å…¥å­¦ä¹ **ï¼šå‚è€ƒ [09-http-advanced.md](./09-http-advanced.md)

---

## 10. é”™è¯¯å¤„ç†

### å¼‚å¸¸ä½“ç³»ä¸ç»§æ‰¿è§„åˆ™

```python
from aury.boot.application.errors import (
    BaseError,
    NotFoundError,
    AlreadyExistsError,
    UnauthorizedError,
    ForbiddenError,
)

# âœ… å¼€å‘è§„èŒƒï¼šæ‰€æœ‰æœåŠ¡ç‰¹å®šå¼‚å¸¸éƒ½è¦ç»§æ‰¿ Foundation Kit çš„å¼‚å¸¸
class MyServiceError(UnauthorizedError):
    """æœåŠ¡ç‰¹å®šå¼‚å¸¸å¿…é¡»ç»§æ‰¿ Foundation Kit çš„å¼‚å¸¸ç±»ã€‚"""
    
    def __init__(self, message: str, **kwargs):
        super().__init__(message=message, **kwargs)

@router.get("/users/{user_id}")
async def get_user(user_id: str):
    user = await repo.get(user_id)
    if not user:
        # Foundation Kit å…¨å±€å¼‚å¸¸å¤„ç†å™¨ä¼šè‡ªåŠ¨è½¬æ¢ä¸º HTTP 404
        raise NotFoundError(f"ç”¨æˆ· {user_id} ä¸å­˜åœ¨")
    return user
```

### å¼‚å¸¸ç»§æ‰¿è§„åˆ™å’Œé”™è¯¯ä»£ç 

**åŸåˆ™**ï¼š
1. æ‰€æœ‰å¼‚å¸¸å¿…é¡»ç»§æ‰¿ Foundation Kit çš„å¼‚å¸¸ç±»ï¼ˆUnauthorizedErrorã€NotFoundError ç­‰ï¼‰
2. æ‰€æœ‰é”™è¯¯ä»£ç å¿…é¡»ç»§æ‰¿ Foundation Kit çš„ `ErrorCode`ï¼Œåœ¨æœåŠ¡èŒƒå›´å†…å®šä¹‰
3. **ä¸è¦†ç›–** Foundation Kit çš„é”™è¯¯ä»£ç ï¼ˆ1xxx-4xxxï¼‰ï¼ŒæœåŠ¡ä½¿ç”¨ 5xxx+ èŒƒå›´

```python
# âœ… æ­£ç¡®ï¼šå®šä¹‰é”™è¯¯ä»£ç æšä¸¾ï¼Œç»§æ‰¿ ErrorCode
from aury.boot.application.errors.codes import ErrorCode

class IdentityErrorCode(ErrorCode):
    INVALID_CREDENTIALS = "5001"
    USER_NOT_FOUND = "5101"
    DUPLICATE_USER = "5104"

# âœ… æ­£ç¡®ï¼šå¼‚å¸¸ç»§æ‰¿ Foundation Kit çš„å¼‚å¸¸
class InvalidCredentialsError(UnauthorizedError):
    def __init__(self, **kwargs):
        metadata = kwargs.pop("metadata", {})
        metadata["error_code"] = IdentityErrorCode.INVALID_CREDENTIALS.value
        super().__init__(message="ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯", metadata=metadata, **kwargs)

# âŒ é”™è¯¯ï¼šä¸ç»§æ‰¿ Foundation Kit
class MyCustomError(Exception):
    pass

# âŒ é”™è¯¯ï¼šæ²¡æœ‰è°ƒç”¨ super().__init__()
class BadError(NotFoundError):
    self.message = message  # é”™ï¼
```

> ğŸ“– **è¯¦ç»†è§„èŒƒ**ï¼šå‚è€ƒ [10-error-handling-guide.md](./10-error-handling-guide.md)

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [10-error-handling-guide.md](./10-error-handling-guide.md)

---

## 11. äº‹åŠ¡ç®¡ç†

### æ¨èæ–¹å¼ï¼šè£…é¥°å™¨

```python
from aury.boot.domain.transaction import transactional
from sqlalchemy.ext.asyncio import AsyncSession

@transactional
async def create_user_with_profile(session: AsyncSession, name: str):
    repo = UserRepository(session)
    user = await repo.create({"username": name})
    # è‡ªåŠ¨æäº¤ï¼Œå¼‚å¸¸æ—¶è‡ªåŠ¨å›æ»š
    return user
```

> ğŸ“– **å…¶ä»–æ–¹å¼**ï¼šå‚è€ƒ [11-transaction-management.md](./11-transaction-management.md)

---

## 12. æ•°æ®åº“

### å®šä¹‰æ¨¡å‹

```python
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy import String
from aury.boot.domain.models import UUIDAuditableStateModel

class User(UUIDAuditableStateModel):
    """ç”¨æˆ·æ¨¡å‹ - è‡ªåŠ¨è·å¾— UUID ä¸»é”®ã€æ—¶é—´æˆ³å’Œè½¯åˆ é™¤åŠŸèƒ½"""
    __tablename__ = "users"
    
    # UUIDAuditableStateModel è‡ªåŠ¨æä¾›ï¼š
    # - id: UUID ä¸»é”®
    # - created_at: åˆ›å»ºæ—¶é—´
    # - updated_at: æ›´æ–°æ—¶é—´
    # - deleted_at: è½¯åˆ é™¤æ—¶é—´
    
    username: Mapped[str] = mapped_column(String(50), unique=True)
    email: Mapped[str] = mapped_column(String(100), unique=True)
```

### åˆ›å»ºä»“å‚¨

```python
from aury.boot.domain.repository.impl import BaseRepository

class UserRepository(BaseRepository[User]):
    async def get_by_email(self, email: str):
        return await self.get_by(email=email)
```

### åœ¨ API ä¸­ä½¿ç”¨

```python
from aury.boot.infrastructure.database import DatabaseManager

db_manager = DatabaseManager.get_instance()

async def get_user_repo(session=Depends(db_manager.get_session)):
    return UserRepository(session)

@router.get("/users/{user_id}")
async def get_user(user_id: str, repo=Depends(get_user_repo)):
    user = await repo.get(user_id)
    if not user:
        raise NotFoundError("ç”¨æˆ·ä¸å­˜åœ¨")
    return BaseResponse(code=200, message="è·å–æˆåŠŸ", data=user)
```

> ğŸ“– **æ·±å…¥å­¦ä¹ **ï¼šå‚è€ƒ [12-database-complete.md](./12-database-complete.md)

---

## 13. ç¼“å­˜

### åŸºæœ¬ç”¨æ³•

```python
from aury.boot.infrastructure.cache import CacheManager

cache = CacheManager.get_instance()

# è®¾ç½®
await cache.set("user:1", {"name": "test"}, expire=300)

# è·å–
user = await cache.get("user:1")

# åˆ é™¤
await cache.delete("user:1")
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [13-caching-advanced.md](./13-caching-advanced.md)

---

## 14. å¼‚æ­¥ä»»åŠ¡

### å®šä¹‰ä»»åŠ¡

```python
from aury.boot.infrastructure.tasks.manager import TaskManager

tm = TaskManager.get_instance()

@tm.conditional_task(queue_name="default", max_retries=3)
async def send_email_task(email: str, content: str):
    pass
```

### è°ƒç”¨ä»»åŠ¡

```python
# å‘é€
send_email_task.send("test@example.com", "Hello!")
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [14-async-tasks-guide.md](./14-async-tasks-guide.md)

---

## 15. äº‹ä»¶é©±åŠ¨

### å®šä¹‰å’Œè®¢é˜…

```python
from aury.boot.infrastructure.events.bus import EventBus
from aury.boot.infrastructure.events import Event

class OrderCreatedEvent(Event):
    order_id: str
    amount: float
    
    @property
    def event_name(self) -> str:
        return "order.created"

bus = EventBus.get_instance()

@bus.subscribe(OrderCreatedEvent)
async def on_order_created(event: OrderCreatedEvent):
    print(f"è®¢å•åˆ›å»º: {event.order_id}")
```

### å‘å¸ƒäº‹ä»¶

```python
await bus.publish(OrderCreatedEvent(order_id="1001", amount=99.9))
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [15-events-driven.md](./15-events-driven.md)

---

## 16. å®šæ—¶è°ƒåº¦

```python
from aury.boot.infrastructure.scheduler.manager import SchedulerManager
from datetime import datetime

scheduler = SchedulerManager.get_instance()

# Cron ä»»åŠ¡
scheduler.add_job(
    func=daily_report,
    trigger="cron",
    hour=2, minute=30,
    id="daily_report"
)

# é—´éš”ä»»åŠ¡
scheduler.add_job(
    func=heartbeat,
    trigger="interval",
    seconds=30
)
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [16-scheduler-guide.md](./16-scheduler-guide.md)

---

## 17. RPC ä¸æœåŠ¡å‘ç°

### é…ç½®

```bash
# ç¯å¢ƒå˜é‡
RPC_CLIENT_SERVICES={"order-service": "http://order-service:8000"}
```

### å‘èµ·è°ƒç”¨

```python
from aury.boot.application.rpc.client import create_rpc_client

client = create_rpc_client(service_name="order-service")
response = await client.get("/api/orders/123")
```

### è‡ªåŠ¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª

```python
from aury.boot.common.logging import get_trace_id, logger

trace_id = get_trace_id()
logger.info(f"å¤„ç†è¯·æ±‚ | Trace-ID: {trace_id}")
# RPC è°ƒç”¨ä¼šè‡ªåŠ¨æ·»åŠ  X-Trace-ID è¯·æ±‚å¤´
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [17-rpc-microservices.md](./17-rpc-microservices.md)

---

## 18. WebSocket

### åŸºæœ¬è¿æ¥

```python
from fastapi import APIRouter, WebSocket
from aury.boot.infrastructure.database import DatabaseManager

router = APIRouter()
db_manager = DatabaseManager.get_instance()

@router.websocket("/ws/chat/{room_id}")
async def websocket_chat(websocket: WebSocket, room_id: str):
    await websocket.accept()
    
    try:
        while True:
            data = await websocket.receive_text()
            
            async with db_manager.session() as session:
                repo = MessageRepository(session)
                await repo.create({"room_id": room_id, "content": data})
            
            await websocket.send_json({"status": "ok"})
    except Exception as e:
        await websocket.close(code=1011, reason=str(e))
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [18-websocket-guide.md](./18-websocket-guide.md)

---

## 19. å¯¹è±¡å­˜å‚¨

åŸºäº [aury-sdk-storage](https://github.com/AUMNeo/aury-sdk-storage)ï¼Œæ”¯æŒ S3 å…¼å®¹å­˜å‚¨å’Œ STS ä¸´æ—¶å‡­è¯ã€‚

```bash
# å®‰è£…
uv add "aury-sdk-storage[aws]"
```

```python
from io import BytesIO
from aury.boot.infrastructure.storage import (
    StorageManager, StorageConfig, StorageBackend, StorageFile,
)

# è·å–å­˜å‚¨ç®¡ç†å™¨ï¼ˆæ”¯æŒå‘½åå¤šå®ä¾‹ï¼‰
storage = StorageManager.get_instance()

# åˆå§‹åŒ–ï¼ˆä¸€èˆ¬ç”± StorageComponent è‡ªåŠ¨å®Œæˆï¼‰
await storage.init(StorageConfig(
    backend=StorageBackend.COS,
    bucket_name="my-bucket-1250000000",
    region="ap-guangzhou",
    endpoint="https://cos.ap-guangzhou.myqcloud.com",
    access_key_id="AKIDxxxxx",
    access_key_secret="xxxxx",
))

# ä¸Šä¼ 
url = await storage.upload_file(
    StorageFile(
        object_name="avatars/user_1.png",
        data=BytesIO(image_bytes),
        content_type="image/png",
    )
)
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [19-storage-guide.md](./19-storage-guide.md)

---

## 20. å›½é™…åŒ–

```python
from aury.boot.common.i18n.translator import translate, load_translations

# åŠ è½½ç¿»è¯‘
load_translations({
    "zh_CN": {"error.not_found": "èµ„æº {name} æœªæ‰¾åˆ°"},
    "en_US": {"error.not_found": "Resource {name} not found"}
})

# ä½¿ç”¨
msg = translate("error.not_found", name="User", locale="zh_CN")
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [20-i18n-guide.md](./20-i18n-guide.md)

---

## 21. æ•°æ®åº“è¿ç§»

### è‡ªåŠ¨è¿ç§»ï¼ˆæ¨èï¼‰

åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œè¿ç§»ï¼š

```python
from aury.boot.application.app.components import MigrationComponent

class MyApp(FoundationApp):
    components = [
        DatabaseComponent,
        MigrationComponent,  # è‡ªåŠ¨æ‰§è¡Œè¿ç§»
        CacheComponent,
    ]

# åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ‰§è¡Œè¿ç§»åˆ°æœ€æ–°ç‰ˆæœ¬
```

### æ‰‹åŠ¨è¿ç§»

```bash
# åˆå§‹åŒ–
alembic init -t async alembic

# ç”Ÿæˆè¿ç§»
aury migrate make -m "Add users table"

# æ‰§è¡Œè¿ç§»
aury migrate up

# æŸ¥çœ‹çŠ¶æ€
aury migrate status
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [21-migration-guide.md](./21-migration-guide.md)

---

## 22. æ—¥å¿—ç³»ç»Ÿ

### ç¯å¢ƒå˜é‡

```bash
LOG_LEVEL=INFO
LOG_DIR=log
LOG_ROTATION_TIME=00:00
LOG_RETENTION_DAYS=7
```

### ä½¿ç”¨æ—¥å¿—

```python
from aury.boot.common.logging import logger, get_trace_id

logger.info("ä¿¡æ¯")
logger.warning("è­¦å‘Š")
logger.error("é”™è¯¯")

# è‡ªåŠ¨åŒ…å« Trace ID
trace_id = get_trace_id()
logger.info(f"å¤„ç†è¯·æ±‚ | Trace-ID: {trace_id}")
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [22-logging-complete.md](./22-logging-complete.md)

---

## 23. CLI å‘½ä»¤

### ç»Ÿä¸€å…¥å£

å®‰è£…åå¯ä½¿ç”¨ `aury` ç»Ÿä¸€å‘½ä»¤ï¼š

```bash
# é¡¹ç›®åˆå§‹åŒ–ï¼ˆå…ˆç”¨ uv åˆ›å»ºé¡¹ç›®ï¼‰
uv init . --name my_service --no-package --python 3.13
uv add "aury-boot[recommended]"
aury init -i              # äº¤äº’å¼æ¨¡å¼ï¼ˆæ¨èï¼‰
aury init                 # é»˜è®¤é…ç½®
aury init my_package      # é¡¶å±‚åŒ…ç»“æ„
aury init --docker        # åŒ…å« Docker é…ç½®

# ä»£ç ç”Ÿæˆ
aury generate crud user

# æœåŠ¡å™¨
aury server dev
aury server prod

# æ•°æ®åº“è¿ç§»
aury migrate make -m "add user"
aury migrate up
aury migrate status

# Shell è¡¥å…¨
aum --install-completion
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [24-cli-commands.md](./24-cli-commands.md)

---

## 24. æœ€ä½³å®è·µ

### ä½¿ç”¨ Foundation Kit é¢„å®šä¹‰æ¨¡å‹

Foundation Kit æä¾›å¤šä¸ªé¢„å®šä¹‰æ¨¡å‹ç»„åˆï¼Œæ¨èç›´æ¥ä½¿ç”¨è€Œä¸æ˜¯ `Base`ï¼š

```python
from aury.boot.domain.models import (
    UUIDAuditableStateModel,  # ã€æ¨èã€‘UUIDä¸»é”® + æ—¶é—´æˆ³ + è½¯åˆ é™¤
    UUIDModel,                # UUIDä¸»é”® + æ—¶é—´æˆ³
    Model,                    # æ•´æ•°ä¸»é”® + æ—¶é—´æˆ³
    FullFeaturedUUIDModel,    # å®Œæ•´åŠŸèƒ½ï¼šUUID + æ—¶é—´æˆ³ + è½¯åˆ é™¤ + ä¹è§‚é”
)

# âœ… æ¨èï¼šä½¿ç”¨ UUIDAuditableStateModel
class Identity(UUIDAuditableStateModel):
    """èº«ä»½æ¨¡å‹ - è‡ªåŠ¨è·å¾—ä»¥ä¸‹å­—æ®µï¼š
    - id: UUID ä¸»é”®
    - created_at: åˆ›å»ºæ—¶é—´
    - updated_at: æ›´æ–°æ—¶é—´  
    - deleted_at: è½¯åˆ é™¤æ—¶é—´ï¼ˆ0 æœªåˆ é™¤ï¼Œ>0 å·²åˆ é™¤æ—¶é—´æˆ³ï¼‰
    """
    __tablename__ = "identity_identities"
    username: Mapped[str] = mapped_column(String(100))

# âŒ ä¸æ¨èï¼šç›´æ¥ä½¿ç”¨ Base
class BadModel(Base):
    __tablename__ = "bad_model"
    # éœ€è¦æ‰‹åŠ¨æ·»åŠ  idã€created_at ç­‰å­—æ®µ
```

**é¢„å®šä¹‰æ¨¡å‹å¯¹æ¯”**ï¼š

| æ¨¡å‹ | UUID ä¸»é”® | æ—¶é—´æˆ³ | è½¯åˆ é™¤ | ä¹è§‚é” | ç”¨é€” |
|------|----------|--------|--------|--------|------|
| **UUIDAuditableStateModel** | âœ… | âœ… | âœ… | âŒ | ã€æ¨èã€‘å¤§å¤šæ•°ä¸šåŠ¡æ¨¡å‹ |
| **UUIDModel** | âœ… | âœ… | âŒ | âŒ | ä¸éœ€è¦è½¯åˆ é™¤çš„æ¨¡å‹ |
| **Model** | âŒ | âœ… | âŒ | âŒ | ä½¿ç”¨æ•´æ•°ä¸»é”® |
| **FullFeaturedUUIDModel** | âœ… | âœ… | âœ… | âœ… | éœ€è¦å®Œæ•´åŠŸèƒ½çš„å…³é”®ä¸šåŠ¡ |

### è´«è¡€æ¨¡å‹ + Repository æ¨¡å¼

æ¨èä½¿ç”¨"è´«è¡€æ¨¡å‹"è®¾è®¡ï¼ˆåªåŒ…å«å­—æ®µï¼Œæ— å…³ç³»å®šä¹‰ï¼‰ï¼Œæ‰€æœ‰æŸ¥è¯¢ç”± Repository å±‚è´Ÿè´£ï¼š

```python
# âœ… æ¨¡å‹å±‚ï¼ˆçº¯æ•°æ®ç»“æ„ï¼‰
class Tenant(UUIDAuditableStateModel):
    __tablename__ = "tenants"
    name: Mapped[str] = mapped_column(String(100))
    # ä¸å®šä¹‰ relationshipï¼Œä¸å®šä¹‰ ForeignKey

# âœ… ä»“åº“å±‚ï¼ˆè´Ÿè´£æ‰€æœ‰æŸ¥è¯¢ï¼‰
class TenantRepository(BaseRepository[Tenant]):
    async def get_with_members(self, tenant_id: GUID):
        # æ˜¾å¼ joinï¼Œå¯æ§çš„æŸ¥è¯¢
        stmt = select(Tenant).where(Tenant.id == tenant_id)
        return await self.session.scalar(stmt)
    
    async def list_members(self, tenant_id: GUID):
        # æ˜¾å¼æŸ¥è¯¢æˆå‘˜ï¼Œé¿å…éšå¼ N+1
        stmt = select(TenantMembership).where(TenantMembership.tenant_id == tenant_id)
        return await self.session.scalars(stmt)
```

**å¥½å¤„**ï¼š
- æ¨¡å‹ç®€æ´ï¼Œæ˜“äºç»´æŠ¤
- é¿å…éšå¼æŸ¥è¯¢å¯¼è‡´çš„ N+1 é—®é¢˜
- æŸ¥è¯¢é€»è¾‘é›†ä¸­åœ¨ Repositoryï¼Œä¾¿äºä¼˜åŒ–
- å®Œå…¨æŒæ§æ•°æ®åŠ è½½ç­–ç•¥

### é¿å… N+1 æŸ¥è¯¢

```python
from sqlalchemy.orm import selectinload

class UserRepository(BaseRepository[User]):
    async def list_with_orders(self):
        stmt = select(User).options(selectinload(User.orders))
        result = await self.session.execute(stmt)
        return result.scalars().all()
```

### Event Bus vs Task Queue

| ç‰¹æ€§ | Event Bus | Task Queue |
|------|-----------|-----------|
| æ¶ˆè´¹è€… | å¤šä¸ª | å•ä¸ª |
| å»¶è¿Ÿ | æ¯«ç§’çº§ | ç§’çº§ |
| é‡è¯• | æ—  | æœ‰ |
| ç”¨é€” | é€šçŸ¥ã€åˆ†æ | æ•°æ®å¤„ç†ã€æ”¯ä»˜ |

### ä¾èµ–ç®¡ç†

```bash
uv init my-service
uv add "aury-boot[recommended]"
uv lock
```

> ğŸ“– **è¯¦ç»†è¯´æ˜**ï¼šå‚è€ƒ [23-best-practices.md](./23-best-practices.md)
