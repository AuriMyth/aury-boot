{"config":{"lang":["zh","en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"\ud83d\ude80 Aury Boot","text":"<p>\u6b22\u8fce\u4f7f\u7528 Aury Boot - \u73b0\u4ee3\u5316\u5fae\u670d\u52a1\u57fa\u7840\u67b6\u6784\u6846\u67b6\uff01</p> <p>\u8fd9\u662f\u4e00\u6b3e\u4e13\u4e3a\u6784\u5efa\u9ad8\u6027\u80fd\u3001\u53ef\u6269\u5c55\u5fae\u670d\u52a1\u800c\u8bbe\u8ba1\u7684 Python \u6846\u67b6\uff0c\u63d0\u4f9b\u4e86\u5f00\u7bb1\u5373\u7528\u7684\u4f01\u4e1a\u7ea7\u529f\u80fd\u3002</p>"},{"location":"#_1","title":"\u26a1 \u5feb\u901f\u5f00\u59cb","text":"<pre><code># 1. \u521b\u5efa\u9879\u76ee\u76ee\u5f55\u5e76\u521d\u59cb\u5316\nmkdir my-service &amp;&amp; cd my-service\nuv init . --name my_service --no-package --python 3.13\n\n# 2. \u6dfb\u52a0\u4f9d\u8d56\nuv add \"aury-boot[recommended,admin]\"  # admin \u53ef\u9009\uff0c\u63d0\u4f9b SQLAdmin \u7ba1\u7406\u540e\u53f0\n\n# 3. \u521d\u59cb\u5316\u9879\u76ee\u7ed3\u6784\naury init\n\n# 4. \u542f\u52a8\u5f00\u53d1\u670d\u52a1\u5668\naury server dev</code></pre> <p>\u8bbf\u95ee http://localhost:8000/docs \u67e5\u770b API \u6587\u6863\u3002</p>"},{"location":"#hello-world","title":"Hello World","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom aury.boot.application.server import run_app\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nclass AppConfig(BaseConfig):\n    pass\n\napp = FoundationApp(\n    title=\"My Service\",\n    version=\"0.1.0\",\n    config=AppConfig()\n)\n\n@app.get(\"/\")\ndef hello():\n    return BaseResponse(code=200, message=\"Hello\", data={\"message\": \"Hello AUM!\"})\n\nif __name__ == \"__main__\":\n    run_app(app, host=\"0.0.0.0\", port=8000)</code></pre>"},{"location":"#_2","title":"\u8fd0\u884c","text":"<pre><code># \u5f00\u53d1\u6a21\u5f0f\uff08\u70ed\u91cd\u8f7d\uff09\naury server dev\n\n# \u751f\u4ea7\u6a21\u5f0f\uff08\u591a\u8fdb\u7a0b\uff09\naury server prod</code></pre> <p>\u8bbf\u95ee http://localhost:8000</p>"},{"location":"#_3","title":"\ud83d\udcda \u6587\u6863\u7ed3\u6784","text":"<p>\u672c\u6587\u6863\u5171 24 \u4e2a\u7ae0\u8282\uff0c\u5206\u4e3a\u56db\u4e2a\u4e3b\u8981\u90e8\u5206\uff1a</p>"},{"location":"#6","title":"\u57fa\u7840\u90e8\u5206\uff086 \u7ae0\uff09","text":"<ul> <li>\u5feb\u901f\u5f00\u59cb - \u6240\u6709\u529f\u80fd\u7684\u901f\u67e5\u624b\u518c</li> <li>Framework \u67b6\u6784 - \u7406\u89e3\u8bbe\u8ba1\u7406\u5ff5</li> <li>\u5b89\u88c5\u6307\u5357 - \u5b8c\u6574\u7684\u4f9d\u8d56\u5b89\u88c5</li> <li>\u670d\u52a1\u5668\u8fd0\u884c - \u542f\u52a8\u548c\u90e8\u7f72\u5e94\u7528</li> <li>\u9879\u76ee\u7ed3\u6784 - \u63a8\u8350\u7684\u9879\u76ee\u7ec4\u7ec7</li> <li>\u914d\u7f6e\u7ba1\u7406 - \u7075\u6d3b\u7684\u914d\u7f6e\u7cfb\u7edf</li> </ul>"},{"location":"#7","title":"\u6838\u5fc3\u529f\u80fd\uff087 \u7ae0\uff09","text":"<ul> <li>\u4f9d\u8d56\u6ce8\u5165 - DI \u5bb9\u5668\u7cfb\u7edf</li> <li>\u4e2d\u95f4\u4ef6\u7cfb\u7edf - HTTP \u8bf7\u6c42\u5904\u7406</li> <li>\u7ec4\u4ef6\u7cfb\u7edf - \u57fa\u7840\u8bbe\u65bd\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>HTTP \u63a5\u53e3 - Ingress/Egress \u5b8c\u6574\u8bb2\u89e3</li> <li>\u9519\u8bef\u5904\u7406 - \u5f02\u5e38\u4f53\u7cfb</li> <li>\u4e8b\u52a1\u7ba1\u7406 - 4 \u79cd\u4e8b\u52a1\u65b9\u5f0f</li> <li>\u6570\u636e\u5e93 - ORM \u548c\u6570\u636e\u8bbf\u95ee</li> </ul>"},{"location":"#11","title":"\u9ad8\u7ea7\u529f\u80fd\uff0811 \u7ae0\uff09","text":"<ul> <li>\u7f13\u5b58\u7cfb\u7edf</li> <li>\u5f02\u6b65\u4efb\u52a1</li> <li>\u4e8b\u4ef6\u9a71\u52a8</li> <li>\u5b9a\u65f6\u8c03\u5ea6</li> <li>RPC \u5fae\u670d\u52a1</li> <li>WebSocket</li> <li>\u5bf9\u8c61\u5b58\u50a8</li> <li>\u56fd\u9645\u5316</li> <li>\u6570\u636e\u5e93\u8fc1\u79fb</li> <li>\u65e5\u5fd7\u7cfb\u7edf</li> <li>\u57fa\u7840\u8bbe\u65bd\u9ad8\u7ea7 - \u591a\u5b9e\u4f8b\u914d\u7f6e\u3001Channel\u3001MQ\u3001\u5ba2\u6237\u7aef\u7ba1\u7406</li> </ul>"},{"location":"#1","title":"\u6700\u4f73\u5b9e\u8df5\uff081 \u7ae0\uff09","text":"<ul> <li>\u6700\u4f73\u5b9e\u8df5 - \u67b6\u6784\u3001\u6027\u80fd\u3001\u6d4b\u8bd5</li> </ul>"},{"location":"#_4","title":"\u2728 \u6838\u5fc3\u7279\u6027","text":""},{"location":"#_5","title":"\u7edf\u4e00\u7684\u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6\u7ba1\u7406","text":"<pre><code>class MyApp(FoundationApp):\n    middlewares = [RequestLoggingMiddleware, CORSMiddleware]\n    components = [DatabaseComponent, CacheComponent, TaskComponent]</code></pre>"},{"location":"#di","title":"\u4f01\u4e1a\u7ea7 DI \u5bb9\u5668","text":"<pre><code>container = Container.get_instance()\ncontainer.register_singleton(UserService)\nservice = container.resolve(UserService)</code></pre>"},{"location":"#api","title":"\u6807\u51c6\u5316 API \u54cd\u5e94","text":"<pre><code>return BaseResponse(code=200, message=\"Success\", data=user)</code></pre>"},{"location":"#_6","title":"\u5b8c\u6574\u7684\u4e8b\u52a1\u652f\u6301","text":"<pre><code>@transactional\nasync def create_order(session: AsyncSession, request: OrderRequest):\n    # \u81ea\u52a8\u5904\u7406\u63d0\u4ea4\u548c\u56de\u6eda\n    pass</code></pre>"},{"location":"#_7","title":"\u5fae\u670d\u52a1\u5f00\u7bb1\u5373\u7528","text":"<ul> <li>\u670d\u52a1\u53d1\u73b0</li> <li>RPC \u901a\u4fe1</li> <li>\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a</li> <li>\u8d1f\u8f7d\u5747\u8861</li> </ul>"},{"location":"#_8","title":"\ud83c\udfaf \u5b66\u4e60\u8def\u5f84","text":""},{"location":"#5","title":"5 \u5206\u949f\u5feb\u901f\u4e0a\u624b","text":"<ol> <li>\u8bfb \u5feb\u901f\u5f00\u59cb</li> <li>\u6309\u7167 Hello World \u793a\u4f8b\u8fd0\u884c</li> </ol>"},{"location":"#30","title":"30 \u5206\u949f\u5b8c\u6574\u5e94\u7528","text":"<ol> <li>\u9879\u76ee\u7ed3\u6784</li> <li>HTTP \u63a5\u53e3</li> <li>\u6570\u636e\u5e93</li> </ol>"},{"location":"#_9","title":"\u6df1\u5165\u7406\u89e3\u6846\u67b6","text":"<ol> <li>Framework \u67b6\u6784</li> <li>DI \u5bb9\u5668</li> <li>\u4e2d\u95f4\u4ef6\u7cfb\u7edf</li> <li>\u7ec4\u4ef6\u7cfb\u7edf</li> </ol>"},{"location":"#_10","title":"\ud83d\udd0d \u5feb\u901f\u67e5\u627e","text":"\u9700\u6c42 \u6587\u6863 \u5982\u4f55\u542f\u52a8\u5e94\u7528\uff1f \u670d\u52a1\u5668\u8fd0\u884c \u5982\u4f55\u5b9a\u4e49 API\uff1f HTTP \u63a5\u53e3 \u5982\u4f55\u64cd\u4f5c\u6570\u636e\u5e93\uff1f \u6570\u636e\u5e93 \u5982\u4f55\u5904\u7406\u9519\u8bef\uff1f \u9519\u8bef\u5904\u7406 \u5982\u4f55\u7ec4\u7ec7\u9879\u76ee\uff1f \u9879\u76ee\u7ed3\u6784 \u5982\u4f55\u4f18\u5316\u6027\u80fd\uff1f \u6700\u4f73\u5b9e\u8df5"},{"location":"#_11","title":"\ud83d\udca1 \u5e38\u89c1\u95ee\u9898","text":""},{"location":"#q","title":"Q: \u6211\u5e94\u8be5\u4ece\u54ea\u91cc\u5f00\u59cb\uff1f","text":"<p>A: \u4ece \u5feb\u901f\u5f00\u59cb \u5f00\u59cb\uff0c\u8fd9\u662f\u6240\u6709\u529f\u80fd\u7684\u901f\u67e5\u624b\u518c\u3002</p>"},{"location":"#q_1","title":"Q: \u5982\u4f55\u8fde\u63a5\u6570\u636e\u5e93\uff1f","text":"<p>A: \u67e5\u770b \u9879\u76ee\u7ed3\u6784 \u548c \u6570\u636e\u5e93\u3002</p>"},{"location":"#q_2","title":"Q: \u5982\u4f55\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\uff1f","text":"<p>A: \u67e5\u770b \u670d\u52a1\u5668\u8fd0\u884c \u4e2d\u7684\u751f\u4ea7\u6a21\u5f0f\u914d\u7f6e\u3002</p>"},{"location":"#_12","title":"\ud83c\udf1f \u6846\u67b6\u4f18\u52bf","text":"<ul> <li>\u2705 \u5f00\u7bb1\u5373\u7528 - \u6240\u6709\u4f01\u4e1a\u7ea7\u529f\u80fd\u90fd\u5df2\u96c6\u6210</li> <li>\u2705 \u6807\u51c6\u5316 - \u9075\u5faa\u5fae\u670d\u52a1\u6700\u4f73\u5b9e\u8df5</li> <li>\u2705 \u9ad8\u6027\u80fd - \u5f02\u6b65\u4f18\u5148\u8bbe\u8ba1</li> <li>\u2705 \u53ef\u6269\u5c55 - \u7075\u6d3b\u7684\u7ec4\u4ef6\u548c DI \u7cfb\u7edf</li> <li>\u2705 \u6613\u7ef4\u62a4 - \u6e05\u6670\u7684\u4ee3\u7801\u7ed3\u6784\u548c\u5b8c\u6574\u6587\u6863</li> </ul>"},{"location":"#_13","title":"\ud83d\ude80 \u4e0b\u4e00\u6b65","text":"<ol> <li>\u5b89\u88c5 - \u6309\u7167\u6b65\u9aa4\u5b89\u88c5\u4f9d\u8d56</li> <li>\u5feb\u901f\u5f00\u59cb - 5 \u5206\u949f\u4e86\u89e3\u6240\u6709\u529f\u80fd</li> <li>\u9879\u76ee\u7ed3\u6784 - \u5efa\u7acb\u9879\u76ee\u9aa8\u67b6</li> <li>\u6784\u5efa\u5e94\u7528 - \u5f00\u59cb\u7f16\u5199\u4ee3\u7801</li> </ol>"},{"location":"#_14","title":"\ud83d\udcde \u652f\u6301","text":"<ul> <li>\ud83d\udcd6 \u5b8c\u6574\u6587\u6863</li> <li>\ud83d\udc1b GitHub Issues</li> <li>\ud83d\udcac GitHub Discussions</li> </ul> <p>\u73b0\u5728\u5c31\u5f00\u59cb\u6784\u5efa\u9ad8\u6027\u80fd\u7684\u5fae\u670d\u52a1\u5427\uff01 \ud83c\udf89</p>"},{"location":"00-quick-start/","title":"Aury Boot \u7528\u6237\u5f00\u53d1\u624b\u518c","text":"<p>\u6b22\u8fce\u4f7f\u7528 Aury Boot\uff01\u8fd9\u662f\u4e00\u6b3e\u4e13\u4e3a\u6784\u5efa\u73b0\u4ee3\u5316\u3001\u9ad8\u6027\u80fd\u5fae\u670d\u52a1\u800c\u8bbe\u8ba1\u7684 Python \u57fa\u7840\u8bbe\u65bd\u6846\u67b6\u3002</p>"},{"location":"00-quick-start/#ai","title":"\u7528 AI \u7f16\u7a0b\u7684\u63a8\u8350\u65b9\u5f0f\uff08\u5f3a\u70c8\u5efa\u8bae\u5148\u770b\uff09","text":"<p>\u5229\u7528 AI\uff08\u5982 Cursor / Warp AI / GitHub Copilot / OpenAI Codex \u7b49\uff09\u5f00\u53d1\u670d\u52a1\u65f6\uff0c\u5efa\u8bae\u5148\u4e3a AI \u51c6\u5907\u597d\u5f53\u524d\u9879\u76ee\u7684\u5173\u952e\u6587\u6863\u3002</p>"},{"location":"00-quick-start/#_1","title":"\u7b2c\u4e00\u6b65\uff1a\u751f\u6210\u9879\u76ee\u6587\u6863","text":"<p>\u5728\u4f60\u7684\u4e1a\u52a1\u9879\u76ee\u6839\u76ee\u5f55\u5b89\u88c5\u597d <code>aury-boot</code> \u4e4b\u540e\uff0c\u6267\u884c\uff1a</p> <pre><code>aury docs all        # \u4e00\u6b21\u6027\u751f\u6210/\u66f4\u65b0\u6240\u6709\u6587\u6863\uff08\u63a8\u8350\uff09\n\n# \u6216\u8005\u6309\u9700\uff1a\naury docs agents     # \u751f\u6210 AGENTS.md\uff08AI \u7f16\u7a0b\u52a9\u624b\u4e0a\u4e0b\u6587\u6587\u6863\uff09\naury docs dev        # \u751f\u6210 aury_docs/ \u76ee\u5f55\uff08\u5f00\u53d1\u6587\u6863\u5305\uff09\naury docs cli        # \u751f\u6210 CLI.md\uff08\u547d\u4ee4\u884c\u4f7f\u7528\u6587\u6863\uff09\naury docs env        # \u751f\u6210 .env.example\uff08\u73af\u5883\u53d8\u91cf\u793a\u4f8b\uff09</code></pre> <p>\u751f\u6210\u7684\u6587\u6863\u7ed3\u6784\uff1a</p> <pre><code>your-project/\n\u251c\u2500\u2500 AGENTS.md           # AI \u7f16\u7a0b\u52a9\u624b\u5165\u53e3\uff08\u6307\u5bfc AI \u9605\u8bfb\u54ea\u4e9b\u6587\u6863\uff09\n\u251c\u2500\u2500 aury_docs/          # \u5f00\u53d1\u6587\u6863\u5305\n\u2502   \u251c\u2500\u2500 00-overview.md    # \u9879\u76ee\u6982\u89c8\u4e0e\u6700\u4f73\u5b9e\u8df5\n\u2502   \u251c\u2500\u2500 01-model.md       # Model \u5f00\u53d1\u6307\u5357\n\u2502   \u251c\u2500\u2500 02-repository.md  # Repository \u5f00\u53d1\u6307\u5357\n\u2502   \u251c\u2500\u2500 03-service.md     # Service \u5f00\u53d1\u6307\u5357\uff08\u542b\u4e8b\u52a1\uff09\n\u2502   \u251c\u2500\u2500 04-schema.md      # Schema \u5f00\u53d1\u6307\u5357\n\u2502   \u251c\u2500\u2500 05-api.md         # API \u5f00\u53d1\u6307\u5357\n\u2502   \u251c\u2500\u2500 06-exception.md   # \u5f02\u5e38\u5904\u7406\u6307\u5357\n\u2502   \u251c\u2500\u2500 07-cache.md       # \u7f13\u5b58\u6307\u5357\n\u2502   \u251c\u2500\u2500 08-scheduler.md   # \u5b9a\u65f6\u4efb\u52a1\u6307\u5357\n\u2502   \u251c\u2500\u2500 09-tasks.md       # \u5f02\u6b65\u4efb\u52a1\u6307\u5357\n\u2502   \u251c\u2500\u2500 10-storage.md     # \u5bf9\u8c61\u5b58\u50a8\u6307\u5357\n\u2502   \u251c\u2500\u2500 11-logging.md     # \u65e5\u5fd7\u6307\u5357\n\u2502   \u251c\u2500\u2500 12-admin.md       # \u7ba1\u7406\u540e\u53f0\u6307\u5357\n\u2502   \u251c\u2500\u2500 13-channel.md     # \u6d41\u5f0f\u901a\u9053\u6307\u5357\uff08Pub/Sub\u3001SSE\u3001\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff09\n\u2502   \u251c\u2500\u2500 14-mq.md          # \u6d88\u606f\u961f\u5217\u6307\u5357\n\u2502   \u2514\u2500\u2500 15-events.md      # \u4e8b\u4ef6\u603b\u7ebf\u6307\u5357\n\u251c\u2500\u2500 CLI.md              # CLI \u547d\u4ee4\u53c2\u8003\n\u2514\u2500\u2500 .env.example        # \u73af\u5883\u53d8\u91cf\u793a\u4f8b\n</code></pre>"},{"location":"00-quick-start/#ai-agentsmd","title":"\u7b2c\u4e8c\u6b65\uff1a\u8ba9 AI \u9605\u8bfb AGENTS.md","text":"<p><code>AGENTS.md</code> \u662f AI \u7f16\u7a0b\u52a9\u624b\u7684\u5165\u53e3\u6587\u6863\uff0c\u5b83\u4f1a\u6307\u5bfc AI \u6839\u636e\u4f60\u8981\u5f00\u53d1\u7684\u529f\u80fd\u7c7b\u578b\u9605\u8bfb\u5bf9\u5e94\u7684 <code>aury_docs/</code> \u6587\u6863\u3002</p> <p>\u4f8b\u5982\uff0c\u5f00\u53d1 CRUD \u529f\u80fd\u65f6\uff0cAI \u4f1a\u6309\u987a\u5e8f\u9605\u8bfb\uff1a - <code>aury_docs/01-model.md</code> \u2192 <code>aury_docs/02-repository.md</code> \u2192 <code>aury_docs/03-service.md</code> \u2192 ...</p>"},{"location":"00-quick-start/#_2","title":"\u7b2c\u4e09\u6b65\uff1a\u63cf\u8ff0\u4e1a\u52a1\u9700\u6c42","text":"<p>\u5728 AI \u4e2d\u63cf\u8ff0\u4f60\u8981\u505a\u7684\u4e1a\u52a1\u9700\u6c42\uff0c\u8ba9\u5b83\u5728\u7406\u89e3\u6587\u6863\u7684\u57fa\u7840\u4e0a\u5e2e\u4f60\uff1a - \u8bbe\u8ba1\u9879\u76ee\u7ed3\u6784\u4e0e\u6a21\u5757\u5212\u5206 - \u7f16\u5199/\u4fee\u6539\u4e1a\u52a1\u4ee3\u7801\u3001\u914d\u7f6e\u548c\u6570\u636e\u5e93\u8fc1\u79fb - \u751f\u6210\u6d4b\u8bd5\u7528\u4f8b\u548c\u8fd0\u7ef4\u811a\u672c</p> <p>\u540e\u9762\u7684\u7ae0\u8282\u5219\u662f\u7ed9\u4eba\u7c7b\u5f00\u53d1\u8005\u9605\u8bfb\u7684\u8be6\u7ec6\u8bf4\u660e\uff0cAI \u4e5f\u53ef\u4ee5\u4e00\u8d77\u9605\u8bfb\uff0c\u7528\u4e8e\u66f4\u6df1\u5c42\u6b21\u7684\u81ea\u52a8\u5316\u6539\u9020\u3002</p>"},{"location":"00-quick-start/#_3","title":"\u76ee\u5f55\uff08\u5feb\u901f\u5f00\u59cb\uff09","text":"<p>\ud83d\udcd6 \u8be6\u7ec6\u6587\u6863\uff1a\u672c\u76ee\u5f55\u4e0b\u8fd8\u6709\u66f4\u8be6\u7ec6\u7684\u6280\u672f\u6307\u5357</p> <ol> <li>\u7b80\u4ecb - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a01-intro-detailed.md</li> <li>\u5feb\u901f\u4e0a\u624b\uff08\u811a\u624b\u67b6\uff09 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a25-scaffold-guide.md</li> <li>\u5feb\u901f\u4e0a\u624b\uff08\u624b\u52a8\uff09 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a02-installation-guide.md</li> <li>\u670d\u52a1\u5668\u8fd0\u884c - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a03-server-deployment.md</li> <li>\u9879\u76ee\u7ed3\u6784 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a04-project-structure.md</li> <li>\u914d\u7f6e - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a05-configuration-advanced.md</li> <li>\u4f9d\u8d56\u6ce8\u5165 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a06-di-container-complete.md</li> <li>\u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a07-middleware-guide.md / 08-components-detailed.md</li> <li>HTTP \u63a5\u53e3 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a09-http-advanced.md \uff08Ingress/Egress \u8be6\u89e3\uff09</li> <li>\u9519\u8bef\u5904\u7406 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a10-error-handling-guide.md</li> <li>\u4e8b\u52a1\u7ba1\u7406 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a11-transaction-management.md</li> <li>\u6570\u636e\u5e93 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a12-database-complete.md</li> <li>\u7f13\u5b58 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a13-caching-advanced.md</li> <li>\u5f02\u6b65\u4efb\u52a1 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a14-async-tasks-guide.md</li> <li>\u4e8b\u4ef6\u9a71\u52a8 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a15-events-driven.md</li> <li>\u5b9a\u65f6\u8c03\u5ea6 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a16-scheduler-guide.md</li> <li>RPC \u4e0e\u670d\u52a1\u53d1\u73b0 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a17-rpc-microservices.md</li> <li>WebSocket - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a18-websocket-guide.md</li> <li>\u5bf9\u8c61\u5b58\u50a8 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a19-storage-guide.md</li> <li>\u56fd\u9645\u5316 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a20-i18n-guide.md</li> <li>\u6570\u636e\u5e93\u8fc1\u79fb - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a21-migration-guide.md</li> <li>\u65e5\u5fd7\u7cfb\u7edf - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a22-logging-complete.md</li> <li>CLI \u547d\u4ee4 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a24-cli-commands.md</li> <li>\u6700\u4f73\u5b9e\u8df5 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a23-best-practices.md</li> <li>\u57fa\u7840\u8bbe\u65bd\u9ad8\u7ea7 - \u67e5\u770b\u8be6\u7ec6\u7248\uff1a26-infrastructure-advanced.md\uff08Channel\u3001MQ\u3001\u591a\u5b9e\u4f8b\u914d\u7f6e\uff09</li> </ol>"},{"location":"00-quick-start/#1","title":"1. \u7b80\u4ecb","text":"<p>Aury Boot \u662f FastAPI \u7684\u589e\u5f3a\u5c42\uff0c\u63d0\u4f9b\u5fae\u670d\u52a1\u5f00\u53d1\u6240\u9700\u7684\"\u7535\u6c60\"\uff1a</p> <ul> <li>\u7edf\u4e00\u7684\u7ec4\u4ef6\u7ba1\u7406\uff1a\u751f\u547d\u5468\u671f\u81ea\u52a8\u7ba1\u7406\uff08\u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001\u4efb\u52a1\u7b49\uff09</li> <li>\u6807\u51c6\u5316\u67b6\u6784\uff1aDomain/Infrastructure \u5206\u79bb\uff0cRepository \u6a21\u5f0f</li> <li>\u5fae\u670d\u52a1\u80fd\u529b\uff1a\u670d\u52a1\u53d1\u73b0\u3001RPC\u3001\u5206\u5e03\u5f0f\u4e8b\u4ef6\u603b\u7ebf\u5f00\u7bb1\u5373\u7528</li> </ul>"},{"location":"00-quick-start/#2","title":"2. \u5feb\u901f\u4e0a\u624b\uff08\u811a\u624b\u67b6\uff09","text":"<p>\ud83d\udcd6 \u63a8\u8350\u65b9\u5f0f\uff1a\u4f7f\u7528\u811a\u624b\u67b6\u5feb\u901f\u521b\u5efa\u9879\u76ee\uff0c\u8be6\u89c1 25-scaffold-guide.md</p> <pre><code># 1. \u521b\u5efa\u9879\u76ee\u76ee\u5f55\u5e76\u521d\u59cb\u5316\nmkdir my-service &amp;&amp; cd my-service\nuv init . --name my_service --no-package --python 3.13\n\n# 2. \uff08\u53ef\u9009\uff09\u914d\u7f6e\u6e05\u534e\u6e90\u4ee5\u52a0\u901f\u5b89\u88c5\n# \u5728 pyproject.toml \u4e2d\u6dfb\u52a0\u4ee5\u4e0b\u914d\u7f6e\ncat &gt;&gt; pyproject.toml &lt;&lt; EOF\n\n[tool.uv]\nindex-url = \"https://pypi.tuna.tsinghua.edu.cn/simple\"\nEOF\n\n# 3. \u5b89\u88c5\u6846\u67b6\nuv add \"aury-boot[recommended,admin]\"  # admin \u53ef\u9009\uff0c\u63d0\u4f9b SQLAdmin \u7ba1\u7406\u540e\u53f0\n\n# 4. \u521d\u59cb\u5316\u811a\u624b\u67b6\naury init                 # \u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09\uff0c\u4f1a\u8be2\u95ee\u914d\u7f6e\u9009\u9879\naury init -y              # \u8df3\u8fc7\u4ea4\u4e92\uff0c\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\naury init my_package      # \u4f7f\u7528\u9876\u5c42\u5305\u7ed3\u6784\naury init --docker        # \u540c\u65f6\u751f\u6210 Docker \u914d\u7f6e\n\n# 5. \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncp .env.example .env\n# \u7f16\u8f91 .env \u914d\u7f6e\u6570\u636e\u5e93\u8fde\u63a5\n\n# 6. \u751f\u6210 CRUD \u4ee3\u7801\naury generate crud user email:str:unique age:int? status:str=active\n\n# 7. \u751f\u6210\u5e76\u6267\u884c\u6570\u636e\u5e93\u8fc1\u79fb\naury migrate make -m \"initial\"\naury migrate up\n\n# 8. \u542f\u52a8\u5f00\u53d1\u670d\u52a1\u5668\naury server dev</code></pre> <p>\u6ce8\u610f\uff1a<code>init</code> \u4f1a\u8986\u76d6 <code>uv init</code> \u521b\u5efa\u7684\u9ed8\u8ba4 <code>main.py</code>\uff0c\u8fd9\u662f\u6b63\u5e38\u884c\u4e3a\u3002</p> <p>\u8bbf\u95ee http://localhost:8000/docs \u67e5\u770b API \u6587\u6863\u3002</p>"},{"location":"00-quick-start/#admin-console","title":"\uff08\u53ef\u9009\uff09\u542f\u7528\u7ba1\u7406\u540e\u53f0 Admin Console","text":"<p>\u6846\u67b6\u63d0\u4f9b\u53ef\u9009\u7684 SQLAdmin \u7ba1\u7406\u540e\u53f0\u6269\u5c55\uff0c\u9ed8\u8ba4\u8def\u5f84\uff1a<code>/api/admin-console</code>\uff0c\u9002\u5408\u751f\u4ea7\u5feb\u901f\u642d\u5efa\u540e\u53f0\u7ba1\u7406\u80fd\u529b\u3002</p> <pre><code># \u5728 .env \u4e2d\u542f\u7528\u5e76\u8bbe\u7f6e basic \u8ba4\u8bc1\nADMIN_ENABLED=true\nADMIN_PATH=/api/admin-console\nADMIN_AUTH_MODE=basic\nADMIN_AUTH_SECRET_KEY=CHANGE_ME_TO_A_RANDOM_SECRET\nADMIN_AUTH_BASIC_USERNAME=admin\nADMIN_AUTH_BASIC_PASSWORD=change_me</code></pre> <p>\u542f\u52a8\u670d\u52a1\u540e\u8bbf\u95ee\uff1a<code>http://localhost:8000/api/admin-console</code></p>"},{"location":"00-quick-start/#_4","title":"\u5b57\u6bb5\u8bed\u6cd5\u8bf4\u660e","text":"<pre><code># \u683c\u5f0f: name:type:modifiers\n# \u7c7b\u578b: str, text, int, bigint, float, decimal, bool, datetime, date, time, json\n# \u4fee\u9970\u7b26: ? (\u53ef\u7a7a), unique, index, =\u9ed8\u8ba4\u503c\n\n# \u793a\u4f8b\naury generate crud article title:str(200) content:text status:str=draft\naury generate crud product name:str:unique price:decimal stock:int=0\n\n# \u4ea4\u4e92\u5f0f\u6a21\u5f0f\naury generate crud user -i</code></pre>"},{"location":"00-quick-start/#3","title":"3. \u5feb\u901f\u4e0a\u624b\uff08\u624b\u52a8\uff09","text":""},{"location":"00-quick-start/#_5","title":"\u5b89\u88c5","text":"<pre><code># \u63a8\u8350\uff1aPostgreSQL + Redis + \u4efb\u52a1\u961f\u5217 + \u8c03\u5ea6\u5668\nuv add \"aury-boot[recommended]\"\n\n# \u6216\u6309\u9700\u7ec4\u5408\nuv add \"aury-boot[postgres,redis]\"</code></pre>"},{"location":"00-quick-start/#hello-world","title":"Hello World","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom aury.boot.application.server import run_app\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nclass AppConfig(BaseConfig):\n    pass\n\napp = FoundationApp(\n    title=\"My Service\",\n    version=\"0.1.0\",\n    config=AppConfig()\n)\n\n@app.get(\"/\")\ndef hello():\n    return BaseResponse(code=200, message=\"Hello\", data={\"message\": \"Hello AUM!\"})\n\nif __name__ == \"__main__\":\n    run_app(app, host=\"0.0.0.0\", port=8000)</code></pre>"},{"location":"00-quick-start/#_6","title":"\u8fd0\u884c","text":"<pre><code># \u5f00\u53d1\u6a21\u5f0f\uff08\u70ed\u91cd\u8f7d\uff09\naury server dev\n\n# \u751f\u4ea7\u6a21\u5f0f\uff08\u591a\u8fdb\u7a0b\uff09\naury server prod</code></pre>"},{"location":"00-quick-start/#4","title":"4. \u670d\u52a1\u5668\u8fd0\u884c","text":""},{"location":"00-quick-start/#cli","title":"CLI \u547d\u4ee4\uff08\u63a8\u8350\uff09","text":"<pre><code># \u5f00\u53d1\u6a21\u5f0f\uff08\u70ed\u91cd\u8f7d\uff09\naury server dev\n\n# \u751f\u4ea7\u6a21\u5f0f\uff08\u591a\u8fdb\u7a0b\uff09\naury server prod</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u914d\u7f6e\uff1a\u53c2\u8003 03-server-deployment.md</p>"},{"location":"00-quick-start/#5","title":"5. \u9879\u76ee\u7ed3\u6784","text":"<pre><code>my_service/\n\u251c\u2500\u2500 main.py                 # \u5e94\u7528\u5165\u53e3\n\u251c\u2500\u2500 config.py               # \u914d\u7f6e\n\u251c\u2500\u2500 alembic.ini             # Alembic \u914d\u7f6e\n\u251c\u2500\u2500 .env.example            # \u73af\u5883\u53d8\u91cf\u6a21\u677f\n\u251c\u2500\u2500 api/                    # API \u8def\u7531\n\u2502   \u251c\u2500\u2500 users.py\n\u2502   \u2514\u2500\u2500 orders.py\n\u251c\u2500\u2500 services/               # \u4e1a\u52a1\u903b\u8f91\n\u2502   \u251c\u2500\u2500 user_service.py\n\u2502   \u2514\u2500\u2500 order_service.py\n\u251c\u2500\u2500 models/                 # \u6570\u636e\u6a21\u578b\n\u2502   \u251c\u2500\u2500 user.py\n\u2502   \u2514\u2500\u2500 order.py\n\u251c\u2500\u2500 repositories/           # \u6570\u636e\u8bbf\u95ee\n\u2502   \u251c\u2500\u2500 user_repository.py\n\u2502   \u2514\u2500\u2500 order_repository.py\n\u251c\u2500\u2500 schemas/                # Pydantic \u6a21\u578b\n\u2502   \u251c\u2500\u2500 user.py\n\u2502   \u2514\u2500\u2500 order.py\n\u251c\u2500\u2500 migrations/             # \u6570\u636e\u5e93\u8fc1\u79fb\n\u2502   \u251c\u2500\u2500 env.py\n\u2502   \u251c\u2500\u2500 script.py.mako\n\u2502   \u2514\u2500\u2500 versions/\n\u251c\u2500\u2500 tests/                  # \u6d4b\u8bd5\n\u2502   \u2514\u2500\u2500 conftest.py\n\u251c\u2500\u2500 pyproject.toml\n\u2514\u2500\u2500 README.md\n</code></pre> <p>\u5206\u5c42\u8bf4\u660e\uff1a - <code>api/</code>\uff1aHTTP \u8bf7\u6c42\u5904\u7406 - <code>services/</code>\uff1a\u4e1a\u52a1\u903b\u8f91 - <code>models/</code>\uff1aSQLAlchemy \u6a21\u578b - <code>repositories/</code>\uff1a\u6570\u636e\u8bbf\u95ee - <code>schemas/</code>\uff1a\u8bf7\u6c42/\u54cd\u5e94\u5e8f\u5217\u5316</p>"},{"location":"00-quick-start/#6","title":"6. \u914d\u7f6e","text":""},{"location":"00-quick-start/#env","title":"\u73af\u5883\u53d8\u91cf\uff08.env\uff09","text":"<pre><code># \u670d\u52a1\u5668\nSERVER_HOST=0.0.0.0\nSERVER_PORT=8000\n\n# \u6570\u636e\u5e93\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\nDATABASE_POOL_SIZE=10\n\n# \u7f13\u5b58\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\n\n# \u4efb\u52a1\u961f\u5217\nTASK_BROKER_URL=redis://localhost:6379/0\n\n# \u65e5\u5fd7\nLOG_LEVEL=INFO\nLOG_DIR=log</code></pre>"},{"location":"00-quick-start/#_7","title":"\u81ea\u5b9a\u4e49\u914d\u7f6e","text":"<pre><code>from aury.boot.application.config import BaseConfig\nfrom pydantic import Field\n\nclass MyConfig(BaseConfig):\n    my_feature: bool = Field(default=True)</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u914d\u7f6e\uff1a\u53c2\u8003 05-configuration-advanced.md</p>"},{"location":"00-quick-start/#7","title":"7. \u4f9d\u8d56\u6ce8\u5165","text":"<p>Aury Boot \u63d0\u4f9b\u4f01\u4e1a\u7ea7 DI \u5bb9\u5668</p> \u751f\u547d\u5468\u671f \u8bf4\u660e \u573a\u666f SINGLETON \u5e94\u7528\u751f\u547d\u5468\u671f\u552f\u4e00 \u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001\u914d\u7f6e SCOPED \u8bf7\u6c42\u8303\u56f4\u5185\u552f\u4e00 \u6570\u636e\u5e93\u4f1a\u8bdd TRANSIENT \u6bcf\u6b21\u521b\u5efa\u65b0\u5b9e\u4f8b \u670d\u52a1\u3001\u5de5\u5177\u7c7b"},{"location":"00-quick-start/#_8","title":"\u5feb\u901f\u5f00\u59cb","text":"<pre><code>from aury.boot.infrastructure.di import Container\n\ncontainer = Container.get_instance()\n\n# \u6ce8\u518c\ncontainer.register_singleton(DatabaseManager)\ncontainer.register_transient(UserService)\n\n# \u89e3\u6790\nservice = container.resolve(UserService)</code></pre> <p>\ud83d\udcd6 \u6df1\u5165\u5b66\u4e60\uff1a\u53c2\u8003 06-di-container-complete.md</p>"},{"location":"00-quick-start/#8","title":"8. \u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6","text":"<p>Aury Boot \u5c06\u529f\u80fd\u5355\u5143\u5206\u4e3a\u4e24\u7c7b\uff1a - \u4e2d\u95f4\u4ef6\uff08Middleware\uff09\uff1a\u5904\u7406 HTTP \u8bf7\u6c42\u62e6\u622a - \u7ec4\u4ef6\uff08Component\uff09\uff1a\u7ba1\u7406\u57fa\u7840\u8bbe\u65bd\u751f\u547d\u5468\u671f</p>"},{"location":"00-quick-start/#_9","title":"\u5185\u7f6e\u4e2d\u95f4\u4ef6","text":"<pre><code>from aury.boot.application.app.middlewares import (\n    RequestLoggingMiddleware,  # HTTP \u8bf7\u6c42\u65e5\u5fd7\n    CORSMiddleware,            # CORS \u8de8\u57df\n)</code></pre>"},{"location":"00-quick-start/#_10","title":"\u5185\u7f6e\u7ec4\u4ef6","text":"<pre><code>from aury.boot.application.app.components import (\n    DatabaseComponent,        # \u6570\u636e\u5e93\n    CacheComponent,           # \u7f13\u5b58\n    TaskComponent,            # \u5f02\u6b65\u4efb\u52a1\n    SchedulerComponent,       # \u5b9a\u65f6\u8c03\u5ea6\n    MigrationComponent,       # \u6570\u636e\u5e93\u8fc1\u79fb\n)</code></pre>"},{"location":"00-quick-start/#_11","title":"\u81ea\u5b9a\u4e49\u7ec4\u4ef6","text":"<pre><code>from aury.boot.application.app.base import Component, FoundationApp\n\nclass MyComponent(Component):\n    name = \"my_component\"\n    enabled = True\n    depends_on = [\"cache\"]\n\n    async def setup(self, app: FoundationApp, config):\n        print(\"\u521d\u59cb\u5316...\")\n\n    async def teardown(self, app: FoundationApp):\n        print(\"\u6e05\u7406...\")</code></pre>"},{"location":"00-quick-start/#_12","title":"\u6ce8\u518c\u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6","text":"<pre><code>class MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,\n        CORSMiddleware,\n    ]\n    components = [\n        DatabaseComponent,\n        CacheComponent,\n        MyComponent,\n    ]\n\napp = MyApp(config=config)</code></pre> <p>\ud83d\udcd6 \u6df1\u5165\u5b66\u4e60\uff1a\u53c2\u8003 07-middleware-guide.md \u548c 08-components-detailed.md</p>"},{"location":"00-quick-start/#9-http","title":"9. HTTP \u63a5\u53e3","text":""},{"location":"00-quick-start/#ingress","title":"\u8bf7\u6c42\u6a21\u578b\uff08Ingress\uff09","text":"<pre><code>from aury.boot.application.interfaces.ingress import (\n    BaseRequest,\n    PaginationRequest\n)\nfrom pydantic import EmailStr, Field\n\nclass UserCreateRequest(BaseRequest):\n    username: str = Field(..., min_length=3, max_length=50)\n    email: EmailStr\n    password: str = Field(..., min_length=8)</code></pre>"},{"location":"00-quick-start/#egress","title":"\u7edf\u4e00\u54cd\u5e94\u683c\u5f0f\uff08Egress\uff09","text":"<pre><code>from aury.boot.application.interfaces.egress import (\n    BaseResponse,\n    PaginationResponse,\n    Pagination,\n)\n\n# \u5355\u4e2a\u8d44\u6e90\nreturn BaseResponse(code=200, message=\"\u6210\u529f\", data=user)\n\n# \u5217\u8868\u54cd\u5e94\npagination = Pagination(total=100, items=users, page=1, size=20)\nreturn PaginationResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=pagination)</code></pre>"},{"location":"00-quick-start/#_13","title":"\u8def\u7531\u793a\u4f8b","text":"<pre><code>from fastapi import APIRouter, Depends\nfrom aury.boot.infrastructure.di import Container\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nrouter = APIRouter()\ncontainer = Container.get_instance()\n\ndef get_user_service():\n    return container.resolve(UserService)\n\n@router.post(\"/users\")\nasync def create_user(\n    request: UserCreateRequest,\n    service: UserService = Depends(get_user_service)\n):\n    user = await service.create(request)\n    return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=user)</code></pre> <p>\ud83d\udcd6 \u6df1\u5165\u5b66\u4e60\uff1a\u53c2\u8003 09-http-advanced.md</p>"},{"location":"00-quick-start/#10","title":"10. \u9519\u8bef\u5904\u7406","text":""},{"location":"00-quick-start/#_14","title":"\u5f02\u5e38\u4f53\u7cfb\u4e0e\u7ee7\u627f\u89c4\u5219","text":"<pre><code>from aury.boot.application.errors import (\n    BaseError,\n    NotFoundError,\n    AlreadyExistsError,\n    UnauthorizedError,\n    ForbiddenError,\n)\n\n# \u2705 \u5f00\u53d1\u89c4\u8303\uff1a\u6240\u6709\u670d\u52a1\u7279\u5b9a\u5f02\u5e38\u90fd\u8981\u7ee7\u627f Aury Boot \u6846\u67b6\u63d0\u4f9b\u7684\u5f02\u5e38\nclass MyServiceError(UnauthorizedError):\n    \"\"\"\u670d\u52a1\u7279\u5b9a\u5f02\u5e38\u5fc5\u987b\u7ee7\u627f Aury Boot \u6846\u67b6\u5185\u7f6e\u7684\u5f02\u5e38\u7c7b\u3002\"\"\"\n\n    def __init__(self, message: str, **kwargs):\n        super().__init__(message=message, **kwargs)\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str):\n    user = await repo.get(user_id)\n    if not user:\n        # Aury Boot \u7684\u5168\u5c40\u5f02\u5e38\u5904\u7406\u5668\u4f1a\u81ea\u52a8\u8f6c\u6362\u4e3a HTTP 404\n        raise NotFoundError(f\"\u7528\u6237 {user_id} \u4e0d\u5b58\u5728\")\n    return user</code></pre>"},{"location":"00-quick-start/#_15","title":"\u5f02\u5e38\u7ee7\u627f\u89c4\u5219\u548c\u9519\u8bef\u4ee3\u7801","text":"<p>\u539f\u5219\uff1a 1. \u6240\u6709\u5f02\u5e38\u5fc5\u987b\u7ee7\u627f Aury Boot \u63d0\u4f9b\u7684\u5f02\u5e38\u57fa\u7c7b\uff08UnauthorizedError\u3001NotFoundError \u7b49\uff09 2. \u6240\u6709\u9519\u8bef\u4ee3\u7801\u5fc5\u987b\u7ee7\u627f Aury Boot \u7684 <code>ErrorCode</code>\uff0c\u5728\u670d\u52a1\u8303\u56f4\u5185\u5b9a\u4e49 3. \u4e0d\u8986\u76d6 Aury Boot \u7684\u5185\u7f6e\u9519\u8bef\u4ee3\u7801\uff081xxx-4xxx\uff09\uff0c\u670d\u52a1\u4f7f\u7528 5xxx+ \u8303\u56f4</p> <pre><code># \u2705 \u6b63\u786e\uff1a\u5b9a\u4e49\u9519\u8bef\u4ee3\u7801\u679a\u4e3e\uff0c\u7ee7\u627f ErrorCode\nfrom aury.boot.application.errors.codes import ErrorCode\n\nclass IdentityErrorCode(ErrorCode):\n    INVALID_CREDENTIALS = \"5001\"\n    USER_NOT_FOUND = \"5101\"\n    DUPLICATE_USER = \"5104\"\n\n# \u2705 \u6b63\u786e\uff1a\u5f02\u5e38\u7ee7\u627f Aury Boot \u7684\u5f02\u5e38\nclass InvalidCredentialsError(UnauthorizedError):\n    def __init__(self, **kwargs):\n        metadata = kwargs.pop(\"metadata\", {})\n        metadata[\"error_code\"] = IdentityErrorCode.INVALID_CREDENTIALS.value\n        super().__init__(message=\"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\", metadata=metadata, **kwargs)\n\n# \u274c \u9519\u8bef\uff1a\u4e0d\u7ee7\u627f Aury Boot \u7684\u5f02\u5e38\u4f53\u7cfb\nclass MyCustomError(Exception):\n    pass\n\n# \u274c \u9519\u8bef\uff1a\u6ca1\u6709\u8c03\u7528 super().__init__()\nclass BadError(NotFoundError):\n    self.message = message  # \u9519\uff01</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u89c4\u8303\uff1a\u53c2\u8003 10-error-handling-guide.md</p> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 10-error-handling-guide.md</p>"},{"location":"00-quick-start/#11","title":"11. \u4e8b\u52a1\u7ba1\u7406","text":""},{"location":"00-quick-start/#_16","title":"\u63a8\u8350\u65b9\u5f0f\uff1a\u88c5\u9970\u5668","text":"<pre><code>from aury.boot.domain.transaction import transactional\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\n@transactional\nasync def create_user_with_profile(session: AsyncSession, name: str):\n    repo = UserRepository(session)\n    user = await repo.create({\"username\": name})\n    # \u81ea\u52a8\u63d0\u4ea4\uff0c\u5f02\u5e38\u65f6\u81ea\u52a8\u56de\u6eda\n    return user</code></pre> <p>\ud83d\udcd6 \u5176\u4ed6\u65b9\u5f0f\uff1a\u53c2\u8003 11-transaction-management.md</p>"},{"location":"00-quick-start/#12","title":"12. \u6570\u636e\u5e93","text":""},{"location":"00-quick-start/#_17","title":"\u5b9a\u4e49\u6a21\u578b","text":"<pre><code>from sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy import String\nfrom aury.boot.domain.models import UUIDAuditableStateModel\n\nclass User(UUIDAuditableStateModel):\n    \"\"\"\u7528\u6237\u6a21\u578b - \u81ea\u52a8\u83b7\u5f97 UUID \u4e3b\u952e\u3001\u65f6\u95f4\u6233\u548c\u8f6f\u5220\u9664\u529f\u80fd\"\"\"\n    __tablename__ = \"users\"\n\n    # UUIDAuditableStateModel \u81ea\u52a8\u63d0\u4f9b\uff1a\n    # - id: UUID \u4e3b\u952e\n    # - created_at: \u521b\u5efa\u65f6\u95f4\n    # - updated_at: \u66f4\u65b0\u65f6\u95f4\n    # - deleted_at: \u8f6f\u5220\u9664\u65f6\u95f4\n\n    username: Mapped[str] = mapped_column(String(50), unique=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True)</code></pre>"},{"location":"00-quick-start/#_18","title":"\u521b\u5efa\u4ed3\u50a8","text":"<pre><code>from aury.boot.domain.repository.impl import BaseRepository\n\nclass UserRepository(BaseRepository[User]):\n    async def get_by_email(self, email: str):\n        return await self.get_by(email=email)</code></pre>"},{"location":"00-quick-start/#api","title":"\u5728 API \u4e2d\u4f7f\u7528","text":"<pre><code>from aury.boot.infrastructure.database import DatabaseManager\n\ndb_manager = DatabaseManager.get_instance()\n\nasync def get_user_repo(session=Depends(db_manager.get_session)):\n    return UserRepository(session)\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, repo=Depends(get_user_repo)):\n    user = await repo.get(user_id)\n    if not user:\n        raise NotFoundError(\"\u7528\u6237\u4e0d\u5b58\u5728\")\n    return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)</code></pre> <p>\ud83d\udcd6 \u6df1\u5165\u5b66\u4e60\uff1a\u53c2\u8003 12-database-complete.md</p>"},{"location":"00-quick-start/#13","title":"13. \u7f13\u5b58","text":""},{"location":"00-quick-start/#_19","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>from aury.boot.infrastructure.cache import CacheManager\n\ncache = CacheManager.get_instance()\n\n# \u8bbe\u7f6e\nawait cache.set(\"user:1\", {\"name\": \"test\"}, expire=300)\n\n# \u83b7\u53d6\nuser = await cache.get(\"user:1\")\n\n# \u5220\u9664\nawait cache.delete(\"user:1\")</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 13-caching-advanced.md</p>"},{"location":"00-quick-start/#14","title":"14. \u5f02\u6b65\u4efb\u52a1","text":""},{"location":"00-quick-start/#_20","title":"\u5b9a\u4e49\u4efb\u52a1","text":"<pre><code>from aury.boot.infrastructure.tasks.manager import TaskManager\n\ntm = TaskManager.get_instance()\n\n@tm.conditional_task(queue_name=\"default\", max_retries=3)\nasync def send_email_task(email: str, content: str):\n    pass</code></pre>"},{"location":"00-quick-start/#_21","title":"\u8c03\u7528\u4efb\u52a1","text":"<pre><code># \u53d1\u9001\nsend_email_task.send(\"test@example.com\", \"Hello!\")</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 14-async-tasks-guide.md</p>"},{"location":"00-quick-start/#15","title":"15. \u4e8b\u4ef6\u9a71\u52a8","text":""},{"location":"00-quick-start/#_22","title":"\u5b9a\u4e49\u548c\u8ba2\u9605","text":"<pre><code>from aury.boot.infrastructure.events.bus import EventBus\nfrom aury.boot.infrastructure.events import Event\n\nclass OrderCreatedEvent(Event):\n    order_id: str\n    amount: float\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"order.created\"\n\nbus = EventBus.get_instance()\n\n@bus.subscribe(OrderCreatedEvent)\nasync def on_order_created(event: OrderCreatedEvent):\n    print(f\"\u8ba2\u5355\u521b\u5efa: {event.order_id}\")</code></pre>"},{"location":"00-quick-start/#_23","title":"\u53d1\u5e03\u4e8b\u4ef6","text":"<pre><code>await bus.publish(OrderCreatedEvent(order_id=\"1001\", amount=99.9))</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 15-events-driven.md</p>"},{"location":"00-quick-start/#16","title":"16. \u5b9a\u65f6\u8c03\u5ea6","text":"<pre><code>from aury.boot.infrastructure.scheduler.manager import SchedulerManager\nfrom datetime import datetime\n\nscheduler = SchedulerManager.get_instance()\n\n# Cron \u4efb\u52a1\nscheduler.add_job(\n    func=daily_report,\n    trigger=\"cron\",\n    hour=2, minute=30,\n    id=\"daily_report\"\n)\n\n# \u95f4\u9694\u4efb\u52a1\nscheduler.add_job(\n    func=heartbeat,\n    trigger=\"interval\",\n    seconds=30\n)</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 16-scheduler-guide.md</p>"},{"location":"00-quick-start/#17-rpc","title":"17. RPC \u4e0e\u670d\u52a1\u53d1\u73b0","text":""},{"location":"00-quick-start/#_24","title":"\u914d\u7f6e","text":"<pre><code># \u73af\u5883\u53d8\u91cf\nRPC_CLIENT_SERVICES={\"order-service\": \"http://order-service:8000\"}</code></pre>"},{"location":"00-quick-start/#_25","title":"\u53d1\u8d77\u8c03\u7528","text":"<pre><code>from aury.boot.application.rpc.client import create_rpc_client\n\nclient = create_rpc_client(service_name=\"order-service\")\nresponse = await client.get(\"/api/orders/123\")</code></pre>"},{"location":"00-quick-start/#_26","title":"\u81ea\u52a8\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a","text":"<pre><code>from aury.boot.common.logging import get_trace_id, logger\n\ntrace_id = get_trace_id()\nlogger.info(f\"\u5904\u7406\u8bf7\u6c42 | Trace-ID: {trace_id}\")\n# RPC \u8c03\u7528\u4f1a\u81ea\u52a8\u6dfb\u52a0 X-Trace-ID \u8bf7\u6c42\u5934</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 17-rpc-microservices.md</p>"},{"location":"00-quick-start/#18-websocket","title":"18. WebSocket","text":""},{"location":"00-quick-start/#_27","title":"\u57fa\u672c\u8fde\u63a5","text":"<pre><code>from fastapi import APIRouter, WebSocket\nfrom aury.boot.infrastructure.database import DatabaseManager\n\nrouter = APIRouter()\ndb_manager = DatabaseManager.get_instance()\n\n@router.websocket(\"/ws/chat/{room_id}\")\nasync def websocket_chat(websocket: WebSocket, room_id: str):\n    await websocket.accept()\n\n    try:\n        while True:\n            data = await websocket.receive_text()\n\n            async with db_manager.session() as session:\n                repo = MessageRepository(session)\n                await repo.create({\"room_id\": room_id, \"content\": data})\n\n            await websocket.send_json({\"status\": \"ok\"})\n    except Exception as e:\n        await websocket.close(code=1011, reason=str(e))</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 18-websocket-guide.md</p>"},{"location":"00-quick-start/#19","title":"19. \u5bf9\u8c61\u5b58\u50a8","text":"<p>\u57fa\u4e8e aury-sdk-storage\uff0c\u652f\u6301 S3 \u517c\u5bb9\u5b58\u50a8\u548c STS \u4e34\u65f6\u51ed\u8bc1\u3002</p> <pre><code># \u5b89\u88c5\nuv add \"aury-sdk-storage[aws]\"</code></pre> <pre><code>from io import BytesIO\nfrom aury.boot.infrastructure.storage import (\n    StorageManager, StorageConfig, StorageBackend, StorageFile,\n)\n\n# \u83b7\u53d6\u5b58\u50a8\u7ba1\u7406\u5668\uff08\u652f\u6301\u547d\u540d\u591a\u5b9e\u4f8b\uff09\nstorage = StorageManager.get_instance()\n\n# \u521d\u59cb\u5316\uff08\u4e00\u822c\u7531 StorageComponent \u81ea\u52a8\u5b8c\u6210\uff09\nawait storage.init(StorageConfig(\n    backend=StorageBackend.COS,\n    bucket_name=\"my-bucket-1250000000\",\n    region=\"ap-guangzhou\",\n    endpoint=\"https://cos.ap-guangzhou.myqcloud.com\",\n    access_key_id=\"AKIDxxxxx\",\n    access_key_secret=\"xxxxx\",\n))\n\n# \u4e0a\u4f20\nurl = await storage.upload_file(\n    StorageFile(\n        object_name=\"avatars/user_1.png\",\n        data=BytesIO(image_bytes),\n        content_type=\"image/png\",\n    )\n)</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 19-storage-guide.md</p>"},{"location":"00-quick-start/#20","title":"20. \u56fd\u9645\u5316","text":"<pre><code>from aury.boot.common.i18n.translator import translate, load_translations\n\n# \u52a0\u8f7d\u7ffb\u8bd1\nload_translations({\n    \"zh_CN\": {\"error.not_found\": \"\u8d44\u6e90 {name} \u672a\u627e\u5230\"},\n    \"en_US\": {\"error.not_found\": \"Resource {name} not found\"}\n})\n\n# \u4f7f\u7528\nmsg = translate(\"error.not_found\", name=\"User\", locale=\"zh_CN\")</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 20-i18n-guide.md</p>"},{"location":"00-quick-start/#21","title":"21. \u6570\u636e\u5e93\u8fc1\u79fb","text":""},{"location":"00-quick-start/#_28","title":"\u81ea\u52a8\u8fc1\u79fb\uff08\u63a8\u8350\uff09","text":"<p>\u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\uff1a</p> <pre><code>from aury.boot.application.app.components import MigrationComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        DatabaseComponent,\n        MigrationComponent,  # \u81ea\u52a8\u6267\u884c\u8fc1\u79fb\n        CacheComponent,\n    ]\n\n# \u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\u5230\u6700\u65b0\u7248\u672c</code></pre>"},{"location":"00-quick-start/#_29","title":"\u624b\u52a8\u8fc1\u79fb","text":"<pre><code># \u521d\u59cb\u5316\nalembic init -t async alembic\n\n# \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Add users table\"\n\n# \u6267\u884c\u8fc1\u79fb\naury migrate up\n\n# \u67e5\u770b\u72b6\u6001\naury migrate status</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 21-migration-guide.md</p>"},{"location":"00-quick-start/#22","title":"22. \u65e5\u5fd7\u7cfb\u7edf","text":""},{"location":"00-quick-start/#_30","title":"\u73af\u5883\u53d8\u91cf","text":"<pre><code>LOG_LEVEL=INFO\nLOG_DIR=log\nLOG_ROTATION_TIME=00:00\nLOG_RETENTION_DAYS=7</code></pre>"},{"location":"00-quick-start/#_31","title":"\u4f7f\u7528\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger, get_trace_id\n\nlogger.info(\"\u4fe1\u606f\")\nlogger.warning(\"\u8b66\u544a\")\nlogger.error(\"\u9519\u8bef\")\n\n# \u81ea\u52a8\u5305\u542b Trace ID\ntrace_id = get_trace_id()\nlogger.info(f\"\u5904\u7406\u8bf7\u6c42 | Trace-ID: {trace_id}\")</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 22-logging-complete.md</p>"},{"location":"00-quick-start/#23-cli","title":"23. CLI \u547d\u4ee4","text":""},{"location":"00-quick-start/#_32","title":"\u7edf\u4e00\u5165\u53e3","text":"<p>\u5b89\u88c5\u540e\u53ef\u4f7f\u7528 <code>aury</code> \u7edf\u4e00\u547d\u4ee4\uff1a</p> <pre><code># \u9879\u76ee\u521d\u59cb\u5316\uff08\u5148\u7528 uv \u521b\u5efa\u9879\u76ee\uff09\nuv init . --name my_service --no-package --python 3.13\nuv add \"aury-boot[recommended]\"\naury init -i              # \u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u63a8\u8350\uff09\naury init                 # \u9ed8\u8ba4\u914d\u7f6e\naury init my_package      # \u9876\u5c42\u5305\u7ed3\u6784\naury init --docker        # \u5305\u542b Docker \u914d\u7f6e\n\n# \u4ee3\u7801\u751f\u6210\naury generate crud user\n\n# \u670d\u52a1\u5668\naury server dev\naury server prod\n\n# \u6570\u636e\u5e93\u8fc1\u79fb\naury migrate make -m \"add user\"\naury migrate up\naury migrate status\n\n# Shell \u8865\u5168\naum --install-completion</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 24-cli-commands.md</p>"},{"location":"00-quick-start/#24","title":"24. \u6700\u4f73\u5b9e\u8df5","text":""},{"location":"00-quick-start/#aury-boot_1","title":"\u4f7f\u7528 Aury Boot \u63d0\u4f9b\u7684\u9884\u5b9a\u4e49\u6a21\u578b","text":"<p>Aury Boot \u63d0\u4f9b\u591a\u4e2a\u9884\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408\uff0c\u63a8\u8350\u76f4\u63a5\u4f7f\u7528\u800c\u4e0d\u662f <code>Base</code>\uff1a</p> <pre><code>from aury.boot.domain.models import (\n    UUIDAuditableStateModel,  # \u3010\u63a8\u8350\u3011UUID\u4e3b\u952e + \u65f6\u95f4\u6233 + \u8f6f\u5220\u9664\n    UUIDModel,                # UUID\u4e3b\u952e + \u65f6\u95f4\u6233\n    Model,                    # \u6574\u6570\u4e3b\u952e + \u65f6\u95f4\u6233\n    FullFeaturedUUIDModel,    # \u5b8c\u6574\u529f\u80fd\uff1aUUID + \u65f6\u95f4\u6233 + \u8f6f\u5220\u9664 + \u4e50\u89c2\u9501\n)\n\n# \u2705 \u63a8\u8350\uff1a\u4f7f\u7528 UUIDAuditableStateModel\nclass Identity(UUIDAuditableStateModel):\n    \"\"\"\u8eab\u4efd\u6a21\u578b - \u81ea\u52a8\u83b7\u5f97\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n    - id: UUID \u4e3b\u952e\n    - created_at: \u521b\u5efa\u65f6\u95f4\n    - updated_at: \u66f4\u65b0\u65f6\u95f4  \n    - deleted_at: \u8f6f\u5220\u9664\u65f6\u95f4\uff080 \u672a\u5220\u9664\uff0c&gt;0 \u5df2\u5220\u9664\u65f6\u95f4\u6233\uff09\n    \"\"\"\n    __tablename__ = \"identity_identities\"\n    username: Mapped[str] = mapped_column(String(100))\n\n# \u274c \u4e0d\u63a8\u8350\uff1a\u76f4\u63a5\u4f7f\u7528 Base\nclass BadModel(Base):\n    __tablename__ = \"bad_model\"\n    # \u9700\u8981\u624b\u52a8\u6dfb\u52a0 id\u3001created_at \u7b49\u5b57\u6bb5</code></pre> <p>\u9884\u5b9a\u4e49\u6a21\u578b\u5bf9\u6bd4\uff1a</p> \u6a21\u578b UUID \u4e3b\u952e \u65f6\u95f4\u6233 \u8f6f\u5220\u9664 \u4e50\u89c2\u9501 \u7528\u9014 UUIDAuditableStateModel \u2705 \u2705 \u2705 \u274c \u3010\u63a8\u8350\u3011\u5927\u591a\u6570\u4e1a\u52a1\u6a21\u578b UUIDModel \u2705 \u2705 \u274c \u274c \u4e0d\u9700\u8981\u8f6f\u5220\u9664\u7684\u6a21\u578b Model \u274c \u2705 \u274c \u274c \u4f7f\u7528\u6574\u6570\u4e3b\u952e FullFeaturedUUIDModel \u2705 \u2705 \u2705 \u2705 \u9700\u8981\u5b8c\u6574\u529f\u80fd\u7684\u5173\u952e\u4e1a\u52a1"},{"location":"00-quick-start/#repository","title":"\u8d2b\u8840\u6a21\u578b + Repository \u6a21\u5f0f","text":"<p>\u63a8\u8350\u4f7f\u7528\"\u8d2b\u8840\u6a21\u578b\"\u8bbe\u8ba1\uff08\u53ea\u5305\u542b\u5b57\u6bb5\uff0c\u65e0\u5173\u7cfb\u5b9a\u4e49\uff09\uff0c\u6240\u6709\u67e5\u8be2\u7531 Repository \u5c42\u8d1f\u8d23\uff1a</p> <pre><code># \u2705 \u6a21\u578b\u5c42\uff08\u7eaf\u6570\u636e\u7ed3\u6784\uff09\nclass Tenant(UUIDAuditableStateModel):\n    __tablename__ = \"tenants\"\n    name: Mapped[str] = mapped_column(String(100))\n    # \u4e0d\u5b9a\u4e49 relationship\uff0c\u4e0d\u5b9a\u4e49 ForeignKey\n\n# \u2705 \u4ed3\u5e93\u5c42\uff08\u8d1f\u8d23\u6240\u6709\u67e5\u8be2\uff09\nclass TenantRepository(BaseRepository[Tenant]):\n    async def get_with_members(self, tenant_id: GUID):\n        # \u663e\u5f0f join\uff0c\u53ef\u63a7\u7684\u67e5\u8be2\n        stmt = select(Tenant).where(Tenant.id == tenant_id)\n        return await self.session.scalar(stmt)\n\n    async def list_members(self, tenant_id: GUID):\n        # \u663e\u5f0f\u67e5\u8be2\u6210\u5458\uff0c\u907f\u514d\u9690\u5f0f N+1\n        stmt = select(TenantMembership).where(TenantMembership.tenant_id == tenant_id)\n        return await self.session.scalars(stmt)</code></pre> <p>\u597d\u5904\uff1a - \u6a21\u578b\u7b80\u6d01\uff0c\u6613\u4e8e\u7ef4\u62a4 - \u907f\u514d\u9690\u5f0f\u67e5\u8be2\u5bfc\u81f4\u7684 N+1 \u95ee\u9898 - \u67e5\u8be2\u903b\u8f91\u96c6\u4e2d\u5728 Repository\uff0c\u4fbf\u4e8e\u4f18\u5316 - \u5b8c\u5168\u638c\u63a7\u6570\u636e\u52a0\u8f7d\u7b56\u7565</p>"},{"location":"00-quick-start/#n1","title":"\u907f\u514d N+1 \u67e5\u8be2","text":"<pre><code>from sqlalchemy.orm import selectinload\n\nclass UserRepository(BaseRepository[User]):\n    async def list_with_orders(self):\n        stmt = select(User).options(selectinload(User.orders))\n        result = await self.session.execute(stmt)\n        return result.scalars().all()</code></pre>"},{"location":"00-quick-start/#event-bus-vs-task-queue","title":"Event Bus vs Task Queue","text":"\u7279\u6027 Event Bus Task Queue \u6d88\u8d39\u8005 \u591a\u4e2a \u5355\u4e2a \u5ef6\u8fdf \u6beb\u79d2\u7ea7 \u79d2\u7ea7 \u91cd\u8bd5 \u65e0 \u6709 \u7528\u9014 \u901a\u77e5\u3001\u5206\u6790 \u6570\u636e\u5904\u7406\u3001\u652f\u4ed8"},{"location":"00-quick-start/#_33","title":"\u4f9d\u8d56\u7ba1\u7406","text":"<pre><code>uv init my-service\nuv add \"aury-boot[recommended]\"\nuv lock</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 23-best-practices.md</p>"},{"location":"00-quick-start/#25","title":"25. \u57fa\u7840\u8bbe\u65bd\u9ad8\u7ea7","text":""},{"location":"00-quick-start/#_34","title":"\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<p>\u6240\u6709 Manager \u652f\u6301\u591a\u5b9e\u4f8b\uff0c\u73af\u5883\u53d8\u91cf\u683c\u5f0f\uff1a<code>{PREFIX}_{INSTANCE}_{FIELD}</code></p> <pre><code># \u6570\u636e\u5e93\u591a\u5b9e\u4f8b\nDATABASE_DEFAULT_URL=postgresql+asyncpg://localhost/mydb\nDATABASE_READONLY_URL=postgresql+asyncpg://replica/mydb\n\n# Redis \u591a\u5b9e\u4f8b\nREDIS_CACHE_URL=redis://localhost:6379/1\nREDIS_SESSION_URL=redis://localhost:6379/2</code></pre>"},{"location":"00-quick-start/#channel","title":"\u6d41\u5f0f\u901a\u9053\uff08Channel\uff09","text":"<p>\u7528\u4e8e Pub/Sub\u3001SSE \u548c\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff1a</p> <pre><code>from aury.boot.infrastructure.channel import ChannelManager\n\nchannel = ChannelManager.get_instance()\nawait channel.configure(backend=\"redis\", redis_url=\"redis://localhost:6379/0\").initialize()\n\n# \u53d1\u5e03\nawait channel.publish(\"user:123\", {\"event\": \"message\"})\n\n# \u8ba2\u9605\nasync for msg in channel.subscribe(\"user:123\"):\n    print(msg)</code></pre>"},{"location":"00-quick-start/#mq","title":"\u6d88\u606f\u961f\u5217\uff08MQ\uff09","text":"<p>\u652f\u6301 Redis \u548c RabbitMQ \u540e\u7aef\uff1a</p> <pre><code>from aury.boot.infrastructure.mq import MQManager\n\nmq = MQManager.get_instance()\nawait mq.configure(backend=\"redis\", url=\"redis://localhost:6379/0\").initialize()\n\n# \u751f\u4ea7\u8005\nawait mq.publish(\"orders\", {\"order_id\": \"123\"})\n\n# \u6d88\u8d39\u8005\nawait mq.consume(\"orders\", handler)</code></pre>"},{"location":"00-quick-start/#_35","title":"\u4e8b\u4ef6\u603b\u7ebf\u540e\u7aef","text":"<p>\u652f\u6301 memory\u3001redis\u3001rabbitmq \u540e\u7aef\uff1a</p> <pre><code># \u5185\u5b58\u540e\u7aef\uff08\u5355\u8fdb\u7a0b\uff09\nEVENT_BACKEND=memory\n\n# Redis Pub/Sub\nEVENT_BACKEND=redis\nEVENT_URL=redis://localhost:6379/0\n\n# RabbitMQ\nEVENT_BACKEND=rabbitmq\nEVENT_URL=amqp://guest:guest@localhost:5672/</code></pre> <p>\ud83d\udcd6 \u8be6\u7ec6\u8bf4\u660e\uff1a\u53c2\u8003 26-infrastructure-advanced.md</p>"},{"location":"01-intro-detailed/","title":"1. \u7b80\u4ecb - \u6df1\u5165\u7406\u89e3 Aury Boot","text":""},{"location":"01-intro-detailed/#aury-boot","title":"\u4ec0\u4e48\u662f Aury Boot\uff1f","text":"<p>Aury Boot \u662f\u4e00\u4e2a\u5fae\u670d\u52a1\u5f00\u53d1\u6846\u67b6\uff0c\u57fa\u4e8e FastAPI\uff0c\u4f46\u63d0\u4f9b\u4e86\u4f01\u4e1a\u7ea7\u7684\u57fa\u7840\u8bbe\u65bd\u652f\u6301\u3002\u5b83\u4e0d\u662f\u66ff\u4ee3 FastAPI\uff0c\u800c\u662f\u5728\u5176\u57fa\u7840\u4e0a\u589e\u52a0\u4e86\u751f\u4ea7\u73af\u5883\u5fc5\u9700\u7684\u529f\u80fd\u3002</p>"},{"location":"01-intro-detailed/#_1","title":"\u6846\u67b6\u7684\u6838\u5fc3\u7406\u5ff5","text":"<ol> <li>\u5f00\u7bb1\u5373\u7528\uff1a\u63d0\u4f9b\u5f00\u53d1\u5fae\u670d\u52a1\u6240\u9700\u7684\u6240\u6709\"\u7535\u6c60\"\uff08DI\u3001\u65e5\u5fd7\u3001\u7f13\u5b58\u3001\u4efb\u52a1\u961f\u5217\u7b49\uff09</li> <li>\u6807\u51c6\u5316\u67b6\u6784\uff1a\u901a\u8fc7\u5185\u7f6e\u7684\u7ec4\u4ef6\u7cfb\u7edf\u3001\u4ed3\u50a8\u6a21\u5f0f\u7b49\uff0c\u89c4\u8303\u4ee3\u7801\u7ed3\u6784</li> <li>\u751f\u4ea7\u5c31\u7eea\uff1a\u5206\u5e03\u5f0f\u8ffd\u8e2a\u3001\u4f01\u4e1a\u7ea7\u65e5\u5fd7\u3001\u9519\u8bef\u5904\u7406\u7b49\u529f\u80fd\u5185\u7f6e</li> <li>\u7075\u6d3b\u53ef\u6269\u5c55\uff1a\u7ec4\u4ef6\u7cfb\u7edf\u5141\u8bb8\u81ea\u5b9a\u4e49\u6269\u5c55\uff0cDI \u5bb9\u5668\u652f\u6301\u591a\u79cd\u751f\u547d\u5468\u671f</li> </ol>"},{"location":"01-intro-detailed/#_2","title":"\u67b6\u6784\u5c42\u6b21","text":"<pre><code>FastAPI (HTTP \u6846\u67b6)\n    \u2193\nFoundationApp (\u5e94\u7528\u57fa\u7c7b)\n    \u2193\nComponent System (\u7ec4\u4ef6\u7ba1\u7406)\n    \u2193\nInfrastructure Layer (\u57fa\u7840\u8bbe\u65bd\u5c42)\n\u251c\u2500\u2500 Database (\u6570\u636e\u5e93)\n\u251c\u2500\u2500 Cache (\u7f13\u5b58)\n\u251c\u2500\u2500 Task Queue (\u4efb\u52a1\u961f\u5217)\n\u251c\u2500\u2500 Event Bus (\u4e8b\u4ef6\u603b\u7ebf)\n\u251c\u2500\u2500 Scheduler (\u5b9a\u65f6\u5668)\n\u251c\u2500\u2500 RPC (\u8fdc\u7a0b\u8c03\u7528)\n\u251c\u2500\u2500 Logging (\u65e5\u5fd7)\n\u2514\u2500\u2500 DI Container (\u4f9d\u8d56\u6ce8\u5165)\n</code></pre>"},{"location":"01-intro-detailed/#_3","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u5b83\uff1f","text":""},{"location":"01-intro-detailed/#fastapi","title":"\u4f20\u7edf FastAPI \u5e94\u7528\u7684\u95ee\u9898","text":"<pre><code># \u274c \u4f20\u7edf\u505a\u6cd5\uff1a\u624b\u52a8\u7ba1\u7406\u4e00\u5207\napp = FastAPI()\n\n# \u9700\u8981\u624b\u52a8\u521b\u5efa\u548c\u7ba1\u7406\ndb = None\ncache = None\nlogger = None\n\n@app.on_event(\"startup\")\nasync def startup():\n    global db, cache, logger\n    # \u624b\u52a8\u521d\u59cb\u5316\u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001\u65e5\u5fd7...\n    # \u4ee3\u7801\u5197\u957f\uff0c\u5bb9\u6613\u51fa\u9519\n\n@app.on_event(\"shutdown\")\nasync def shutdown():\n    # \u624b\u52a8\u6e05\u7406\u8d44\u6e90...\n    pass\n\n@app.get(\"/users\")\nasync def list_users():\n    # \u6bcf\u4e2a\u8def\u7531\u4e2d\u624b\u52a8\u6ce8\u5165\u4f9d\u8d56\n    session = db.session()\n    # ...</code></pre>"},{"location":"01-intro-detailed/#foundation-kit","title":"\u4f7f\u7528 Foundation Kit \u7684\u4f18\u52bf","text":"<pre><code># \u2705 \u4f7f\u7528 Kit\uff1a\u7edf\u4e00\u7ba1\u7406\nclass AppConfig(BaseConfig):\n    pass\n\napp = FoundationApp(config=AppConfig())\n# \u6240\u6709\u57fa\u7840\u8bbe\u65bd\u81ea\u52a8\u521d\u59cb\u5316\u548c\u7ba1\u7406\n\ncontainer = Container.get_instance()\n# \u7edf\u4e00\u7684 DI \u5bb9\u5668\n\n@app.get(\"/users\")\nasync def list_users(repo: UserRepository = Depends(get_user_repo)):\n    # \u4f9d\u8d56\u81ea\u52a8\u6ce8\u5165\uff0c\u4ee3\u7801\u6e05\u6670\n    pass</code></pre>"},{"location":"01-intro-detailed/#_4","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"01-intro-detailed/#1","title":"1. \u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6\u7cfb\u7edf","text":"<p>Kit \u5c06\u529f\u80fd\u5355\u5143\u5206\u4e3a\u4e24\u7c7b\uff1a</p> <p>\u4e2d\u95f4\u4ef6\uff08Middleware\uff09 - \u5904\u7406 HTTP \u8bf7\u6c42\u62e6\u622a\uff1a - <code>register()</code> \u540c\u6b65\u6ce8\u518c - \u6309 <code>order</code> \u6392\u5e8f\u6267\u884c - \u5185\u7f6e\uff1a<code>RequestLoggingMiddleware</code>\u3001<code>CORSMiddleware</code></p> <p>\u7ec4\u4ef6\uff08Component\uff09 - \u7ba1\u7406\u57fa\u7840\u8bbe\u65bd\u751f\u547d\u5468\u671f\uff1a - <code>setup()</code> / <code>teardown()</code> \u5f02\u6b65\u63a5\u53e3 - \u81ea\u52a8\u4f9d\u8d56\u7ba1\u7406\uff08<code>depends_on</code>\uff09 - \u6761\u4ef6\u542f\u7528\uff08<code>can_enable()</code>\uff09 - \u5185\u7f6e\uff1a<code>DatabaseComponent</code>\u3001<code>CacheComponent</code>\u3001<code>TaskComponent</code>\u3001<code>SchedulerComponent</code></p>"},{"location":"01-intro-detailed/#2-di-container","title":"2. \u4f9d\u8d56\u6ce8\u5165\u5bb9\u5668\uff08DI Container\uff09","text":"<p>\u751f\u547d\u5468\u671f\u7ba1\u7406\uff1a</p> <ul> <li>SINGLETON\uff1a\u6574\u4e2a\u5e94\u7528\u751f\u547d\u5468\u671f\u552f\u4e00\uff08\u5982\uff1a\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u3001\u7f13\u5b58\u5ba2\u6237\u7aef\uff09</li> <li>SCOPED\uff1a\u8bf7\u6c42\u8303\u56f4\u5185\u552f\u4e00\uff08\u5982\uff1a\u6570\u636e\u5e93\u4f1a\u8bdd\u3001\u7528\u6237\u4e0a\u4e0b\u6587\uff09</li> <li>TRANSIENT\uff1a\u6bcf\u6b21\u90fd\u521b\u5efa\u65b0\u5b9e\u4f8b\uff08\u5982\uff1a\u4e1a\u52a1\u903b\u8f91\u670d\u52a1\uff09</li> </ul> <p>\u81ea\u52a8\u4f9d\u8d56\u89e3\u6790\uff1a\u901a\u8fc7\u7c7b\u578b\u6ce8\u89e3\u81ea\u52a8\u89e3\u6790\u4f9d\u8d56\u5173\u7cfb</p>"},{"location":"01-intro-detailed/#3","title":"3. \u5206\u5c42\u67b6\u6784","text":"<pre><code>API \u5c42 (api/)\n  \u2193 \u4f9d\u8d56\n\u4e1a\u52a1\u903b\u8f91\u5c42 (services/)\n  \u2193 \u4f9d\u8d56\n\u6570\u636e\u8bbf\u95ee\u5c42 (repositories/)\n  \u2193 \u4f7f\u7528\n\u6570\u636e\u6a21\u578b\u5c42 (models/)\n</code></pre> <p>\u6bcf\u4e00\u5c42\u804c\u8d23\u6e05\u6670\uff0c\u6613\u4e8e\u6d4b\u8bd5\u548c\u7ef4\u62a4\u3002</p>"},{"location":"01-intro-detailed/#4","title":"4. \u5fae\u670d\u52a1\u80fd\u529b","text":"<ul> <li>RPC \u5ba2\u6237\u7aef\uff1a\u8de8\u670d\u52a1\u901a\u4fe1</li> <li>\u670d\u52a1\u53d1\u73b0\uff1aDNS \u81ea\u52a8\u89e3\u6790\u6216\u663e\u5f0f\u6620\u5c04</li> <li>\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1aTrace ID \u81ea\u52a8\u4f20\u9012</li> <li>\u4e8b\u4ef6\u603b\u7ebf\uff1a\u8de8\u670d\u52a1\u4e8b\u4ef6\u901a\u4fe1</li> </ul>"},{"location":"01-intro-detailed/#_5","title":"\u4e0e\u5176\u4ed6\u6846\u67b6\u7684\u5bf9\u6bd4","text":"\u7279\u6027 FastAPI Kit Spring Boot HTTP \u6846\u67b6 \u2705 \u2705 \u2705 DI \u5bb9\u5668 \u274c \u2705 \u2705 \u7ec4\u4ef6\u7cfb\u7edf \u274c \u2705 \u2705 \u6570\u636e\u5e93 ORM \u274c \u2705 \u2705 \u65e5\u5fd7\u7cfb\u7edf \u274c \u2705 \u2705 \u7f13\u5b58\u7ba1\u7406 \u274c \u2705 \u2705 \u4efb\u52a1\u961f\u5217 \u274c \u2705 \u2705 \u5fae\u670d\u52a1\u652f\u6301 \u274c \u2705 \u2705 \u5b66\u4e60\u66f2\u7ebf \u5e73\u7f13 \u4e2d\u7b49 \u9661\u5ced"},{"location":"01-intro-detailed/#kit","title":"\u4f55\u65f6\u4f7f\u7528 Kit\uff1f","text":""},{"location":"01-intro-detailed/#_6","title":"\u2705 \u9002\u5408\u4f7f\u7528","text":"<ul> <li>\u6784\u5efa\u5fae\u670d\u52a1\u67b6\u6784</li> <li>\u9700\u8981\u5206\u5e03\u5f0f\u8ffd\u8e2a\u548c\u65e5\u5fd7</li> <li>\u9879\u76ee\u4e2d\u6709\u591a\u4e2a\u72ec\u7acb\u670d\u52a1\u9700\u8981\u901a\u4fe1</li> <li>\u9700\u8981\u5f02\u6b65\u4efb\u52a1\u548c\u5b9a\u65f6\u4efb\u52a1</li> <li>\u9700\u8981\u6807\u51c6\u5316\u7684\u9879\u76ee\u7ed3\u6784\u548c\u4ee3\u7801\u89c4\u8303</li> </ul>"},{"location":"01-intro-detailed/#_7","title":"\u274c \u4e0d\u9002\u5408\u4f7f\u7528","text":"<ul> <li>\u7b80\u5355\u7684\u5355\u4f53\u5e94\u7528\uff08\u6bd4\u5982\u5c0f\u5de5\u5177\u811a\u672c\uff09</li> <li>\u4e0d\u9700\u8981\u4efb\u4f55\u57fa\u7840\u8bbe\u65bd\u652f\u6301\u7684 API</li> <li>\u5b66\u4e60 Python Web \u5f00\u53d1\u7684\u521d\u671f\u9636\u6bb5</li> </ul>"},{"location":"01-intro-detailed/#_8","title":"\u6027\u80fd\u7279\u6027","text":""},{"location":"01-intro-detailed/#_9","title":"\u4f18\u5316\u70b9","text":"<ol> <li>\u5f02\u6b65\u4f18\u5148\uff1a\u6240\u6709 I/O \u64cd\u4f5c\u5747\u4e3a\u5f02\u6b65</li> <li>\u8fde\u63a5\u6c60\uff1a\u6570\u636e\u5e93\u3001\u7f13\u5b58\u7b49\u81ea\u52a8\u8fde\u63a5\u6c60\u7ba1\u7406</li> <li>\u7f13\u5b58\u5c42\uff1a\u5185\u7f6e\u591a\u7ea7\u7f13\u5b58\u652f\u6301</li> <li>\u4efb\u52a1\u961f\u5217\uff1a\u540e\u53f0\u4efb\u52a1\u5f02\u6b65\u6267\u884c</li> <li>\u65e5\u5fd7\u5f02\u6b65\u5199\u5165\uff1a\u4e0d\u963b\u585e\u4e1a\u52a1\u6d41\u7a0b</li> </ol>"},{"location":"01-intro-detailed/#_10","title":"\u57fa\u51c6\u6570\u636e","text":"<p>\u5728\u6807\u51c6\u786c\u4ef6\u4e0a\uff08\u5047\u8bbe\u573a\u666f\uff09\uff1a</p> <ul> <li>\u541e\u5410\u91cf\uff1a~5000 req/s\uff08\u5355\u4e2a\u5b9e\u4f8b\uff0c\u7b80\u5355 API\uff09</li> <li>\u5ef6\u8fdf\uff1aP99 &lt; 100ms</li> <li>\u5185\u5b58\u5360\u7528\uff1a~80-150MB\uff08\u57fa\u7840\u5e94\u7528\uff09</li> </ul>"},{"location":"01-intro-detailed/#_11","title":"\u4f9d\u8d56\u5173\u7cfb","text":"<pre><code>aury-boot\n\u251c\u2500\u2500 FastAPI &gt;= 0.122.0\n\u251c\u2500\u2500 SQLAlchemy &gt;= 2.0.44\n\u251c\u2500\u2500 pydantic &gt;= 2.12\n\u251c\u2500\u2500 loguru (\u65e5\u5fd7)\n\u251c\u2500\u2500 uvicorn[standard] (ASGI \u670d\u52a1\u5668)\n\u251c\u2500\u2500 typer (\u547d\u4ee4\u884c)\n\u251c\u2500\u2500 APScheduler (\u5b9a\u65f6\uff0c\u53ef\u9009)\n\u251c\u2500\u2500 redis (\u53ef\u9009)\n\u251c\u2500\u2500 asyncpg (PostgreSQL \u9a71\u52a8\uff0c\u53ef\u9009)\n\u2514\u2500\u2500 ...\u5176\u4ed6\u57fa\u7840\u5e93\n</code></pre>"},{"location":"01-intro-detailed/#_12","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 02-installation-guide.md \u5b66\u4e60\u5b89\u88c5</li> <li>\u67e5\u770b 03-project-structure.md \u4e86\u89e3\u9879\u76ee\u7ed3\u6784</li> </ul>"},{"location":"02-installation-guide/","title":"2. \u5b89\u88c5\u6307\u5357","text":""},{"location":"02-installation-guide/#_1","title":"\u7cfb\u7edf\u8981\u6c42","text":"<ul> <li>Python \u7248\u672c\uff1a&gt;= 3.13</li> <li>\u64cd\u4f5c\u7cfb\u7edf\uff1aLinux, macOS, Windows</li> <li>\u5305\u7ba1\u7406\u5de5\u5177\uff1auv\uff08\u63a8\u8350\uff09\u6216 pip</li> </ul>"},{"location":"02-installation-guide/#_2","title":"\u5b89\u88c5\u65b9\u5f0f","text":""},{"location":"02-installation-guide/#1-uv","title":"\u65b9\u5f0f 1\uff1a\u4f7f\u7528 uv\uff08\u63a8\u8350\uff09","text":"<p>uv \u662f\u4e00\u4e2a\u6781\u901f\u7684 Python \u5305\u7ba1\u7406\u5de5\u5177\uff0c\u6bd4 pip \u5feb 10-100 \u500d\u3002</p> <p>\u5b89\u88c5 uv\uff1a <pre><code>curl -LsSf https://astral.sh/uv/install.sh | sh</code></pre></p> <p>\u521b\u5efa\u65b0\u9879\u76ee\uff1a <pre><code>uv init my-service\ncd my-service</code></pre></p> <p>\u5b89\u88c5 Kit\uff08\u4ece PyPI\uff09\uff1a <pre><code>uv add aury-boot</code></pre></p> <p>\u5b89\u88c5 Kit\uff08\u4ece Git - \u5f00\u53d1\u7248\u672c\uff09\uff1a <pre><code>uv add git+https://github.com/AuriMyth/aury-boot.git</code></pre></p>"},{"location":"02-installation-guide/#2-pip","title":"\u65b9\u5f0f 2\uff1a\u4f7f\u7528 pip","text":"<pre><code># \u4ece PyPI\npip install aury-boot\n\n# \u4ece Git\npip install git+https://github.com/AuriMyth/aury-boot.git</code></pre>"},{"location":"02-installation-guide/#3","title":"\u65b9\u5f0f 3\uff1a\u672c\u5730\u5f00\u53d1\u5b89\u88c5","text":"<p>\u5982\u679c\u4f60\u8981\u4fee\u6539 Kit \u7684\u4ee3\u7801\uff1a</p> <pre><code># \u514b\u9686\u4ed3\u5e93\ngit clone https://github.com/AuriMyth/aury-boot.git\ncd aury-boot\n\n# \u4f7f\u7528 uv \u5b89\u88c5\u5230\u672c\u5730\u53ef\u7f16\u8f91\u6a21\u5f0f\nuv sync\n\n# \u5728\u4f60\u7684\u9879\u76ee\u4e2d\u5f15\u7528\u672c\u5730\u8def\u5f84\n# pyproject.toml:\n# dependencies = [\n#     \"aury-boot @ file:///path/to/aury-boot\"\n# ]</code></pre>"},{"location":"02-installation-guide/#_3","title":"\u4f9d\u8d56\u5b89\u88c5","text":"<p>Foundation Kit \u91c7\u7528\u6a21\u5757\u5316\u7684\u53ef\u9009\u4f9d\u8d56\u8bbe\u8ba1\uff0c\u6309\u9700\u5b89\u88c5\u3002</p>"},{"location":"02-installation-guide/#_4","title":"\u5b89\u88c5\u65b9\u5f0f","text":"<pre><code># \u6838\u5fc3\uff08\u53ea\u6709\u6838\u5fc3\u6846\u67b6\uff0c\u4e0d\u542b\u6570\u636e\u5e93/\u7f13\u5b58\u7b49\u9a71\u52a8\uff09\nuv add aury-boot\n\n# \u63a8\u8350\uff08PostgreSQL + Redis + \u4efb\u52a1\u961f\u5217 + \u8c03\u5ea6\u5668\uff09\nuv add \"aury-boot[recommended]\"\n\n# \u6309\u9700\u7ec4\u5408\nuv add \"aury-boot[postgres,redis,scheduler]\"\n\n# \u5168\u90e8\u4f9d\u8d56\nuv add \"aury-boot[all]\"</code></pre>"},{"location":"02-installation-guide/#_5","title":"\u53ef\u9009\u4f9d\u8d56\u6e05\u5355","text":"\u540d\u79f0 \u8bf4\u660e \u5305\u542b\u7684\u5e93 <code>postgres</code> PostgreSQL \u6570\u636e\u5e93 asyncpg <code>mysql</code> MySQL \u6570\u636e\u5e93 aiomysql <code>sqlite</code> SQLite \u6570\u636e\u5e93 aiosqlite <code>redis</code> Redis \u7f13\u5b58 redis <code>s3</code> S3 \u5bf9\u8c61\u5b58\u50a8 aioboto3 <code>tasks</code> \u4efb\u52a1\u961f\u5217\uff08Dramatiq + Kombu\uff09 dramatiq, kombu, dramatiq-kombu-broker <code>rabbitmq</code> RabbitMQ \u652f\u6301\uff08\u914d\u5408 tasks\uff09 amqp <code>scheduler</code> \u5b9a\u65f6\u8c03\u5ea6 apscheduler <code>recommended</code> \u63a8\u8350\u7ec4\u5408 postgres + redis + tasks + scheduler <code>all</code> \u5168\u90e8\u4f9d\u8d56 \u4ee5\u4e0a\u6240\u6709 <code>dev</code> \u5f00\u53d1\u5de5\u5177 pytest, ruff, mypy <code>docs</code> \u6587\u6863\u751f\u6210 mkdocs, mkdocs-material"},{"location":"02-installation-guide/#_6","title":"\u5e38\u89c1\u7ec4\u5408\u793a\u4f8b","text":"<pre><code># Web API \u670d\u52a1\uff08\u6570\u636e\u5e93 + \u7f13\u5b58\uff09\nuv add \"aury-boot[postgres,redis]\"\n\n# \u540e\u53f0\u4efb\u52a1\u670d\u52a1\uff08\u6570\u636e\u5e93 + \u4efb\u52a1\u961f\u5217 + RabbitMQ\uff09\nuv add \"aury-boot[postgres,tasks,rabbitmq]\"\n\n# \u5b9a\u65f6\u4efb\u52a1\u670d\u52a1\uff08\u6570\u636e\u5e93 + \u8c03\u5ea6\u5668\uff09\nuv add \"aury-boot[postgres,scheduler]\"\n\n# \u5b8c\u6574\u5fae\u670d\u52a1\uff08\u63a8\u8350\uff09\nuv add \"aury-boot[recommended]\"</code></pre>"},{"location":"02-installation-guide/#pyprojecttoml","title":"\u5b8c\u6574 pyproject.toml \u793a\u4f8b","text":"<pre><code>[build-system]\nrequires = [\"hatchling\"]\nbuild-backend = \"hatchling.build\"\n\n[project]\nname = \"my-service\"\nversion = \"0.1.0\"\ndescription = \"My Aury service\"\nreadme = \"README.md\"\nrequires-python = \"&gt;=3.13\"\nauthors = [\n    { name = \"Your Name\", email = \"you@example.com\" }\n]\n\ndependencies = [\n    \"aury-boot[recommended]\",\n]\n\n[project.optional-dependencies]\ndev = [\n    \"pytest&gt;=9.0.1\",\n    \"pytest-asyncio&gt;=1.3.0\",\n    \"mypy&gt;=1.19.0\",\n    \"ruff&gt;=0.14.7\",\n]\n\n[tool.pytest.ini_options]\nasyncio_mode = \"auto\"\ntestpaths = [\"tests\"]\n\n[tool.mypy]\npython_version = \"3.13\"\nstrict = true\n</code></pre>"},{"location":"02-installation-guide/#_7","title":"\u9a8c\u8bc1\u5b89\u88c5","text":"<p>\u521b\u5efa <code>test_install.py</code>\uff1a</p> <pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\n\nclass Config(BaseConfig):\n    pass\n\napp = FoundationApp(\n    title=\"Test App\",\n    version=\"0.1.0\",\n    config=Config()\n)\n\n@app.get(\"/health\")\ndef health_check():\n    return {\"status\": \"ok\"}\n\nif __name__ == \"__main__\":\n    import uvicorn\n    uvicorn.run(app, host=\"0.0.0.0\", port=8000)</code></pre> <p>\u8fd0\u884c\u9a8c\u8bc1\uff1a <pre><code>uv run python test_install.py</code></pre></p> <p>\u8bbf\u95ee http://localhost:8000/health \u5e94\u8be5\u8fd4\u56de <code>{\"status\": \"ok\"}</code></p>"},{"location":"02-installation-guide/#_8","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"02-installation-guide/#q-python-312","title":"Q: \u80fd\u5728 Python 3.12 \u6216\u66f4\u4f4e\u7248\u672c\u4e0a\u4f7f\u7528\u5417\uff1f","text":"<p>A: \u4e0d\u884c\u3002Kit \u4f7f\u7528\u4e86 Python 3.13+ \u7684\u7279\u6027\uff08\u5982\u7c7b\u578b\u6ce8\u89e3\u65b0\u8bed\u6cd5\u3001\u6539\u8fdb\u7684\u6cdb\u578b\u7b49\uff09\u3002\u5fc5\u987b\u4f7f\u7528 Python 3.13 \u6216\u66f4\u9ad8\u7248\u672c\u3002</p>"},{"location":"02-installation-guide/#q-uv-pip","title":"Q: uv \u548c pip \u6709\u4ec0\u4e48\u533a\u522b\uff1f","text":"<p>A: uv \u66f4\u5feb\u3001\u66f4\u53ef\u9760\uff1a - \u901f\u5ea6\u5feb 10-100 \u500d - \u81ea\u52a8\u7ba1\u7406\u865a\u62df\u73af\u5883 - \u66f4\u597d\u7684\u4f9d\u8d56\u89e3\u6790 - \u5185\u7f6e\u9501\u5b9a\u6587\u4ef6\u652f\u6301</p>"},{"location":"02-installation-guide/#q","title":"Q: \u5982\u4f55\u79bb\u7ebf\u5b89\u88c5\uff1f","text":"<p>A: \u5148\u5728\u6709\u7f51\u7684\u673a\u5668\u4e0a\u751f\u6210 lock \u6587\u4ef6\uff1a <pre><code>uv lock</code></pre></p> <p>\u7136\u540e\u79bb\u7ebf\u5b89\u88c5\uff1a <pre><code>uv sync --frozen</code></pre></p>"},{"location":"02-installation-guide/#q-docker","title":"Q: \u5728 Docker \u4e2d\u5b89\u88c5","text":"<pre><code>FROM python:3.13-slim\n\nWORKDIR /app\n\n# \u5b89\u88c5 uv\nRUN curl -LsSf https://astral.sh/uv/install.sh | sh\n\nCOPY pyproject.toml uv.lock ./\n\n# \u5b89\u88c5\u4f9d\u8d56\nRUN /root/.local/bin/uv sync --no-dev\n\nCOPY . .\n\nCMD [\"uv\", \"run\", \"python\", \"main.py\"]\n</code></pre>"},{"location":"02-installation-guide/#_9","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 03-project-structure.md \u5efa\u7acb\u9879\u76ee\u7ed3\u6784</li> <li>\u67e5\u770b 02-quick-start.md \u7f16\u5199\u7b2c\u4e00\u4e2a\u5e94\u7528</li> </ul>"},{"location":"03-server-deployment/","title":"3. \u670d\u52a1\u5668\u8fd0\u884c\u548c\u90e8\u7f72\u6307\u5357","text":"<p>Kit \u63d0\u4f9b\u4e86\u4e24\u5957\u670d\u52a1\u5668\u8fd0\u884c\u7cfb\u7edf\uff1aApplicationServer \u7c7b \u548c CLI \u547d\u4ee4\u3002</p>"},{"location":"03-server-deployment/#applicationserver","title":"ApplicationServer \u7c7b","text":"<p>\u57fa\u4e8e uvicorn\uff0c\u63d0\u4f9b\u5b8c\u6574\u7684\u670d\u52a1\u5668\u7ba1\u7406\u529f\u80fd\u3002</p>"},{"location":"03-server-deployment/#_1","title":"\u57fa\u7840\u4f7f\u7528","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom aury.boot.application.server import ApplicationServer\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nclass AppConfig(BaseConfig):\n    pass\n\napp = FoundationApp(\n    title=\"My Service\",\n    version=\"0.1.0\",\n    config=AppConfig()\n)\n\n@app.get(\"/health\")\nasync def health_check():\n    return BaseResponse(code=200, message=\"Healthy\", data={\"status\": \"ok\"})\n\n# \u8fd0\u884c\u670d\u52a1\u5668\nif __name__ == \"__main__\":\n    server = ApplicationServer(\n        app=app,\n        host=\"0.0.0.0\",\n        port=8000,\n        workers=1,\n    )\n    server.run()</code></pre>"},{"location":"03-server-deployment/#_2","title":"\u5e38\u89c1\u914d\u7f6e","text":""},{"location":"03-server-deployment/#_3","title":"\u5f00\u53d1\u6a21\u5f0f\uff08\u70ed\u91cd\u8f7d\uff09","text":"<pre><code>server = ApplicationServer(\n    app=app,\n    host=\"127.0.0.1\",\n    port=8000,\n    reload=True,              # \u542f\u7528\u70ed\u91cd\u8f7d\n    reload_dirs=[\"./src\"],    # \u76d1\u63a7\u76ee\u5f55\n    debug=True,               # \u8c03\u8bd5\u6a21\u5f0f\n)\nserver.run()</code></pre>"},{"location":"03-server-deployment/#_4","title":"\u751f\u4ea7\u6a21\u5f0f\uff08\u591a\u8fdb\u7a0b\uff09","text":"<pre><code>import os\n\nserver = ApplicationServer(\n    app=app,\n    host=\"0.0.0.0\",\n    port=8000,\n    workers=os.cpu_count() or 4,  # \u4f7f\u7528 CPU \u6838\u5fc3\u6570\n    reload=False,\n    debug=False,\n)\nserver.run()</code></pre>"},{"location":"03-server-deployment/#https","title":"HTTPS \u652f\u6301","text":"<pre><code>server = ApplicationServer(\n    app=app,\n    host=\"0.0.0.0\",\n    port=443,\n    ssl_keyfile=\"/path/to/key.pem\",\n    ssl_certfile=\"/path/to/cert.pem\",\n    ssl_keyfile_password=None,  # \u5982\u679c\u5bc6\u94a5\u6709\u5bc6\u7801\n)\nserver.run()</code></pre>"},{"location":"03-server-deployment/#http","title":"\u4e8b\u4ef6\u5faa\u73af\u548c HTTP \u534f\u8bae\u4f18\u5316","text":"<pre><code>server = ApplicationServer(\n    app=app,\n    host=\"0.0.0.0\",\n    port=8000,\n    loop=\"uvloop\",      # \u4e8b\u4ef6\u5faa\u73af\u5b9e\u73b0\uff1aauto/asyncio/uvloop\n    http=\"httptools\",   # HTTP \u534f\u8bae\uff1aauto/h11/httptools\n)\nserver.run()</code></pre> <p>\u6027\u80fd\u5bf9\u6bd4\uff1a - <code>loop=\"uvloop\"</code> - \u6bd4\u6807\u51c6 asyncio \u5feb 2-4 \u500d - <code>http=\"httptools\"</code> - \u6bd4 h11 \u5feb 3 \u500d - \u9700\u8981\u989d\u5916\u5b89\u88c5\uff1a<code>pip install uvloop httptools</code></p>"},{"location":"03-server-deployment/#_5","title":"\u5f02\u6b65\u8fd0\u884c","text":"<pre><code>import asyncio\nfrom aury.boot.application.server import ApplicationServer\n\nasync def run_server_async():\n    server = ApplicationServer(\n        app=app,\n        host=\"0.0.0.0\",\n        port=8000,\n    )\n    await server.run_async()\n\n# \u5728\u5f02\u6b65\u6846\u67b6\u4e2d\u4f7f\u7528\nif __name__ == \"__main__\":\n    asyncio.run(run_server_async())</code></pre>"},{"location":"03-server-deployment/#_6","title":"\u83b7\u53d6\u670d\u52a1\u5668\u914d\u7f6e","text":"<pre><code>server = ApplicationServer(\n    app=app,\n    host=\"0.0.0.0\",\n    port=8000,\n)\n\n# \u83b7\u53d6 uvicorn \u914d\u7f6e\u5bf9\u8c61\nconfig = server.get_config()\nprint(f\"\u76d1\u542c\u5730\u5740: {config.host}:{config.port}\")\nprint(f\"\u5de5\u4f5c\u8fdb\u7a0b: {config.workers}\")</code></pre>"},{"location":"03-server-deployment/#run_app","title":"run_app \u5feb\u6377\u51fd\u6570","text":"<p>\u7b80\u5316\u7684\u8fd0\u884c\u63a5\u53e3\uff0c\u81ea\u52a8\u8bfb\u53d6\u73af\u5883\u53d8\u91cf\u3002</p>"},{"location":"03-server-deployment/#_7","title":"\u57fa\u7840\u4f7f\u7528","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.server import run_app\n\napp = FoundationApp(title=\"My Service\")\n\nif __name__ == \"__main__\":\n    run_app(app)  # \u81ea\u52a8\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u6216\u9ed8\u8ba4\u503c</code></pre>"},{"location":"03-server-deployment/#_8","title":"\u6307\u5b9a\u53c2\u6570","text":"<pre><code>run_app(\n    app,\n    host=\"0.0.0.0\",\n    port=8000,\n    workers=4,\n    reload=False,\n    # \u5176\u4ed6 ApplicationServer \u53c2\u6570\n)</code></pre>"},{"location":"03-server-deployment/#_9","title":"\u73af\u5883\u53d8\u91cf\u652f\u6301","text":"<pre><code># \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\nexport SERVER_HOST=0.0.0.0\nexport SERVER_PORT=8000\nexport SERVER_WORKERS=4\nexport SERVER_RELOAD=true\n\n# \u8fd0\u884c\u5e94\u7528\npython main.py</code></pre>"},{"location":"03-server-deployment/#cli","title":"CLI \u547d\u4ee4","text":"<p>\u63d0\u4f9b\u4e86\u5f00\u7bb1\u5373\u7528\u7684\u547d\u4ee4\u884c\u5de5\u5177\u3002</p>"},{"location":"03-server-deployment/#_10","title":"\u57fa\u7840\u547d\u4ee4","text":"<p>\u65b9\u5f0f 1\uff1a\u76f4\u63a5\u4f7f\u7528\u547d\u4ee4\uff08\u63a8\u8350\uff09</p> <pre><code># \u5f00\u53d1\u670d\u52a1\u5668\uff08\u70ed\u91cd\u8f7d\uff09\naury server dev\n# \u6216\u4f7f\u7528\u77ed\u522b\u540d\naury server dev\n\n# \u901a\u7528\u8fd0\u884c\u547d\u4ee4\naury server run\n\n# \u751f\u4ea7\u670d\u52a1\u5668\uff08\u591a\u8fdb\u7a0b\uff09\naury server prod</code></pre> <p>\u65b9\u5f0f 2\uff1a\u4f7f\u7528 Python \u6a21\u5757</p> <pre><code># \u5f00\u53d1\u670d\u52a1\u5668\nuv run aury server dev\n\n# \u901a\u7528\u8fd0\u884c\nuv run aury server run\n\n# \u751f\u4ea7\u670d\u52a1\u5668\nuv run aury server prod</code></pre>"},{"location":"03-server-deployment/#dev","title":"dev \u547d\u4ee4\uff08\u5f00\u53d1\u6a21\u5f0f\uff09","text":"<pre><code># \u57fa\u7840\u7528\u6cd5\naury server dev\n\n# \u6307\u5b9a\u7aef\u53e3\naury server dev --port 9000\n\n# \u6307\u5b9a\u5730\u5740\u548c\u7aef\u53e3\naury server dev --host 0.0.0.0 --port 9000</code></pre> <p>\u7279\u70b9\uff1a - \u81ea\u52a8\u542f\u7528\u70ed\u91cd\u8f7d - \u81ea\u52a8\u542f\u7528\u8c03\u8bd5\u6a21\u5f0f - \u5355\u8fdb\u7a0b\u8fd0\u884c - \u63a8\u8350\u7528\u4e8e\u5f00\u53d1</p>"},{"location":"03-server-deployment/#run","title":"run \u547d\u4ee4\uff08\u901a\u7528\u8fd0\u884c\uff09","text":"<pre><code># \u57fa\u7840\u7528\u6cd5\naury server run\n\n# \u6307\u5b9a\u5de5\u4f5c\u8fdb\u7a0b\naury server run --workers 4\n\n# \u542f\u7528\u70ed\u91cd\u8f7d\naury server run --reload\n\n# \u6307\u5b9a\u70ed\u91cd\u8f7d\u76d1\u63a7\u76ee\u5f55\naury server run --reload --reload-dir src --reload-dir tests\n\n# HTTPS\naury server run \\\n    --ssl-keyfile key.pem \\\n    --ssl-certfile cert.pem\n\n# \u5b8c\u6574\u793a\u4f8b\naury server run \\\n    --host 0.0.0.0 \\\n    --port 8000 \\\n    --workers 4 \\\n    --loop uvloop \\\n    --http httptools \\\n    --debug</code></pre> <p>\u6240\u6709\u9009\u9879\uff1a <pre><code>--host              \u76d1\u542c\u5730\u5740\uff08\u9ed8\u8ba4\uff1a127.0.0.1\uff09\n--port              \u76d1\u542c\u7aef\u53e3\uff08\u9ed8\u8ba4\uff1a8000\uff09\n--workers           \u5de5\u4f5c\u8fdb\u7a0b\u6570\uff08\u9ed8\u8ba4\uff1a1\uff09\n--reload            \u542f\u7528\u70ed\u91cd\u8f7d\n--reload-dir        \u70ed\u91cd\u8f7d\u76d1\u63a7\u76ee\u5f55\uff08\u53ef\u6307\u5b9a\u591a\u4e2a\uff09\n--debug             \u542f\u7528\u8c03\u8bd5\u6a21\u5f0f\n--loop              \u4e8b\u4ef6\u5faa\u73af\u5b9e\u73b0\uff08auto/asyncio/uvloop\uff09\n--http              HTTP \u534f\u8bae\u7248\u672c\uff08auto/h11/httptools\uff09\n--ssl-keyfile       SSL \u5bc6\u94a5\u6587\u4ef6\n--ssl-certfile      SSL \u8bc1\u4e66\u6587\u4ef6\n--no-access-log     \u7981\u7528\u8bbf\u95ee\u65e5\u5fd7\n</code></pre></p>"},{"location":"03-server-deployment/#prod","title":"prod \u547d\u4ee4\uff08\u751f\u4ea7\u6a21\u5f0f\uff09","text":"<pre><code># \u57fa\u7840\u7528\u6cd5\uff08\u81ea\u52a8\u4f7f\u7528 CPU \u6838\u5fc3\u6570\uff09\naury server prod\n\n# \u6307\u5b9a\u5de5\u4f5c\u8fdb\u7a0b\u6570\naury server prod --workers 8\n\n# \u6307\u5b9a\u5730\u5740\u548c\u7aef\u53e3\naury server prod --host 0.0.0.0 --port 8000</code></pre> <p>\u7279\u70b9\uff1a - \u81ea\u52a8\u4f7f\u7528 CPU \u6838\u5fc3\u6570\u4f5c\u4e3a\u5de5\u4f5c\u8fdb\u7a0b\u6570 - \u7981\u7528\u70ed\u91cd\u8f7d - \u7981\u7528\u8c03\u8bd5\u6a21\u5f0f - \u63a8\u8350\u7528\u4e8e\u751f\u4ea7\u73af\u5883</p>"},{"location":"03-server-deployment/#_11","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e","text":"<p>\u6240\u6709\u547d\u4ee4\u90fd\u652f\u6301\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff1a</p> <pre><code># \u5171\u901a\u73af\u5883\u53d8\u91cf\nSERVER_HOST=0.0.0.0      # \u76d1\u542c\u5730\u5740\nSERVER_PORT=8000         # \u76d1\u542c\u7aef\u53e3\nSERVER_WORKERS=4         # \u5de5\u4f5c\u8fdb\u7a0b\u6570\nSERVER_RELOAD=true       # \u542f\u7528\u70ed\u91cd\u8f7d\nDEBUG=true               # \u8c03\u8bd5\u6a21\u5f0f\n\n# \u4f8b\u5b50\uff1a\u5b8c\u6574\u914d\u7f6e\nexport SERVER_HOST=0.0.0.0\nexport SERVER_PORT=8000\nexport SERVER_WORKERS=4\nexport SERVER_RELOAD=false\nexport DEBUG=false\n\naury server run</code></pre>"},{"location":"03-server-deployment/#mainpy","title":"\u9879\u76ee main.py \u7ed3\u6784","text":""},{"location":"03-server-deployment/#mainpy_1","title":"\u63a8\u8350\u7684 main.py \u7ed3\u6784","text":"<pre><code>\"\"\"\u5e94\u7528\u5165\u53e3\u70b9\u3002\"\"\"\n\nfrom aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom aury.boot.application.server import run_app\nfrom aury.boot.application.app.components import (\n    RequestLoggingComponent,\n    DatabaseComponent,\n    CacheComponent,\n)\n\n# ============= \u914d\u7f6e =============\n\nclass AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n    pass\n\n# ============= \u5e94\u7528\u521b\u5efa =============\n\ndef create_app() -&gt; FoundationApp:\n    \"\"\"\u5de5\u5382\u51fd\u6570\u521b\u5efa\u5e94\u7528\"\"\"\n    config = AppConfig()\n\n    app = FoundationApp(\n        title=\"My Service\",\n        version=\"0.1.0\",\n        config=config\n    )\n\n    # \u6ce8\u518c\u7ec4\u4ef6\n    app.items = [\n        RequestLoggingComponent,\n        DatabaseComponent,\n        CacheComponent,\n    ]\n\n    # \u6ce8\u518c\u8def\u7531\n    from api.v1 import users_router\n    app.include_router(users_router, prefix=\"/api/v1\")\n\n    return app\n\n# ============= \u5e94\u7528\u5b9e\u4f8b =============\n\napp = create_app()\n\n# ============= \u542f\u52a8 =============\n\nif __name__ == \"__main__\":\n    run_app(app)</code></pre>"},{"location":"03-server-deployment/#_12","title":"\u4f7f\u7528\u65b9\u5f0f","text":"<pre><code># \u76f4\u63a5\u8fd0\u884c\nuv run python main.py\n\n# \u6216\u4f7f\u7528 CLI \u547d\u4ee4\uff08\u63a8\u8350\uff09\naury server dev\n\n# \u6216\u6307\u5b9a uvicorn\nuvicorn main:app --reload</code></pre>"},{"location":"03-server-deployment/#docker","title":"Docker \u90e8\u7f72","text":""},{"location":"03-server-deployment/#dockerfile","title":"Dockerfile","text":"<pre><code>FROM python:3.13-slim\n\nWORKDIR /app\n\n# \u5b89\u88c5 uv\nRUN curl -LsSf https://astral.sh/uv/install.sh | sh\n\n# \u590d\u5236\u4f9d\u8d56\u6587\u4ef6\nCOPY pyproject.toml uv.lock ./\n\n# \u5b89\u88c5\u4f9d\u8d56\nRUN /root/.local/bin/uv sync --frozen --no-dev\n\n# \u590d\u5236\u4ee3\u7801\nCOPY . .\n\n# \u66b4\u9732\u7aef\u53e3\nEXPOSE 8000\n\n# \u8fd0\u884c\u5e94\u7528\nCMD [\"/root/.local/bin/uv\", \"run\", \"aum\", \"server\", \"prod\"]\n</code></pre>"},{"location":"03-server-deployment/#docker-composeyml","title":"docker-compose.yml","text":"<pre><code>version: '3.8'\n\nservices:\n  app:\n    build: .\n    ports:\n      - \"8000:8000\"\n    environment:\n      SERVER_HOST: 0.0.0.0\n      SERVER_PORT: 8000\n      SERVER_WORKERS: 4\n      DATABASE_URL: postgresql+asyncpg://user:pass@db:5432/mydb\n    depends_on:\n      - db\n    volumes:\n      - ./logs:/app/logs\n\n  db:\n    image: postgres:15\n    environment:\n      POSTGRES_USER: user\n      POSTGRES_PASSWORD: pass\n      POSTGRES_DB: mydb\n    volumes:\n      - postgres_data:/var/lib/postgresql/data\n\nvolumes:\n  postgres_data:\n</code></pre>"},{"location":"03-server-deployment/#_13","title":"\u8fd0\u884c","text":"<pre><code>docker-compose up\n\n# \u67e5\u770b\u65e5\u5fd7\ndocker-compose logs -f app</code></pre>"},{"location":"03-server-deployment/#_14","title":"\u6027\u80fd\u4f18\u5316","text":""},{"location":"03-server-deployment/#1","title":"1. \u591a\u8fdb\u7a0b\u914d\u7f6e","text":"<pre><code># \u4f7f\u7528 CPU \u6838\u5fc3\u6570\naury server prod\n\n# \u6216\u6307\u5b9a\u5177\u4f53\u6570\u503c\naury server run --workers 8</code></pre>"},{"location":"03-server-deployment/#2","title":"2. \u4e8b\u4ef6\u5faa\u73af\u4f18\u5316","text":"<pre><code># uvloop \u5df2\u901a\u8fc7 uvicorn[standard] \u4f9d\u8d56\u81ea\u52a8\u5b89\u88c5\n\n# \u4f7f\u7528 uvloop\naury server run --loop uvloop --http httptools</code></pre>"},{"location":"03-server-deployment/#3_1","title":"3. \u5185\u5b58\u7ba1\u7406","text":"<pre><code># \u76d1\u63a7\u5185\u5b58\u4f7f\u7528\nps aux | grep python\n\n# \u9650\u5236\u5185\u5b58\ndocker run --memory=1g myapp</code></pre>"},{"location":"03-server-deployment/#4","title":"4. \u8fde\u63a5\u6c60\u4f18\u5316","text":"<pre><code>class AppConfig(BaseConfig):\n    database: DatabaseSettings = Field(\n        default_factory=lambda: DatabaseSettings(\n            pool_size=20,           # \u8fde\u63a5\u6c60\u5927\u5c0f\n            max_overflow=30,        # \u8d85\u9650\u8fde\u63a5\u6570\n            pool_recycle=3600,      # \u8fde\u63a5\u56de\u6536\u65f6\u95f4\uff08\u79d2\uff09\n        )\n    )</code></pre>"},{"location":"03-server-deployment/#_15","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"03-server-deployment/#q-https","title":"Q: \u5982\u4f55\u5728\u751f\u4ea7\u73af\u5883\u4f7f\u7528 HTTPS\uff1f","text":"<p>A: \u4f7f\u7528 SSL \u8bc1\u4e66\uff1a <pre><code>aury server run \\\n    --ssl-keyfile /path/to/key.pem \\\n    --ssl-certfile /path/to/cert.pem</code></pre></p>"},{"location":"03-server-deployment/#q","title":"Q: \u5f00\u53d1\u65f6\u70ed\u91cd\u8f7d\u4e0d\u5de5\u4f5c\uff1f","text":"<p>A: \u786e\u4fdd\uff1a 1. \u542f\u7528\u4e86 <code>--reload</code> \u6807\u5fd7 2. \u4fee\u6539\u4e86\u4ee3\u7801\uff08\u4e0d\u662f\u5bfc\u5165\u7684\u5305\uff09 3. \u4f7f\u7528\u4e86\u652f\u6301\u7684\u6587\u4ef6\u683c\u5f0f</p>"},{"location":"03-server-deployment/#q_1","title":"Q: \u5982\u4f55\u4f18\u5316\u5185\u5b58\u4f7f\u7528\uff1f","text":"<p>A:  1. \u4f7f\u7528 uvloop\uff1a<code>--loop uvloop</code> 2. \u9650\u5236\u5de5\u4f5c\u8fdb\u7a0b\u6570 3. \u542f\u7528\u8fde\u63a5\u6c60\u56de\u6536\uff1a<code>pool_recycle=3600</code></p>"},{"location":"03-server-deployment/#q_2","title":"Q: \u751f\u4ea7\u73af\u5883\u7528\u591a\u5c11\u5de5\u4f5c\u8fdb\u7a0b\uff1f","text":"<p>A: \u901a\u5e38\u4e3a CPU \u6838\u5fc3\u6570\u3002<code>prod</code> \u547d\u4ee4\u81ea\u52a8\u8ba1\u7b97\u3002</p>"},{"location":"03-server-deployment/#_16","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 06-components-detailed.md \u4e86\u89e3\u7ec4\u4ef6\u7cfb\u7edf</li> <li>\u67e5\u770b 09-database-complete.md \u4e86\u89e3\u6570\u636e\u5e93\u914d\u7f6e</li> <li>\u67e5\u770b 20-best-practices.md \u4e86\u89e3\u90e8\u7f72\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"04-project-structure/","title":"4. \u9879\u76ee\u7ed3\u6784\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"04-project-structure/#_1","title":"\u63a8\u8350\u7684\u9879\u76ee\u7ed3\u6784","text":"<p>\u4f7f\u7528\u5206\u5c42\u67b6\u6784\uff08Layered Architecture\uff09\uff1a</p> <pre><code>my-service/\n\u251c\u2500\u2500 main.py                  # \u5e94\u7528\u5165\u53e3\n\u251c\u2500\u2500 config.py                # \u914d\u7f6e\u5b9a\u4e49\n\u251c\u2500\u2500 pyproject.toml           # \u9879\u76ee\u914d\u7f6e\n\u251c\u2500\u2500 uv.lock                  # \u4f9d\u8d56\u9501\u5b9a\n\u251c\u2500\u2500 .env                     # \u73af\u5883\u53d8\u91cf\uff08\u5f00\u53d1\uff09\n\u251c\u2500\u2500 .env.example             # \u73af\u5883\u53d8\u91cf\u6a21\u677f\n\u251c\u2500\u2500 README.md                # \u9879\u76ee\u8bf4\u660e\n\u2502\n\u251c\u2500\u2500 api/                     # API \u5c42\n\u2502   \u2514\u2500\u2500 v1/\n\u2502       \u251c\u2500\u2500 __init__.py\n\u2502       \u251c\u2500\u2500 users.py         # \u7528\u6237\u76f8\u5173\u8def\u7531\n\u2502       \u251c\u2500\u2500 orders.py        # \u8ba2\u5355\u76f8\u5173\u8def\u7531\n\u2502       \u2514\u2500\u2500 health.py        # \u5065\u5eb7\u68c0\u67e5\n\u2502\n\u251c\u2500\u2500 services/                # Service \u5c42\uff08\u4e1a\u52a1\u903b\u8f91\uff09\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 user_service.py\n\u2502   \u251c\u2500\u2500 order_service.py\n\u2502   \u2514\u2500\u2500 payment_service.py\n\u2502\n\u251c\u2500\u2500 models/                  # \u6570\u636e\u6a21\u578b\uff08SQLAlchemy\uff09\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 user.py\n\u2502   \u251c\u2500\u2500 order.py\n\u2502   \u2514\u2500\u2500 base.py              # \u57fa\u7840\u6a21\u578b\n\u2502\n\u251c\u2500\u2500 repositories/            # Repository \u5c42\uff08\u6570\u636e\u8bbf\u95ee\uff09\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 user_repository.py\n\u2502   \u251c\u2500\u2500 order_repository.py\n\u2502   \u2514\u2500\u2500 base_repository.py\n\u2502\n\u251c\u2500\u2500 schemas/                 # Pydantic \u6a21\u578b\uff08\u8bf7\u6c42/\u54cd\u5e94\uff09\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 user.py\n\u2502   \u251c\u2500\u2500 order.py\n\u2502   \u2514\u2500\u2500 common.py\n\u2502\n\u251c\u2500\u2500 exceptions/              # \u81ea\u5b9a\u4e49\u5f02\u5e38\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2514\u2500\u2500 custom_errors.py\n\u2502\n\u251c\u2500\u2500 components/              # \u81ea\u5b9a\u4e49\u7ec4\u4ef6\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u2514\u2500\u2500 custom_component.py\n\u2502\n\u251c\u2500\u2500 utils/                   # \u5de5\u5177\u51fd\u6570\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 helpers.py\n\u2502   \u2514\u2500\u2500 validators.py\n\u2502\n\u251c\u2500\u2500 migrations/              # \u6570\u636e\u5e93\u8fc1\u79fb\uff08Alembic\uff09\n\u2502   \u251c\u2500\u2500 env.py\n\u2502   \u251c\u2500\u2500 script.py.mako\n\u2502   \u2514\u2500\u2500 versions/\n\u2502\n\u251c\u2500\u2500 logs/                    # \u65e5\u5fd7\u76ee\u5f55\n\u2502   \u251c\u2500\u2500 app.log\n\u2502   \u251c\u2500\u2500 error.log\n\u2502   \u2514\u2500\u2500 access.log\n\u2502\n\u2514\u2500\u2500 tests/                   # \u6d4b\u8bd5\n    \u251c\u2500\u2500 __init__.py\n    \u251c\u2500\u2500 conftest.py          # pytest \u914d\u7f6e\n    \u251c\u2500\u2500 test_users.py\n    \u251c\u2500\u2500 test_orders.py\n    \u2514\u2500\u2500 fixtures.py          # \u6d4b\u8bd5\u6570\u636e\n</code></pre>"},{"location":"04-project-structure/#_2","title":"\u5206\u5c42\u8bf4\u660e","text":""},{"location":"04-project-structure/#api-api","title":"API \u5c42\uff08api/\uff09","text":"<p>\u5904\u7406 HTTP \u8bf7\u6c42\u548c\u54cd\u5e94\u3002</p> <pre><code># api/v1/users.py\nfrom fastapi import APIRouter, Depends\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nrouter = APIRouter()\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, service=Depends(get_user_service)):\n    user = await service.get_user(user_id)\n    return BaseResponse(code=200, message=\"\u6210\u529f\", data=user)</code></pre> <p>\u804c\u8d23\uff1a - HTTP \u8bf7\u6c42\u89e3\u6790 - \u53c2\u6570\u9a8c\u8bc1 - \u8c03\u7528 Service - \u54cd\u5e94\u5e8f\u5217\u5316</p>"},{"location":"04-project-structure/#service-services","title":"Service \u5c42\uff08services/\uff09","text":"<p>\u5904\u7406\u4e1a\u52a1\u903b\u8f91\u3002</p> <pre><code># services/user_service.py\nclass UserService:\n    def __init__(self, repo: UserRepository):\n        self.repo = repo\n\n    async def get_user(self, user_id: str) -&gt; User:\n        user = await self.repo.get(user_id)\n        if not user:\n            raise NotFoundError(\"\u7528\u6237\u4e0d\u5b58\u5728\")\n        return user\n\n    async def create_user(self, data: dict) -&gt; User:\n        if await self.repo.get_by_email(data[\"email\"]):\n            raise AlreadyExistsError(\"\u90ae\u7bb1\u5df2\u5b58\u5728\")\n        return await self.repo.create(data)</code></pre> <p>\u804c\u8d23\uff1a - \u4e1a\u52a1\u903b\u8f91\u5904\u7406 - \u4e8b\u52a1\u7ba1\u7406 - \u8de8 Repository \u64cd\u4f5c - \u6570\u636e\u9a8c\u8bc1</p>"},{"location":"04-project-structure/#repository-repositories","title":"Repository \u5c42\uff08repositories/\uff09","text":"<p>\u5904\u7406\u6570\u636e\u8bbf\u95ee\u3002</p> <pre><code># repositories/user_repository.py\nfrom aury.boot.domain.repository.impl import BaseRepository\n\nclass UserRepository(BaseRepository[User]):\n    async def get_by_email(self, email: str) -&gt; Optional[User]:\n        return await self.get_by(email=email)\n\n    async def list_active(self) -&gt; List[User]:\n        return await self.list(is_active=True)</code></pre> <p>\u804c\u8d23\uff1a - \u6570\u636e\u5e93\u67e5\u8be2 - CRUD \u64cd\u4f5c - \u67e5\u8be2\u4f18\u5316 - \u5173\u7cfb\u52a0\u8f7d</p>"},{"location":"04-project-structure/#models-models","title":"Models \u5c42\uff08models/\uff09","text":"<p>\u5b9a\u4e49\u6570\u636e\u6a21\u578b\u3002\u63a8\u8350\u4f7f\u7528 Kit \u63d0\u4f9b\u7684\u9884\u5b9a\u4e49\u57fa\u7c7b\u3002</p> <pre><code># models/user.py\nfrom sqlalchemy import String\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom aury.boot.domain.models import UUIDAuditableStateModel\n\nclass User(UUIDAuditableStateModel):\n    \"\"\"\u7528\u6237\u6a21\u578b\u3002\n\n    \u7ee7\u627f UUIDAuditableStateModel \u81ea\u52a8\u83b7\u5f97\uff1a\n    - id: UUID \u4e3b\u952e\n    - created_at: \u521b\u5efa\u65f6\u95f4\n    - updated_at: \u66f4\u65b0\u65f6\u95f4\n    - deleted_at: \u8f6f\u5220\u9664\u65f6\u95f4\u6233\n    \"\"\"\n    __tablename__ = \"users\"\n\n    username: Mapped[str] = mapped_column(String(50), unique=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True)</code></pre> <p>\u804c\u8d23\uff1a - SQLAlchemy \u6a21\u578b\u5b9a\u4e49 - \u6570\u636e\u5e93\u5b57\u6bb5\u6620\u5c04 - \u4e0d\u63a8\u8350\u5b9a\u4e49 relationship\uff08\u4f7f\u7528\u8d2b\u8840\u6a21\u578b + Repository \u6a21\u5f0f\uff09</p>"},{"location":"04-project-structure/#schemas-schemas","title":"Schemas \u5c42\uff08schemas/\uff09","text":"<p>\u5b9a\u4e49\u8bf7\u6c42/\u54cd\u5e94\u6a21\u578b\u3002</p> <pre><code># schemas/user.py\nfrom pydantic import BaseModel, EmailStr\n\nclass UserCreateRequest(BaseModel):\n    username: str\n    email: EmailStr\n    password: str\n\nclass UserResponse(BaseModel):\n    id: str\n    username: str\n    email: str\n\n    class Config:\n        from_attributes = True</code></pre> <p>\u804c\u8d23\uff1a - \u8bf7\u6c42\u9a8c\u8bc1 - \u54cd\u5e94\u5e8f\u5217\u5316 - \u6587\u6863\u751f\u6210</p>"},{"location":"04-project-structure/#_3","title":"\u5bfc\u5165\u7ec4\u7ec7","text":""},{"location":"04-project-structure/#_4","title":"\u6309\u5305\u7ec4\u7ec7","text":"<pre><code># main.py\nfrom api.v1 import users_router, orders_router\nfrom services import UserService, OrderService\nfrom repositories import UserRepository, OrderRepository</code></pre>"},{"location":"04-project-structure/#_5","title":"\u6309\u529f\u80fd\u7ec4\u7ec7","text":"<pre><code># services/__init__.py\nfrom .user_service import UserService\nfrom .order_service import OrderService\n\n__all__ = [\"UserService\", \"OrderService\"]</code></pre>"},{"location":"04-project-structure/#_6","title":"\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"04-project-structure/#_7","title":"\u5355\u4e00\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># config.py\nfrom aury.boot.application.config import BaseConfig\nfrom pydantic import Field\n\nclass AppConfig(BaseConfig):\n    app_name: str = Field(default=\"My Service\")\n    app_version: str = Field(default=\"0.1.0\")\n\n    # \u4e1a\u52a1\u914d\u7f6e\n    max_retries: int = Field(default=3)\n    cache_ttl: int = Field(default=3600)</code></pre>"},{"location":"04-project-structure/#mainpy","title":"\u5728 main.py \u4e2d\u4f7f\u7528","text":"<pre><code># main.py\nfrom config import AppConfig\nfrom aury.boot.application.app.base import FoundationApp\n\nconfig = AppConfig()\napp = FoundationApp(\n    title=config.app_name,\n    version=config.app_version,\n    config=config\n)</code></pre>"},{"location":"04-project-structure/#_8","title":"\u8def\u7531\u7ec4\u7ec7","text":""},{"location":"04-project-structure/#_9","title":"\u5206\u6a21\u5757\u8def\u7531","text":"<pre><code># main.py\nfrom fastapi import APIRouter\nfrom api.v1 import users, orders, payments\n\n# \u521b\u5efa\u4e3b\u8def\u7531\napi_router = APIRouter(prefix=\"/api/v1\")\napi_router.include_router(users.router, prefix=\"/users\", tags=[\"Users\"])\napi_router.include_router(orders.router, prefix=\"/orders\", tags=[\"Orders\"])\napi_router.include_router(payments.router, prefix=\"/payments\", tags=[\"Payments\"])\n\n# \u6ce8\u518c\u5230\u5e94\u7528\napp.include_router(api_router)</code></pre>"},{"location":"04-project-structure/#_10","title":"\u8def\u7531\u6587\u4ef6\u7ed3\u6784","text":"<pre><code># api/v1/users.py\nfrom fastapi import APIRouter, Depends\n\nrouter = APIRouter()\n\n# \u5b9a\u4e49\u8def\u7531\n@router.get(\"/{user_id}\")\nasync def get_user(user_id: str):\n    pass\n\n@router.post(\"\")\nasync def create_user(request: UserCreateRequest):\n    pass\n\n# \u6ce8\u610f\uff1a\u4e0d\u8981\u5728\u8fd9\u91cc\u521b\u5efa APIRouter \u7684\u5b9e\u4f8b</code></pre>"},{"location":"04-project-structure/#_11","title":"\u4f9d\u8d56\u7ba1\u7406","text":""},{"location":"04-project-structure/#_12","title":"\u4f7f\u7528\u5de5\u5382\u51fd\u6570","text":"<pre><code># main.py\nfrom aury.boot.infrastructure.di import Container\n\ncontainer = Container.get_instance()\n\n# \u6ce8\u518c\u670d\u52a1\ncontainer.register_singleton(UserRepository)\ncontainer.register_transient(UserService)\n\n# \u521b\u5efa\u5de5\u5382\u51fd\u6570\ndef get_user_service() -&gt; UserService:\n    return container.resolve(UserService)</code></pre>"},{"location":"04-project-structure/#_13","title":"\u5728\u8def\u7531\u4e2d\u4f7f\u7528","text":"<pre><code># api/v1/users.py\nfrom main import get_user_service\n\n@router.get(\"/{user_id}\")\nasync def get_user(\n    user_id: str,\n    service: UserService = Depends(get_user_service)\n):\n    user = await service.get_user(user_id)\n    return BaseResponse(code=200, message=\"\u6210\u529f\", data=user)</code></pre>"},{"location":"04-project-structure/#_14","title":"\u5f02\u5e38\u5904\u7406","text":""},{"location":"04-project-structure/#_15","title":"\u81ea\u5b9a\u4e49\u5f02\u5e38","text":"<p>\u5f02\u5e38\u5fc5\u987b\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\u7c7b\uff1a</p> <pre><code># exceptions/custom_errors.py\nfrom aury.boot.application.errors import (\n    NotFoundError,\n    UnauthorizedError,\n)\n\nclass UserNotFoundError(NotFoundError):\n    \"\"\"\u7528\u6237\u4e0d\u5b58\u5728\u5f02\u5e38\u3002\"\"\"\n    def __init__(self, user_id: str):\n        super().__init__(\n            message=f\"\u7528\u6237 {user_id} \u4e0d\u5b58\u5728\",\n            resource=user_id,\n        )\n\nclass InvalidCredentialsError(UnauthorizedError):\n    \"\"\"\u8eab\u4efd\u9a8c\u8bc1\u5931\u8d25\u5f02\u5e38\u3002\"\"\"\n    def __init__(self):\n        super().__init__(\n            message=\"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\",\n        )</code></pre>"},{"location":"04-project-structure/#_16","title":"\u5728\u670d\u52a1\u4e2d\u4f7f\u7528","text":"<pre><code># services/user_service.py\nfrom exceptions.custom_errors import UserNotFoundError\n\nasync def get_user(self, user_id: str):\n    user = await self.repo.get(user_id)\n    if not user:\n        raise UserNotFoundError(user_id)\n    return user</code></pre>"},{"location":"04-project-structure/#_17","title":"\u6d4b\u8bd5\u7ed3\u6784","text":""},{"location":"04-project-structure/#_18","title":"\u6d4b\u8bd5\u6587\u4ef6\u7ec4\u7ec7","text":"<pre><code>tests/\n\u251c\u2500\u2500 conftest.py              # \u5171\u4eab\u7684 fixtures\n\u251c\u2500\u2500 test_users.py            # \u7528\u6237 API \u6d4b\u8bd5\n\u251c\u2500\u2500 test_orders.py           # \u8ba2\u5355 API \u6d4b\u8bd5\n\u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 test_user_service.py\n\u2502   \u2514\u2500\u2500 test_order_service.py\n\u2514\u2500\u2500 repositories/\n    \u251c\u2500\u2500 test_user_repository.py\n    \u2514\u2500\u2500 test_order_repository.py\n</code></pre>"},{"location":"04-project-structure/#_19","title":"\u57fa\u7840\u6d4b\u8bd5\u793a\u4f8b","text":"<pre><code># tests/test_users.py\nimport pytest\nfrom fastapi.testclient import TestClient\nfrom main import app\n\nclient = TestClient(app)\n\n@pytest.mark.asyncio\nasync def test_get_user():\n    response = client.get(\"/api/v1/users/123\")\n    assert response.status_code == 200\n    assert response.json()[\"code\"] == 200</code></pre>"},{"location":"04-project-structure/#_20","title":"\u73af\u5883\u914d\u7f6e","text":""},{"location":"04-project-structure/#env","title":".env \u6587\u4ef6","text":"<pre><code># \u670d\u52a1\u5668\nSERVER_HOST=0.0.0.0\nSERVER_PORT=8000\nSERVER_WORKERS=1\n\n# \u6570\u636e\u5e93\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\n\n# \u7f13\u5b58\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\n\n# \u65e5\u5fd7\nLOG_LEVEL=INFO\nLOG_DIR=logs</code></pre>"},{"location":"04-project-structure/#envexample","title":".env.example","text":"<p>\u63d0\u4f9b\u4e00\u4e2a\u6a21\u677f\u6587\u4ef6\uff0c\u4f9b\u5f00\u53d1\u8005\u53c2\u8003\uff1a</p> <pre><code>cp .env.example .env</code></pre>"},{"location":"04-project-structure/#_21","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"04-project-structure/#q","title":"Q: \u4f55\u65f6\u62c6\u5206\u6587\u4ef6\uff1f","text":"<p>A: \u5f53\u6587\u4ef6\u8d85\u8fc7 300 \u884c\u65f6\uff0c\u8003\u8651\u62c6\u5206\u3002</p>"},{"location":"04-project-structure/#q_1","title":"Q: \u5982\u4f55\u7ec4\u7ec7\u5927\u578b\u9879\u76ee\uff1f","text":"<p>A: \u6309\u529f\u80fd\u57df\uff08domain\uff09\u800c\u4e0d\u662f\u6280\u672f\u5c42\u6765\u7ec4\u7ec7\u3002</p>"},{"location":"04-project-structure/#q_2","title":"Q: \u5982\u4f55\u5904\u7406\u8de8\u6a21\u5757\u4f9d\u8d56\uff1f","text":"<p>A: \u4f7f\u7528 DI \u5bb9\u5668\u548c\u62bd\u8c61\u63a5\u53e3\u3002</p>"},{"location":"04-project-structure/#_22","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 05-configuration-advanced.md \u4e86\u89e3\u9ad8\u7ea7\u914d\u7f6e</li> <li>\u67e5\u770b 06-di-container-complete.md \u4e86\u89e3\u4f9d\u8d56\u6ce8\u5165</li> </ul>"},{"location":"05-configuration-advanced/","title":"5. \u9ad8\u7ea7\u914d\u7f6e\u7ba1\u7406","text":""},{"location":"05-configuration-advanced/#_1","title":"\u914d\u7f6e\u4f53\u7cfb","text":"<p>Kit \u4f7f\u7528 Pydantic \u7684 <code>BaseSettings</code> \u5b9e\u73b0\u5206\u5c42\u914d\u7f6e\u7ba1\u7406\u3002</p>"},{"location":"05-configuration-advanced/#_2","title":"\u57fa\u7840\u914d\u7f6e\u7c7b","text":"<pre><code># config.py\nfrom aury.boot.application.config import BaseConfig\nfrom pydantic import Field\n\nclass AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n\n    # \u4e1a\u52a1\u914d\u7f6e\n    app_name: str = Field(default=\"My Service\", description=\"\u5e94\u7528\u540d\u79f0\")\n    max_retries: int = Field(default=3, description=\"\u6700\u5927\u91cd\u8bd5\u6b21\u6570\")\n    cache_ttl: int = Field(default=3600, description=\"\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\uff08\u79d2\uff09\")</code></pre>"},{"location":"05-configuration-advanced/#_3","title":"\u73af\u5883\u53d8\u91cf\u6620\u5c04","text":"<p>\u6240\u6709\u5b57\u6bb5\u81ea\u52a8\u6620\u5c04\u5230\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code># .env\nAPP_NAME=\"My Service\"\nMAX_RETRIES=3\nCACHE_TTL=3600\n\n# \u670d\u52a1\u5668\u914d\u7f6e\nSERVER_HOST=0.0.0.0\nSERVER_PORT=8000\n\n# \u6570\u636e\u5e93\u914d\u7f6e\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\n\n# \u7f13\u5b58\u914d\u7f6e\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0</code></pre>"},{"location":"05-configuration-advanced/#_4","title":"\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<p>\u6846\u67b6\u652f\u6301\u591a\u5b9e\u4f8b\u914d\u7f6e\uff0c\u73af\u5883\u53d8\u91cf\u683c\u5f0f\uff1a<code>{PREFIX}_{INSTANCE}_{FIELD}</code></p>"},{"location":"05-configuration-advanced/#_5","title":"\u6570\u636e\u5e93\u591a\u5b9e\u4f8b","text":"<pre><code># \u9ed8\u8ba4\u5b9e\u4f8b\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\n# \u7b49\u540c\u4e8e\nDATABASE_DEFAULT_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\n\n# \u53ea\u8bfb\u5b9e\u4f8b\nDATABASE_READONLY_URL=postgresql+asyncpg://user:pass@replica:5432/mydb\nDATABASE_READONLY_POOL_SIZE=20</code></pre>"},{"location":"05-configuration-advanced/#_6","title":"\u7f13\u5b58\u591a\u5b9e\u4f8b","text":"<pre><code># \u9ed8\u8ba4\u5b9e\u4f8b\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\n\n# \u4f1a\u8bdd\u7f13\u5b58\u5b9e\u4f8b\nCACHE_SESSION_TYPE=redis\nCACHE_SESSION_URL=redis://localhost:6379/2\nCACHE_SESSION_MAX_SIZE=5000</code></pre>"},{"location":"05-configuration-advanced/#_7","title":"\u5728\u4ee3\u7801\u4e2d\u83b7\u53d6\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<pre><code>from aury.boot.application.config import BaseConfig\n\nconfig = BaseConfig()\n\n# \u83b7\u53d6\u6240\u6709\u6570\u636e\u5e93\u5b9e\u4f8b\u914d\u7f6e\ndb_instances = config.get_database_instances()\n# \u8fd4\u56de: {\"default\": DatabaseInstanceConfig(...), \"readonly\": DatabaseInstanceConfig(...)}\n\n# \u83b7\u53d6\u6240\u6709\u7f13\u5b58\u5b9e\u4f8b\u914d\u7f6e\ncache_instances = config.get_cache_instances()\n# \u8fd4\u56de: {\"default\": CacheInstanceConfig(...), \"session\": CacheInstanceConfig(...)}\n\n# \u652f\u6301\u7684\u591a\u5b9e\u4f8b\u7c7b\u578b\uff1a\n# - get_database_instances()\n# - get_cache_instances()\n# - get_storage_instances()\n# - get_channel_instances()\n# - get_mq_instances()\n# - get_event_instances()</code></pre>"},{"location":"05-configuration-advanced/#_8","title":"\u5206\u5c42\u914d\u7f6e","text":""},{"location":"05-configuration-advanced/#_9","title":"\u7ec4\u7ec7\u914d\u7f6e\u6587\u4ef6","text":"<pre><code># config.py\nfrom aury.boot.application.config import BaseConfig\nfrom pydantic import Field\n\n# ========== \u5e94\u7528\u914d\u7f6e ==========\nclass ApplicationSettings(BaseModel):\n    \"\"\"\u5e94\u7528\u7ea7\u522b\u914d\u7f6e\"\"\"\n    name: str = Field(default=\"My Service\")\n    version: str = Field(default=\"0.1.0\")\n    debug: bool = Field(default=False)\n\n# ========== \u4e1a\u52a1\u914d\u7f6e ==========\nclass BusinessSettings(BaseModel):\n    \"\"\"\u4e1a\u52a1\u7ea7\u522b\u914d\u7f6e\"\"\"\n    max_retries: int = Field(default=3)\n    timeout: int = Field(default=30)\n    cache_ttl: int = Field(default=3600)\n\n# ========== \u96c6\u6210\u914d\u7f6e ==========\nclass AppConfig(BaseConfig):\n    \"\"\"\u603b\u914d\u7f6e\"\"\"\n\n    # \u5e94\u7528\u8bbe\u7f6e\n    app: ApplicationSettings = Field(default_factory=ApplicationSettings)\n\n    # \u4e1a\u52a1\u8bbe\u7f6e\n    business: BusinessSettings = Field(default_factory=BusinessSettings)\n\n    class Config:\n        env_nested_delimiter = \"__\"  # \u652f\u6301 APP__NAME \u8fd9\u6837\u7684\u5d4c\u5957\u73af\u5883\u53d8\u91cf</code></pre>"},{"location":"05-configuration-advanced/#_10","title":"\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528","text":"<pre><code>from config import AppConfig\n\nconfig = AppConfig()\n\n# \u8bbf\u95ee\u5e94\u7528\u914d\u7f6e\napp_name = config.app.name\n\n# \u8bbf\u95ee\u4e1a\u52a1\u914d\u7f6e\nmax_retries = config.business.max_retries\n\n# \u8bbf\u95ee\u6846\u67b6\u914d\u7f6e\ndatabase_url = config.database.url</code></pre>"},{"location":"05-configuration-advanced/#_11","title":"\u73af\u5883\u7279\u5b9a\u914d\u7f6e","text":""},{"location":"05-configuration-advanced/#_12","title":"\u5f00\u53d1/\u751f\u4ea7\u914d\u7f6e\u5207\u6362","text":"<pre><code># config.py\nimport os\nfrom aury.boot.application.config import BaseConfig\nfrom pydantic import Field\n\nclass AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n\n    # \u68c0\u6d4b\u73af\u5883\n    environment: str = Field(default=\"development\")\n\n    # \u6839\u636e\u73af\u5883\u8c03\u6574\u914d\u7f6e\n    @property\n    def is_production(self) -&gt; bool:\n        return self.environment == \"production\"\n\n    @property\n    def is_development(self) -&gt; bool:\n        return self.environment == \"development\"\n\n# \u5728 main.py \u4e2d\nconfig = AppConfig()\n\nif config.is_development:\n    # \u5f00\u53d1\u7279\u5b9a\u914d\u7f6e\n    pass\nelse:\n    # \u751f\u4ea7\u7279\u5b9a\u914d\u7f6e\n    pass</code></pre>"},{"location":"05-configuration-advanced/#_13","title":"\u73af\u5883\u53d8\u91cf\u6587\u4ef6","text":"<pre><code># .env.development\nENVIRONMENT=development\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/dev_db\nLOG_LEVEL=DEBUG\nDEBUG=true\n\n# .env.production\nENVIRONMENT=production\nDATABASE_URL=postgresql+asyncpg://user:pass@prod-db:5432/prod_db\nLOG_LEVEL=INFO\nDEBUG=false</code></pre>"},{"location":"05-configuration-advanced/#_14","title":"\u9a8c\u8bc1\u914d\u7f6e","text":""},{"location":"05-configuration-advanced/#_15","title":"\u81ea\u5b9a\u4e49\u9a8c\u8bc1\u5668","text":"<pre><code>from pydantic import BaseModel, field_validator, Field\n\nclass AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n\n    max_retries: int = Field(ge=1, le=10, description=\"\u91cd\u8bd5\u6b21\u6570\uff081-10\uff09\")\n    cache_ttl: int = Field(gt=0, description=\"\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\uff08&gt;0\uff09\")\n\n    @field_validator('cache_ttl')\n    @classmethod\n    def validate_cache_ttl(cls, v):\n        if v &lt; 60:\n            raise ValueError(\"\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\u4e0d\u80fd\u5c11\u4e8e 60 \u79d2\")\n        return v\n\n    @field_validator('database_url')\n    @classmethod\n    def validate_database_url(cls, v):\n        if not v.startswith(('postgresql:', 'mysql:', 'sqlite:')):\n            raise ValueError(\"\u6570\u636e\u5e93 URL \u683c\u5f0f\u4e0d\u652f\u6301\")\n        return v</code></pre>"},{"location":"05-configuration-advanced/#_16","title":"\u914d\u7f6e\u52a0\u8f7d\u4f18\u5148\u7ea7","text":"<p>\u4ece\u9ad8\u5230\u4f4e\uff1a</p> <ol> <li>\u4ee3\u7801\u4e2d\u663e\u5f0f\u4f20\u5165\u7684\u503c</li> <li>\u73af\u5883\u53d8\u91cf</li> <li>.env \u6587\u4ef6</li> <li>\u5b57\u6bb5\u9ed8\u8ba4\u503c</li> </ol> <pre><code># \u4f18\u5148\u7ea7\u6f14\u793a\nclass AppConfig(BaseConfig):\n    host: str = Field(default=\"127.0.0.1\")  # 3. \u9ed8\u8ba4\u503c\n\n# .env \u6587\u4ef6\u4e2d\n# HOST=0.0.0.0  # 2. \u73af\u5883\u53d8\u91cf\n\n# \u4ee3\u7801\u4e2d\nconfig = AppConfig(host=\"0.0.0.0\")  # 1. \u663e\u5f0f\u4f20\u5165\n\n# \u6700\u7ec8\uff1aconfig.host = \"0.0.0.0\"\uff08\u4ee3\u7801\u4e2d\u7684\u503c\uff09</code></pre>"},{"location":"05-configuration-advanced/#_17","title":"\u914d\u7f6e\u6587\u4ef6\u52a0\u8f7d","text":""},{"location":"05-configuration-advanced/#env","title":"\u624b\u52a8\u6307\u5b9a .env \u6587\u4ef6","text":"<pre><code>from dotenv import load_dotenv\nfrom config import AppConfig\n\n# \u52a0\u8f7d\u7279\u5b9a\u7684 .env \u6587\u4ef6\nload_dotenv(\".env.production\")\n\nconfig = AppConfig()</code></pre>"},{"location":"05-configuration-advanced/#env_1","title":"\u57fa\u4e8e\u73af\u5883\u9009\u62e9 .env \u6587\u4ef6","text":"<pre><code>import os\nfrom dotenv import load_dotenv\nfrom config import AppConfig\n\nenv = os.getenv(\"ENVIRONMENT\", \"development\")\nenv_file = f\".env.{env}\"\n\nif os.path.exists(env_file):\n    load_dotenv(env_file)\n\nconfig = AppConfig()</code></pre>"},{"location":"05-configuration-advanced/#_18","title":"\u654f\u611f\u4fe1\u606f\u5904\u7406","text":""},{"location":"05-configuration-advanced/#_19","title":"\u907f\u514d\u6cc4\u9732\u654f\u611f\u4fe1\u606f","text":"<pre><code>class AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n\n    database_url: str = Field(description=\"\u6570\u636e\u5e93\u8fde\u63a5\u5b57\u7b26\u4e32\")\n    api_key: str = Field(description=\"API \u5bc6\u94a5\")\n    secret_key: str = Field(description=\"\u5e94\u7528\u5bc6\u94a5\")\n\n    def __str__(self):\n        # \u4e0d\u8981\u5728\u5b57\u7b26\u4e32\u8868\u793a\u4e2d\u66b4\u9732\u654f\u611f\u4fe1\u606f\n        return f\"AppConfig(database=***,api_key=***,secret_key=***)\"\n\n    def model_dump(self):\n        # \u4e0d\u8981\u5bfc\u51fa\u654f\u611f\u4fe1\u606f\n        data = super().model_dump()\n        data[\"database_url\"] = \"***\"\n        data[\"api_key\"] = \"***\"\n        data[\"secret_key\"] = \"***\"\n        return data</code></pre>"},{"location":"05-configuration-advanced/#_20","title":"\u4ece\u73af\u5883\u53d8\u91cf\u8bfb\u53d6\u654f\u611f\u4fe1\u606f","text":"<pre><code># \u4e0d\u8981\u5728 .env \u4e2d\u786c\u7f16\u7801\u654f\u611f\u4fe1\u606f\uff01\n# \u800c\u662f\u4ece\u7cfb\u7edf\u73af\u5883\u53d8\u91cf\u4e2d\u8bfb\u53d6\n\n# \u5bb9\u5668/CI \u7cfb\u7edf\u4e2d\u8bbe\u7f6e\nexport DATABASE_PASSWORD=\"secure_password\"\nexport API_KEY=\"secret_key\"</code></pre>"},{"location":"05-configuration-advanced/#_21","title":"\u52a8\u6001\u914d\u7f6e","text":""},{"location":"05-configuration-advanced/#_22","title":"\u8fd0\u884c\u65f6\u66f4\u65b0\u914d\u7f6e","text":"<pre><code>from typing import Any\n\nclass AppConfig(BaseConfig):\n    \"\"\"\u5e94\u7528\u914d\u7f6e\"\"\"\n\n    cache_ttl: int = Field(default=3600)\n    debug: bool = Field(default=False)\n\n    def set_debug(self, enabled: bool):\n        \"\"\"\u8bbe\u7f6e\u8c03\u8bd5\u6a21\u5f0f\"\"\"\n        self.debug = enabled\n\n    def set_cache_ttl(self, ttl: int):\n        \"\"\"\u8bbe\u7f6e\u7f13\u5b58\u8fc7\u671f\u65f6\u95f4\"\"\"\n        if ttl &lt; 60:\n            raise ValueError(\"\u6700\u5c0f 60 \u79d2\")\n        self.cache_ttl = ttl</code></pre>"},{"location":"05-configuration-advanced/#_23","title":"\u914d\u7f6e\u91cd\u65b0\u52a0\u8f7d","text":"<pre><code>import signal\nfrom config import AppConfig\n\nconfig = AppConfig()\n\ndef reload_config(signum, frame):\n    \"\"\"\u5904\u7406 SIGHUP \u4fe1\u53f7\uff0c\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\"\"\"\n    global config\n    config = AppConfig()\n    print(\"\u914d\u7f6e\u5df2\u91cd\u65b0\u52a0\u8f7d\")\n\nsignal.signal(signal.SIGHUP, reload_config)</code></pre>"},{"location":"05-configuration-advanced/#_24","title":"\u914d\u7f6e\u6587\u6863","text":""},{"location":"05-configuration-advanced/#_25","title":"\u81ea\u52a8\u751f\u6210\u914d\u7f6e\u6587\u6863","text":"<pre><code>from config import AppConfig\nimport json\n\n# \u751f\u6210 JSON Schema\nschema = AppConfig.model_json_schema()\nprint(json.dumps(schema, indent=2, ensure_ascii=False))\n\n# \u751f\u6210 Markdown \u6587\u6863\ndef generate_config_docs(config_class):\n    schema = config_class.model_json_schema()\n    for field, details in schema[\"properties\"].items():\n        print(f\"- `{field}` ({details.get('type', 'string')})\")\n        print(f\"  {details.get('description', 'No description')}\")\n\ngenerate_config_docs(AppConfig)</code></pre>"},{"location":"05-configuration-advanced/#_26","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"05-configuration-advanced/#q","title":"Q: \u5982\u4f55\u5904\u7406\u5fc5\u9700\u7684\u914d\u7f6e\uff1f","text":"<p>A: \u4e0d\u8bbe\u7f6e\u9ed8\u8ba4\u503c\uff0cPydantic \u4f1a\u81ea\u52a8\u9a8c\u8bc1\u5fc5\u9700\u5b57\u6bb5\u3002</p> <pre><code>class AppConfig(BaseConfig):\n    database_url: str  # \u5fc5\u9700\uff0c\u6ca1\u6709\u9ed8\u8ba4\u503c\n    # \u5bf9\u5e94\u7684\u73af\u5883\u53d8\u91cf\u5fc5\u987b\u8bbe\u7f6e</code></pre>"},{"location":"05-configuration-advanced/#q_1","title":"Q: \u5982\u4f55\u5904\u7406\u5217\u8868/\u5b57\u5178\u7c7b\u578b\u7684\u73af\u5883\u53d8\u91cf\uff1f","text":"<p>A: \u4f7f\u7528 JSON \u683c\u5f0f\u3002</p> <pre><code># .env\nRPC_SERVICES='{\"user-service\": \"http://localhost:8001\", \"order-service\": \"http://localhost:8002\"}'\nALLOWED_HOSTS='[\"localhost\", \"127.0.0.1\"]'</code></pre> <pre><code>class AppConfig(BaseConfig):\n    rpc_services: dict = Field(default_factory=dict)\n    allowed_hosts: list = Field(default_factory=list)</code></pre>"},{"location":"05-configuration-advanced/#q_2","title":"Q: \u5982\u4f55\u6d4b\u8bd5\u914d\u7f6e\uff1f","text":"<p>A: \u4f7f\u7528\u4e34\u65f6 .env \u6587\u4ef6\u6216\u73af\u5883\u53d8\u91cf\u3002</p> <pre><code>import pytest\nfrom dotenv import load_dotenv\nfrom config import AppConfig\n\n@pytest.fixture\ndef test_config(tmp_path):\n    env_file = tmp_path / \".env.test\"\n    env_file.write_text(\"DATABASE_URL=sqlite:///test.db\\n\")\n    load_dotenv(env_file)\n    return AppConfig()</code></pre>"},{"location":"05-configuration-advanced/#_27","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 06-di-container-complete.md \u4e86\u89e3\u4f9d\u8d56\u6ce8\u5165</li> <li>\u67e5\u770b 04-project-structure.md \u4e86\u89e3\u9879\u76ee\u7ec4\u7ec7</li> </ul>"},{"location":"06-di-container-complete/","title":"5. \u4f9d\u8d56\u6ce8\u5165\u5bb9\u5668 - \u5b8c\u5168\u6307\u5357","text":""},{"location":"06-di-container-complete/#_1","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"06-di-container-complete/#_2","title":"\u4ec0\u4e48\u662f\u4f9d\u8d56\u6ce8\u5165\uff1f","text":"<p>\u4f9d\u8d56\u6ce8\u5165\uff08DI\uff09\u662f\u4e00\u79cd\u8bbe\u8ba1\u6a21\u5f0f\uff0c\u7528\u4e8e\u89e3\u8026\u7ec4\u4ef6\u95f4\u7684\u4f9d\u8d56\u5173\u7cfb\u3002\u4e0d\u662f\u5728\u7c7b\u5185\u90e8\u521b\u5efa\u4f9d\u8d56\uff0c\u800c\u662f\u4ece\u5916\u90e8\"\u6ce8\u5165\"\u5b83\u4eec\u3002</p>"},{"location":"06-di-container-complete/#di","title":"\u4e3a\u4ec0\u4e48\u9700\u8981 DI\uff1f","text":"<pre><code># \u274c \u6ca1\u6709 DI\uff1a\u786c\u7f16\u7801\u4f9d\u8d56\uff0c\u96be\u4ee5\u6d4b\u8bd5\nclass UserService:\n    def __init__(self):\n        self.db = Database()  # \u786c\u7f16\u7801\uff0c\u65e0\u6cd5\u6d4b\u8bd5\n        self.cache = Cache()\n\n    async def get_user(self, user_id):\n        return await self.db.get(user_id)\n\n# \u6d4b\u8bd5\u65f6\u65e0\u6cd5\u4f7f\u7528 Mock \u6570\u636e\u5e93\n\n# \u2705 \u4f7f\u7528 DI\uff1a\u4f9d\u8d56\u4ece\u5916\u90e8\u6ce8\u5165\uff0c\u6613\u4e8e\u6d4b\u8bd5\nclass UserService:\n    def __init__(self, db: IUserRepository, cache: CacheManager):\n        self.db = db\n        self.cache = cache\n\n    async def get_user(self, user_id):\n        return await self.db.get(user_id)\n\n# \u6d4b\u8bd5\u65f6\u53ef\u4ee5\u4f20\u5165 Mock \u5bf9\u8c61</code></pre>"},{"location":"06-di-container-complete/#container","title":"Container \u7684\u751f\u547d\u5468\u671f","text":""},{"location":"06-di-container-complete/#singleton","title":"SINGLETON\uff08\u5355\u4f8b\uff09","text":"<p>\u6574\u4e2a\u5e94\u7528\u751f\u547d\u5468\u671f\u53ea\u521b\u5efa\u4e00\u6b21\u3002</p> <p>\u4f55\u65f6\u4f7f\u7528\uff1a - \u6570\u636e\u5e93\u8fde\u63a5\u6c60\uff08\u521b\u5efa\u6210\u672c\u9ad8\uff0c\u53ef\u590d\u7528\uff09 - \u7f13\u5b58\u5ba2\u6237\u7aef\uff08Redis\u3001Memcached\uff09 - \u914d\u7f6e\u5bf9\u8c61 - \u65e5\u5fd7\u7ba1\u7406\u5668</p> <p>\u793a\u4f8b\uff1a</p> <pre><code>container = Container.get_instance()\n\n# \u6ce8\u518c\u5355\u4f8b\ncontainer.register_singleton(DatabaseManager)\ncontainer.register_singleton(CacheManager)\n\n# \u7b2c\u4e00\u6b21\u89e3\u6790\u65f6\u521b\u5efa\ndb1 = container.resolve(DatabaseManager)\n# \u540e\u7eed\u89e3\u6790\u8fd4\u56de\u540c\u4e00\u5b9e\u4f8b\ndb2 = container.resolve(DatabaseManager)\nassert db1 is db2  # True</code></pre>"},{"location":"06-di-container-complete/#scoped","title":"SCOPED\uff08\u4f5c\u7528\u57df\uff09","text":"<p>\u6bcf\u4e2a\u4f5c\u7528\u57df\u5185\u53ea\u521b\u5efa\u4e00\u6b21\uff0c\u4f5c\u7528\u57df\u5916\u65b0\u5efa\u3002</p> <p>\u4f55\u65f6\u4f7f\u7528\uff1a - \u6570\u636e\u5e93\u4f1a\u8bdd\uff08\u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a\u4f1a\u8bdd\uff09 - \u7528\u6237\u4e0a\u4e0b\u6587\uff08\u8bf7\u6c42\u7ea7\u522b\u7684\u7528\u6237\u4fe1\u606f\uff09 - \u4e8b\u52a1\u7ba1\u7406\u5668</p> <p>\u793a\u4f8b\uff1a</p> <pre><code>container.register_scoped(DatabaseSession)\n\n# \u4f5c\u7528\u57df 1\nwith container.create_scope() as scope1:\n    session1a = scope1.resolve(DatabaseSession)\n    session1b = scope1.resolve(DatabaseSession)\n    assert session1a is session1b  # \u540c\u4e00\u4f5c\u7528\u57df\uff0c\u540c\u4e00\u5b9e\u4f8b\n\n# \u4f5c\u7528\u57df 2\nwith container.create_scope() as scope2:\n    session2 = scope2.resolve(DatabaseSession)\n    assert session2 is not session1a  # \u4e0d\u540c\u4f5c\u7528\u57df\uff0c\u4e0d\u540c\u5b9e\u4f8b</code></pre>"},{"location":"06-di-container-complete/#transient","title":"TRANSIENT\uff08\u77ac\u65f6\uff09","text":"<p>\u6bcf\u6b21\u90fd\u521b\u5efa\u65b0\u5b9e\u4f8b\u3002</p> <p>\u4f55\u65f6\u4f7f\u7528\uff1a - \u4e1a\u52a1\u903b\u8f91\u670d\u52a1\uff08\u65e0\u72b6\u6001\u7684\u670d\u52a1\uff09 - \u6570\u636e\u5904\u7406\u5de5\u5177 - \u4e34\u65f6\u5bf9\u8c61</p> <p>\u793a\u4f8b\uff1a</p> <pre><code>container.register_transient(UserService)\n\nservice1 = container.resolve(UserService)\nservice2 = container.resolve(UserService)\nassert service1 is not service2  # \u4e0d\u540c\u5b9e\u4f8b</code></pre>"},{"location":"06-di-container-complete/#_3","title":"\u6ce8\u518c\u65b9\u5f0f\u8be6\u89e3","text":""},{"location":"06-di-container-complete/#1","title":"1. \u901a\u8fc7\u5b9e\u73b0\u7c7b\u6ce8\u518c","text":"<pre><code># \u6700\u7b80\u5355\u7684\u65b9\u5f0f\ncontainer.register_singleton(UserRepository)\n\n# \u7b49\u4ef7\u4e8e\uff1a\u901a\u8fc7\u7c7b\u578b\u6ce8\u89e3\u81ea\u52a8\u89e3\u6790\uff0c\u521b\u5efa UserRepository()\nrepo = container.resolve(UserRepository)</code></pre>"},{"location":"06-di-container-complete/#2","title":"2. \u901a\u8fc7\u63a5\u53e3\u6ce8\u518c\uff08\u63a8\u8350\uff09","text":"<p>\u5b9e\u73b0\u591a\u6001\u548c\u66f4\u597d\u7684\u6d4b\u8bd5\u80fd\u529b\u3002</p> <pre><code>from abc import ABC, abstractmethod\n\nclass IUserRepository(ABC):\n    @abstractmethod\n    async def get_by_id(self, user_id: str): ...\n\nclass UserRepository(IUserRepository):\n    async def get_by_id(self, user_id: str):\n        # \u5b9e\u73b0\n        pass\n\n# \u6ce8\u518c\u65f6\u4f7f\u7528\u63a5\u53e3\ncontainer.register_singleton(IUserRepository, UserRepository)\n\n# \u4f9d\u8d56\u65f6\u4f7f\u7528\u63a5\u53e3\nclass UserService:\n    def __init__(self, repo: IUserRepository):  # \u4f9d\u8d56\u63a5\u53e3\n        self.repo = repo\n\n# \u6d4b\u8bd5\u65f6\u53ef\u4ee5\u6ce8\u5165 Mock \u5b9e\u73b0\nclass MockUserRepository(IUserRepository):\n    async def get_by_id(self, user_id: str):\n        return {\"id\": user_id, \"name\": \"Mock\"}</code></pre>"},{"location":"06-di-container-complete/#3","title":"3. \u901a\u8fc7\u5de5\u5382\u51fd\u6570\u6ce8\u518c","text":"<p>\u5bf9\u4e8e\u9700\u8981\u590d\u6742\u521d\u59cb\u5316\u903b\u8f91\u7684\u5bf9\u8c61\u3002</p> <pre><code>def create_user_repository(container: Container) -&gt; UserRepository:\n    \"\"\"\u5de5\u5382\u51fd\u6570\u63a5\u6536\u5bb9\u5668\u4f5c\u4e3a\u53c2\u6570\"\"\"\n    # \u624b\u52a8\u521b\u5efa\u4f9d\u8d56\n    session = container.resolve(DatabaseSession)\n    config = container.resolve(BaseConfig)\n\n    # \u81ea\u5b9a\u4e49\u521d\u59cb\u5316\n    repo = UserRepository(session)\n    repo.set_timeout(config.database.timeout)\n    repo.set_pool_size(config.database.pool_size)\n\n    return repo\n\n# \u6ce8\u518c\ncontainer.register(\n    UserRepository,\n    factory=create_user_repository,\n    lifetime=Lifetime.SCOPED\n)\n\n# \u89e3\u6790\u65f6\u81ea\u52a8\u8c03\u7528\u5de5\u5382\u51fd\u6570\nrepo = container.resolve(UserRepository)</code></pre>"},{"location":"06-di-container-complete/#4","title":"4. \u6ce8\u518c\u5b9e\u4f8b","text":"<pre><code># \u76f4\u63a5\u6ce8\u518c\u5df2\u6709\u7684\u5b9e\u4f8b\nconfig = BaseConfig()\ncontainer.register_instance(BaseConfig, config)\n\n# \u89e3\u6790\u65f6\u8fd4\u56de\u8be5\u5b9e\u4f8b\nsame_config = container.resolve(BaseConfig)\nassert same_config is config  # True</code></pre>"},{"location":"06-di-container-complete/#_4","title":"\u81ea\u52a8\u4f9d\u8d56\u89e3\u6790","text":"<p>Kit \u7684 DI \u5bb9\u5668\u53ef\u4ee5\u81ea\u52a8\u68c0\u6d4b\u6784\u9020\u51fd\u6570\u53c2\u6570\u5e76\u4ece\u5bb9\u5668\u4e2d\u89e3\u6790\u3002</p>"},{"location":"06-di-container-complete/#_5","title":"\u5de5\u4f5c\u539f\u7406","text":"<pre><code>class UserService:\n    def __init__(self, repo: UserRepository, cache: CacheManager):\n        \"\"\"\n        \u901a\u8fc7\u7c7b\u578b\u6ce8\u89e3\uff0c\u5bb9\u5668\u4f1a\u81ea\u52a8\uff1a\n        1. \u68c0\u6d4b\u53c2\u6570 repo \u9700\u8981 UserRepository\n        2. \u68c0\u6d4b\u53c2\u6570 cache \u9700\u8981 CacheManager\n        3. \u4ece\u5bb9\u5668\u89e3\u6790\u8fd9\u4e24\u4e2a\u4f9d\u8d56\n        4. \u521b\u5efa UserService \u5b9e\u4f8b\u5e76\u6ce8\u5165\n        \"\"\"\n        self.repo = repo\n        self.cache = cache\n\n# \u6ce8\u518c\ncontainer.register_singleton(UserRepository)\ncontainer.register_singleton(CacheManager)\ncontainer.register_transient(UserService)\n\n# \u89e3\u6790\u65f6\u81ea\u52a8\u6ce8\u5165\u6240\u6709\u4f9d\u8d56\nservice = container.resolve(UserService)\n# \u7b49\u4ef7\u4e8e\uff1a\n# service = UserService(\n#     repo=container.resolve(UserRepository),\n#     cache=container.resolve(CacheManager)\n# )</code></pre>"},{"location":"06-di-container-complete/#_6","title":"\u4f9d\u8d56\u94fe","text":"<p>\u5bb9\u5668\u81ea\u52a8\u5904\u7406\u4f9d\u8d56\u7684\u4f9d\u8d56\u3002</p> <pre><code>class DatabaseSession:\n    def __init__(self, config: BaseConfig):\n        self.config = config\n\nclass UserRepository:\n    def __init__(self, session: DatabaseSession):\n        self.session = session\n\nclass UserService:\n    def __init__(self, repo: UserRepository):\n        self.repo = repo\n\n# \u6ce8\u518c\ncontainer.register_instance(BaseConfig, config)\ncontainer.register_scoped(DatabaseSession)\ncontainer.register_scoped(UserRepository)\ncontainer.register_transient(UserService)\n\n# \u89e3\u6790\u65f6\u81ea\u52a8\u94fe\u5f0f\u4f9d\u8d56\nservice = container.resolve(UserService)\n# \u5185\u90e8\u6267\u884c\u987a\u5e8f\uff1a\n# 1. \u89e3\u6790 UserService\uff0c\u9700\u8981 UserRepository\n# 2. \u89e3\u6790 UserRepository\uff0c\u9700\u8981 DatabaseSession\n# 3. \u89e3\u6790 DatabaseSession\uff0c\u9700\u8981 BaseConfig\n# 4. \u8fd4\u56de BaseConfig \u5b9e\u4f8b\n# 5. \u521b\u5efa DatabaseSession(config)\n# 6. \u521b\u5efa UserRepository(session)\n# 7. \u521b\u5efa UserService(repo)</code></pre>"},{"location":"06-di-container-complete/#_7","title":"\u4f5c\u7528\u57df\u7ba1\u7406","text":""},{"location":"06-di-container-complete/#_8","title":"\u8bf7\u6c42\u7ea7\u522b\u7684\u4f5c\u7528\u57df","text":"<p>\u5728 Web \u8bf7\u6c42\u4e2d\u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u521b\u5efa\u72ec\u7acb\u4f5c\u7528\u57df\u3002</p> <pre><code>from fastapi import APIRouter, Request\n\nrouter = APIRouter()\ncontainer = Container.get_instance()\n\n# \u5728\u5e94\u7528\u542f\u52a8\u65f6\u6ce8\u518c\ncontainer.register_singleton(UserService)\ncontainer.register_scoped(UserRepository)\ncontainer.register_scoped(DatabaseSession)\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, request: Request):\n    # \u4e3a\u6bcf\u4e2a\u8bf7\u6c42\u521b\u5efa\u72ec\u7acb\u4f5c\u7528\u57df\n    with container.create_scope() as scope:\n        # \u5728\u8fd9\u4e2a\u4f5c\u7528\u57df\u5185\uff0cSCOPED \u670d\u52a1\u4f1a\u88ab\u590d\u7528\n        service = scope.resolve(UserService)\n        user = await service.get_user(user_id)\n        return user\n    # \u4f5c\u7528\u57df\u9000\u51fa\u65f6\uff0c\u6240\u6709 SCOPED \u8d44\u6e90\u81ea\u52a8\u6e05\u7406</code></pre>"},{"location":"06-di-container-complete/#_9","title":"\u81ea\u52a8\u6e05\u7406","text":"<pre><code>class DatabaseSession:\n    def __init__(self):\n        self.connection = None\n\n    async def connect(self):\n        self.connection = await create_db_connection()\n\n    async def disconnect(self):\n        if self.connection:\n            await self.connection.close()\n\n# \u5728\u5de5\u5382\u51fd\u6570\u4e2d\u8bbe\u7f6e\u6e05\u7406\u903b\u8f91\nasync def create_session(container: Container):\n    session = DatabaseSession()\n    await session.connect()\n\n    # \u8fd4\u56de\u65f6\u8bbe\u7f6e\u6e05\u7406\u56de\u8c03\n    # \uff08\u5b9e\u9645\u5b9e\u73b0\u9700\u8981\u5728 Scope \u4e2d\u652f\u6301 on_exit \u94a9\u5b50\uff09\n\n    return session\n\nwith container.create_scope() as scope:\n    session = scope.resolve(DatabaseSession)\n    # \u4f7f\u7528 session...\n# \u9000\u51fa\u4f5c\u7528\u57df\u65f6\u81ea\u52a8\u8c03\u7528\u6e05\u7406</code></pre>"},{"location":"06-di-container-complete/#fastapi-depends","title":"\u4e0e FastAPI Depends \u96c6\u6210","text":"<p>Kit DI \u4e0e FastAPI \u7684 <code>Depends()</code> \u5b8c\u7f8e\u914d\u5408\u3002</p> <pre><code>from fastapi import APIRouter, Depends\nfrom aury.boot.infrastructure.di import Container\n\nrouter = APIRouter()\ncontainer = Container.get_instance()\n\n# \u5728\u5e94\u7528\u542f\u52a8\u65f6\u6ce8\u518c\ncontainer.register_singleton(UserService)\n\n# \u521b\u5efa FastAPI \u4f9d\u8d56\u51fd\u6570\ndef get_user_service() -&gt; UserService:\n    return container.resolve(UserService)\n\n# \u5728\u8def\u7531\u4e2d\u4f7f\u7528\n@router.get(\"/users\")\nasync def list_users(service: UserService = Depends(get_user_service)):\n    \"\"\"\n    FastAPI \u6d41\u7a0b\uff1a\n    1. \u68c0\u6d4b\u5230 Depends(get_user_service)\n    2. \u8c03\u7528 get_user_service()\n    3. \u83b7\u5f97 UserService \u5b9e\u4f8b\n    4. \u6ce8\u5165\u5230 list_users()\n    \"\"\"\n    return await service.list_all()</code></pre>"},{"location":"06-di-container-complete/#_10","title":"\u5e38\u89c1\u6a21\u5f0f","text":""},{"location":"06-di-container-complete/#1_1","title":"1. \u5206\u5c42\u6ce8\u518c","text":"<pre><code>def setup_container(config: BaseConfig):\n    container = Container.get_instance()\n\n    # \u914d\u7f6e\u5c42\n    container.register_instance(BaseConfig, config)\n\n    # \u57fa\u7840\u8bbe\u65bd\u5c42\n    container.register_singleton(DatabaseManager)\n    container.register_singleton(CacheManager)\n\n    # \u6570\u636e\u8bbf\u95ee\u5c42\uff08SCOPED - \u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a\uff09\n    container.register_scoped(UserRepository)\n    container.register_scoped(OrderRepository)\n\n    # \u4e1a\u52a1\u903b\u8f91\u5c42\uff08TRANSIENT - \u6bcf\u6b21\u521b\u5efa\u65b0\u7684\uff09\n    container.register_transient(UserService)\n    container.register_transient(OrderService)</code></pre>"},{"location":"06-di-container-complete/#2_1","title":"2. \u5de5\u5382\u6a21\u5f0f\u7ec4\u5408","text":"<pre><code>def create_user_service(container: Container) -&gt; UserService:\n    repo = container.resolve(UserRepository)\n    cache = container.resolve(CacheManager)\n    logger = container.resolve(Logger)\n    return UserService(repo, cache, logger)\n\ncontainer.register(\n    UserService,\n    factory=create_user_service,\n    lifetime=Lifetime.TRANSIENT\n)</code></pre>"},{"location":"06-di-container-complete/#3_1","title":"3. \u6d4b\u8bd5\u4e2d\u7684\u4f9d\u8d56\u66ff\u6362","text":"<pre><code># \u6d4b\u8bd5\ndef test_user_service():\n    # \u521b\u5efa\u6d4b\u8bd5\u5bb9\u5668\n    test_container = Container()\n\n    # \u6ce8\u518c Mock \u5b9e\u73b0\n    mock_repo = AsyncMock(spec=UserRepository)\n    mock_repo.get_by_id.return_value = {\"id\": \"1\", \"name\": \"Test\"}\n\n    test_container.register_instance(UserRepository, mock_repo)\n    test_container.register_transient(UserService)\n\n    # \u6d4b\u8bd5\n    service = test_container.resolve(UserService)\n    result = await service.get_user(\"1\")\n\n    assert result[\"name\"] == \"Test\"\n    mock_repo.get_by_id.assert_called_once_with(\"1\")</code></pre>"},{"location":"06-di-container-complete/#_11","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"06-di-container-complete/#_12","title":"\u2705 \u63a8\u8350\u505a\u6cd5","text":"<ol> <li> <p>\u4f9d\u8d56\u63a5\u53e3\uff0c\u4e0d\u4f9d\u8d56\u5b9e\u73b0 <pre><code>def __init__(self, repo: IUserRepository):  # \u2705 \u597d\n    self.repo = repo\n\ndef __init__(self, repo: UserRepository):  # \u274c \u8026\u5408\u5ea6\u9ad8\n    self.repo = repo</code></pre></p> </li> <li> <p>\u5728\u4e3b\u6587\u4ef6\u4e2d\u7edf\u4e00\u914d\u7f6e <pre><code># main.py\ndef setup_di(config: BaseConfig):\n    container = Container.get_instance()\n    # \u6240\u6709\u6ce8\u518c\u5728\u8fd9\u91cc\n\n# \u800c\u4e0d\u662f\u5206\u6563\u5728\u5404\u4e2a\u6a21\u5757\u4e2d</code></pre></p> </li> <li> <p>\u4f7f\u7528\u5de5\u5382\u5904\u7406\u590d\u6742\u521d\u59cb\u5316 <pre><code>def create_repo(container: Container):\n    # \u590d\u6742\u903b\u8f91\u5728\u8fd9\u91cc\n    return UserRepository(...)\n\n# \u800c\u4e0d\u662f\u5728\u670d\u52a1\u6784\u9020\u51fd\u6570\u4e2d</code></pre></p> </li> <li> <p>\u4e3a\u4f5c\u7528\u57df\u670d\u52a1\u63d0\u4f9b\u5de5\u5382 <pre><code>def create_session(db_manager: DatabaseManager):\n    return db_manager.get_session()\n\ncontainer.register(\n    DatabaseSession,\n    factory=create_session,\n    lifetime=Lifetime.SCOPED\n)</code></pre></p> </li> </ol>"},{"location":"06-di-container-complete/#_13","title":"\u274c \u907f\u514d\u7684\u505a\u6cd5","text":"<ol> <li> <p>\u786c\u7f16\u7801\u4f9d\u8d56 <pre><code>class UserService:\n    def __init__(self):\n        self.repo = UserRepository()  # \u274c \u65e0\u6cd5\u6d4b\u8bd5</code></pre></p> </li> <li> <p>\u5728\u5404\u5904\u521b\u5efa\u5bb9\u5668 <pre><code>container1 = Container()  # \u274c \u65b0\u5b9e\u4f8b\ncontainer2 = Container()  # \u274c \u4e0d\u540c\u5b9e\u4f8b\n\ncontainer = Container.get_instance()  # \u2705 \u4f7f\u7528\u5355\u4f8b</code></pre></p> </li> <li> <p>\u8fc7\u5ea6\u4f7f\u7528 TRANSIENT <pre><code>container.register_transient(DatabaseManager)  # \u274c \u6bcf\u6b21\u521b\u5efa\u65b0\u8fde\u63a5\ncontainer.register_singleton(DatabaseManager)  # \u2705 \u590d\u7528\u8fde\u63a5</code></pre></p> </li> </ol>"},{"location":"06-di-container-complete/#_14","title":"\u4e0e\u7ec4\u4ef6\u7cfb\u7edf\u7684\u96c6\u6210","text":"<p>DI \u5bb9\u5668\u548c\u7ec4\u4ef6\u7cfb\u7edf\u53ef\u4ee5\u534f\u4f5c\u3002</p> <pre><code>from aury.boot.application.app.base import Component, FoundationApp\n\nclass DISetupComponent(Component):\n    \"\"\"\u5728\u5e94\u7528\u542f\u52a8\u65f6\u521d\u59cb\u5316 DI \u5bb9\u5668\"\"\"\n    name = \"di_setup\"\n    enabled = True\n    depends_on = []\n\n    async def setup(self, app: FoundationApp, config: BaseConfig):\n        container = Container.get_instance()\n\n        # \u6ce8\u518c\u6240\u6709\u4f9d\u8d56\n        container.register_instance(BaseConfig, config)\n        container.register_singleton(DatabaseManager)\n        container.register_scoped(UserRepository)\n        container.register_transient(UserService)\n\n        logger.info(\"DI \u5bb9\u5668\u5df2\u521d\u59cb\u5316\")\n\n    async def teardown(self, app: FoundationApp):\n        container = Container.get_instance()\n        container.clear()\n\n# \u5728\u5e94\u7528\u4e2d\u4f7f\u7528\napp = FoundationApp(config=config)\napp.add_component(DISetupComponent())</code></pre>"},{"location":"06-di-container-complete/#_15","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 06-components-detailed.md \u5b66\u4e60\u7ec4\u4ef6\u7cfb\u7edf</li> <li>\u67e5\u770b 09-database-complete.md \u5b66\u4e60\u6570\u636e\u5e93\u96c6\u6210</li> </ul>"},{"location":"07-middleware-guide/","title":"7. \u4e2d\u95f4\u4ef6\u7cfb\u7edf - \u5b8c\u6574\u6307\u5357","text":""},{"location":"07-middleware-guide/#_1","title":"\u4e2d\u95f4\u4ef6\u6982\u8ff0","text":"<p>\u4e2d\u95f4\u4ef6\uff08Middleware\uff09\u662f Kit \u4e2d\u5904\u7406 HTTP \u8bf7\u6c42\u62e6\u622a\u7684\u529f\u80fd\u5355\u5143\u3002\u4e0e\u7ec4\u4ef6\uff08Component\uff09\u4e0d\u540c\uff0c\u4e2d\u95f4\u4ef6\u4e13\u6ce8\u4e8e\u8bf7\u6c42/\u54cd\u5e94\u7684\u5904\u7406\u94fe\u3002</p>"},{"location":"07-middleware-guide/#vs","title":"\u4e2d\u95f4\u4ef6 vs \u7ec4\u4ef6","text":"\u7279\u6027 \u4e2d\u95f4\u4ef6\uff08Middleware\uff09 \u7ec4\u4ef6\uff08Component\uff09 \u804c\u8d23 HTTP \u8bf7\u6c42\u5904\u7406 \u57fa\u7840\u8bbe\u65bd\u751f\u547d\u5468\u671f\u7ba1\u7406 \u6267\u884c\u65f6\u673a \u6bcf\u4e2a HTTP \u8bf7\u6c42 \u5e94\u7528\u542f\u52a8/\u5173\u95ed \u6ce8\u518c\u65b9\u5f0f \u540c\u6b65\uff08\u5e94\u7528\u6784\u9020\u9636\u6bb5\uff09 \u5f02\u6b65\uff08lifespan \u9636\u6bb5\uff09 \u6392\u5e8f\u65b9\u5f0f \u6309 <code>order</code> \u5c5e\u6027 \u6309 <code>depends_on</code> \u4f9d\u8d56 \u5178\u578b\u573a\u666f CORS\u3001\u65e5\u5fd7\u3001\u8ba4\u8bc1 \u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001\u4efb\u52a1\u961f\u5217"},{"location":"07-middleware-guide/#_2","title":"\u4e3a\u4ec0\u4e48\u5206\u79bb\u4e2d\u95f4\u4ef6\u548c\u7ec4\u4ef6\uff1f","text":"<pre><code># \u274c \u65e7\u8bbe\u8ba1\uff1a\u6df7\u5408\u5728\u4e00\u8d77\uff0c\u804c\u8d23\u4e0d\u6e05\nclass MyApp(FoundationApp):\n    items = [\n        RequestLoggingComponent,  # \u5b9e\u9645\u662f\u4e2d\u95f4\u4ef6\n        DatabaseComponent,        # \u5b9e\u9645\u662f\u7ec4\u4ef6\n    ]\n\n# \u2705 \u65b0\u8bbe\u8ba1\uff1a\u804c\u8d23\u5206\u79bb\uff0c\u6e05\u6670\u660e\u4e86\nclass MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,  # \u4e2d\u95f4\u4ef6\n        CORSMiddleware,\n    ]\n    components = [\n        DatabaseComponent,         # \u7ec4\u4ef6\n        CacheComponent,\n    ]</code></pre>"},{"location":"07-middleware-guide/#_3","title":"\u4e2d\u95f4\u4ef6\u7ed3\u6784","text":""},{"location":"07-middleware-guide/#_4","title":"\u57fa\u7c7b\u5b9a\u4e49","text":"<pre><code>from aury.boot.application.app.base import Middleware\nfrom aury.boot.application.config import BaseConfig\nfrom starlette.middleware import Middleware as StarletteMiddleware\n\nclass Middleware(ABC):\n    name: str                    # \u4e2d\u95f4\u4ef6\u552f\u4e00\u6807\u8bc6\n    enabled: bool = True         # \u662f\u5426\u542f\u7528\n    order: int = 0               # \u6267\u884c\u987a\u5e8f\uff08\u6570\u5b57\u5c0f\u7684\u5148\u6267\u884c\uff09\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u6761\u4ef6\u542f\u7528\uff1a\u8fd4\u56de False \u5219\u8df3\u8fc7\u6b64\u4e2d\u95f4\u4ef6\"\"\"\n        return self.enabled\n\n    def build(self, config: BaseConfig) -&gt; StarletteMiddleware:\n        \"\"\"\u6784\u5efa\u4e2d\u95f4\u4ef6\u5b9e\u4f8b\uff0c\u7531\u6846\u67b6\u7edf\u4e00\u6ce8\u518c\"\"\"\n        pass</code></pre>"},{"location":"07-middleware-guide/#_5","title":"\u751f\u547d\u5468\u671f","text":"<pre><code>\u5e94\u7528\u6784\u9020 \u2192 \u4e2d\u95f4\u4ef6 register() \u2192 lifespan \u542f\u52a8 \u2192 \u7ec4\u4ef6 setup()\n                                              \u2193\n                              HTTP \u8bf7\u6c42 \u2192 \u4e2d\u95f4\u4ef6\u5904\u7406\u94fe\n                                              \u2193\n                              lifespan \u5173\u95ed \u2192 \u7ec4\u4ef6 teardown()\n</code></pre>"},{"location":"07-middleware-guide/#_6","title":"\u5185\u7f6e\u4e2d\u95f4\u4ef6","text":""},{"location":"07-middleware-guide/#1-requestloggingmiddleware","title":"1. RequestLoggingMiddleware","text":"<p>HTTP \u8bf7\u6c42\u65e5\u5fd7\u4e2d\u95f4\u4ef6\uff0c\u81ea\u52a8\u8bb0\u5f55\u6240\u6709\u8bf7\u6c42\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</p> <pre><code>from aury.boot.application.app.middlewares import RequestLoggingMiddleware\n\nclass MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,\n    ]\n\n# \u81ea\u52a8\u8bb0\u5f55\uff1a\n# \u2192 GET /api/users | \u5ba2\u6237\u7aef: 127.0.0.1 | Trace-ID: abc123\n# \u2190 GET /api/users | \u72b6\u6001: 200 | \u8017\u65f6: 0.015s</code></pre> <p>\u8bb0\u5f55\u7684\u4fe1\u606f\uff1a - \u8bf7\u6c42\u65b9\u6cd5\u3001\u8def\u5f84\u3001\u67e5\u8be2\u53c2\u6570 - \u5ba2\u6237\u7aef IP\u3001User-Agent - \u54cd\u5e94\u72b6\u6001\u7801\u3001\u8017\u65f6 - \u94fe\u8def\u8ffd\u8e2a ID\uff08X-Trace-ID / X-Request-ID\uff09</p> <p>\u7279\u6027\uff1a - <code>order = 0</code>\uff1a\u6700\u5148\u6267\u884c\uff0c\u786e\u4fdd\u8bb0\u5f55\u6240\u6709\u8bf7\u6c42 - \u81ea\u52a8\u751f\u6210\u6216\u4f20\u9012 Trace ID - \u6162\u8bf7\u6c42\u8b66\u544a\uff08\u8d85\u8fc7 1 \u79d2\uff09</p>"},{"location":"07-middleware-guide/#2-corsmiddleware","title":"2. CORSMiddleware","text":"<p>CORS \u8de8\u57df\u5904\u7406\u4e2d\u95f4\u4ef6\u3002</p> <pre><code>from aury.boot.application.app.middlewares import CORSMiddleware\n\nclass MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,\n        CORSMiddleware,\n    ]\n\n# \u914d\u7f6e CORS\uff08.env \u6216\u73af\u5883\u53d8\u91cf\uff09\n# CORS_ORIGINS=[\"http://localhost:3000\", \"https://example.com\"]\n# CORS_ALLOW_CREDENTIALS=true\n# CORS_ALLOW_METHODS=[\"GET\", \"POST\", \"PUT\", \"DELETE\"]\n# CORS_ALLOW_HEADERS=[\"*\"]</code></pre> <p>\u7279\u6027\uff1a - <code>order = 10</code>\uff1a\u5728\u8bf7\u6c42\u65e5\u5fd7\u4e4b\u540e\u6267\u884c - \u4ec5\u5f53\u914d\u7f6e\u4e86 <code>origins</code> \u65f6\u542f\u7528</p>"},{"location":"07-middleware-guide/#_7","title":"\u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6","text":""},{"location":"07-middleware-guide/#_8","title":"\u57fa\u672c\u7ed3\u6784","text":"<pre><code>from aury.boot.application.app.base import Middleware\nfrom aury.boot.application.config import BaseConfig\nfrom starlette.middleware import Middleware as StarletteMiddleware\nfrom starlette.middleware.authentication import AuthenticationMiddleware\n\nclass AuthMiddleware(Middleware):\n    \"\"\"\u8ba4\u8bc1\u4e2d\u95f4\u4ef6\"\"\"\n\n    name = \"auth\"\n    enabled = True\n    order = 20  # \u5728 CORS \u4e4b\u540e\u6267\u884c\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u4ec5\u5728\u914d\u7f6e\u4e86\u8ba4\u8bc1\u65f6\u542f\u7528\"\"\"\n        return self.enabled and hasattr(config, 'auth_enabled') and config.auth_enabled\n\n    def build(self, config: BaseConfig) -&gt; StarletteMiddleware:\n        \"\"\"\u6784\u5efa\u8ba4\u8bc1\u4e2d\u95f4\u4ef6\u5b9e\u4f8b\"\"\"\n        from my_app.auth import JWTAuthBackend\n\n        return StarletteMiddleware(\n            AuthenticationMiddleware,\n            backend=JWTAuthBackend(config.jwt_secret),\n        )</code></pre>"},{"location":"07-middleware-guide/#_9","title":"\u5b9e\u9645\u793a\u4f8b\uff1a\u8bf7\u6c42\u9650\u6d41","text":"<pre><code>from slowapi.middleware import SlowAPIMiddleware\nfrom starlette.middleware import Middleware as StarletteMiddleware\n\nclass RateLimitMiddleware(Middleware):\n    \"\"\"\u8bf7\u6c42\u9650\u6d41\u4e2d\u95f4\u4ef6\"\"\"\n\n    name = \"rate_limit\"\n    enabled = True\n    order = 5  # \u5728\u65e5\u5fd7\u4e4b\u540e\u3001CORS \u4e4b\u524d\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u4ec5\u5728\u751f\u4ea7\u73af\u5883\u542f\u7528\"\"\"\n        return self.enabled and config.env == \"production\"\n\n    def build(self, config: BaseConfig) -&gt; StarletteMiddleware:\n        \"\"\"\u6784\u5efa\u9650\u6d41\u4e2d\u95f4\u4ef6\u5b9e\u4f8b\"\"\"\n        return StarletteMiddleware(SlowAPIMiddleware)</code></pre>"},{"location":"07-middleware-guide/#id","title":"\u5b9e\u9645\u793a\u4f8b\uff1a\u8bf7\u6c42 ID \u6ce8\u5165","text":"<pre><code>from starlette.middleware.base import BaseHTTPMiddleware\nfrom starlette.middleware import Middleware as StarletteMiddleware\nfrom starlette.requests import Request\nimport uuid\n\nclass RequestIDHTTPMiddleware(BaseHTTPMiddleware):\n    \"\"\"Starlette \u539f\u751f\u4e2d\u95f4\u4ef6\u5b9e\u73b0\"\"\"\n\n    async def dispatch(self, request: Request, call_next):\n        request_id = request.headers.get(\"X-Request-ID\") or str(uuid.uuid4())\n        request.state.request_id = request_id\n        response = await call_next(request)\n        response.headers[\"X-Request-ID\"] = request_id\n        return response\n\n\nclass RequestIDMiddleware(Middleware):\n    \"\"\"\u8bf7\u6c42 ID \u4e2d\u95f4\u4ef6\"\"\"\n\n    name = \"request_id\"\n    enabled = True\n    order = 1  # \u5728\u65e5\u5fd7\u4e4b\u540e\u7acb\u5373\u6267\u884c\n\n    def build(self, config: BaseConfig) -&gt; StarletteMiddleware:\n        \"\"\"\u6784\u5efa\u8bf7\u6c42 ID \u4e2d\u95f4\u4ef6\u5b9e\u4f8b\"\"\"\n        return StarletteMiddleware(RequestIDHTTPMiddleware)</code></pre>"},{"location":"07-middleware-guide/#_10","title":"\u4e2d\u95f4\u4ef6\u6ce8\u518c","text":""},{"location":"07-middleware-guide/#1","title":"\u65b9\u5f0f 1\uff1a\u7c7b\u5c5e\u6027\uff08\u63a8\u8350\uff09","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.app.middlewares import (\n    RequestLoggingMiddleware,\n    CORSMiddleware,\n)\n\nclass MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,\n        CORSMiddleware,\n        AuthMiddleware,  # \u81ea\u5b9a\u4e49\u4e2d\u95f4\u4ef6\n    ]\n\napp = MyApp(config=config)</code></pre>"},{"location":"07-middleware-guide/#2","title":"\u65b9\u5f0f 2\uff1a\u6761\u4ef6\u6ce8\u518c","text":"<pre><code>class MyApp(FoundationApp):\n    middlewares = [\n        RequestLoggingMiddleware,\n    ]\n\n    def __init__(self, *args, **kwargs):\n        # \u5728 super().__init__() \u4e4b\u524d\u4fee\u6539 middlewares\n        if some_condition:\n            self.middlewares = [\n                RequestLoggingMiddleware,\n                CORSMiddleware,\n            ]\n        super().__init__(*args, **kwargs)</code></pre>"},{"location":"07-middleware-guide/#_11","title":"\u6267\u884c\u987a\u5e8f","text":"<p>\u4e2d\u95f4\u4ef6\u6309 <code>order</code> \u5c5e\u6027\u6392\u5e8f\u6267\u884c\uff08\u6570\u5b57\u5c0f\u7684\u5148\u6267\u884c\uff09\uff1a</p> <pre><code>class MiddlewareA(Middleware):\n    name = \"a\"\n    order = 0\n\nclass MiddlewareB(Middleware):\n    name = \"b\"\n    order = 10\n\nclass MiddlewareC(Middleware):\n    name = \"c\"\n    order = 20\n\n# \u6267\u884c\u987a\u5e8f\uff1aA \u2192 B \u2192 C\n# \u8bf7\u6c42\u5904\u7406\u94fe\uff1a\n# Request \u2192 A \u2192 B \u2192 C \u2192 Handler \u2192 C \u2192 B \u2192 A \u2192 Response</code></pre> <p>\u5185\u7f6e\u4e2d\u95f4\u4ef6\u7684 order\uff1a - <code>RequestLoggingMiddleware</code>: 0 - <code>CORSMiddleware</code>: 10</p>"},{"location":"07-middleware-guide/#_12","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"07-middleware-guide/#_13","title":"\u2705 \u63a8\u8350\u505a\u6cd5","text":"<ol> <li> <p>\u5408\u7406\u8bbe\u7f6e order <pre><code># \u2705 \u597d\uff1a\u6309\u804c\u8d23\u6392\u5e8f\nclass LoggingMiddleware(Middleware):\n    order = 0   # \u6700\u5148\uff0c\u8bb0\u5f55\u6240\u6709\u8bf7\u6c42\n\nclass AuthMiddleware(Middleware):\n    order = 20  # \u8ba4\u8bc1\n\nclass RateLimitMiddleware(Middleware):\n    order = 30  # \u9650\u6d41</code></pre></p> </li> <li> <p>\u4f7f\u7528 can_enable \u8fdb\u884c\u6761\u4ef6\u63a7\u5236 <pre><code># \u2705 \u597d\uff1a\u6839\u636e\u914d\u7f6e\u51b3\u5b9a\u662f\u5426\u542f\u7528\ndef can_enable(self, config):\n    return config.env != \"test\"</code></pre></p> </li> <li> <p>\u4fdd\u6301\u4e2d\u95f4\u4ef6\u8f7b\u91cf <pre><code># \u2705 \u597d\uff1a\u53ea\u505a\u8bf7\u6c42\u5904\u7406\u76f8\u5173\u7684\u4e8b\ndef build(self, config):\n    return StarletteMiddleware(SomeMiddleware)</code></pre></p> </li> </ol>"},{"location":"07-middleware-guide/#_14","title":"\u274c \u907f\u514d\u7684\u505a\u6cd5","text":"<ol> <li> <p>\u5728\u4e2d\u95f4\u4ef6\u4e2d\u505a\u57fa\u7840\u8bbe\u65bd\u521d\u59cb\u5316 <pre><code># \u274c \u4e0d\u597d\uff1a\u8fd9\u5e94\u8be5\u662f\u7ec4\u4ef6\u7684\u804c\u8d23\nclass BadMiddleware(Middleware):\n    def build(self, config):\n        init_database()  # \u5e94\u8be5\u7528 Component\n        return StarletteMiddleware(SomeMiddleware)</code></pre></p> </li> <li> <p>\u5ffd\u7565 order \u8bbe\u7f6e <pre><code># \u274c \u4e0d\u597d\uff1a\u53ef\u80fd\u5bfc\u81f4\u6267\u884c\u987a\u5e8f\u95ee\u9898\nclass AuthMiddleware(Middleware):\n    order = 0  # \u8ba4\u8bc1\u4e0d\u5e94\u8be5\u6700\u5148\u6267\u884c</code></pre></p> </li> </ol>"},{"location":"07-middleware-guide/#_15","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 08-components-detailed.md \u4e86\u89e3\u7ec4\u4ef6\u7cfb\u7edf</li> <li>\u67e5\u770b 09-http-advanced.md \u4e86\u89e3 HTTP \u63a5\u53e3\u9ad8\u7ea7\u7528\u6cd5</li> </ul>"},{"location":"08-components-detailed/","title":"8. \u7ec4\u4ef6\u7cfb\u7edf - \u5b8c\u6574\u6307\u5357","text":""},{"location":"08-components-detailed/#_1","title":"\u7ec4\u4ef6\u6982\u8ff0","text":"<p>\u7ec4\u4ef6\uff08Component\uff09\u662f Kit \u4e2d\u7ba1\u7406 \u57fa\u7840\u8bbe\u65bd\u751f\u547d\u5468\u671f\u7684\u529f\u80fd\u5355\u5143\u3002\u4e0e\u4e2d\u95f4\u4ef6\uff08Middleware\uff09\u4e0d\u540c\uff0c\u7ec4\u4ef6\u4e13\u6ce8\u4e8e\u6570\u636e\u5e93\u3001\u7f13\u5b58\u3001\u4efb\u52a1\u961f\u5217\u7b49\u57fa\u7840\u8bbe\u65bd\u7684\u521d\u59cb\u5316\u548c\u6e05\u7406\u3002</p>"},{"location":"08-components-detailed/#_2","title":"\u4e3a\u4ec0\u4e48\u9700\u8981\u7ec4\u4ef6\u7cfb\u7edf\uff1f","text":"<pre><code># \u274c \u4f20\u7edf\u505a\u6cd5\uff1a\u624b\u52a8\u7ba1\u7406\u751f\u547d\u5468\u671f\n@app.on_event(\"startup\")\nasync def startup():\n    global db, cache\n    db = await init_db()\n    cache = await init_cache()\n\n@app.on_event(\"shutdown\")\nasync def shutdown():\n    await db.close()\n    await cache.close()\n\n# \u2705 \u4f7f\u7528\u7ec4\u4ef6\u7cfb\u7edf\uff1a\u81ea\u52a8\u7ba1\u7406\nclass DatabaseComponent(Component):\n    async def setup(self, app, config):\n        app.state.db = await init_db()\n    async def teardown(self, app):\n        await app.state.db.close()\n\n# \u6e05\u6670\u3001\u53ef\u590d\u7528\u3001\u652f\u6301\u4f9d\u8d56\u7ba1\u7406</code></pre>"},{"location":"08-components-detailed/#_3","title":"\u7ec4\u4ef6\u7ed3\u6784","text":""},{"location":"08-components-detailed/#_4","title":"\u57fa\u7c7b\u5b9a\u4e49","text":"<pre><code>from aury.boot.application.app.base import Component, FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom typing import ClassVar\n\nclass Component(ABC):\n    name: str                            # \u7ec4\u4ef6\u552f\u4e00\u6807\u8bc6\n    enabled: bool = True                 # \u662f\u5426\u542f\u7528\n    depends_on: ClassVar[list[str]] = [] # \u4f9d\u8d56\u7684\u7ec4\u4ef6\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u6761\u4ef6\u542f\u7528\uff1a\u8fd4\u56de False \u5219\u8df3\u8fc7\u6b64\u7ec4\u4ef6\"\"\"\n        return self.enabled\n\n    async def setup(self, app: FoundationApp, config: BaseConfig) -&gt; None:\n        \"\"\"\u5e94\u7528\u542f\u52a8\u65f6\u8c03\u7528\uff08\u5f02\u6b65\uff09\"\"\"\n        pass\n\n    async def teardown(self, app: FoundationApp) -&gt; None:\n        \"\"\"\u5e94\u7528\u5173\u95ed\u65f6\u8c03\u7528\uff08\u5f02\u6b65\uff09\"\"\"\n        pass</code></pre>"},{"location":"08-components-detailed/#_5","title":"\u751f\u547d\u5468\u671f","text":"<pre><code>\u5e94\u7528\u6784\u9020 \u2192 \u4e2d\u95f4\u4ef6\u6ce8\u518c \u2192 lifespan \u542f\u52a8\n                            \u2193\n                      \u7ec4\u4ef6\u62d3\u6251\u6392\u5e8f\n                            \u2193\n                      \u7ec4\u4ef6 setup()\uff08\u6309\u4f9d\u8d56\u987a\u5e8f\uff09\n                            \u2193\n                      \u5e94\u7528\u8fd0\u884c\u4e2d...\n                            \u2193\n                      \u7ec4\u4ef6 teardown()\uff08\u6309\u4f9d\u8d56\u9006\u5e8f\uff09\n                            \u2193\n                      lifespan \u5173\u95ed\n</code></pre>"},{"location":"08-components-detailed/#_6","title":"\u5185\u7f6e\u7ec4\u4ef6","text":""},{"location":"08-components-detailed/#1-databasecomponent","title":"1. DatabaseComponent","text":"<p>\u7ba1\u7406\u6570\u636e\u5e93\u8fde\u63a5\u548c\u8fde\u63a5\u6c60\u3002</p> <pre><code>from aury.boot.application.app.components import DatabaseComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        DatabaseComponent,\n    ]\n\n# \u81ea\u52a8\u521d\u59cb\u5316\uff1a\n# - \u521b\u5efa\u5f02\u6b65\u5f15\u64ce\n# - \u5efa\u7acb\u8fde\u63a5\u6c60\n# - \u521b\u5efa\u4f1a\u8bdd\u5de5\u5382\n\n# \u5728\u8def\u7531\u4e2d\u4f7f\u7528\nfrom aury.boot.infrastructure.database import DatabaseManager\n\ndb_manager = DatabaseManager.get_instance()\n\n@app.get(\"/users\")\nasync def list_users(session=Depends(db_manager.get_session)):\n    repo = UserRepository(session)\n    return await repo.list()</code></pre> <p>\u914d\u7f6e\uff08.env\uff09\uff1a <pre><code>DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb\nDATABASE_POOL_SIZE=10\nDATABASE_MAX_OVERFLOW=20\nDATABASE_POOL_TIMEOUT=30\nDATABASE_POOL_RECYCLE=3600\nDATABASE_ECHO=false</code></pre></p>"},{"location":"08-components-detailed/#2-cachecomponent","title":"2. CacheComponent","text":"<p>\u7ba1\u7406\u7f13\u5b58\u7cfb\u7edf\uff08Redis \u6216\u5185\u5b58\uff09\u3002</p> <pre><code>from aury.boot.application.app.components import CacheComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        CacheComponent,\n    ]\n\n# \u6839\u636e\u914d\u7f6e\u81ea\u52a8\u9009\u62e9\u540e\u7aef\uff1a\n# CACHE_TYPE=memory    \u2192 \u5185\u5b58\u7f13\u5b58\uff08\u5f00\u53d1\uff09\n# CACHE_TYPE=redis     \u2192 Redis \u7f13\u5b58\uff08\u751f\u4ea7\uff09\n\nfrom aury.boot.infrastructure.cache import CacheManager\n\ncache = CacheManager.get_instance()\nawait cache.set(\"key\", \"value\", expire=300)\nvalue = await cache.get(\"key\")</code></pre> <p>\u914d\u7f6e\uff08.env\uff09\uff1a <pre><code>CACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\nCACHE_MAX_SIZE=1000</code></pre></p>"},{"location":"08-components-detailed/#3-taskcomponent","title":"3. TaskComponent","text":"<p>\u7ba1\u7406\u5f02\u6b65\u4efb\u52a1\u961f\u5217\u3002</p> <pre><code>from aury.boot.application.app.components import TaskComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        TaskComponent,\n    ]\n\n# \u5728 API \u6a21\u5f0f\u4e0b\uff1a\u4f5c\u4e3a\u751f\u4ea7\u8005\uff0c\u63d0\u4ea4\u4efb\u52a1\u5230\u961f\u5217\n# \u5728 Worker \u6a21\u5f0f\u4e0b\uff1a\u6d88\u8d39\u961f\u5217\u4e2d\u7684\u4efb\u52a1\n\nfrom aury.boot.infrastructure.tasks import TaskManager\n\ntm = TaskManager.get_instance()\n\n@tm.conditional_task(queue_name=\"default\", max_retries=3)\nasync def send_email(email: str):\n    pass\n\n# \u63d0\u4ea4\u4efb\u52a1\nsend_email.send(\"user@example.com\")</code></pre> <p>\u914d\u7f6e\uff08.env\uff09\uff1a <pre><code>SERVICE_TYPE=api  # \u6216 worker\nTASK_BROKER_URL=redis://localhost:6379/0</code></pre></p>"},{"location":"08-components-detailed/#4-schedulercomponent","title":"4. SchedulerComponent","text":"<p>\u7ba1\u7406\u5b9a\u65f6\u4efb\u52a1\u8c03\u5ea6\u3002</p> <pre><code>from aury.boot.application.app.components import SchedulerComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        SchedulerComponent,\n    ]\n\nfrom aury.boot.infrastructure.scheduler import SchedulerManager\n\nscheduler = SchedulerManager.get_instance()\n\nscheduler.add_job(\n    func=daily_cleanup,\n    trigger=\"cron\",\n    hour=2, minute=0\n)</code></pre> <p>\u914d\u7f6e\uff08.env\uff09\uff1a <pre><code>SCHEDULER_MODE=embedded  # \u6216 standalone</code></pre></p>"},{"location":"08-components-detailed/#5-migrationcomponent","title":"5. MigrationComponent","text":"<p>\u81ea\u52a8\u6267\u884c\u6570\u636e\u5e93\u8fc1\u79fb\u3002</p> <pre><code>from aury.boot.application.app.components import (\n    DatabaseComponent,\n    MigrationComponent,\n)\n\nclass MyApp(FoundationApp):\n    components = [\n        DatabaseComponent,\n        MigrationComponent,  # \u4f9d\u8d56 DatabaseComponent\n    ]\n\n# \u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\u5230\u6700\u65b0\u7248\u672c\n# \ud83d\udd04 \u68c0\u67e5\u6570\u636e\u5e93\u8fc1\u79fb...\n# \u2705 \u6570\u636e\u5e93\u5df2\u662f\u6700\u65b0\u7248\u672c\uff0c\u65e0\u9700\u8fc1\u79fb</code></pre>"},{"location":"08-components-detailed/#6-adminconsolecomponent","title":"6. AdminConsoleComponent\uff08\u53ef\u9009\uff09","text":"<p>\u63d0\u4f9b\u57fa\u4e8e SQLAdmin \u7684\u7ba1\u7406\u540e\u53f0\uff08\u9ed8\u8ba4\u8def\u5f84\uff1a<code>/api/admin-console</code>\uff09\uff0c\u7528\u4e8e\u5feb\u901f\u642d\u5efa\u751f\u4ea7\u53ef\u7528\u7684\u540e\u53f0\u7ba1\u7406\u80fd\u529b\u3002</p> <p>\u4f9d\u8d56\uff1a<code>uv add \"aury-boot[admin]\"</code>\uff08\u9700\u540c\u6b65\u6570\u636e\u5e93\u9a71\u52a8\uff09</p> <pre><code>from aury.boot.application.app.components import AdminConsoleComponent\n\nclass MyApp(FoundationApp):\n    components = [\n        AdminConsoleComponent,\n    ]</code></pre> <p>\u914d\u7f6e\uff08.env\uff09\uff1a</p> <pre><code>ADMIN_ENABLED=true\nADMIN_PATH=/api/admin-console\n\n# SQLAdmin \u901a\u5e38\u8981\u6c42\u540c\u6b65 Engine\uff1b\u82e5 DATABASE_URL \u662f\u5f02\u6b65\u9a71\u52a8\uff0c\u5efa\u8bae\u663e\u5f0f\u63d0\u4f9b\u540c\u6b65 URL\n# ADMIN_DATABASE_URL=postgresql+psycopg://user:pass@localhost:5432/mydb\n\n# \u8ba4\u8bc1\uff08\u9ed8\u8ba4\u63a8\u8350 basic \u6216 bearer\uff09\nADMIN_AUTH_MODE=basic\nADMIN_AUTH_SECRET_KEY=CHANGE_ME_TO_A_RANDOM_SECRET\nADMIN_AUTH_BASIC_USERNAME=admin\nADMIN_AUTH_BASIC_PASSWORD=change_me</code></pre>"},{"location":"08-components-detailed/#_7","title":"\u81ea\u5b9a\u4e49\u7ec4\u4ef6","text":""},{"location":"08-components-detailed/#_8","title":"\u57fa\u672c\u7ed3\u6784","text":"<pre><code>from aury.boot.application.app.base import Component, FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom typing import ClassVar\n\nclass MyCustomComponent(Component):\n    name = \"my_custom\"           # \u552f\u4e00\u6807\u8bc6\n    enabled = True               # \u662f\u5426\u542f\u7528\n    depends_on: ClassVar[list[str]] = [\"database\"]  # \u4f9d\u8d56\u5173\u7cfb\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u6761\u4ef6\u542f\u7528\uff1a\u68c0\u67e5\u914d\u7f6e\u51b3\u5b9a\u662f\u5426\u542f\u7528\"\"\"\n        return hasattr(config, 'my_feature_enabled') and config.my_feature_enabled\n\n    async def setup(self, app: FoundationApp, config: BaseConfig) -&gt; None:\n        \"\"\"\u5e94\u7528\u542f\u52a8\u65f6\u8c03\u7528\"\"\"\n        print(\"\ud83d\ude80 \u521d\u59cb\u5316...\")\n        app.state.my_resource = SomeResource()\n\n    async def teardown(self, app: FoundationApp) -&gt; None:\n        \"\"\"\u5e94\u7528\u5173\u95ed\u65f6\u8c03\u7528\"\"\"\n        print(\"\ud83d\uded1 \u6e05\u7406...\")\n        if hasattr(app.state, 'my_resource'):\n            await app.state.my_resource.close()</code></pre>"},{"location":"08-components-detailed/#redis","title":"\u5b9e\u9645\u793a\u4f8b\uff1aRedis \u8fde\u63a5\u6c60","text":"<pre><code>class RedisConnectionComponent(Component):\n    name = \"redis\"\n    enabled = True\n    depends_on: ClassVar[list[str]] = []\n\n    def can_enable(self, config: BaseConfig) -&gt; bool:\n        \"\"\"\u4ec5\u5f53\u914d\u7f6e\u4e86 Redis \u65f6\u542f\u7528\"\"\"\n        return bool(getattr(config.cache, 'redis_url', None))\n\n    async def setup(self, app: FoundationApp, config: BaseConfig) -&gt; None:\n        \"\"\"\u521d\u59cb\u5316 Redis \u8fde\u63a5\"\"\"\n        import redis.asyncio as redis\n\n        pool = redis.ConnectionPool.from_url(\n            config.cache.redis_url,\n            max_connections=50\n        )\n        app.state.redis_pool = pool\n        logger.info(f\"\u2705 Redis \u5df2\u8fde\u63a5: {config.cache.redis_url}\")\n\n    async def teardown(self, app: FoundationApp) -&gt; None:\n        \"\"\"\u5173\u95ed Redis \u8fde\u63a5\"\"\"\n        if hasattr(app.state, 'redis_pool'):\n            await app.state.redis_pool.disconnect()\n            logger.info(\"\u2705 Redis \u5df2\u65ad\u5f00\u8fde\u63a5\")</code></pre>"},{"location":"08-components-detailed/#api","title":"\u5b9e\u9645\u793a\u4f8b\uff1a\u5916\u90e8 API \u5ba2\u6237\u7aef","text":"<pre><code>import httpx\n\nclass ExternalAPIComponent(Component):\n    name = \"external_api\"\n    enabled = True\n    depends_on: ClassVar[list[str]] = []\n\n    async def setup(self, app: FoundationApp, config: BaseConfig) -&gt; None:\n        \"\"\"\u521d\u59cb\u5316 HTTP \u5ba2\u6237\u7aef\"\"\"\n        app.state.http_client = httpx.AsyncClient(\n            base_url=config.external_api_url,\n            timeout=30.0,\n        )\n        logger.info(\"\u2705 HTTP \u5ba2\u6237\u7aef\u5df2\u521d\u59cb\u5316\")\n\n    async def teardown(self, app: FoundationApp) -&gt; None:\n        \"\"\"\u5173\u95ed HTTP \u5ba2\u6237\u7aef\"\"\"\n        if hasattr(app.state, 'http_client'):\n            await app.state.http_client.aclose()\n            logger.info(\"\u2705 HTTP \u5ba2\u6237\u7aef\u5df2\u5173\u95ed\")</code></pre>"},{"location":"08-components-detailed/#_9","title":"\u7ec4\u4ef6\u6ce8\u518c","text":""},{"location":"08-components-detailed/#1","title":"\u65b9\u5f0f 1\uff1a\u7c7b\u5c5e\u6027\uff08\u63a8\u8350\uff09","text":"<pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.app.components import (\n    DatabaseComponent,\n    CacheComponent,\n)\n\nclass MyApp(FoundationApp):\n    components = [\n        DatabaseComponent,\n        CacheComponent,\n        MyCustomComponent,  # \u81ea\u5b9a\u4e49\u7ec4\u4ef6\n    ]\n\napp = MyApp(config=config)</code></pre>"},{"location":"08-components-detailed/#2","title":"\u65b9\u5f0f 2\uff1a\u6761\u4ef6\u6ce8\u518c","text":"<pre><code>class MyApp(FoundationApp):\n    components = [\n        DatabaseComponent,\n    ]\n\n    def __init__(self, *args, **kwargs):\n        # \u6839\u636e\u6761\u4ef6\u52a8\u6001\u6dfb\u52a0\u7ec4\u4ef6\n        if self._config.enable_cache:\n            self.components = [\n                DatabaseComponent,\n                CacheComponent,\n            ]\n        super().__init__(*args, **kwargs)</code></pre>"},{"location":"08-components-detailed/#_10","title":"\u7ec4\u4ef6\u4f9d\u8d56\u7ba1\u7406","text":""},{"location":"08-components-detailed/#_11","title":"\u4f9d\u8d56\u5173\u7cfb\u58f0\u660e","text":"<pre><code>class ComponentA(Component):\n    name = \"a\"\n    depends_on: ClassVar[list[str]] = []\n\nclass ComponentB(Component):\n    name = \"b\"\n    depends_on: ClassVar[list[str]] = [\"a\"]  # \u4f9d\u8d56 A\n\nclass ComponentC(Component):\n    name = \"c\"\n    depends_on: ClassVar[list[str]] = [\"a\", \"b\"]  # \u4f9d\u8d56 A \u548c B\n\n# \u542f\u52a8\u987a\u5e8f\uff1aA \u2192 B \u2192 C\n# \u5173\u95ed\u987a\u5e8f\uff1aC \u2192 B \u2192 A\uff08\u53cd\u5411\uff09</code></pre>"},{"location":"08-components-detailed/#_12","title":"\u5faa\u73af\u4f9d\u8d56\u68c0\u6d4b","text":"<pre><code>class ComponentX(Component):\n    name = \"x\"\n    depends_on: ClassVar[list[str]] = [\"y\"]\n\nclass ComponentY(Component):\n    name = \"y\"\n    depends_on: ClassVar[list[str]] = [\"x\"]  # \u5faa\u73af\u4f9d\u8d56\uff01\n\n# \u6846\u67b6\u4f1a\u8bb0\u5f55\u8b66\u544a\uff1a\n# \"\u68c0\u6d4b\u5230\u5faa\u73af\u4f9d\u8d56: x\"</code></pre>"},{"location":"08-components-detailed/#_13","title":"\u8bbf\u95ee\u5176\u4ed6\u7ec4\u4ef6\u7684\u8d44\u6e90","text":"<pre><code>class DependentComponent(Component):\n    name = \"dependent\"\n    depends_on: ClassVar[list[str]] = [\"database\", \"cache\"]\n\n    async def setup(self, app: FoundationApp, config: BaseConfig) -&gt; None:\n        # \u901a\u8fc7\u5355\u4f8b\u7ba1\u7406\u5668\u8bbf\u95ee\u8d44\u6e90\n        from aury.boot.infrastructure.database import DatabaseManager\n        from aury.boot.infrastructure.cache import CacheManager\n\n        db_manager = DatabaseManager.get_instance()\n        cache_manager = CacheManager.get_instance()\n\n        # \u4f7f\u7528\u5b83\u4eec\n        app.state.my_service = MyService(db_manager, cache_manager)</code></pre>"},{"location":"08-components-detailed/#_14","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"08-components-detailed/#_15","title":"\u2705 \u63a8\u8350\u505a\u6cd5","text":"<ol> <li> <p>\u5355\u4e00\u804c\u8d23 <pre><code># \u2705 \u597d\uff1a\u6bcf\u4e2a\u7ec4\u4ef6\u53ea\u7ba1\u7406\u4e00\u4e2a\u8d44\u6e90\nclass DatabaseComponent(Component): ...\nclass CacheComponent(Component): ...\n\n# \u274c \u4e0d\u597d\uff1a\u4e00\u4e2a\u7ec4\u4ef6\u7ba1\u7406\u591a\u4e2a\u8d44\u6e90\nclass InfrastructureComponent(Component):\n    async def setup(self, ...):\n        app.state.db = ...\n        app.state.cache = ...</code></pre></p> </li> <li> <p>\u660e\u786e\u58f0\u660e\u4f9d\u8d56 <pre><code># \u2705 \u597d\ndepends_on: ClassVar[list[str]] = [\"database\", \"cache\"]\n\n# \u274c \u4e0d\u597d\uff1a\u5b9e\u9645\u4f9d\u8d56\u4f46\u672a\u58f0\u660e\ndepends_on: ClassVar[list[str]] = []  # \u4f46 setup \u4e2d\u4f7f\u7528\u4e86 database</code></pre></p> </li> <li> <p>\u6761\u4ef6\u542f\u7528 <pre><code># \u2705 \u597d\ndef can_enable(self, config):\n    return bool(config.database.url)\n\n# \u274c \u4e0d\u597d\ndef can_enable(self, config):\n    return True  # \u5373\u4f7f\u914d\u7f6e\u4e0d\u5b8c\u6574\u4e5f\u542f\u7528</code></pre></p> </li> <li> <p>\u5f02\u5e38\u5904\u7406 <pre><code># \u2705 \u597d\nasync def setup(self, app, config):\n    try:\n        app.state.resource = await init_resource()\n        logger.info(\"Resource initialized\")\n    except Exception as e:\n        logger.error(f\"Failed to initialize: {e}\")\n        raise</code></pre></p> </li> </ol>"},{"location":"08-components-detailed/#_16","title":"\u274c \u907f\u514d\u7684\u505a\u6cd5","text":"<ol> <li>\u5728 setup() \u4e2d\u6267\u884c\u957f\u65f6\u95f4\u64cd\u4f5c</li> <li>\u4f1a\u5bfc\u81f4\u5e94\u7528\u542f\u52a8\u7f13\u6162</li> <li> <p>\u4f7f\u7528\u540e\u53f0\u4efb\u52a1\u4ee3\u66ff</p> </li> <li> <p>\u5728 teardown() \u4e2d\u5ffd\u7565\u5f02\u5e38</p> </li> <li>\u53ef\u80fd\u5bfc\u81f4\u8d44\u6e90\u6cc4\u6f0f</li> <li> <p>\u603b\u662f\u6355\u83b7\u5e76\u8bb0\u5f55\u5f02\u5e38</p> </li> <li> <p>\u7ec4\u4ef6\u95f4\u76f4\u63a5\u901a\u4fe1</p> </li> <li>\u5e94\u8be5\u901a\u8fc7\u5355\u4f8b\u7ba1\u7406\u5668\u6216\u5e94\u7528\u72b6\u6001\u901a\u4fe1</li> <li>\u4e0d\u8981\u76f4\u63a5\u4f9d\u8d56\u5176\u4ed6\u7ec4\u4ef6\u5b9e\u4f8b</li> </ol>"},{"location":"08-components-detailed/#_17","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 12-database-complete.md \u4e86\u89e3 DatabaseComponent \u8be6\u7ec6\u7528\u6cd5</li> <li>\u67e5\u770b 13-caching-advanced.md \u4e86\u89e3 CacheComponent \u8be6\u7ec6\u7528\u6cd5</li> <li>\u67e5\u770b 06-di-container-complete.md \u4e86\u89e3\u5982\u4f55\u4e0e DI \u5bb9\u5668\u914d\u5408</li> <li>\u67e5\u770b 26-infrastructure-advanced.md \u4e86\u89e3 Channel\u3001MQ\u3001Events \u7b49\u65b0\u6a21\u5757</li> </ul>"},{"location":"09-http-advanced/","title":"7. HTTP \u63a5\u53e3 - \u9ad8\u7ea7\u6307\u5357","text":""},{"location":"09-http-advanced/#ingress-egress","title":"Ingress \u548c Egress \u6982\u89c8","text":"<p>Kit \u63d0\u4f9b\u4e86\u4e24\u4e2a\u6838\u5fc3\u7684\u63a5\u53e3\u5c42\uff1a</p> <ul> <li>Ingress\uff08\u5165\u53e3\uff09\uff1a\u6240\u6709 API \u8bf7\u6c42\u7684\u57fa\u7c7b\u6a21\u578b</li> <li><code>BaseRequest</code>\uff1a\u57fa\u7840\u8bf7\u6c42</li> <li><code>PaginationRequest</code>\uff1a\u5206\u9875\u8bf7\u6c42</li> <li><code>ListRequest</code>\uff1a\u5217\u8868\u8bf7\u6c42</li> <li><code>FilterRequest</code>\uff1a\u8fc7\u6ee4\u8bf7\u6c42</li> <li> <p><code>SortOrder</code>\uff1a\u6392\u5e8f\u65b9\u5411\u679a\u4e3e</p> </li> <li> <p>Egress\uff08\u51fa\u53e3\uff09\uff1a\u6240\u6709 API \u54cd\u5e94\u7684\u57fa\u7c7b\u6a21\u578b</p> </li> <li><code>BaseResponse[T]</code>\uff1a\u901a\u7528\u54cd\u5e94</li> <li><code>PaginationResponse[T]</code>\uff1a\u5206\u9875\u54cd\u5e94</li> <li><code>SuccessResponse</code>\uff1a\u6210\u529f\u6d88\u606f</li> <li><code>ErrorResponse</code>\uff1a\u9519\u8bef\u54cd\u5e94</li> <li><code>IDResponse</code>\uff1aID \u54cd\u5e94</li> <li><code>CountResponse</code>\uff1a\u8ba1\u6570\u54cd\u5e94</li> <li><code>ResponseBuilder</code>\uff1a\u54cd\u5e94\u6784\u5efa\u5668</li> </ul> <p>\u4f7f\u7528\u8fd9\u4e9b\u6807\u51c6\u6a21\u578b\u786e\u4fdd API \u7684\u4e00\u81f4\u6027\u548c\u53ef\u9884\u6d4b\u6027\u3002</p>"},{"location":"09-http-advanced/#_1","title":"\u7edf\u4e00\u54cd\u5e94\u683c\u5f0f","text":"<p>Kit \u63d0\u4f9b\u4e86\u7edf\u4e00\u7684\u54cd\u5e94\u6a21\u578b\uff0c\u6240\u6709 API \u8fd4\u56de\u90fd\u5e94\u8be5\u4f7f\u7528 <code>BaseResponse</code> \u6216\u5176\u884d\u751f\u7c7b\u3002</p>"},{"location":"09-http-advanced/#baseresponse","title":"BaseResponse \u7ed3\u6784","text":"<pre><code>from aury.boot.application.interfaces.egress import BaseResponse\nfrom datetime import datetime\n\n# BaseResponse \u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a\n{\n    \"code\": 200,              # \u54cd\u5e94\u72b6\u6001\u7801\n    \"message\": \"\u64cd\u4f5c\u6210\u529f\",    # \u54cd\u5e94\u6d88\u606f\n    \"data\": {...},            # \u54cd\u5e94\u6570\u636e\uff08\u6cdb\u578b\uff09\n    \"timestamp\": \"2024-01-01T12:00:00Z\"  # \u54cd\u5e94\u65f6\u95f4\u6233\n}</code></pre>"},{"location":"09-http-advanced/#_2","title":"\u57fa\u672c\u4f7f\u7528","text":"<pre><code>from fastapi import APIRouter\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nrouter = APIRouter()\n\n# \u8fd4\u56de\u5355\u4e2a\u5bf9\u8c61\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str):\n    user = await db.get_user(user_id)\n    return BaseResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u6210\u529f\",\n        data=user\n    )\n\n# \u8fd4\u56de\u7b80\u5355\u503c\n@router.get(\"/count\")\nasync def get_count():\n    count = await db.count_users()\n    return BaseResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u6210\u529f\",\n        data=count\n    )\n\n# \u8fd4\u56de None\uff08\u4e0d\u9700\u8981\u6570\u636e\uff09\n@router.delete(\"/users/{user_id}\")\nasync def delete_user(user_id: str):\n    await db.delete_user(user_id)\n    return BaseResponse(\n        code=200,\n        message=\"\u5220\u9664\u6210\u529f\",\n        data=None\n    )</code></pre>"},{"location":"09-http-advanced/#_3","title":"\u5206\u9875\u54cd\u5e94","text":""},{"location":"09-http-advanced/#pagination","title":"Pagination \u6a21\u578b","text":"<pre><code>from aury.boot.application.interfaces.egress import (\n    Pagination,\n    PaginationResponse\n)\n\n# Pagination \u5305\u542b\uff1a\n{\n    \"total\": 100,           # \u603b\u8bb0\u5f55\u6570\n    \"items\": [...],         # \u6570\u636e\u5217\u8868\n    \"page\": 1,              # \u5f53\u524d\u9875\u7801\uff08\u4ece 1 \u5f00\u59cb\uff09\n    \"size\": 20,             # \u6bcf\u9875\u5927\u5c0f\n    \"pages\": 5              # \u603b\u9875\u6570\uff08\u81ea\u52a8\u8ba1\u7b97\uff09\n}\n\n# \u9644\u52a0\u5c5e\u6027\uff1a\npagination.has_next         # \u662f\u5426\u6709\u4e0b\u4e00\u9875\npagination.has_prev         # \u662f\u5426\u6709\u4e0a\u4e00\u9875\npagination.skip             # \u8df3\u8fc7\u7684\u8bb0\u5f55\u6570\uff08\u7528\u4e8e SQL OFFSET\uff09</code></pre>"},{"location":"09-http-advanced/#_4","title":"\u5206\u9875\u54cd\u5e94\u793a\u4f8b","text":"<pre><code>@router.get(\"/users\")\nasync def list_users(\n    page: int = 1,\n    size: int = 20,\n    repo=Depends(get_user_repo)\n):\n    # \u83b7\u53d6\u5206\u9875\u6570\u636e\n    items, total = await repo.paginate(page=page, size=size)\n\n    # \u6784\u9020 Pagination \u5bf9\u8c61\n    pagination = Pagination(\n        total=total,\n        items=items,\n        page=page,\n        size=size\n    )\n\n    # \u8fd4\u56de\u5206\u9875\u54cd\u5e94\n    return PaginationResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u5217\u8868\u6210\u529f\",\n        data=pagination\n    )</code></pre>"},{"location":"09-http-advanced/#_5","title":"\u7279\u6b8a\u54cd\u5e94\u7c7b\u578b","text":""},{"location":"09-http-advanced/#successresponse-","title":"SuccessResponse - \u7b80\u5355\u6210\u529f\u6d88\u606f","text":"<pre><code>from aury.boot.application.interfaces.egress import SuccessResponse\n\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest):\n    user = await service.create(request)\n\n    # \u4f7f\u7528\u5de5\u5382\u65b9\u6cd5\u521b\u5efa\n    return SuccessResponse.create(\n        message=\"\u7528\u6237\u521b\u5efa\u6210\u529f\",\n        data={\"user_id\": user.id}\n    )</code></pre>"},{"location":"09-http-advanced/#errorresponse-","title":"ErrorResponse - \u9519\u8bef\u54cd\u5e94","text":"<pre><code>from aury.boot.application.interfaces.egress import ErrorResponse\n\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest):\n    try:\n        user = await service.create(request)\n        return BaseResponse(code=200, message=\"\u6210\u529f\", data=user)\n    except EmailAlreadyExists:\n        return ErrorResponse.create(\n            code=400,\n            message=\"\u90ae\u7bb1\u5df2\u5b58\u5728\",\n            error_code=\"EMAIL_DUPLICATE\"\n        )</code></pre>"},{"location":"09-http-advanced/#idresponse-id","title":"IDResponse - \u8fd4\u56de ID","text":"<pre><code>from aury.boot.application.interfaces.egress import IDResponse\n\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest):\n    user = await service.create(request)\n    return IDResponse(\n        code=200,\n        message=\"\u7528\u6237\u521b\u5efa\u6210\u529f\",\n        data=user.id  # \u53ea\u8fd4\u56de ID\n    )</code></pre>"},{"location":"09-http-advanced/#countresponse-","title":"CountResponse - \u8fd4\u56de\u8ba1\u6570","text":"<pre><code>from aury.boot.application.interfaces.egress import CountResponse\n\n@router.get(\"/users/count\")\nasync def count_users():\n    count = await repo.count()\n    return CountResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u6210\u529f\",\n        data=count\n    )</code></pre>"},{"location":"09-http-advanced/#responsebuilder-","title":"ResponseBuilder - \u4fbf\u6377\u6784\u9020\u5668","text":""},{"location":"09-http-advanced/#responsebuilder","title":"\u4f7f\u7528 ResponseBuilder","text":"<pre><code>from aury.boot.application.interfaces.egress import ResponseBuilder\n\n# \u6210\u529f\u54cd\u5e94\nreturn ResponseBuilder.success(\n    message=\"\u64cd\u4f5c\u6210\u529f\",\n    data={\"key\": \"value\"},\n    code=200\n)\n\n# \u5931\u8d25\u54cd\u5e94\nreturn ResponseBuilder.fail(\n    message=\"\u64cd\u4f5c\u5931\u8d25\",\n    code=400,\n    error_code=\"VALIDATION_ERROR\",\n    errors=[\n        {\"field\": \"email\", \"message\": \"\u90ae\u7bb1\u683c\u5f0f\u4e0d\u6b63\u786e\"}\n    ]\n)</code></pre>"},{"location":"09-http-advanced/#-ingress","title":"\u8bf7\u6c42\u6a21\u578b - Ingress","text":"<p>Kit \u63d0\u4f9b\u4e86\u5185\u7f6e\u7684\u8bf7\u6c42\u6a21\u578b\u57fa\u7c7b\uff0c\u65b9\u4fbf\u6784\u5efa\u6807\u51c6\u7684 API \u8bf7\u6c42\uff1a</p>"},{"location":"09-http-advanced/#baserequest-","title":"BaseRequest - \u57fa\u7840\u8bf7\u6c42","text":"<pre><code>from aury.boot.application.interfaces.ingress import BaseRequest\nfrom pydantic import Field\n\nclass UserCreateRequest(BaseRequest):\n    \"\"\"\u521b\u5efa\u7528\u6237\u8bf7\u6c42\"\"\"\n    username: str = Field(..., min_length=3, max_length=50, description=\"\u7528\u6237\u540d\")\n    email: str = Field(..., description=\"\u90ae\u7bb1\")\n    password: str = Field(..., min_length=8, description=\"\u5bc6\u7801\")\n\n# BaseRequest \u81ea\u52a8\u5305\u542b\uff1a\n# - request_id: str | None  # \u8bf7\u6c42\u8ffd\u8e2a ID</code></pre>"},{"location":"09-http-advanced/#paginationrequest-","title":"PaginationRequest - \u5206\u9875\u8bf7\u6c42","text":"<pre><code>from aury.boot.application.interfaces.ingress import (\n    PaginationRequest,\n    SortOrder\n)\n\nclass UserListRequest(PaginationRequest):\n    \"\"\"\u7528\u6237\u5217\u8868\u8bf7\u6c42\"\"\"\n    keyword: str | None = Field(None, description=\"\u641c\u7d22\u5173\u952e\u8bcd\")\n    is_active: bool | None = Field(None, description=\"\u662f\u5426\u6d3b\u8dc3\")\n\n# PaginationRequest \u5305\u542b\uff1a\n# - page: int = 1           # \u9875\u7801\uff08\u4ece 1 \u5f00\u59cb\uff09\n# - size: int = 20          # \u6bcf\u9875\u6570\u91cf\n# - sort: str | None        # \u6392\u5e8f\u5b57\u6bb5\n# - order: SortOrder        # \u6392\u5e8f\u65b9\u5411\uff08asc/desc\uff09\n# - request_id: str | None  # \u8bf7\u6c42\u8ffd\u8e2a ID\n\n# \u81ea\u52a8\u63d0\u4f9b\u5c5e\u6027\uff1a\npagination_req = UserListRequest(page=2, size=50)\npagination_req.skip        # \u8df3\u8fc7\u7684\u8bb0\u5f55\u6570\uff0850\uff09\npagination_req.limit       # \u9650\u5236\u6570\u91cf\uff0850\uff09</code></pre>"},{"location":"09-http-advanced/#listrequest-","title":"ListRequest - \u5217\u8868\u8bf7\u6c42\uff08\u4e0d\u5206\u9875\uff09","text":"<pre><code>from aury.boot.application.interfaces.ingress import ListRequest\n\nclass UserListAllRequest(ListRequest):\n    \"\"\"\u83b7\u53d6\u6240\u6709\u7528\u6237\u8bf7\u6c42\"\"\"\n    keyword: str | None = Field(None, description=\"\u641c\u7d22\u5173\u952e\u8bcd\")\n\n# ListRequest \u5305\u542b\uff1a\n# - limit: int | None       # \u9650\u5236\u8fd4\u56de\u6570\u91cf\uff08\u6700\u591a 1000\uff09\n# - offset: int = 0         # \u504f\u79fb\u91cf\n# - sort: str | None        # \u6392\u5e8f\u5b57\u6bb5\n# - order: SortOrder        # \u6392\u5e8f\u65b9\u5411\n\nlist_req = UserListAllRequest(limit=100, offset=0)\n# \u4f7f\u7528 offset \u5904\u7406\u6570\u636e\u5e93\u67e5\u8be2\nitems = await db.query(User).offset(list_req.offset).limit(list_req.limit).all()</code></pre>"},{"location":"09-http-advanced/#filterrequest-","title":"FilterRequest - \u8fc7\u6ee4\u8bf7\u6c42","text":"<pre><code>from aury.boot.application.interfaces.ingress import FilterRequest\n\nclass UserFilterRequest(FilterRequest):\n    \"\"\"\u7528\u6237\u8fc7\u6ee4\u8bf7\u6c42\"\"\"\n    keyword: str | None = Field(None, description=\"\u5173\u952e\u8bcd\")\n\n# FilterRequest \u5305\u542b\uff1a\n# - filters: dict | None    # \u8fc7\u6ee4\u6761\u4ef6\u5b57\u5178\n\nfilter_req = UserFilterRequest(filters={\"status\": \"active\", \"role\": \"admin\"})\n# \u4f7f\u7528 filters \u52a8\u6001\u6784\u5efa\u67e5\u8be2\u6761\u4ef6</code></pre>"},{"location":"09-http-advanced/#_6","title":"\u5728\u8def\u7531\u4e2d\u4f7f\u7528","text":"<pre><code>from fastapi import APIRouter\nfrom aury.boot.application.interfaces.ingress import PaginationRequest\n\nrouter = APIRouter()\n\n# \u65b9\u5f0f 1\uff1a\u4f7f\u7528 Query \u53c2\u6570\uff08\u81ea\u52a8\u89e3\u6790\uff09\n@router.get(\"/users\")\nasync def list_users(\n    page: int = 1,\n    size: int = 20,\n    keyword: str | None = None,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u83b7\u53d6\u7528\u6237\u5217\u8868\"\"\"\n    items, total = await service.search(\n        keyword=keyword,\n        page=page,\n        size=size\n    )\n    pagination = Pagination(\n        total=total,\n        items=items,\n        page=page,\n        size=size\n    )\n    return PaginationResponse(code=200, message=\"\u83b7\u53d6\u5217\u8868\u6210\u529f\", data=pagination)\n\n# \u65b9\u5f0f 2\uff1a\u4f7f\u7528\u8bf7\u6c42\u6a21\u578b\uff08\u63a8\u8350\u7528\u4e8e\u590d\u6742\u67e5\u8be2\uff09\nclass UserSearchRequest(PaginationRequest):\n    keyword: str | None = None\n    is_active: bool | None = None\n\n@router.post(\"/users/search\")\nasync def search_users(\n    request: UserSearchRequest,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u641c\u7d22\u7528\u6237\"\"\"\n    items, total = await service.search(\n        keyword=request.keyword,\n        is_active=request.is_active,\n        page=request.page,\n        size=request.size,\n        sort=request.sort,\n        order=request.order\n    )\n    pagination = Pagination(\n        total=total,\n        items=items,\n        page=request.page,\n        size=request.size\n    )\n    return PaginationResponse(code=200, message=\"\u641c\u7d22\u6210\u529f\", data=pagination)</code></pre>"},{"location":"09-http-advanced/#_7","title":"\u5b9a\u4e49\u81ea\u5b9a\u4e49\u8bf7\u6c42\u6a21\u578b","text":""},{"location":"09-http-advanced/#_8","title":"\u521b\u5efa\u6e05\u6670\u7684\u8bf7\u6c42\u6a21\u578b","text":"<pre><code>from pydantic import BaseModel, EmailStr, Field\n\nclass UserCreateRequest(BaseModel):\n    \"\"\"\u521b\u5efa\u7528\u6237\u8bf7\u6c42\"\"\"\n    username: str = Field(..., min_length=3, max_length=50, description=\"\u7528\u6237\u540d\")\n    email: EmailStr = Field(..., description=\"\u90ae\u7bb1\")\n    password: str = Field(..., min_length=8, description=\"\u5bc6\u7801\")\n\n    class Config:\n        json_schema_extra = {\n            \"example\": {\n                \"username\": \"john_doe\",\n                \"email\": \"john@example.com\",\n                \"password\": \"secure_password_123\"\n            }\n        }\n\nclass UserUpdateRequest(BaseModel):\n    \"\"\"\u66f4\u65b0\u7528\u6237\u8bf7\u6c42\"\"\"\n    username: str | None = Field(None, min_length=3, max_length=50)\n    email: EmailStr | None = Field(None)\n    bio: str | None = Field(None, max_length=500)</code></pre>"},{"location":"09-http-advanced/#_9","title":"\u4f7f\u7528\u9a8c\u8bc1\u5668","text":"<pre><code>from pydantic import BaseModel, field_validator\n\nclass UserCreateRequest(BaseModel):\n    username: str\n    email: str\n    password: str\n    password_confirm: str\n\n    @field_validator('username')\n    @classmethod\n    def validate_username(cls, v):\n        if not v.isalnum():\n            raise ValueError('\u7528\u6237\u540d\u53ea\u80fd\u5305\u542b\u5b57\u6bcd\u548c\u6570\u5b57')\n        return v\n\n    @field_validator('password')\n    @classmethod\n    def validate_password(cls, v):\n        if len(v) &lt; 8:\n            raise ValueError('\u5bc6\u7801\u81f3\u5c11 8 \u4e2a\u5b57\u7b26')\n        if not any(c.isupper() for c in v):\n            raise ValueError('\u5bc6\u7801\u5fc5\u987b\u5305\u542b\u5927\u5199\u5b57\u6bcd')\n        return v\n\n    @field_validator('password_confirm')\n    @classmethod\n    def validate_password_match(cls, v, info):\n        if v != info.data.get('password'):\n            raise ValueError('\u4e24\u6b21\u8f93\u5165\u7684\u5bc6\u7801\u4e0d\u4e00\u81f4')\n        return v</code></pre>"},{"location":"09-http-advanced/#crud","title":"\u5b8c\u6574 CRUD \u793a\u4f8b","text":"<pre><code>from fastapi import APIRouter, Depends, HTTPException\nfrom aury.boot.application.interfaces.egress import (\n    BaseResponse,\n    PaginationResponse,\n    Pagination,\n)\n\nrouter = APIRouter(prefix=\"/users\", tags=[\"users\"])\n\n# CREATE\n@router.post(\"\")\nasync def create_user(\n    request: UserCreateRequest,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u521b\u5efa\u7528\u6237\"\"\"\n    try:\n        user = await service.create(request)\n        return BaseResponse(\n            code=200,\n            message=\"\u7528\u6237\u521b\u5efa\u6210\u529f\",\n            data=user\n        )\n    except EmailAlreadyExists as e:\n        raise HTTPException(status_code=400, detail=str(e))\n\n# READ\n@router.get(\"/{user_id}\")\nasync def get_user(\n    user_id: str,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u83b7\u53d6\u5355\u4e2a\u7528\u6237\"\"\"\n    user = await service.get_user(user_id)\n    if not user:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n    return BaseResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u6210\u529f\",\n        data=user\n    )\n\n# LIST\n@router.get(\"\")\nasync def list_users(\n    page: int = 1,\n    size: int = 20,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u83b7\u53d6\u7528\u6237\u5217\u8868\uff08\u5206\u9875\uff09\"\"\"\n    items, total = await service.list_users(page=page, size=size)\n    pagination = Pagination(\n        total=total,\n        items=items,\n        page=page,\n        size=size\n    )\n    return PaginationResponse(\n        code=200,\n        message=\"\u83b7\u53d6\u5217\u8868\u6210\u529f\",\n        data=pagination\n    )\n\n# UPDATE\n@router.put(\"/{user_id}\")\nasync def update_user(\n    user_id: str,\n    request: UserUpdateRequest,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u66f4\u65b0\u7528\u6237\"\"\"\n    user = await service.get_user(user_id)\n    if not user:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n\n    user = await service.update_user(user_id, request)\n    return BaseResponse(\n        code=200,\n        message=\"\u66f4\u65b0\u6210\u529f\",\n        data=user\n    )\n\n# DELETE\n@router.delete(\"/{user_id}\")\nasync def delete_user(\n    user_id: str,\n    service=Depends(get_user_service)\n):\n    \"\"\"\u5220\u9664\u7528\u6237\"\"\"\n    success = await service.delete_user(user_id)\n    if not success:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n    return BaseResponse(\n        code=200,\n        message=\"\u5220\u9664\u6210\u529f\",\n        data=None\n    )</code></pre>"},{"location":"09-http-advanced/#_10","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"09-http-advanced/#_11","title":"\u5f02\u5e38\u4e0e\u54cd\u5e94\u6620\u5c04","text":"<pre><code>from fastapi import FastAPI\nfrom aury.boot.application.errors import (\n    NotFoundError,\n    AlreadyExistsError,\n    UnauthorizedError,\n)\nfrom aury.boot.application.interfaces.egress import ErrorResponse\n\napp = FastAPI()\n\n@app.exception_handler(NotFoundError)\nasync def not_found_handler(request, exc):\n    return ErrorResponse.create(\n        code=404,\n        message=str(exc),\n        error_code=\"NOT_FOUND\"\n    )\n\n@app.exception_handler(AlreadyExistsError)\nasync def already_exists_handler(request, exc):\n    return ErrorResponse.create(\n        code=400,\n        message=str(exc),\n        error_code=\"ALREADY_EXISTS\"\n    )</code></pre>"},{"location":"09-http-advanced/#_12","title":"\u9a8c\u8bc1\u9519\u8bef\u5904\u7406","text":"<pre><code>from fastapi.exceptions import RequestValidationError\nfrom fastapi.responses import JSONResponse\n\n@app.exception_handler(RequestValidationError)\nasync def validation_exception_handler(request, exc):\n    errors = []\n    for error in exc.errors():\n        errors.append({\n            \"field\": \".\".join(str(x) for x in error[\"loc\"][1:]),\n            \"message\": error[\"msg\"]\n        })\n\n    return JSONResponse(\n        status_code=400,\n        content={\n            \"code\": 400,\n            \"message\": \"\u8bf7\u6c42\u53c2\u6570\u9a8c\u8bc1\u5931\u8d25\",\n            \"error_code\": \"VALIDATION_ERROR\",\n            \"details\": {\"errors\": errors}\n        }\n    )</code></pre>"},{"location":"09-http-advanced/#_13","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"09-http-advanced/#q-fastapi-response_model","title":"Q: \u4e3a\u4ec0\u4e48\u4e0d\u4f7f\u7528 FastAPI \u7684 response_model\uff1f","text":"<p>A: Kit \u91c7\u7528\u7edf\u4e00\u7684\u54cd\u5e94\u683c\u5f0f\u6709\u4ee5\u4e0b\u4f18\u52bf\uff1a - \u6240\u6709 API \u54cd\u5e94\u7ed3\u6784\u4e00\u81f4 - \u81ea\u52a8\u5305\u542b\u65f6\u95f4\u6233\u548c\u72b6\u6001\u7801 - \u4fbf\u4e8e\u5ba2\u6237\u7aef\u5904\u7406 - \u652f\u6301\u56fd\u9645\u5316\u9519\u8bef\u6d88\u606f</p>"},{"location":"09-http-advanced/#q","title":"Q: \u5982\u4f55\u8fd4\u56de\u81ea\u5b9a\u4e49\u6570\u636e\u7ed3\u6784\uff1f","text":"<p>A: \u4f7f\u7528 <code>BaseResponse[T]</code> \u7684\u6cdb\u578b\uff1a</p> <pre><code>from aury.boot.application.interfaces.egress import BaseResponse\nfrom pydantic import BaseModel\n\nclass CustomData(BaseModel):\n    key1: str\n    key2: int\n\nreturn BaseResponse[CustomData](\n    code=200,\n    message=\"\u6210\u529f\",\n    data=CustomData(key1=\"value\", key2=123)\n)</code></pre>"},{"location":"09-http-advanced/#q_1","title":"Q: \u80fd\u5426\u81ea\u5b9a\u4e49\u54cd\u5e94\u5b57\u6bb5\uff1f","text":"<p>A: \u53ef\u4ee5\u7ee7\u627f <code>BaseResponse</code>\uff1a</p> <pre><code>from aury.boot.application.interfaces.egress import BaseResponse\nfrom pydantic import Field\n\nclass CustomResponse(BaseResponse[dict]):\n    extra_field: str = Field(..., description=\"\u989d\u5916\u5b57\u6bb5\")\n\nreturn CustomResponse(\n    code=200,\n    message=\"\u6210\u529f\",\n    data={},\n    extra_field=\"custom_value\"\n)</code></pre>"},{"location":"09-http-advanced/#_14","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 08-error-handling-guide.md \u4e86\u89e3\u9519\u8bef\u5904\u7406</li> <li>\u67e5\u770b 09-database-complete.md \u4e86\u89e3\u6570\u636e\u8bbf\u95ee</li> <li>\u67e5\u770b 20-best-practices.md \u4e86\u89e3\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"10-error-handling-guide/","title":"9. \u9519\u8bef\u5904\u7406\u5b8c\u5168\u6307\u5357","text":""},{"location":"10-error-handling-guide/#_1","title":"\u5f00\u53d1\u89c4\u8303\uff1a\u5f02\u5e38\u7ee7\u627f\u539f\u5219","text":"<p>\u6838\u5fc3\u539f\u5219\uff1a\u6240\u6709\u670d\u52a1\u7684\u4e1a\u52a1\u5f02\u5e38\u90fd\u5fc5\u987b\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\u7c7b\uff0c\u4e0d\u5141\u8bb8\u521b\u5efa\u72ec\u7acb\u7684\u5f02\u5e38\u4f53\u7cfb\u3002</p> <p>\u8fd9\u786e\u4fdd\uff1a - \u2705 \u5f02\u5e38\u80fd\u88ab Foundation Kit \u7684\u5168\u5c40\u5f02\u5e38\u5904\u7406\u5668\u6b63\u786e\u6355\u83b7 - \u2705 \u81ea\u52a8\u6620\u5c04\u5230\u6b63\u786e\u7684 HTTP \u72b6\u6001\u7801 - \u2705 \u7edf\u4e00\u7684\u5f02\u5e38\u54cd\u5e94\u683c\u5f0f - \u2705 \u4fbf\u4e8e\u670d\u52a1\u95f4\u5f02\u5e38\u5904\u7406</p>"},{"location":"10-error-handling-guide/#_2","title":"\u5f02\u5e38\u4f53\u7cfb","text":"<p>Kit \u63d0\u4f9b\u4e86\u6807\u51c6\u5316\u7684\u5f02\u5e38\u4f53\u7cfb\uff0c\u8986\u76d6\u5e38\u89c1\u7684\u5e94\u7528\u573a\u666f\u3002</p>"},{"location":"10-error-handling-guide/#_3","title":"\u6807\u51c6\u5f02\u5e38","text":"<pre><code>from aury.boot.application.errors import (\n    NotFoundError,              # 404 \u8d44\u6e90\u4e0d\u5b58\u5728\n    AlreadyExistsError,         # 409 \u8d44\u6e90\u5df2\u5b58\u5728\n    UnauthorizedError,          # 401 \u672a\u6388\u6743\n    ForbiddenError,             # 403 \u65e0\u6743\u9650\n    ValidationError,            # 400 \u9a8c\u8bc1\u5931\u8d25\n    ConflictError,              # 409 \u51b2\u7a81\n    InternalServerError,        # 500 \u670d\u52a1\u5668\u9519\u8bef\n    ServiceUnavailableError,    # 503 \u670d\u52a1\u4e0d\u53ef\u7528\n)\n\n# \u4f7f\u7528\u793a\u4f8b\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, repo=Depends(get_user_repo)):\n    user = await repo.get(user_id)\n    if not user:\n        raise NotFoundError(f\"\u7528\u6237 {user_id} \u4e0d\u5b58\u5728\")\n    return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)\n\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest, repo=Depends(get_user_repo)):\n    existing = await repo.get_by_email(request.email)\n    if existing:\n        raise AlreadyExistsError(f\"\u90ae\u7bb1 {request.email} \u5df2\u88ab\u4f7f\u7528\")\n\n    user = await repo.create({\"email\": request.email})\n    return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=user)</code></pre>"},{"location":"10-error-handling-guide/#http","title":"\u5f02\u5e38\u5230 HTTP \u72b6\u6001\u7801\u7684\u6620\u5c04","text":"<pre><code>NotFoundError           \u2192 404\nAlreadyExistsError      \u2192 409\nUnauthorizedError       \u2192 401\nForbiddenError          \u2192 403\nValidationError         \u2192 400\nConflictError           \u2192 409\nInternalServerError     \u2192 500\nServiceUnavailableError \u2192 503\n</code></pre>"},{"location":"10-error-handling-guide/#_4","title":"\u81ea\u5b9a\u4e49\u5f02\u5e38\uff08\u9075\u5faa\u7ee7\u627f\u89c4\u5219\uff09","text":""},{"location":"10-error-handling-guide/#_5","title":"\u5b9a\u4e49\u4e1a\u52a1\u5f02\u5e38\u7684\u6b63\u786e\u65b9\u5f0f","text":"<pre><code># \u2705 \u6b63\u786e\uff1a\u4e1a\u52a1\u5f02\u5e38\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\u7c7b\nfrom aury.boot.application.errors import (\n    BusinessError,\n    NotFoundError,\n    AlreadyExistsError,\n)\n\nclass InsufficientBalanceError(BusinessError):\n    \"\"\"\u4f59\u989d\u4e0d\u8db3\u9519\u8bef - \u7ee7\u627f BusinessError (400)\"\"\"\n\n    def __init__(self, balance: float, required: float, **kwargs):\n        super().__init__(\n            message=f\"\u4f59\u989d\u4e0d\u8db3\uff1a\u9700\u8981 {required}\uff0c\u73b0\u6709 {balance}\",\n            metadata={\n                \"balance\": balance,\n                \"required\": required,\n            },\n            **kwargs\n        )\n\nclass OrderNotFoundError(NotFoundError):\n    \"\"\"\u8ba2\u5355\u4e0d\u5b58\u5728\u9519\u8bef - \u7ee7\u627f NotFoundError (404)\"\"\"\n\n    def __init__(self, order_id: str, **kwargs):\n        super().__init__(\n            message=f\"\u8ba2\u5355 {order_id} \u4e0d\u5b58\u5728\",\n            resource=\"Order\",\n            metadata={\"order_id\": order_id},\n            **kwargs\n        )\n\nclass DuplicateOrderError(AlreadyExistsError):\n    \"\"\"\u8ba2\u5355\u91cd\u590d\u9519\u8bef - \u7ee7\u627f AlreadyExistsError (409)\"\"\"\n\n    def __init__(self, order_id: str, **kwargs):\n        super().__init__(\n            message=f\"\u8ba2\u5355 {order_id} \u5df2\u5b58\u5728\",\n            resource=\"Order\",\n            metadata={\"order_id\": order_id},\n            **kwargs\n        )\n\n# \u274c \u9519\u8bef\uff1a\u4e0d\u8981\u521b\u5efa\u72ec\u7acb\u7684\u5f02\u5e38\u4f53\u7cfb\n# from some_custom_lib import CustomAppError  # \u4e0d\u5141\u8bb8\n# class OrderProcessingError(CustomAppError):  # \u4e0d\u5141\u8bb8\n#     pass\n\n# \u4f7f\u7528\n@router.post(\"/orders/{order_id}/pay\")\nasync def pay_order(order_id: str, service=Depends(get_order_service)):\n    try:\n        result = await service.process_payment(order_id)\n        return BaseResponse(code=200, message=\"\u652f\u4ed8\u6210\u529f\", data=result)\n    except InsufficientBalanceError as e:\n        raise HTTPException(status_code=400, detail=e.message)\n    except OrderProcessingError as e:\n        raise HTTPException(status_code=400, detail=e.message)</code></pre>"},{"location":"10-error-handling-guide/#_6","title":"\u5f02\u5e38\u5904\u7406","text":""},{"location":"10-error-handling-guide/#_7","title":"\u5168\u5c40\u5f02\u5e38\u5904\u7406\u5668","text":"<pre><code>from fastapi import FastAPI, Request\nfrom fastapi.responses import JSONResponse\nfrom fastapi.exceptions import RequestValidationError\nfrom aury.boot.application.interfaces.egress import (\n    ErrorResponse,\n    ResponseBuilder\n)\nfrom aury.boot.common.logging import logger\n\napp = FastAPI()\n\n# \u5904\u7406\u5e94\u7528\u5f02\u5e38\n@app.exception_handler(Exception)\nasync def global_exception_handler(request: Request, exc: Exception):\n    logger.error(f\"\u672a\u6355\u83b7\u7684\u5f02\u5e38: {exc}\", exc_info=exc)\n\n    return JSONResponse(\n        status_code=500,\n        content=ErrorResponse.create(\n            code=500,\n            message=\"\u670d\u52a1\u5668\u5185\u90e8\u9519\u8bef\",\n            error_code=\"INTERNAL_SERVER_ERROR\"\n        ).model_dump()\n    )\n\n# \u5904\u7406\u9a8c\u8bc1\u9519\u8bef\n@app.exception_handler(RequestValidationError)\nasync def validation_exception_handler(request: Request, exc: RequestValidationError):\n    errors = []\n    for error in exc.errors():\n        field_path = \".\".join(str(x) for x in error[\"loc\"][1:])\n        errors.append({\n            \"field\": field_path,\n            \"message\": error[\"msg\"],\n            \"type\": error[\"type\"]\n        })\n\n    return JSONResponse(\n        status_code=400,\n        content=ErrorResponse.create(\n            code=400,\n            message=\"\u8bf7\u6c42\u53c2\u6570\u9a8c\u8bc1\u5931\u8d25\",\n            error_code=\"VALIDATION_ERROR\",\n            details={\"errors\": errors}\n        ).model_dump()\n    )\n\n# \u5904\u7406\u7279\u5b9a\u5f02\u5e38\n@app.exception_handler(NotFoundError)\nasync def not_found_handler(request: Request, exc: NotFoundError):\n    return JSONResponse(\n        status_code=404,\n        content=ErrorResponse.create(\n            code=404,\n            message=str(exc),\n            error_code=\"NOT_FOUND\"\n        ).model_dump()\n    )\n\n@app.exception_handler(AlreadyExistsError)\nasync def already_exists_handler(request: Request, exc: AlreadyExistsError):\n    return JSONResponse(\n        status_code=409,\n        content=ErrorResponse.create(\n            code=409,\n            message=str(exc),\n            error_code=\"ALREADY_EXISTS\"\n        ).model_dump()\n    )\n\n@app.exception_handler(UnauthorizedError)\nasync def unauthorized_handler(request: Request, exc: UnauthorizedError):\n    return JSONResponse(\n        status_code=401,\n        content=ErrorResponse.create(\n            code=401,\n            message=str(exc),\n            error_code=\"UNAUTHORIZED\"\n        ).model_dump()\n    )</code></pre>"},{"location":"10-error-handling-guide/#_8","title":"\u9519\u8bef\u4ee3\u7801\u7ba1\u7406","text":""},{"location":"10-error-handling-guide/#_9","title":"\u96c6\u4e2d\u7ba1\u7406\u9519\u8bef\u4ee3\u7801","text":"<pre><code># errors/codes.py\nclass ErrorCode:\n    \"\"\"\u9519\u8bef\u4ee3\u7801\u5e38\u91cf\"\"\"\n\n    # \u7528\u6237\u76f8\u5173\n    USER_NOT_FOUND = \"USER_NOT_FOUND\"\n    USER_ALREADY_EXISTS = \"USER_ALREADY_EXISTS\"\n    INVALID_CREDENTIALS = \"INVALID_CREDENTIALS\"\n\n    # \u8ba2\u5355\u76f8\u5173\n    ORDER_NOT_FOUND = \"ORDER_NOT_FOUND\"\n    INVALID_ORDER_STATUS = \"INVALID_ORDER_STATUS\"\n    INSUFFICIENT_BALANCE = \"INSUFFICIENT_BALANCE\"\n\n    # \u9a8c\u8bc1\u76f8\u5173\n    VALIDATION_ERROR = \"VALIDATION_ERROR\"\n    INVALID_EMAIL = \"INVALID_EMAIL\"\n    WEAK_PASSWORD = \"WEAK_PASSWORD\"\n\n# \u4f7f\u7528\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest, service=Depends(...)):\n    try:\n        user = await service.create(request)\n        return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=user)\n    except Exception as e:\n        raise HTTPException(\n            status_code=400,\n            detail=ErrorResponse.create(\n                code=400,\n                message=str(e),\n                error_code=ErrorCode.VALIDATION_ERROR\n            ).model_dump()\n        )</code></pre>"},{"location":"10-error-handling-guide/#_10","title":"\u9519\u8bef\u65e5\u5fd7","text":""},{"location":"10-error-handling-guide/#_11","title":"\u7ed3\u6784\u5316\u9519\u8bef\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\n@router.post(\"/orders\")\nasync def create_order(request: OrderRequest, service=Depends(...)):\n    try:\n        order = await service.create(request)\n        logger.info(\"\u8ba2\u5355\u521b\u5efa\u6210\u529f\", extra={\n            \"order_id\": order.id,\n            \"user_id\": order.user_id,\n            \"amount\": order.total_amount\n        })\n        return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=order)\n\n    except ValidationError as e:\n        logger.warning(\"\u8ba2\u5355\u9a8c\u8bc1\u5931\u8d25\", extra={\n            \"errors\": str(e),\n            \"request\": request.dict()\n        })\n        raise\n\n    except Exception as e:\n        logger.error(\"\u8ba2\u5355\u521b\u5efa\u5f02\u5e38\", extra={\n            \"error\": str(e),\n            \"error_type\": type(e).__name__,\n            \"request\": request.dict()\n        })\n        raise</code></pre>"},{"location":"10-error-handling-guide/#_12","title":"\u4f18\u96c5\u7684\u9519\u8bef\u5904\u7406\u6a21\u5f0f","text":""},{"location":"10-error-handling-guide/#try-except-else","title":"Try-Except-Else \u6a21\u5f0f","text":"<pre><code>@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest, service=Depends(...)):\n    try:\n        user = await service.create(request)\n    except AlreadyExistsError:\n        logger.warning(f\"\u7528\u6237\u90ae\u7bb1\u5df2\u5b58\u5728: {request.email}\")\n        raise HTTPException(status_code=409, detail=\"\u90ae\u7bb1\u5df2\u5b58\u5728\")\n    except ValidationError as e:\n        logger.warning(f\"\u9a8c\u8bc1\u5931\u8d25: {e}\")\n        raise HTTPException(status_code=400, detail=str(e))\n    except Exception as e:\n        logger.error(f\"\u521b\u5efa\u7528\u6237\u5f02\u5e38: {e}\")\n        raise HTTPException(status_code=500, detail=\"\u670d\u52a1\u5668\u9519\u8bef\")\n    else:\n        # \u6210\u529f\u5206\u652f\n        logger.info(f\"\u7528\u6237\u521b\u5efa\u6210\u529f: {user.id}\")\n        return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=user)</code></pre>"},{"location":"10-error-handling-guide/#context-manager","title":"Context Manager \u6a21\u5f0f\uff08\u4e8b\u52a1\u76f8\u5173\uff09","text":"<pre><code>from aury.boot.domain.transaction import transactional_context\n\n@router.post(\"/orders\")\nasync def create_order(request: OrderRequest, session=Depends(...)):\n    try:\n        async with transactional_context(session) as txn_session:\n            order_repo = OrderRepository(txn_session)\n            order = await order_repo.create(request.dict())\n\n            # \u5982\u679c\u4ee5\u4e0b\u4efb\u4f55\u64cd\u4f5c\u5931\u8d25\uff0c\u6574\u4e2a\u4e8b\u52a1\u56de\u6eda\n            item_repo = OrderItemRepository(txn_session)\n            for item in request.items:\n                await item_repo.create({\n                    \"order_id\": order.id,\n                    **item.dict()\n                })\n\n    except Exception as e:\n        logger.error(f\"\u521b\u5efa\u8ba2\u5355\u5931\u8d25: {e}\")\n        raise HTTPException(status_code=500, detail=\"\u521b\u5efa\u8ba2\u5355\u5931\u8d25\")\n\n    return BaseResponse(code=200, message=\"\u521b\u5efa\u6210\u529f\", data=order)</code></pre>"},{"location":"10-error-handling-guide/#_13","title":"\u5e38\u89c1\u95ee\u9898\u548c\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"10-error-handling-guide/#_14","title":"\u274c \u5e38\u89c1\u9519\u8bef","text":"<pre><code># \u9519\u8bef 1: \u6355\u83b7\u6240\u6709\u5f02\u5e38\u4f46\u4ec0\u4e48\u90fd\u4e0d\u505a\ntry:\n    result = await operation()\nexcept:\n    pass  # \u274c \u9690\u85cf\u4e86\u771f\u5b9e\u9519\u8bef\n\n# \u9519\u8bef 2: \u5f02\u5e38\u6d88\u606f\u66b4\u9732\u5185\u90e8\u7ec6\u8282\nraise Exception(f\"\u6570\u636e\u5e93\u8fde\u63a5\u5931\u8d25: {db_error}\")  # \u274c \u66b4\u9732\u5185\u90e8\u4fe1\u606f\n\n# \u9519\u8bef 3: \u6ca1\u6709\u8bb0\u5f55\u5f02\u5e38\u5806\u6808\nexcept Exception:\n    logger.error(\"\u64cd\u4f5c\u5931\u8d25\")  # \u274c \u6ca1\u6709\u5806\u6808\u4fe1\u606f\n\n# \u9519\u8bef 4: \u91cd\u590d\u5305\u88c5\u5f02\u5e38\ntry:\n    operation()\nexcept Exception as e:\n    raise Exception(f\"\u64cd\u4f5c\u5931\u8d25: {e}\")  # \u274c \u4e22\u5931\u539f\u59cb\u4fe1\u606f</code></pre>"},{"location":"10-error-handling-guide/#_15","title":"\u2705 \u6700\u4f73\u5b9e\u8df5","text":"<pre><code># \u597d 1: \u6355\u83b7\u7279\u5b9a\u5f02\u5e38\u5e76\u9002\u5f53\u5904\u7406\ntry:\n    result = await operation()\nexcept SpecificError as e:\n    logger.warning(f\"\u9884\u671f\u7684\u9519\u8bef: {e}\")\n    # \u5904\u7406\u5df2\u77e5\u7684\u9519\u8bef\n    raise HTTPException(status_code=400, detail=\"\u64cd\u4f5c\u5931\u8d25\")\nexcept Exception as e:\n    logger.error(f\"\u672a\u9884\u671f\u7684\u9519\u8bef\", exc_info=e)\n    # \u5904\u7406\u672a\u77e5\u7684\u9519\u8bef\n    raise HTTPException(status_code=500, detail=\"\u670d\u52a1\u5668\u9519\u8bef\")\n\n# \u597d 2: \u5f02\u5e38\u6d88\u606f\u4e0d\u66b4\u9732\u5185\u90e8\u7ec6\u8282\ntry:\n    connection = await connect_db()\nexcept Exception as e:\n    logger.error(f\"\u6570\u636e\u5e93\u8fde\u63a5\u5931\u8d25: {e}\")\n    # \u5bf9\u7528\u6237\u9690\u85cf\u7ec6\u8282\n    raise ServiceUnavailableError(\"\u6570\u636e\u5e93\u6682\u65f6\u4e0d\u53ef\u7528\")\n\n# \u597d 3: \u8bb0\u5f55\u5b8c\u6574\u7684\u5f02\u5e38\u4fe1\u606f\nexcept Exception as e:\n    logger.error(\"\u64cd\u4f5c\u5931\u8d25\", exc_info=e)  # \u5305\u542b\u5806\u6808\n\n# \u597d 4: \u63d0\u4f9b\u6709\u7528\u7684\u9519\u8bef\u4e0a\u4e0b\u6587\nexcept DatabaseError as e:\n    logger.error(\"\u6570\u636e\u5e93\u64cd\u4f5c\u5931\u8d25\", extra={\n        \"operation\": \"create_user\",\n        \"user_email\": request.email,\n        \"error\": str(e)\n    })\n    raise</code></pre>"},{"location":"10-error-handling-guide/#_16","title":"\u9519\u8bef\u54cd\u5e94\u793a\u4f8b","text":"<pre><code>{\n  \"code\": 400,\n  \"message\": \"\u8bf7\u6c42\u53c2\u6570\u9a8c\u8bc1\u5931\u8d25\",\n  \"error_code\": \"VALIDATION_ERROR\",\n  \"details\": {\n    \"errors\": [\n      {\n        \"field\": \"email\",\n        \"message\": \"invalid email format\",\n        \"type\": \"value_error.email\"\n      },\n      {\n        \"field\": \"password\",\n        \"message\": \"ensure this value has at least 8 characters\",\n        \"type\": \"value_error.string.too_short\"\n      }\n    ]\n  },\n  \"timestamp\": \"2024-01-01T12:00:00Z\"\n}\n</code></pre>"},{"location":"10-error-handling-guide/#_17","title":"\u670d\u52a1\u5f02\u5e38\u5b9a\u4e49\u7684\u5f00\u53d1\u89c4\u8303","text":""},{"location":"10-error-handling-guide/#_18","title":"\u5f02\u5e38\u547d\u540d\u7ea6\u5b9a","text":"<p>\u89c4\u8303\uff1a<code>&lt;\u4e1a\u52a1\u5bf9\u8c61&gt;&lt;\u64cd\u4f5c&gt;&lt;\u5f02\u5e38\u7c7b\u578b&gt;Error</code></p> <pre><code>\u2705 \u6b63\u786e\u7684\u547d\u540d\n- UserNotFoundError       (\u7528\u6237\u4e0d\u5b58\u5728)\n- UserInactiveError       (\u7528\u6237\u672a\u6fc0\u6d3b)\n- DuplicateUserError      (\u7528\u6237\u91cd\u590d)\n- InvalidCredentialsError (\u65e0\u6548\u51ed\u8bc1)\n- TokenExpiredError       (\u4ee4\u724c\u8fc7\u671f)\n\n\u274c \u4e0d\u89c4\u8303\u7684\u547d\u540d\n- UserError              (\u592a\u5bbd\u6cdb)\n- NotFoundErr            (\u7f29\u5199\u4e0d\u4e00\u81f4)\n- UserExistsAlready      (\u683c\u5f0f\u4e0d\u4e00\u81f4)\n</code></pre>"},{"location":"10-error-handling-guide/#_19","title":"\u5f02\u5e38\u4ee3\u7801\u8303\u56f4\u7ea6\u5b9a","text":"<p>\u6bcf\u4e2a\u670d\u52a1\u7684\u9519\u8bef\u4ee3\u7801\u679a\u4e3e\u5fc5\u987b\u7ee7\u627f Foundation Kit \u7684 <code>ErrorCode</code>\uff0c\u5728\u670d\u52a1\u7279\u5b9a\u7684\u8303\u56f4\u5185\u5b9a\u4e49\uff0c\u4e0d\u5141\u8bb8\u8986\u76d6\u5df2\u6709\u7684\u9519\u8bef\u4ee3\u7801\uff1a</p> <p>Foundation Kit \u4fdd\u7559\u8303\u56f4\uff08\u4e0d\u8986\u76d6\uff09\uff1a <pre><code>\u901a\u7528\u9519\u8bef     (1xxx):  VALIDATION_ERROR\u3001NOT_FOUND \u7b49\n\u6570\u636e\u5e93\u9519\u8bef   (2xxx):  DATABASE_ERROR\u3001DUPLICATE_KEY \u7b49\n\u4e1a\u52a1\u9519\u8bef     (3xxx):  BUSINESS_ERROR\u3001INVALID_OPERATION \u7b49\n\u5916\u90e8\u670d\u52a1\u9519\u8bef (4xxx):  EXTERNAL_SERVICE_ERROR\u3001TIMEOUT_ERROR \u7b49\n</code></pre></p> <p>\u670d\u52a1\u5b9a\u4e49\u8303\u56f4\u793a\u4f8b\uff08Identity \u670d\u52a1\uff09\uff1a <pre><code>\u8ba4\u8bc1\u9519\u8bef     (5001-5099):  INVALID_CREDENTIALS\u3001TOKEN_EXPIRED \u7b49\n\u7528\u6237\u9519\u8bef     (5101-5199):  USER_NOT_FOUND\u3001DUPLICATE_USER \u7b49\n\u79df\u6237\u9519\u8bef     (5201-5299):  TENANT_NOT_FOUND\u3001TENANT_INACTIVE \u7b49\n\u5e94\u7528\u9519\u8bef     (5301-5399):  APPLICATION_NOT_FOUND \u7b49\n\u4f1a\u8bdd\u9519\u8bef     (5401-5499):  SESSION_NOT_FOUND\u3001SESSION_EXPIRED \u7b49\n\u8bbf\u95ee\u5bc6\u94a5\u9519\u8bef (5501-5599):  ACCESS_KEY_NOT_FOUND \u7b49\n\u9a8c\u8bc1\u9519\u8bef     (5601-5699):  VERIFICATION_CODE_INVALID \u7b49\n\u6743\u9650\u9519\u8bef     (5701-5799):  PERMISSION_DENIED \u7b49\n</code></pre></p>"},{"location":"10-error-handling-guide/#_20","title":"\u5f02\u5e38\u7ee7\u627f\u548c\u4ee3\u7801\u7684\u5b8c\u6574\u89c4\u8303","text":"<p>\u9519\u8bef\u4ee3\u7801\u7ee7\u627f\u94fe\uff1a\u5b9a\u4e49\u9519\u8bef\u4ee3\u7801\u679a\u4e3e\u65f6\u5fc5\u987b\u7ee7\u627f Foundation Kit \u7684 <code>ErrorCode</code></p> <pre><code>from aury.boot.application.errors.codes import ErrorCode\n\n# \u2705 \u6b63\u786e\u7684\u7ee7\u627f\u65b9\u5f0f - \u7ee7\u627f ErrorCode\uff0c\u5728 5xxx \u8303\u56f4\u5185\u5b9a\u4e49\nclass IdentityErrorCode(ErrorCode):\n    \"\"\"Identity \u670d\u52a1\u9519\u8bef\u4ee3\u7801\u3002\n\n    \u7ee7\u627f\u81ea Foundation Kit \u7684 ErrorCode\uff0c\u5728 5xxx \u8303\u56f4\u5185\u5b9a\u4e49\u3002\n    \u4e0d\u8986\u76d6 Foundation Kit \u5df2\u6709\u7684\u9519\u8bef\u4ee3\u7801\uff081xxx-4xxx\uff09\u3002\n    \"\"\"\n    # \u8ba4\u8bc1\u9519\u8bef (5001-5099)\n    INVALID_CREDENTIALS = \"5001\"\n    INVALID_TOKEN = \"5002\"\n    TOKEN_EXPIRED = \"5003\"\n\n    # \u7528\u6237\u9519\u8bef (5101-5199)\n    USER_NOT_FOUND = \"5101\"\n    DUPLICATE_USER = \"5104\"\n    # ... \u66f4\u591a\u9519\u8bef\u4ee3\u7801</code></pre> <p>\u5f02\u5e38\u7ee7\u627f\u94fe\uff1a\u5b9a\u4e49\u5f02\u5e38\u65f6\u5fc5\u987b\u663e\u5f0f\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\u7c7b\uff0c\u5e76\u5728 metadata \u4e2d\u4f7f\u7528\u9519\u8bef\u4ee3\u7801</p> <pre><code>from aury.boot.application.errors import (\n    UnauthorizedError,      # 401\n    NotFoundError,          # 404\n    AlreadyExistsError,     # 409\n    ForbiddenError,         # 403\n    ValidationError,        # 400\n    BusinessError,          # 400\n)\n\n# \u2705 \u6b63\u786e\u7684\u7ee7\u627f\u65b9\u5f0f\nclass InvalidCredentialsError(UnauthorizedError):\n    \"\"\"\u51ed\u8bc1\u65e0\u6548\u5f02\u5e38\u3002\n\n    \u7ee7\u627f\u81ea UnauthorizedError (401)\n    \"\"\"\n    def __init__(self, message: str = \"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\", **kwargs):\n        # \u5fc5\u987b\u8c03\u7528\u7236\u7c7b __init__\n        metadata = kwargs.pop(\"metadata\", {})\n        metadata[\"error_code\"] = IdentityErrorCode.INVALID_CREDENTIALS.value\n        super().__init__(message=message, metadata=metadata, **kwargs)\n\nclass UserNotFoundError(NotFoundError):\n    \"\"\"\u7528\u6237\u4e0d\u5b58\u5728\u5f02\u5e38 - \u4ee3\u7801 4101\"\"\"\n    def __init__(self, user_id: str | None = None, **kwargs):\n        message = kwargs.pop(\"message\", \"\u7528\u6237\u4e0d\u5b58\u5728\")\n        metadata = kwargs.pop(\"metadata\", {})\n        if user_id:\n            metadata[\"user_id\"] = user_id\n        # \u5fc5\u987b\u8c03\u7528\u7236\u7c7b __init__\uff0c\u4f20\u9012 resource \u548c metadata\n        super().__init__(\n            message=message, \n            resource=\"User\",\n            metadata=metadata, \n            **kwargs\n        )\n\nclass DuplicateUserError(AlreadyExistsError):\n    \"\"\"\u7528\u6237\u91cd\u590d\u5f02\u5e38 - \u4ee3\u7801 4104\"\"\"\n    def __init__(self, field: str, value: str, **kwargs):\n        message = kwargs.pop(\"message\", f\"{field} \u5df2\u88ab\u4f7f\u7528\")\n        metadata = kwargs.pop(\"metadata\", {})\n        metadata[\"field\"] = field\n        metadata[\"value\"] = value\n        # \u5fc5\u987b\u8c03\u7528\u7236\u7c7b __init__\n        super().__init__(\n            message=message,\n            resource=\"User\",\n            metadata=metadata,\n            **kwargs\n        )\n\n# \u274c \u9519\u8bef\u7684\u65b9\u5f0f - \u4e0d\u7ee7\u627f\u4efb\u4f55\u5f02\u5e38\nclass MyCustomError(Exception):\n    pass\n\n# \u274c \u9519\u8bef\u7684\u65b9\u5f0f - \u6ca1\u6709\u8c03\u7528\u7236\u7c7b __init__\nclass BadError(NotFoundError):\n    def __init__(self, message: str):\n        # \u6ca1\u6709\u8c03\u7528 super().__init__()\uff0c\u4f1a\u5bfc\u81f4\u5f02\u5e38\u5904\u7406\u5931\u8d25\n        self.message = message</code></pre> <p>\u9519\u8bef\u4ee3\u7801\u8ffd\u8e2a\u793a\u4f8b\uff1a</p> <pre><code># \u670d\u52a1\u5c42\u5b9a\u4e49\u5f02\u5e38\u65f6\u4f7f\u7528\u7edf\u4e00\u7684\u9519\u8bef\u4ee3\u7801\nclass ErrorCodes:\n    \"\"\"\u670d\u52a1\u9519\u8bef\u4ee3\u7801\u5e38\u91cf\"\"\"\n    INVALID_CREDENTIALS = 4001      # \u8ba4\u8bc1\u9519\u8bef\u8303\u56f4\n    USER_NOT_FOUND = 4101           # \u7528\u6237\u9519\u8bef\u8303\u56f4\n    DUPLICATE_USER = 4104\n    PERMISSION_DENIED = 4701        # \u6743\u9650\u9519\u8bef\u8303\u56f4\n\n# \u5728\u5f02\u5e38\u4e2d\u4f7f\u7528\u9519\u8bef\u4ee3\u7801\uff08\u53ef\u9009\uff09\nraise InvalidCredentialsError(\n    message=\"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\",\n    metadata={\n        \"error_code\": ErrorCodes.INVALID_CREDENTIALS,\n        \"timestamp\": datetime.utcnow().isoformat(),\n    }\n)\n\n# HTTP \u54cd\u5e94\u4f1a\u81ea\u52a8\u5305\u542b\u5143\u6570\u636e\u4e2d\u7684\u9519\u8bef\u4ee3\u7801\n# {\n#     \"code\": 401,                          # HTTP \u72b6\u6001\u7801\uff08\u7531\u5f02\u5e38\u7c7b\u51b3\u5b9a\uff09\n#     \"message\": \"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\",\n#     \"metadata\": {\n#         \"error_code\": 4001,               # \u670d\u52a1\u9519\u8bef\u4ee3\u7801\n#         \"timestamp\": \"2025-12-01T10:00:00\"\n#     }\n# }</code></pre> <p>\u7ee7\u627f\u94fe\u8981\u6c42\u603b\u7ed3\uff1a</p> \u8981\u6c42 \u8bf4\u660e \u5fc5\u987b\u7ee7\u627f \u6240\u6709\u5f02\u5e38\u90fd\u5fc5\u987b\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\uff08UnauthorizedError\u3001NotFoundError \u7b49\uff09 \u8c03\u7528 super().init() \u5fc5\u987b\u663e\u5f0f\u8c03\u7528\u7236\u7c7b\u521d\u59cb\u5316\uff0c\u4f20\u9012\u6240\u6709\u5fc5\u8981\u53c2\u6570\uff08message\u3001resource\u3001metadata \u7b49\uff09 \u4e0d\u8981\u521b\u5efa\u65b0\u7684\u57fa\u7c7b \u4e0d\u8981\u521b\u5efa\u81ea\u5b9a\u4e49\u7684 BaseError \u6216 AppError\uff0c\u76f4\u63a5\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38 \u4f7f\u7528 metadata \u5728 metadata \u4e2d\u5b58\u50a8\u670d\u52a1\u7279\u5b9a\u7684\u9519\u8bef\u4ee3\u7801\u548c\u5176\u4ed6\u4e0a\u4e0b\u6587\u4fe1\u606f \u9075\u5faa\u547d\u540d\u89c4\u8303 \u4f7f\u7528 <code>&lt;\u5bf9\u8c61&gt;&lt;\u64cd\u4f5c&gt;&lt;\u5f02\u5e38&gt;Error</code> \u683c\u5f0f\uff0c\u4f8b\u5982 <code>UserNotFoundError</code> \u4f7f\u7528\u6b63\u786e\u7684\u4ee3\u7801\u8303\u56f4 \u6839\u636e\u5f02\u5e38\u7c7b\u578b\u4f7f\u7528\u6307\u5b9a\u7684\u4ee3\u7801\u8303\u56f4\uff084001-4099\u30014101-4199 \u7b49\uff09"},{"location":"10-error-handling-guide/#identity","title":"Identity \u670d\u52a1\u5f02\u5e38\u5206\u7c7b\u793a\u4f8b","text":"<p>Identity \u670d\u52a1\u6309\u7167\u8fd9\u4e00\u89c4\u8303\u5b9a\u4e49\u4e86\u5f02\u5e38\uff0c\u5c55\u793a\u4e86\u6b63\u786e\u7684\u7ee7\u627f\u65b9\u5f0f\uff1a</p>"},{"location":"10-error-handling-guide/#4001-4099","title":"\u8ba4\u8bc1\u5f02\u5e38\uff084001-4099\uff09","text":"<pre><code>from app.constants import (\n    InvalidCredentialsError,      # \u65e0\u6548\u51ed\u8bc1\uff08401\uff09\n    InvalidTokenError,             # \u65e0\u6548\u4ee4\u724c\uff08401\uff09\n    TokenExpiredError,             # \u4ee4\u724c\u5df2\u8fc7\u671f\uff08401\uff09\n    SessionExpiredError,           # \u4f1a\u8bdd\u5df2\u8fc7\u671f\uff08401\uff09\n    InvalidAccessKeyError,         # \u65e0\u6548\u8bbf\u95ee\u5bc6\u94a5\uff08401\uff09\n)\n\n# \u793a\u4f8b\uff1a\u51ed\u8bc1\u9a8c\u8bc1\u5931\u8d25\nif not verify_password(user.password_hash, password):\n    raise InvalidCredentialsError(\"\u7528\u6237\u540d\u6216\u5bc6\u7801\u9519\u8bef\")\n\n# \u793a\u4f8b\uff1a\u4ee4\u724c\u9a8c\u8bc1\u5931\u8d25\ntry:\n    payload = jwt.decode(token, SECRET_KEY)\nexcept jwt.ExpiredSignatureError:\n    raise TokenExpiredError()</code></pre>"},{"location":"10-error-handling-guide/#4101-4199","title":"\u7528\u6237\u5f02\u5e38\uff084101-4199\uff09","text":"<pre><code>from app.constants import (\n    UserNotFoundError,             # \u7528\u6237\u4e0d\u5b58\u5728\uff08404\uff09\n    UserInactiveError,             # \u7528\u6237\u672a\u6fc0\u6d3b\uff08403\uff09\n    UserBannedError,               # \u7528\u6237\u88ab\u7981\u7528\uff08403\uff09\n    DuplicateUserError,            # \u7528\u6237\u91cd\u590d\uff08409\uff09\n    InvalidPasswordError,          # \u65e0\u6548\u5bc6\u7801\uff08400\uff09\n)\n\n# \u793a\u4f8b\uff1a\u7528\u6237\u4e0d\u5b58\u5728\nuser = await user_repo.get(user_id)\nif not user:\n    raise UserNotFoundError(user_id=user_id)\n\n# \u793a\u4f8b\uff1a\u7528\u6237\u72b6\u6001\u68c0\u67e5\nif user.status == UserStatus.INACTIVE:\n    raise UserInactiveError(user_id=user.id)\n\nif user.status == UserStatus.BANNED:\n    raise UserBannedError(user_id=user.id)\n\n# \u793a\u4f8b\uff1a\u7528\u6237\u91cd\u590d\u68c0\u67e5\nexisting_user = await user_repo.get_by_email(email)\nif existing_user:\n    raise DuplicateUserError(field=\"email\", value=email)</code></pre>"},{"location":"10-error-handling-guide/#4201-4299","title":"\u79df\u6237\u5f02\u5e38\uff084201-4299\uff09","text":"<pre><code>from app.constants import (\n    TenantNotFoundError,           # \u79df\u6237\u4e0d\u5b58\u5728\uff08404\uff09\n    TenantInactiveError,           # \u79df\u6237\u672a\u6fc0\u6d3b\uff08403\uff09\n)\n\n# \u793a\u4f8b\uff1a\u79df\u6237\u4e0d\u5b58\u5728\ntenant = await tenant_repo.get(tenant_id)\nif not tenant:\n    raise TenantNotFoundError(tenant_id=tenant_id)\n\n# \u793a\u4f8b\uff1a\u79df\u6237\u72b6\u6001\u68c0\u67e5\nif tenant.status != TenantStatus.ACTIVE:\n    raise TenantInactiveError(tenant_id=tenant_id)</code></pre>"},{"location":"10-error-handling-guide/#4301-4399","title":"\u5e94\u7528\u5f02\u5e38\uff084301-4399\uff09","text":"<pre><code>from app.constants import (\n    ApplicationNotFoundError,      # \u5e94\u7528\u4e0d\u5b58\u5728\uff08404\uff09\n    ApplicationInactiveError,      # \u5e94\u7528\u672a\u6fc0\u6d3b\uff08403\uff09\n)\n\n# \u793a\u4f8b\uff1a\u5e94\u7528\u4e0d\u5b58\u5728\napp = await app_repo.get(app_id)\nif not app:\n    raise ApplicationNotFoundError(app_id=app_id)</code></pre>"},{"location":"10-error-handling-guide/#4501-4599","title":"\u4f1a\u8bdd\u5f02\u5e38\uff084501-4599\uff09","text":"<pre><code>from app.constants import (\n    SessionNotFoundError,          # \u4f1a\u8bdd\u4e0d\u5b58\u5728\uff08404\uff09\n    SessionExpiredError,           # \u4f1a\u8bdd\u5df2\u8fc7\u671f\uff08401\uff09\n)\n\n# \u793a\u4f8b\uff1a\u4f1a\u8bdd\u9a8c\u8bc1\nsession = await session_repo.get(session_id)\nif not session:\n    raise SessionNotFoundError(session_id=session_id)\n\nif session.expires_at &lt; datetime.utcnow():\n    raise SessionExpiredError()</code></pre>"},{"location":"10-error-handling-guide/#4401-4499","title":"\u8bbf\u95ee\u5bc6\u94a5\u5f02\u5e38\uff084401-4499\uff09","text":"<pre><code>from app.constants import (\n    AccessKeyNotFoundError,        # \u8bbf\u95ee\u5bc6\u94a5\u4e0d\u5b58\u5728\uff08404\uff09\n    AccessKeyInactiveError,        # \u8bbf\u95ee\u5bc6\u94a5\u672a\u6fc0\u6d3b\uff08403\uff09\n    AccessKeyRevokedError,         # \u8bbf\u95ee\u5bc6\u94a5\u5df2\u64a4\u9500\uff08403\uff09\n)\n\n# \u793a\u4f8b\uff1a\u8bbf\u95ee\u5bc6\u94a5\u9a8c\u8bc1\nkey = await key_repo.get(key_id)\nif not key:\n    raise AccessKeyNotFoundError(key_id=key_id)\n\nif key.status == AccessKeyStatus.INACTIVE:\n    raise AccessKeyInactiveError(key_id=key_id)</code></pre>"},{"location":"10-error-handling-guide/#4601-4699","title":"\u9a8c\u8bc1\u5f02\u5e38\uff084601-4699\uff09","text":"<pre><code>from app.constants import (\n    VerificationCodeInvalidError,  # \u9a8c\u8bc1\u7801\u65e0\u6548\uff08400\uff09\n    VerificationCodeExpiredError,  # \u9a8c\u8bc1\u7801\u5df2\u8fc7\u671f\uff08400\uff09\n    VerificationFailedError,       # \u9a8c\u8bc1\u5931\u8d25\uff08400\uff09\n)\n\n# \u793a\u4f8b\uff1a\u9a8c\u8bc1\u7801\u68c0\u67e5\nif verification_code != stored_code:\n    raise VerificationCodeInvalidError()\n\nif is_expired(verification_time):\n    raise VerificationCodeExpiredError()</code></pre>"},{"location":"10-error-handling-guide/#4701-4799","title":"\u6743\u9650\u5f02\u5e38\uff084701-4799\uff09","text":"<pre><code>from app.constants import PermissionDeniedError\n\n# \u793a\u4f8b\uff1a\u6743\u9650\u68c0\u67e5\nif not user_has_permission(user, resource, action):\n    raise PermissionDeniedError(resource=\"User\")</code></pre>"},{"location":"10-error-handling-guide/#identity_1","title":"Identity \u670d\u52a1\u5f02\u5e38\u7684\u7ee7\u627f\u5173\u7cfb","text":"<p>\u6240\u6709 Identity \u670d\u52a1\u5f02\u5e38\u90fd\u7ee7\u627f\u81ea Foundation Kit \u7684\u57fa\u7840\u5f02\u5e38\u7c7b\uff1a</p> <pre><code>Exception (Python)\n    \u2193\nFoundationError (Foundation Kit)\n    \u2193\nBaseError (Foundation Kit \u5e94\u7528\u5f02\u5e38\u57fa\u7c7b)\n    \u251c\u2500\u2500 UnauthorizedError (401)\n    \u2502   \u251c\u2500\u2500 InvalidCredentialsError\n    \u2502   \u251c\u2500\u2500 InvalidTokenError\n    \u2502   \u251c\u2500\u2500 TokenExpiredError\n    \u2502   \u251c\u2500\u2500 SessionExpiredError\n    \u2502   \u2514\u2500\u2500 InvalidAccessKeyError\n    \u2502\n    \u251c\u2500\u2500 ForbiddenError (403)\n    \u2502   \u251c\u2500\u2500 UserInactiveError\n    \u2502   \u251c\u2500\u2500 UserBannedError\n    \u2502   \u251c\u2500\u2500 TenantInactiveError\n    \u2502   \u251c\u2500\u2500 ApplicationInactiveError\n    \u2502   \u251c\u2500\u2500 AccessKeyInactiveError\n    \u2502   \u251c\u2500\u2500 AccessKeyRevokedError\n    \u2502   \u2514\u2500\u2500 PermissionDeniedError\n    \u2502\n    \u251c\u2500\u2500 NotFoundError (404)\n    \u2502   \u251c\u2500\u2500 UserNotFoundError\n    \u2502   \u251c\u2500\u2500 TenantNotFoundError\n    \u2502   \u251c\u2500\u2500 ApplicationNotFoundError\n    \u2502   \u251c\u2500\u2500 SessionNotFoundError\n    \u2502   \u2514\u2500\u2500 AccessKeyNotFoundError\n    \u2502\n    \u251c\u2500\u2500 AlreadyExistsError (409)\n    \u2502   \u2514\u2500\u2500 DuplicateUserError\n    \u2502\n    \u2514\u2500\u2500 ValidationError (400)\n        \u251c\u2500\u2500 InvalidPasswordError\n        \u251c\u2500\u2500 VerificationCodeError\n        \u251c\u2500\u2500 VerificationCodeInvalidError\n        \u251c\u2500\u2500 VerificationCodeExpiredError\n        \u2514\u2500\u2500 VerificationFailedError\n</code></pre>"},{"location":"10-error-handling-guide/#_21","title":"\u4f7f\u7528\u5143\u6570\u636e\u589e\u5f3a\u5f02\u5e38\u4fe1\u606f","text":"<pre><code># \u5f02\u5e38\u53ef\u4ee5\u5305\u542b\u5143\u6570\u636e\uff0c\u4fbf\u4e8e\u524d\u7aef\u8bc6\u522b\u548c\u5904\u7406\nraise UserNotFoundError(\n    user_id=\"12345\",\n    metadata={\n        \"operation\": \"read\",\n        \"timestamp\": datetime.utcnow().isoformat(),\n    }\n)\n\n# HTTP \u54cd\u5e94\u793a\u4f8b\uff1a\n# {\n#     \"code\": 404,\n#     \"message\": \"\u7528\u6237\u4e0d\u5b58\u5728\",\n#     \"data\": null,\n#     \"metadata\": {\n#         \"user_id\": \"12345\",\n#         \"operation\": \"read\",\n#         \"timestamp\": \"2025-12-01T10:00:00\"\n#     }\n# }</code></pre>"},{"location":"10-error-handling-guide/#_22","title":"\u5728\u670d\u52a1\u5c42\u4f7f\u7528\u5f02\u5e38","text":"<pre><code>from app.constants import (\n    UserNotFoundError,\n    DuplicateUserError,\n    UserInactiveError,\n)\n\nclass UserService:\n    def __init__(self, session: AsyncSession):\n        self.repo = UserRepository(session)\n\n    async def get_user(self, user_id: str):\n        \"\"\"\u83b7\u53d6\u7528\u6237\u3002\"\"\"\n        user = await self.repo.get(user_id)\n        if not user:\n            raise UserNotFoundError(user_id=user_id)\n\n        if user.status == UserStatus.INACTIVE:\n            raise UserInactiveError(user_id=user.id)\n\n        return user\n\n    async def create_user(self, request: UserCreateRequest):\n        \"\"\"\u521b\u5efa\u7528\u6237\u3002\"\"\"\n        # \u68c0\u67e5\u90ae\u7bb1\u662f\u5426\u5df2\u88ab\u4f7f\u7528\n        existing = await self.repo.get_by_email(request.email)\n        if existing:\n            raise DuplicateUserError(\n                field=\"email\",\n                value=request.email,\n                metadata={\"attempted_username\": request.username}\n            )\n\n        # \u521b\u5efa\u65b0\u7528\u6237\n        user = await self.repo.create({\n            \"username\": request.username,\n            \"email\": request.email,\n            \"password_hash\": hash_password(request.password),\n        })\n        return user</code></pre>"},{"location":"10-error-handling-guide/#_23","title":"\u5728\u8def\u7531\u5c42\u5904\u7406\u5f02\u5e38","text":"<pre><code>from fastapi import APIRouter\nfrom aury.boot.application.interfaces.egress import BaseResponse\nfrom app.constants import UserNotFoundError, DuplicateUserError\n\nrouter = APIRouter()\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, service: UserService = Depends()):\n    \"\"\"\u83b7\u53d6\u7528\u6237\u3002\n\n    Foundation Kit \u4f1a\u81ea\u52a8\u6355\u83b7\u6240\u6709 BaseError \u7684\u5b50\u7c7b\uff0c\u5e76\u8f6c\u6362\u4e3a\u6807\u51c6 HTTP \u54cd\u5e94\u3002\n\n    \u629b\u51fa\u7684\u5f02\u5e38\uff1a\n    - UserNotFoundError \u2192 HTTP 404\n    - UserInactiveError \u2192 HTTP 403\n    \"\"\"\n    user = await service.get_user(user_id)\n    return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)\n\n@router.post(\"/users\")\nasync def create_user(\n    request: UserCreateRequest,\n    service: UserService = Depends()\n):\n    \"\"\"\u521b\u5efa\u7528\u6237\u3002\n\n    \u629b\u51fa\u7684\u5f02\u5e38\uff1a\n    - DuplicateUserError \u2192 HTTP 409\n    - InvalidPasswordError \u2192 HTTP 400\n    \"\"\"\n    user = await service.create_user(request)\n    return BaseResponse(code=201, message=\"\u7528\u6237\u521b\u5efa\u6210\u529f\", data=user)</code></pre>"},{"location":"10-error-handling-guide/#_24","title":"\u5f02\u5e38\u5904\u7406\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"10-error-handling-guide/#_25","title":"\u2705 \u63a8\u8350\u505a\u6cd5","text":"<p>1. \u5728\u9002\u5f53\u7684\u5c42\u7ea7\u629b\u51fa\u5f02\u5e38</p> <pre><code># \u2705 \u597d\uff1a\u4e1a\u52a1\u9a8c\u8bc1\u5728 Service \u5c42\nclass UserService:\n    async def create_user(self, request: UserCreateRequest):\n        existing = await self.repo.get_by_email(request.email)\n        if existing:\n            raise DuplicateUserError(field=\"email\", value=request.email)\n        return await self.repo.create({...})\n\n# \u274c \u4e0d\u597d\uff1a\u4e1a\u52a1\u9a8c\u8bc1\u5728 Route \u5c42\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest):\n    existing = await repo.get_by_email(request.email)\n    if existing:\n        raise DuplicateUserError(...)</code></pre> <p>2. \u63d0\u4f9b\u6709\u7528\u7684\u5143\u6570\u636e</p> <pre><code># \u2705 \u597d\nraise UserNotFoundError(\n    user_id=user_id,\n    metadata={\n        \"operation\": \"read\",\n        \"timestamp\": datetime.utcnow().isoformat(),\n        \"requested_by\": current_user.id,\n    }\n)\n\n# \u274c \u4e0d\u597d\nraise UserNotFoundError(user_id=user_id)</code></pre> <p>3. \u4e0d\u8981\u521b\u5efa\u65b0\u7684\u5f02\u5e38\u57fa\u7c7b</p> <pre><code># \u2705 \u597d\uff1a\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\nfrom aury.boot.application.errors import NotFoundError\n\nclass MyServiceNotFoundError(NotFoundError):\n    pass\n\n# \u274c \u9519\uff1a\u521b\u5efa\u65b0\u7684\u5f02\u5e38\u57fa\u7c7b\nclass MyServiceBaseError(Exception):\n    pass\n\nclass MyServiceNotFoundError(MyServiceBaseError):\n    pass</code></pre> <p>4. \u8ba9 Foundation Kit \u5904\u7406\u5f02\u5e38\u8f6c\u6362</p> <pre><code># \u2705 \u597d\uff1a\u5f02\u5e38\u7531 Foundation Kit \u5168\u5c40\u5904\u7406\u5668\u5904\u7406\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, service: UserService = Depends()):\n    user = await service.get_user(user_id)  # \u53ef\u80fd\u629b\u51fa\u5f02\u5e38\n    return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)\n\n# \u274c \u4e0d\u597d\uff1a\u624b\u52a8\u5904\u7406\u5f02\u5e38\u8f6c\u6362\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, service: UserService = Depends()):\n    try:\n        user = await service.get_user(user_id)\n        return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)\n    except UserNotFoundError:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")</code></pre>"},{"location":"10-error-handling-guide/#_26","title":"\u274c \u5e38\u89c1\u9519\u8bef","text":"<p>\u9519\u8bef 1\uff1a\u4e0d\u7ee7\u627f Foundation Kit \u5f02\u5e38</p> <pre><code># \u274c \u9519\nclass MyAppError(Exception):\n    pass\n\n# Foundation Kit \u4e0d\u4f1a\u6355\u83b7\u8fd9\u4e2a\u5f02\u5e38\uff0c\u5bfc\u81f4 500 \u9519\u8bef\nraise MyAppError(\"\u51fa\u9519\u4e86\")</code></pre> <p>\u9519\u8bef 2\uff1a\u6355\u83b7\u5f02\u5e38\u540e\u541e\u6389</p> <pre><code># \u274c \u9519\ntry:\n    user = await get_user(user_id)\nexcept UserNotFoundError:\n    pass  # \u541e\u6389\u5f02\u5e38\uff0c\u5bfc\u81f4\u540e\u7eed\u9519\u8bef\n\n# \u2705 \u597d\ntry:\n    user = await get_user(user_id)\nexcept UserNotFoundError as e:\n    logger.warning(f\"User not found: {user_id}\")\n    raise  # \u91cd\u65b0\u629b\u51fa\u5f02\u5e38</code></pre> <p>\u9519\u8bef 3\uff1a\u5f02\u5e38\u6d88\u606f\u683c\u5f0f\u4e0d\u4e00\u81f4</p> <pre><code># \u274c \u4e0d\u597d\uff1a\u6d88\u606f\u683c\u5f0f\u6df7\u4e71\nraise UserNotFoundError(\"user is not exist\")\nraise UserNotFoundError(\"\u7528\u6237\u4e0d\u5b58\u5728\")\nraise UserNotFoundError(\"\u627e\u4e0d\u5230\u7528\u6237\")\n\n# \u2705 \u597d\uff1a\u7edf\u4e00\u7684\u6d88\u606f\u683c\u5f0f\nraise UserNotFoundError(user_id=user_id)  # \u4f7f\u7528\u9ed8\u8ba4\u6d88\u606f\n# \u8f93\u51fa\uff1a\u7528\u6237\u4e0d\u5b58\u5728</code></pre> <p>\u9519\u8bef 4\uff1a\u4f7f\u7528\u9519\u8bef\u7684\u5f02\u5e38\u7c7b\u578b</p> <pre><code># \u274c \u9519\nraise NotFoundError(\"\u7528\u6237\u5df2\u8fc7\u671f\")  # \u7528\u6237\u8fc7\u671f\u4e0d\u662f\"\u4e0d\u5b58\u5728\"\n\n# \u2705 \u597d\nraise UserInactiveError(user_id=user_id)  # \u4f7f\u7528\u4e13\u95e8\u7684\u5f02\u5e38</code></pre>"},{"location":"10-error-handling-guide/#_27","title":"\u5f02\u5e38\u5904\u7406\u6e05\u5355","text":"<p>\u96c6\u6210\u65b0\u670d\u52a1\u65f6\u7684\u5f02\u5e38\u5904\u7406\u68c0\u67e5\u6e05\u5355\uff1a</p> <ul> <li> \u6240\u6709\u4e1a\u52a1\u5f02\u5e38\u90fd\u7ee7\u627f Foundation Kit \u7684\u5f02\u5e38\u7c7b</li> <li> \u5f02\u5e38\u547d\u540d\u9075\u5faa <code>&lt;\u5bf9\u8c61&gt;&lt;\u64cd\u4f5c&gt;&lt;\u5f02\u5e38&gt;Error</code> \u683c\u5f0f</li> <li> \u5f02\u5e38\u4ee3\u7801\u4f7f\u7528\u670d\u52a1\u6307\u5b9a\u7684\u8303\u56f4</li> <li> Service \u5c42\u8d1f\u8d23\u4e1a\u52a1\u9a8c\u8bc1\u5e76\u629b\u51fa\u5f02\u5e38</li> <li> Route \u5c42\u4e0d\u8fdb\u884c\u5f02\u5e38\u8f6c\u6362\u5904\u7406\uff08\u7531 Foundation Kit \u5904\u7406\uff09</li> <li> \u5f02\u5e38\u5305\u542b\u6709\u7528\u7684\u5143\u6570\u636e</li> <li> \u5f02\u5e38\u6d88\u606f\u683c\u5f0f\u7edf\u4e00\uff0c\u652f\u6301\u56fd\u9645\u5316</li> <li> \u4e0d\u5b58\u5728\u81ea\u5b9a\u4e49\u7684\u5f02\u5e38\u57fa\u7c7b\u4f53\u7cfb</li> </ul>"},{"location":"10-error-handling-guide/#_28","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 10-transaction-management.md \u4e86\u89e3\u4e8b\u52a1\u7ba1\u7406\u548c\u5f02\u5e38\u5904\u7406\u7684\u7ed3\u5408</li> <li>\u67e5\u770b 07-http-advanced.md \u4e86\u89e3\u54cd\u5e94\u6a21\u578b</li> <li>\u67e5\u770b 22-best-practices.md \u4e86\u89e3\u6574\u4f53\u67b6\u6784\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"11-transaction-management/","title":"\u8865\u5145\uff1a\u4e8b\u52a1\u7ba1\u7406\u5b8c\u5168\u6307\u5357","text":"<p>Kit \u5728 <code>domain.transaction</code> \u4e2d\u63d0\u4f9b\u4e86\u4f01\u4e1a\u7ea7\u7684\u4e8b\u52a1\u7ba1\u7406\u5de5\u5177\u3002</p>"},{"location":"11-transaction-management/#repository","title":"Repository \u81ea\u52a8\u63d0\u4ea4\u673a\u5236","text":"<p>Foundation Kit \u7684 Repository \u652f\u6301\u667a\u80fd\u7684\u81ea\u52a8\u63d0\u4ea4\u673a\u5236\uff0c\u4f18\u4e8e Django \u7684\u8bbe\u8ba1\u3002</p>"},{"location":"11-transaction-management/#_2","title":"\u81ea\u52a8\u63d0\u4ea4\u884c\u4e3a","text":"\u573a\u666f \u884c\u4e3a \u975e\u4e8b\u52a1\u4e2d + <code>auto_commit=True</code>\uff08\u9ed8\u8ba4\uff09 \u5199\u64cd\u4f5c\u540e\u81ea\u52a8 commit \u975e\u4e8b\u52a1\u4e2d + <code>auto_commit=False</code> \u53ea flush\uff0c\u9700\u624b\u52a8\u7ba1\u7406\u6216\u4f7f\u7528 <code>.with_commit()</code> \u5728\u4e8b\u52a1\u4e2d\uff08<code>@transactional</code> \u7b49\uff09 \u6c38\u4e0d\u81ea\u52a8\u63d0\u4ea4\uff0c\u7531\u4e8b\u52a1\u7edf\u4e00\u7ba1\u7406"},{"location":"11-transaction-management/#_3","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>from aury.boot.domain.repository.impl import BaseRepository\n\n# \u9ed8\u8ba4\u884c\u4e3a\uff1a\u975e\u4e8b\u52a1\u4e2d\u81ea\u52a8\u63d0\u4ea4\nrepo = UserRepository(session, User)  # auto_commit=True\nawait repo.create({\"name\": \"test\"})  # \u81ea\u52a8 commit\n\n# \u7981\u7528\u81ea\u52a8\u63d0\u4ea4\nrepo = UserRepository(session, User, auto_commit=False)\nawait repo.create({\"name\": \"test\"})  # \u53ea flush\uff0c\u4e0d commit\n\n# \u5355\u6b21\u5f3a\u5236\u63d0\u4ea4\uff08auto_commit=False \u65f6\uff09\nawait repo.with_commit().create({\"name\": \"test2\"})  # \u5f3a\u5236 commit</code></pre>"},{"location":"11-transaction-management/#_4","title":"\u4e0e\u4e8b\u52a1\u7684\u914d\u5408","text":"<pre><code>from aury.boot.domain.transaction import transactional\n\n# \u5728\u4e8b\u52a1\u4e2d\uff1a\u65e0\u8bba auto_commit \u662f\u4ec0\u4e48\uff0c\u90fd\u4e0d\u4f1a\u81ea\u52a8\u63d0\u4ea4\n@transactional\nasync def create_with_profile(session: AsyncSession):\n    user_repo = UserRepository(session, User)  # auto_commit=True \u4f46\u4e0d\u751f\u6548\n    profile_repo = ProfileRepository(session, Profile)\n\n    user = await user_repo.create({\"name\": \"alice\"})  # \u53ea flush\n    await profile_repo.create({\"user_id\": user.id})  # \u53ea flush\n    # \u4e8b\u52a1\u7ed3\u675f\u65f6\u7edf\u4e00 commit\n    return user</code></pre>"},{"location":"11-transaction-management/#django","title":"\u8bbe\u8ba1\u4f18\u52bf\uff08\u5bf9\u6bd4 Django\uff09","text":"<ul> <li>Django\uff1a\u6bcf\u4e2a <code>save()</code> \u9ed8\u8ba4\u72ec\u7acb\u4e8b\u52a1\uff0c\u5bb9\u6613\u65e0\u610f\u8bc6\u5730\u5931\u53bb\u539f\u5b50\u6027\uff0c\u9700\u8981\u663e\u5f0f <code>atomic()</code> \u5305\u88f9</li> <li>Foundation Kit\uff1a\u9ed8\u8ba4\u81ea\u52a8\u63d0\u4ea4\uff0c\u4f46\u4e8b\u52a1\u4e0a\u4e0b\u6587\u81ea\u52a8\u63a5\u7ba1\uff0c\u7528\u6237\u663e\u5f0f\u5f00\u4e8b\u52a1 = \u663e\u5f0f\u8981\u539f\u5b50\u6027</li> </ul>"},{"location":"11-transaction-management/#_5","title":"\u4e8b\u52a1\u7ba1\u7406\u5de5\u5177","text":""},{"location":"11-transaction-management/#1-transactional","title":"1. @transactional \u88c5\u9970\u5668\uff08\u6700\u5e38\u7528\uff09","text":"<p>\u81ea\u52a8\u5904\u7406\u4e8b\u52a1\u5f00\u542f\u3001\u63d0\u4ea4\u3001\u56de\u6eda\u3002</p> <pre><code>from aury.boot.domain.transaction import transactional\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\n@transactional\nasync def create_user_with_profile(session: AsyncSession, name: str, email: str):\n    \"\"\"\u521b\u5efa\u7528\u6237\u53ca\u76f8\u5173\u6570\u636e\uff0c\u5168\u90e8\u5728\u4e8b\u52a1\u4e2d\"\"\"\n    user_repo = UserRepository(session)\n    user = await user_repo.create({\"name\": name, \"email\": email})\n\n    profile_repo = ProfileRepository(session)\n    await profile_repo.create({\"user_id\": user.id})\n\n    # \u6210\u529f\uff1a\u81ea\u52a8 commit\n    # \u5f02\u5e38\uff1a\u81ea\u52a8 rollback\n    return user</code></pre> <p>\u81ea\u52a8\u53c2\u6570\u8bc6\u522b\uff1a <pre><code># \u652f\u6301\u591a\u79cd\u53c2\u6570\u5f62\u5f0f\n@transactional\nasync def method1(session: AsyncSession, data):\n    \"\"\"\u6807\u51c6\u53c2\u6570\u540d\"\"\"\n    pass\n\n@transactional\nasync def method2(db: AsyncSession, data):\n    \"\"\"\u53c2\u6570\u540d\u4e3a db\"\"\"\n    pass\n\n@transactional\nasync def method3(self, data):\n    \"\"\"self.session \u5c5e\u6027\u81ea\u52a8\u8bc6\u522b\"\"\"\n    pass\n\n# \u5728\u7c7b\u4e2d\u4f7f\u7528\nclass UserService:\n    def __init__(self, session: AsyncSession):\n        self.session = session\n\n    @transactional\n    async def create_with_audit(self, data):\n        \"\"\"\u81ea\u52a8\u4f7f\u7528 self.session\"\"\"\n        user = await self.repo.create(data)\n        await self.audit_repo.log(f\"\u521b\u5efa\u7528\u6237: {user.id}\")\n        return user</code></pre></p> <p>\u81ea\u52a8\u5d4c\u5957\u5904\u7406\uff1a <pre><code>@transactional\nasync def outer_operation(session: AsyncSession):\n    await repo1.create({...})\n\n    # \u5d4c\u5957\u8c03\u7528\u53e6\u4e00\u4e2a @transactional \u51fd\u6570\n    result = await inner_operation(session)\n    # \u4e0d\u4f1a\u91cd\u590d\u5f00\u542f\u4e8b\u52a1\uff0c\u590d\u7528\u5916\u5c42\u4e8b\u52a1\n\n    return result\n\n@transactional\nasync def inner_operation(session: AsyncSession):\n    # \u68c0\u6d4b\u5230\u5df2\u5728\u4e8b\u52a1\u4e2d\uff0c\u76f4\u63a5\u6267\u884c\n    return await repo2.create({...})</code></pre></p>"},{"location":"11-transaction-management/#2-transactional_context","title":"2. transactional_context \u4e0a\u4e0b\u6587\u7ba1\u7406\u5668","text":"<p>\u66f4\u660e\u786e\u7684\u4e8b\u52a1\u8fb9\u754c\u3002</p> <pre><code>from aury.boot.domain.transaction import transactional_context\nfrom aury.boot.infrastructure.database import DatabaseManager\n\ndb_manager = DatabaseManager.get_instance()\n\nasync def create_order_full(request: OrderRequest):\n    \"\"\"\u5b8c\u6574\u7684\u8ba2\u5355\u521b\u5efa\u8fc7\u7a0b\"\"\"\n    async with db_manager.session() as session:\n        async with transactional_context(session) as txn_session:\n            # \u5728\u8fd9\u4e2a\u4e0a\u4e0b\u6587\u4e2d\u7684\u6240\u6709\u64cd\u4f5c\u90fd\u5728\u4e8b\u52a1\u4e2d\n            order_repo = OrderRepository(txn_session)\n            order = await order_repo.create({\n                \"user_id\": request.user_id,\n                \"total\": request.total\n            })\n\n            # \u521b\u5efa\u8ba2\u5355\u9879\n            item_repo = OrderItemRepository(txn_session)\n            for item in request.items:\n                await item_repo.create({\n                    \"order_id\": order.id,\n                    \"product_id\": item.product_id,\n                    \"quantity\": item.quantity\n                })\n\n            # \u66f4\u65b0\u5e93\u5b58\n            inventory_repo = InventoryRepository(txn_session)\n            for item in request.items:\n                await inventory_repo.deduct(\n                    item.product_id,\n                    item.quantity\n                )\n\n            # \u81ea\u52a8 commit\uff0c\u5f02\u5e38\u5219 rollback\n            return order</code></pre> <p>\u624b\u52a8\u63a7\u5236\u63d0\u4ea4\uff1a <pre><code>async def operation_with_control(session: AsyncSession):\n    async with transactional_context(session, auto_commit=False) as txn_session:\n        repo = UserRepository(txn_session)\n        user = await repo.create(...)\n\n        # \u5982\u679c\u9700\u8981\uff0c\u53ef\u4ee5\u624b\u52a8 flush \u4f46\u4e0d\u63d0\u4ea4\n        await txn_session.flush()\n\n        # \u505a\u4e00\u4e9b\u9a8c\u8bc1\n        if not validate(user):\n            # \u5f02\u5e38\u4f1a\u5bfc\u81f4\u56de\u6eda\n            raise ValueError(\"\u9a8c\u8bc1\u5931\u8d25\")\n\n        # \u6700\u540e\u5fc5\u987b\u624b\u52a8\u63d0\u4ea4\n        await txn_session.commit()\n        return user</code></pre></p>"},{"location":"11-transaction-management/#3-transactionmanager","title":"3. TransactionManager \u624b\u52a8\u63a7\u5236","text":"<p>\u66f4\u7075\u6d3b\u4f46\u66f4\u5197\u957f\u7684\u65b9\u5f0f\u3002</p> <pre><code>from aury.boot.domain.transaction import TransactionManager\n\nasync def manual_transaction_control(session: AsyncSession):\n    \"\"\"\u624b\u52a8\u63a7\u5236\u4e8b\u52a1\uff0c\u9002\u5408\u590d\u6742\u573a\u666f\"\"\"\n    tm = TransactionManager(session)\n\n    try:\n        await tm.begin()\n\n        # \u6267\u884c\u64cd\u4f5c\n        repo = UserRepository(session)\n        user = await repo.create({...})\n\n        # \u9a8c\u8bc1\n        if not user.is_valid():\n            raise ValueError(\"\u7528\u6237\u65e0\u6548\")\n\n        await tm.commit()\n        return user\n\n    except Exception as e:\n        await tm.rollback()\n        logger.error(f\"\u4e8b\u52a1\u5931\u8d25: {e}\")\n        raise</code></pre> <p>\u4f7f\u7528\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u5f62\u5f0f\uff1a <pre><code>async def transaction_context_form(session: AsyncSession):\n    \"\"\"TransactionManager \u4e5f\u652f\u6301\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\"\"\"\n    tm = TransactionManager(session)\n\n    async with tm:  # \u81ea\u52a8 commit/rollback\n        repo = UserRepository(session)\n        user = await repo.create({...})\n        return user</code></pre></p>"},{"location":"11-transaction-management/#_6","title":"\u4e8b\u52a1\u7279\u6027\u548c\u7528\u4f8b","text":""},{"location":"11-transaction-management/#_7","title":"\u81ea\u52a8\u63d0\u4ea4\u548c\u56de\u6eda","text":"<pre><code>@transactional\nasync def create_user(session: AsyncSession, data: dict):\n    repo = UserRepository(session)\n\n    # \u573a\u666f 1: \u6210\u529f\n    if len(data[\"username\"]) &lt; 3:\n        return None\n\n    user = await repo.create(data)\n    # \u51fd\u6570\u8fd4\u56de\uff1a\u81ea\u52a8 commit\n    return user\n\n# \u8c03\u7528\ntry:\n    result = await create_user(session, {\"username\": \"john\"})\n    # result \u5df2\u6301\u4e45\u5316\u5230\u6570\u636e\u5e93\nexcept Exception as e:\n    # \u5f02\u5e38\u65f6\u5df2\u81ea\u52a8 rollback\uff0c\u6570\u636e\u5e93\u4e2d\u6ca1\u6709\u4e2d\u95f4\u72b6\u6001\n    pass</code></pre>"},{"location":"11-transaction-management/#_8","title":"\u591a\u8868\u64cd\u4f5c\u7684\u4e00\u81f4\u6027","text":"<pre><code>@transactional\nasync def transfer_money(session: AsyncSession, from_user_id: str, to_user_id: str, amount: float):\n    \"\"\"\u8f6c\u8d26\u64cd\u4f5c\uff1a\u5fc5\u987b\u4e24\u4e2a\u64cd\u4f5c\u90fd\u6210\u529f\uff0c\u6216\u90fd\u5931\u8d25\"\"\"\n    account_repo = AccountRepository(session)\n    transaction_repo = TransactionRepository(session)\n\n    # 1. \u68c0\u67e5\u4f59\u989d\n    from_account = await account_repo.get(from_user_id)\n    if from_account.balance &lt; amount:\n        raise InsufficientBalanceError()\n\n    # 2. \u6263\u6b3e\n    from_account.balance -= amount\n    await account_repo.update(from_user_id, {\"balance\": from_account.balance})\n\n    # 3. \u52a0\u6b3e\n    to_account = await account_repo.get(to_user_id)\n    to_account.balance += amount\n    await account_repo.update(to_user_id, {\"balance\": to_account.balance})\n\n    # 4. \u8bb0\u5f55\u4ea4\u6613\n    await transaction_repo.create({\n        \"from_user_id\": from_user_id,\n        \"to_user_id\": to_user_id,\n        \"amount\": amount\n    })\n\n    # \u5982\u679c\u7b2c 3\u30014 \u6b65\u4efb\u610f\u4e00\u4e2a\u5931\u8d25\uff0c1\u30012 \u6b65\u90fd\u4f1a\u56de\u6eda\n    # \u4fdd\u8bc1\u8d26\u6237\u6570\u636e\u4e00\u81f4</code></pre>"},{"location":"11-transaction-management/#_9","title":"\u5d4c\u5957\u4e8b\u52a1","text":"<pre><code>@transactional\nasync def order_creation(session: AsyncSession, order_data):\n    \"\"\"\u5916\u5c42\u4e8b\u52a1\"\"\"\n    order_repo = OrderRepository(session)\n    order = await order_repo.create(order_data)\n\n    # \u8c03\u7528\u53e6\u4e00\u4e2a @transactional \u51fd\u6570\n    await update_inventory(session, order.items)\n    # \u5d4c\u5957\u51fd\u6570\u4e0d\u4f1a\u5f00\u542f\u65b0\u4e8b\u52a1\uff0c\u590d\u7528\u5916\u5c42\u4e8b\u52a1\n\n    return order\n\n@transactional\nasync def update_inventory(session: AsyncSession, items):\n    \"\"\"\u5185\u5c42\u4e8b\u52a1\uff08\u5b9e\u9645\u590d\u7528\u5916\u5c42\uff09\"\"\"\n    inventory_repo = InventoryRepository(session)\n    for item in items:\n        await inventory_repo.deduct(item.product_id, item.quantity)</code></pre>"},{"location":"11-transaction-management/#savepoints","title":"Savepoints\uff08\u4fdd\u5b58\u70b9\uff09","text":"<p>\u4fdd\u5b58\u70b9\u5141\u8bb8\u5728\u4e8b\u52a1\u4e2d\u8bbe\u7f6e\u56de\u6eda\u70b9\uff0c\u5b9e\u73b0\u90e8\u5206\u56de\u6eda\u800c\u4e0d\u5f71\u54cd\u6574\u4e2a\u4e8b\u52a1\u3002</p> <pre><code>from aury.boot.domain.transaction import TransactionManager\n\nasync def complex_operation(session: AsyncSession):\n    \"\"\"\u4f7f\u7528\u4fdd\u5b58\u70b9\u5b9e\u73b0\u90e8\u5206\u56de\u6eda\"\"\"\n    tm = TransactionManager(session)\n\n    await tm.begin()\n    repo = UserRepository(session)\n\n    try:\n        # \u7b2c\u4e00\u6b65\uff1a\u521b\u5efa\u4e3b\u8bb0\u5f55\n        user = await repo.create({\"name\": \"alice\"})\n\n        # \u521b\u5efa\u4fdd\u5b58\u70b9\n        sp_id = await tm.savepoint(\"before_optional\")\n\n        try:\n            # \u7b2c\u4e8c\u6b65\uff1a\u53ef\u9009\u64cd\u4f5c\uff08\u53ef\u80fd\u5931\u8d25\uff09\n            await risky_operation(session)\n\n            # \u6210\u529f\uff1a\u63d0\u4ea4\u4fdd\u5b58\u70b9\n            await tm.savepoint_commit(sp_id)\n        except RiskyOperationError:\n            # \u5931\u8d25\uff1a\u56de\u6eda\u5230\u4fdd\u5b58\u70b9\uff0c\u4f46 user \u521b\u5efa\u4ecd\u7136\u4fdd\u7559\n            await tm.savepoint_rollback(sp_id)\n            logger.warning(\"\u53ef\u9009\u64cd\u4f5c\u5931\u8d25\uff0c\u5df2\u56de\u6eda\uff0c\u7ee7\u7eed\u4e3b\u6d41\u7a0b\")\n\n        # \u7b2c\u4e09\u6b65\uff1a\u7ee7\u7eed\u5176\u4ed6\u64cd\u4f5c\uff08\u4e0d\u53d7\u4fdd\u5b58\u70b9\u56de\u6eda\u5f71\u54cd\uff09\n        await repo.update(user.id, {\"status\": \"active\"})\n\n        await tm.commit()\n        return user\n    except Exception as e:\n        await tm.rollback()\n        raise</code></pre> <p>\u4fdd\u5b58\u70b9 API\uff1a</p> \u65b9\u6cd5 \u63cf\u8ff0 <code>savepoint(name)</code> \u521b\u5efa\u4fdd\u5b58\u70b9\uff0c\u8fd4\u56de\u4fdd\u5b58\u70b9 ID <code>savepoint_commit(sp_id)</code> \u63d0\u4ea4\u4fdd\u5b58\u70b9\uff08\u91ca\u653e\u4fdd\u5b58\u70b9\uff0c\u53d8\u66f4\u751f\u6548\uff09 <code>savepoint_rollback(sp_id)</code> \u56de\u6eda\u5230\u4fdd\u5b58\u70b9\uff08\u64a4\u9500\u4fdd\u5b58\u70b9\u540e\u7684\u53d8\u66f4\uff09 <p>\u5178\u578b\u573a\u666f\uff1a - \u6279\u91cf\u5bfc\u5165\u65f6\uff0c\u67d0\u4e9b\u8bb0\u5f55\u5931\u8d25\u4e0d\u5f71\u54cd\u5176\u4ed6\u8bb0\u5f55 - \u53ef\u9009\u7684\u589e\u5f3a\u64cd\u4f5c\u5931\u8d25\u65f6\u964d\u7ea7\u5904\u7406 - \u590d\u6742\u4e1a\u52a1\u6d41\u7a0b\u4e2d\u7684\u68c0\u67e5\u70b9</p>"},{"location":"11-transaction-management/#on_commit","title":"on_commit \u56de\u8c03","text":"<p>\u6ce8\u518c\u5728\u4e8b\u52a1\u6210\u529f\u63d0\u4ea4\u540e\u6267\u884c\u7684\u56de\u8c03\u51fd\u6570\uff0c\u9002\u5408\u53d1\u9001\u901a\u77e5\u3001\u89e6\u53d1\u540e\u7eed\u4efb\u52a1\u7b49\u526f\u4f5c\u7528\u64cd\u4f5c\u3002</p> <pre><code>from aury.boot.domain.transaction import transactional, on_commit\n\n@transactional\nasync def create_order(session: AsyncSession, order_data: dict):\n    \"\"\"\u521b\u5efa\u8ba2\u5355\u5e76\u5728\u63d0\u4ea4\u540e\u53d1\u9001\u901a\u77e5\"\"\"\n    repo = OrderRepository(session)\n    order = await repo.create(order_data)\n\n    # \u6ce8\u518c\u56de\u8c03\uff1a\u4e8b\u52a1\u6210\u529f\u540e\u6267\u884c\n    on_commit(lambda: send_order_notification(order.id))\n    on_commit(lambda: update_inventory_cache(order.items))\n\n    # \u5982\u679c\u540e\u7eed\u53d1\u751f\u5f02\u5e38\u5bfc\u81f4\u56de\u6eda\uff0c\u56de\u8c03\u4e0d\u4f1a\u6267\u884c\n    await validate_order(order)\n\n    return order\n    # \u4e8b\u52a1 commit \u540e\uff0c\u6240\u6709 on_commit \u56de\u8c03\u6309\u6ce8\u518c\u987a\u5e8f\u6267\u884c\n\ndef send_order_notification(order_id: str):\n    \"\"\"\u540c\u6b65\u56de\u8c03\"\"\"\n    notification_service.send(f\"\u8ba2\u5355 {order_id} \u5df2\u521b\u5efa\")\n\nasync def update_inventory_cache(items: list):\n    \"\"\"\u5f02\u6b65\u56de\u8c03\u4e5f\u652f\u6301\"\"\"\n    await cache.invalidate_inventory(items)</code></pre> <p>\u5728 TransactionManager \u4e2d\u4f7f\u7528\uff1a</p> <pre><code>from aury.boot.domain.transaction import TransactionManager\n\nasync def manual_with_callback(session: AsyncSession):\n    tm = TransactionManager(session)\n\n    await tm.begin()\n    try:\n        user = await create_user(session)\n\n        # \u6ce8\u518c\u5230 TransactionManager\n        tm.on_commit(lambda: print(f\"\u7528\u6237 {user.id} \u521b\u5efa\u6210\u529f\"))\n\n        await tm.commit()  # \u63d0\u4ea4\u540e\u6267\u884c\u56de\u8c03\n    except Exception:\n        await tm.rollback()  # \u56de\u6eda\u65f6\u56de\u8c03\u88ab\u6e05\u9664\uff0c\u4e0d\u6267\u884c\n        raise</code></pre> <p>\u56de\u8c03\u7279\u6027\uff1a</p> \u7279\u6027 \u63cf\u8ff0 \u6267\u884c\u65f6\u673a \u4e8b\u52a1\u6210\u529f <code>commit()</code> \u540e\u7acb\u5373\u6267\u884c \u56de\u6eda\u884c\u4e3a \u4e8b\u52a1\u56de\u6eda\u65f6\uff0c\u5df2\u6ce8\u518c\u7684\u56de\u8c03\u88ab\u6e05\u9664\uff0c\u4e0d\u6267\u884c \u6267\u884c\u987a\u5e8f \u6309\u6ce8\u518c\u987a\u5e8f\u6267\u884c \u652f\u6301\u7c7b\u578b \u540c\u6b65\u51fd\u6570\u548c\u5f02\u6b65\u51fd\u6570\u90fd\u652f\u6301 <p>\u6700\u4f73\u5b9e\u8df5\uff1a - \u56de\u8c03\u4e2d\u4e0d\u8981\u6267\u884c\u5173\u952e\u4e1a\u52a1\u903b\u8f91\uff08\u4e8b\u52a1\u5df2\u63d0\u4ea4\uff0c\u56de\u8c03\u5931\u8d25\u65e0\u6cd5\u56de\u6eda\uff09 - \u9002\u5408\uff1a\u53d1\u9001\u901a\u77e5\u3001\u66f4\u65b0\u7f13\u5b58\u3001\u89e6\u53d1\u5f02\u6b65\u4efb\u52a1\u3001\u8bb0\u5f55\u5ba1\u8ba1\u65e5\u5fd7 - \u56de\u8c03\u4e2d\u5982\u6709\u6570\u636e\u5e93\u64cd\u4f5c\uff0c\u5e94\u5f00\u542f\u65b0\u4e8b\u52a1</p>"},{"location":"11-transaction-management/#_10","title":"\u5f02\u5e38\u5904\u7406\u4e2d\u7684\u4e8b\u52a1","text":"<pre><code>@transactional\nasync def risky_operation(session: AsyncSession):\n    repo = Repository(session)\n\n    try:\n        result1 = await repo.operation1()\n\n        # \u8fd9\u4e2a\u64cd\u4f5c\u53ef\u80fd\u5931\u8d25\n        result2 = await risky_external_call()\n\n        result3 = await repo.operation3()\n\n        # \u6240\u6709\u64cd\u4f5c\u90fd\u6210\u529f\uff1acommit\n        return result1, result2, result3\n\n    except ExternalServiceError as e:\n        # \u5f02\u5e38\u65f6\u81ea\u52a8\u56de\u6eda\n        # \u5373\u4f7f operation1 \u5df2\u7ecf flush\uff0c\u4e5f\u4f1a\u56de\u6eda\n        logger.error(f\"\u5916\u90e8\u670d\u52a1\u5931\u8d25: {e}\")\n        raise</code></pre>"},{"location":"11-transaction-management/#_11","title":"\u4e8b\u52a1\u68c0\u67e5\u548c\u7ea6\u675f","text":""},{"location":"11-transaction-management/#_12","title":"\u68c0\u67e5\u662f\u5426\u5728\u4e8b\u52a1\u4e2d","text":"<pre><code>from aury.boot.domain.transaction import ensure_transaction\n\n@router.post(\"/users\")\nasync def create_user(request: UserCreateRequest, session=Depends(...)):\n    # \u68c0\u67e5\u662f\u5426\u5728\u4e8b\u52a1\u4e2d\n    if not ensure_transaction(session):\n        logger.warning(\"\u64cd\u4f5c\u672a\u5728\u4e8b\u52a1\u4e2d\u8fdb\u884c\")\n\n    repo = UserRepository(session)\n    user = await repo.create(request.dict())\n    return BaseResponse(code=200, message=\"\u6210\u529f\", data=user)</code></pre>"},{"location":"11-transaction-management/#_13","title":"\u5f3a\u5236\u8981\u6c42\u4e8b\u52a1","text":"<pre><code>from aury.boot.domain.transaction import requires_transaction\n\nclass UserRepository(BaseRepository[User]):\n    \"\"\"\u7528\u6237\u4ed3\u50a8\"\"\"\n\n    @requires_transaction\n    async def create_with_validation(self, data: dict):\n        \"\"\"\u6b64\u65b9\u6cd5\u5fc5\u987b\u5728\u4e8b\u52a1\u4e2d\u6267\u884c\"\"\"\n        # \u5982\u679c\u8c03\u7528\u6b64\u65b9\u6cd5\u65f6\u4e0d\u5728\u4e8b\u52a1\u4e2d\uff0c\u629b\u51fa TransactionRequiredError\n        user = User(**data)\n        self.session.add(user)\n        await self.session.flush()\n        return user\n\n# \u4f7f\u7528\n@transactional\nasync def service_method(session: AsyncSession):\n    repo = UserRepository(session)\n    # \u5b89\u5168\uff1a\u5728\u4e8b\u52a1\u4e2d\n    user = await repo.create_with_validation({...})\n    return user\n\n# \u5982\u679c\u5728\u4e8b\u52a1\u5916\u8c03\u7528\nasync def unsafe_call(session: AsyncSession):\n    repo = UserRepository(session)\n    # \u274c \u5f02\u5e38\uff1aTransactionRequiredError\n    user = await repo.create_with_validation({...})</code></pre>"},{"location":"11-transaction-management/#_14","title":"\u6027\u80fd\u8003\u8651","text":""},{"location":"11-transaction-management/#_15","title":"\u4e8b\u52a1\u6301\u7eed\u65f6\u95f4","text":"<pre><code># \u274c \u4e0d\u597d\uff1a\u4e8b\u52a1\u65f6\u95f4\u592a\u957f\n@transactional\nasync def slow_operation(session: AsyncSession):\n    repo = Repository(session)\n    await repo.create({...})\n\n    # \u957f\u65f6\u95f4\u7684\u5916\u90e8 API \u8c03\u7528\u8fd8\u5728\u4e8b\u52a1\u4e2d\n    result = await external_api.call()\n\n    await repo.update({...})\n    # \u6574\u4e2a\u8fc7\u7a0b\u90fd\u9501\u5b9a\u4e86\u6570\u636e\u5e93\u8d44\u6e90\n\n# \u2705 \u597d\uff1a\u4e8b\u52a1\u53ea\u5305\u542b\u6570\u636e\u5e93\u64cd\u4f5c\nasync def optimized_operation(session: AsyncSession):\n    # \u5148\u505a\u5916\u90e8\u8c03\u7528\uff08\u4e0d\u5728\u4e8b\u52a1\u4e2d\uff09\n    result = await external_api.call()\n\n    # \u518d\u5728\u4e8b\u52a1\u4e2d\u8fdb\u884c\u6570\u636e\u5e93\u64cd\u4f5c\n    async with transactional_context(session):\n        repo = Repository(session)\n        await repo.create({...})\n        await repo.update({...})</code></pre>"},{"location":"11-transaction-management/#_16","title":"\u6279\u91cf\u64cd\u4f5c","text":"<pre><code>@transactional\nasync def bulk_create(session: AsyncSession, items: list):\n    \"\"\"\u521b\u5efa\u5927\u91cf\u6570\u636e\"\"\"\n    repo = Repository(session)\n\n    # \u5206\u6279\u521b\u5efa\uff1a\u964d\u4f4e\u5355\u4e2a\u4e8b\u52a1\u7684\u5927\u5c0f\n    batch_size = 100\n    created = []\n\n    for i in range(0, len(items), batch_size):\n        batch = items[i:i + batch_size]\n        for item in batch:\n            created_item = await repo.create(item)\n            created.append(created_item)\n\n    return created</code></pre>"},{"location":"11-transaction-management/#_17","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"11-transaction-management/#q-transactional-transactional_context","title":"Q: @transactional \u548c transactional_context \u7684\u533a\u522b\uff1f","text":"<p>A: - <code>@transactional</code>\uff1a\u88c5\u9970\u5668\uff0c\u81ea\u52a8\u68c0\u6d4b\u53c2\u6570\uff0c\u9002\u5408\u51fd\u6570/\u65b9\u6cd5 - <code>transactional_context</code>\uff1a\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff0c\u663e\u5f0f\u4e8b\u52a1\u8fb9\u754c\uff0c\u9002\u5408\u590d\u6742\u6d41\u7a0b</p> <p>\u9009\u62e9\u5efa\u8bae\uff1a - \u7b80\u5355\u51fd\u6570 \u2192 \u7528 <code>@transactional</code> - \u590d\u6742\u6d41\u7a0b\uff0c\u591a\u6b65\u9aa4 \u2192 \u7528 <code>transactional_context</code> - \u9700\u8981\u624b\u52a8\u63a7\u5236 \u2192 \u7528 <code>TransactionManager</code></p>"},{"location":"11-transaction-management/#q","title":"Q: \u5982\u4f55\u5904\u7406\u5d4c\u5957\u4e8b\u52a1\u4e2d\u7684\u5f02\u5e38\uff1f","text":"<p>A: <pre><code>@transactional\nasync def outer(session: AsyncSession):\n    await operation1(session)\n\n    try:\n        await inner(session)\n    except SpecificError:\n        # \u5f02\u5e38\u88ab\u6355\u83b7\uff0c\u5916\u5c42\u4e8b\u52a1\u7ee7\u7eed\n        logger.warning(\"\u5185\u5c42\u64cd\u4f5c\u5931\u8d25\uff0c\u4f46\u7ee7\u7eed\u5904\u7406\")\n\n    # \u5916\u5c42\u4e8b\u52a1\u6700\u540e commit\n    return result\n\n@transactional\nasync def inner(session: AsyncSession):\n    # \u5982\u679c\u629b\u5f02\u5e38\uff0c\u590d\u7528\u7684\u5916\u5c42\u4e8b\u52a1\u4f1a rollback\n    await operation2(session)</code></pre></p>"},{"location":"11-transaction-management/#q_1","title":"Q: \u5982\u4f55\u5728\u5f02\u6b65\u4efb\u52a1\u4e2d\u4f7f\u7528\u4e8b\u52a1\uff1f","text":"<p>A: <pre><code>from aury.boot.infrastructure.tasks.manager import TaskManager\nfrom aury.boot.infrastructure.database import DatabaseManager\n\ntm = TaskManager.get_instance()\ndb_manager = DatabaseManager.get_instance()\n\n@tm.conditional_task(queue_name=\"default\")\nasync def background_job(user_id: str):\n    \"\"\"\u540e\u53f0\u4efb\u52a1\u4e2d\u7684\u4e8b\u52a1\"\"\"\n    async with db_manager.session() as session:\n        async with transactional_context(session):\n            # \u5728\u540e\u53f0\u4efb\u52a1\u4e2d\u5b89\u5168\u5730\u4f7f\u7528\u4e8b\u52a1\n            repo = UserRepository(session)\n            user = await repo.get(user_id)\n            await repo.update(user_id, {\"processed\": True})</code></pre></p>"},{"location":"11-transaction-management/#_18","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 09-database-complete.md \u4e86\u89e3\u6570\u636e\u5e93\u64cd\u4f5c</li> <li>\u67e5\u770b 08-error-handling-guide.md \u4e86\u89e3\u5f02\u5e38\u5904\u7406</li> <li>\u67e5\u770b 20-best-practices.md \u4e86\u89e3\u67b6\u6784\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"12-database-complete/","title":"9. \u6570\u636e\u5e93\u5b8c\u5168\u6307\u5357","text":""},{"location":"12-database-complete/#_1","title":"\u6982\u8ff0","text":"<p>Kit \u4f7f\u7528 SQLAlchemy 2.0+ \u4f5c\u4e3a ORM\uff0c\u652f\u6301\u5f02\u6b65\u64cd\u4f5c\u548c\u5168\u529f\u80fd\u7684\u5173\u7cfb\u6620\u5c04\u3002</p>"},{"location":"12-database-complete/#_2","title":"\u5b9a\u4e49\u6a21\u578b","text":""},{"location":"12-database-complete/#_3","title":"\u57fa\u7840\u6a21\u578b","text":"<p>\u91cd\u8981\uff1a\u4e0d\u8981\u76f4\u63a5\u7ee7\u627f <code>Base</code> \u7c7b\uff0c\u5e94\u4f7f\u7528 Foundation Kit \u63d0\u4f9b\u7684\u9884\u5b9a\u4e49\u6a21\u578b\u3002</p> <p>\u63a8\u8350\u4f7f\u7528\uff1a - <code>UUIDAuditableStateModel</code>\uff1aUUID \u4e3b\u952e + \u65f6\u95f4\u6233 + \u8f6f\u5220\u9664\uff08\u6700\u5e38\u7528\uff09 - <code>UUIDModel</code>\uff1aUUID \u4e3b\u952e + \u65f6\u95f4\u6233\uff08\u4e0d\u9700\u8981\u8f6f\u5220\u9664\u65f6\uff09 - <code>Model</code>\uff1a\u6574\u6570\u4e3b\u952e + \u65f6\u95f4\u6233\uff08\u4f7f\u7528\u6574\u6570\u4e3b\u952e\u65f6\uff09</p> <pre><code>from sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy import String, Boolean, Text\nfrom aury.boot.domain.models import UUIDAuditableStateModel\n\nclass User(UUIDAuditableStateModel):\n    \"\"\"\u7528\u6237\u6a21\u578b - \u81ea\u52a8\u83b7\u5f97 UUID \u4e3b\u952e\u3001\u65f6\u95f4\u6233\u548c\u8f6f\u5220\u9664\u529f\u80fd\"\"\"\n    __tablename__ = \"users\"\n\n    # UUIDAuditableStateModel \u81ea\u52a8\u63d0\u4f9b\uff1a\n    # - id: UUID \u4e3b\u952e\n    # - created_at: \u521b\u5efa\u65f6\u95f4\n    # - updated_at: \u66f4\u65b0\u65f6\u95f4\n    # - deleted_at: \u8f6f\u5220\u9664\u65f6\u95f4\uff080 \u672a\u5220\u9664\uff0c&gt;0 \u5df2\u5220\u9664\u65f6\u95f4\u6233\uff09\n\n    # \u57fa\u672c\u5b57\u6bb5\n    username: Mapped[str] = mapped_column(String(50), unique=True, nullable=False, index=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True, nullable=False)\n    password_hash: Mapped[str] = mapped_column(String(255), nullable=False)\n\n    # \u53ef\u9009\u5b57\u6bb5\n    avatar_url: Mapped[str | None] = mapped_column(String(500), nullable=True)\n    bio: Mapped[str | None] = mapped_column(Text, nullable=True)\n\n    # \u5e03\u5c14\u5b57\u6bb5\n    is_active: Mapped[bool] = mapped_column(Boolean, default=True)\n    is_admin: Mapped[bool] = mapped_column(Boolean, default=False)\n\n    def __repr__(self) -&gt; str:\n        return f\"&lt;User(id={self.id}, username={self.username})&gt;\"</code></pre>"},{"location":"12-database-complete/#_4","title":"\u5173\u8054\u6a21\u578b\uff08\u4e0d\u4f7f\u7528\u6570\u636e\u5e93\u5916\u952e\uff09","text":"<p>\u6700\u4f73\u5b9e\u8df5\uff1a\u4e0d\u5efa\u8bae\u4f7f\u7528\u6570\u636e\u5e93\u5916\u952e\uff0c\u901a\u8fc7\u7a0b\u5e8f\u63a7\u5236\u5173\u7cfb\u3002\u4fbf\u4e8e\u5206\u5e93\u5206\u8868\u3001\u5fae\u670d\u52a1\u62c6\u5206\uff0c\u907f\u514d\u7ea7\u8054\u64cd\u4f5c\u5f71\u54cd\u6027\u80fd\uff0c\u7b80\u5316\u6570\u636e\u8fc1\u79fb\u3002</p> <pre><code>import uuid\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy import String, Text\nfrom aury.boot.domain.models import UUIDAuditableStateModel\n\nclass Post(UUIDAuditableStateModel):\n    \"\"\"\u6587\u7ae0\u6a21\u578b - \u81ea\u52a8\u83b7\u5f97 UUID \u4e3b\u952e\u3001\u65f6\u95f4\u6233\u548c\u8f6f\u5220\u9664\u529f\u80fd\"\"\"\n    __tablename__ = \"posts\"\n\n    # UUIDAuditableStateModel \u81ea\u52a8\u63d0\u4f9b id\u3001created_at\u3001updated_at\u3001deleted_at\n\n    title: Mapped[str] = mapped_column(String(200), nullable=False)\n    content: Mapped[str] = mapped_column(Text, nullable=False)\n\n    # \u5173\u8054\u5b57\u6bb5\uff08\u4e0d\u4f7f\u7528 ForeignKey\uff0c\u901a\u8fc7\u7a0b\u5e8f\u63a7\u5236\u5173\u7cfb\uff09\n    author_id: Mapped[uuid.UUID] = mapped_column(nullable=False, index=True)\n\n    # \u81ea\u5b9a\u4e49\u65f6\u95f4\u6233\n    published_at: Mapped[datetime | None] = mapped_column(nullable=True)</code></pre>"},{"location":"12-database-complete/#_5","title":"\u8f6f\u5220\u9664\u6a21\u578b","text":"<pre><code>from aury.boot.domain.models.base import SoftDeleteModel\n\nclass Article(SoftDeleteModel):\n    \"\"\"\u652f\u6301\u8f6f\u5220\u9664\u7684\u6a21\u578b\"\"\"\n    __tablename__ = \"articles\"\n\n    id: Mapped[str] = mapped_column(GUID, primary_key=True, default=lambda: str(uuid4()))\n    title: Mapped[str] = mapped_column(String(200))\n    content: Mapped[str] = mapped_column(Text)\n\n    # SoftDeleteModel \u81ea\u52a8\u63d0\u4f9b\uff1a\n    # deleted_at: Mapped[datetime | None]\n    # is_deleted: Mapped[bool]</code></pre>"},{"location":"12-database-complete/#_6","title":"\u521b\u5efa\u4ed3\u50a8","text":""},{"location":"12-database-complete/#baserepository","title":"BaseRepository","text":"<p>\u7ee7\u627f <code>BaseRepository</code> \u83b7\u5f97\u81ea\u52a8 CRUD \u64cd\u4f5c\uff1a</p> <pre><code>from aury.boot.domain.repository.impl import BaseRepository\nfrom models import User\n\nclass UserRepository(BaseRepository[User]):\n    \"\"\"\u7528\u6237\u4ed3\u50a8\"\"\"\n\n    # \u7ee7\u627f\u7684\u81ea\u52a8\u65b9\u6cd5\uff1a\n    # - create(data: dict) -&gt; User\n    # - get(id: str) -&gt; User | None\n    # - get_by(**kwargs) -&gt; User | None\n    # - list(**kwargs) -&gt; list[User]\n    # - paginate(page: int, size: int) -&gt; tuple[list[User], int]\n    # - update(id: str, data: dict) -&gt; User\n    # - delete(id: str) -&gt; bool\n    # - count(**kwargs) -&gt; int\n    # - with_commit() -&gt; Self  # \u5f3a\u5236\u63d0\u4ea4\n\n    # \u81ea\u5b9a\u4e49\u67e5\u8be2\u65b9\u6cd5\n    async def get_by_email(self, email: str) -&gt; User | None:\n        \"\"\"\u6839\u636e\u90ae\u7bb1\u67e5\u8be2\"\"\"\n        return await self.get_by(email=email)\n\n    async def get_active_users(self, limit: int = 100) -&gt; list[User]:\n        \"\"\"\u83b7\u53d6\u6d3b\u8dc3\u7528\u6237\"\"\"\n        return await self.list(is_active=True, limit=limit)\n\n    async def search(self, keyword: str) -&gt; list[User]:\n        \"\"\"\u641c\u7d22\u7528\u6237\"\"\"\n        from sqlalchemy import or_\n        return await self.list(\n            or_(\n                User.username.contains(keyword),\n                User.email.contains(keyword)\n            )\n        )</code></pre>"},{"location":"12-database-complete/#_7","title":"\u81ea\u52a8\u63d0\u4ea4\u673a\u5236","text":"<p>BaseRepository \u652f\u6301\u667a\u80fd\u7684\u81ea\u52a8\u63d0\u4ea4\u673a\u5236\uff1a</p> <pre><code># \u9ed8\u8ba4\u884c\u4e3a\uff1aauto_commit=True\uff0c\u975e\u4e8b\u52a1\u4e2d\u81ea\u52a8\u63d0\u4ea4\nrepo = UserRepository(session, User)\nawait repo.create({\"name\": \"test\"})  # \u81ea\u52a8 commit\n\n# \u7981\u7528\u81ea\u52a8\u63d0\u4ea4\nrepo = UserRepository(session, User, auto_commit=False)\nawait repo.create({\"name\": \"test\"})  # \u53ea flush\uff0c\u4e0d commit\n\n# \u5355\u6b21\u5f3a\u5236\u63d0\u4ea4\nawait repo.with_commit().create({\"name\": \"test2\"})  # \u5f3a\u5236 commit\n\n# \u5728\u4e8b\u52a1\u4e2d\uff1a\u65e0\u8bba auto_commit \u662f\u4ec0\u4e48\uff0c\u90fd\u4e0d\u4f1a\u81ea\u52a8\u63d0\u4ea4\n@transactional\nasync def create_users(session):\n    repo = UserRepository(session, User)  # auto_commit=True \u4f46\u4e0d\u751f\u6548\n    await repo.create({\"name\": \"a\"})  # \u53ea flush\n    await repo.create({\"name\": \"b\"})  # \u53ea flush\n    # \u4e8b\u52a1\u7ed3\u675f\u65f6\u7edf\u4e00 commit</code></pre> <p>\u81ea\u52a8\u63d0\u4ea4\u89c4\u5219\uff1a - <code>auto_commit=True</code>\uff08\u9ed8\u8ba4\uff09\uff1a\u975e\u4e8b\u52a1\u4e2d\u81ea\u52a8 commit - <code>auto_commit=False</code>\uff1a\u53ea flush\uff0c\u9700\u4f7f\u7528 <code>.with_commit()</code> \u6216\u624b\u52a8\u7ba1\u7406 - \u5728\u4e8b\u52a1\u4e2d\uff1a\u6c38\u4e0d\u81ea\u52a8\u63d0\u4ea4\uff0c\u7531\u4e8b\u52a1\u7edf\u4e00\u7ba1\u7406</p>"},{"location":"12-database-complete/#api","title":"\u5728 API \u4e2d\u4f7f\u7528","text":""},{"location":"12-database-complete/#crud","title":"\u57fa\u672c CRUD","text":"<pre><code>from fastapi import APIRouter, Depends, HTTPException\nfrom aury.boot.infrastructure.database import DatabaseManager\nfrom repositories import UserRepository\nfrom schemas import UserCreateRequest, UserResponse\n\nrouter = APIRouter()\n\n# \u83b7\u53d6\u9ed8\u8ba4\u6570\u636e\u5e93\u5b9e\u4f8b\ndb_manager = DatabaseManager.get_instance()\n\n# \u547d\u540d\u591a\u5b9e\u4f8b\uff08\u5982\u4e3b\u5e93/\u4ece\u5e93\uff09\n# primary_db = DatabaseManager.get_instance(\"primary\")\n# replica_db = DatabaseManager.get_instance(\"replica\")\n\n# \u4f9d\u8d56\u6ce8\u5165\nasync def get_user_repo(session=Depends(db_manager.get_session)) -&gt; UserRepository:\n    return UserRepository(session)\n\n# \u521b\u5efa\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\n@router.post(\"/users\")\nasync def create_user(\n    request: UserCreateRequest,\n    repo: UserRepository = Depends(get_user_repo)\n):\n    # \u68c0\u67e5\u91cd\u590d\n    if await repo.get_by_email(request.email):\n        raise HTTPException(status_code=400, detail=\"\u90ae\u7bb1\u5df2\u5b58\u5728\")\n\n    user = await repo.create({\n        \"username\": request.username,\n        \"email\": request.email,\n        \"password_hash\": hash_password(request.password)\n    })\n    return BaseResponse(code=200, message=\"\u7528\u6237\u521b\u5efa\u6210\u529f\", data=user)\n\n# \u8bfb\u53d6\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, repo: UserRepository = Depends(get_user_repo)):\n    user = await repo.get(user_id)\n    if not user:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n    return BaseResponse(code=200, message=\"\u83b7\u53d6\u6210\u529f\", data=user)\n\n# \u5217\u8868\uff08\u5206\u9875\uff09\nfrom aury.boot.application.interfaces.egress import PaginationResponse, Pagination\n\n@router.get(\"/users\")\nasync def list_users(\n    page: int = 1,\n    size: int = 20,\n    repo: UserRepository = Depends(get_user_repo)\n):\n    items, total = await repo.paginate(page=page, size=size)\n    pagination = Pagination(\n        total=total,\n        items=items,\n        page=page,\n        size=size\n    )\n    return PaginationResponse(code=200, message=\"\u83b7\u53d6\u5217\u8868\u6210\u529f\", data=pagination)\n\n# \u66f4\u65b0\n@router.put(\"/users/{user_id}\")\nasync def update_user(\n    user_id: str,\n    request: UserUpdateRequest,\n    repo: UserRepository = Depends(get_user_repo)\n):\n    user = await repo.get(user_id)\n    if not user:\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n\n    user = await repo.update(user_id, request.dict(exclude_unset=True))\n    return BaseResponse(code=200, message=\"\u66f4\u65b0\u6210\u529f\", data=user)\n\n# \u5220\u9664\n@router.delete(\"/users/{user_id}\")\nasync def delete_user(user_id: str, repo: UserRepository = Depends(get_user_repo)):\n    if not await repo.delete(user_id):\n        raise HTTPException(status_code=404, detail=\"\u7528\u6237\u4e0d\u5b58\u5728\")\n    return BaseResponse(code=200, message=\"\u5220\u9664\u6210\u529f\", data=None)</code></pre>"},{"location":"12-database-complete/#_8","title":"\u4e8b\u52a1\u7ba1\u7406","text":"<p>Kit \u63d0\u4f9b\u4e86\u591a\u79cd\u4e8b\u52a1\u7ba1\u7406\u65b9\u5f0f\uff0c\u63a8\u8350\u6309\u573a\u666f\u9009\u62e9\uff1a</p>"},{"location":"12-database-complete/#1transactional","title":"\u65b9\u5f0f 1\uff1a@transactional \u88c5\u9970\u5668\uff08\u6700\u7b80\u6d01\uff09","text":"<pre><code>from aury.boot.domain.transaction import transactional\nfrom sqlalchemy.ext.asyncio import AsyncSession\n\n# \u88c5\u9970\u5668\u81ea\u52a8\u5904\u7406\u4e8b\u52a1\u5f00\u542f\u3001\u63d0\u4ea4\u3001\u56de\u6eda\n@transactional\nasync def create_order(session: AsyncSession, request: OrderRequest):\n    \"\"\"\u521b\u5efa\u8ba2\u5355\u53ca\u5173\u8054\u7684\u8ba2\u5355\u9879\"\"\"\n    order_repo = OrderRepository(session)\n    order = await order_repo.create({\n        \"user_id\": request.user_id,\n        \"total_amount\": request.total_amount\n    })\n\n    # \u521b\u5efa\u8ba2\u5355\u9879\n    item_repo = OrderItemRepository(session)\n    for item in request.items:\n        await item_repo.create({\n            \"order_id\": order.id,\n            \"product_id\": item.product_id,\n            \"quantity\": item.quantity\n        })\n\n    # \u5f02\u5e38\u65f6\u81ea\u52a8\u56de\u6eda\uff0c\u6210\u529f\u65f6\u81ea\u52a8\u63d0\u4ea4\n    return order\n\n# \u5728\u8def\u7531\u4e2d\u8c03\u7528\n@router.post(\"/orders\")\nasync def create_order_api(request: OrderRequest, session=Depends(db_manager.get_session)):\n    order = await create_order(session, request)\n    return BaseResponse(code=200, message=\"\u8ba2\u5355\u521b\u5efa\u6210\u529f\", data=order)</code></pre>"},{"location":"12-database-complete/#2transactional_context","title":"\u65b9\u5f0f 2\uff1atransactional_context \u4e0a\u4e0b\u6587\u7ba1\u7406\u5668","text":"<pre><code>from aury.boot.domain.transaction import transactional_context\nfrom aury.boot.infrastructure.database import DatabaseManager\n\ndb_manager = DatabaseManager.get_instance()\n\nasync def create_order(request: OrderRequest):\n    \"\"\"\u4f7f\u7528\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u7ba1\u7406\u4e8b\u52a1\"\"\"\n    async with db_manager.session() as session:\n        # \u81ea\u52a8\u5f00\u542f\u3001\u63d0\u4ea4\u3001\u56de\u6eda\n        async with transactional_context(session) as txn_session:\n            order_repo = OrderRepository(txn_session)\n            order = await order_repo.create({\n                \"user_id\": request.user_id,\n                \"total_amount\": request.total_amount\n            })\n\n            item_repo = OrderItemRepository(txn_session)\n            for item in request.items:\n                await item_repo.create({\n                    \"order_id\": order.id,\n                    \"product_id\": item.product_id,\n                    \"quantity\": item.quantity\n                })\n\n            return order</code></pre>"},{"location":"12-database-complete/#3transactionmanager","title":"\u65b9\u5f0f 3\uff1aTransactionManager \u624b\u52a8\u63a7\u5236","text":"<pre><code>from aury.boot.domain.transaction import TransactionManager\n\nasync def create_order(request: OrderRequest, session: AsyncSession):\n    \"\"\"\u624b\u52a8\u63a7\u5236\u4e8b\u52a1\uff0c\u9002\u5408\u590d\u6742\u573a\u666f\"\"\"\n    tm = TransactionManager(session)\n\n    try:\n        await tm.begin()\n\n        order_repo = OrderRepository(session)\n        order = await order_repo.create({...})\n\n        item_repo = OrderItemRepository(session)\n        for item in request.items:\n            await item_repo.create({...})\n\n        await tm.commit()\n        return order\n\n    except Exception as e:\n        await tm.rollback()\n        raise\n\n# \u6216\u4f7f\u7528\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u5f62\u5f0f\nasync def create_order_alt(request: OrderRequest, session: AsyncSession):\n    tm = TransactionManager(session)\n    async with tm:  # \u81ea\u52a8 commit/rollback\n        order_repo = OrderRepository(session)\n        order = await order_repo.create({...})\n        return order</code></pre>"},{"location":"12-database-complete/#4sessionbegin","title":"\u65b9\u5f0f 4\uff1asession.begin() \u539f\u59cb\u65b9\u5f0f","text":"<pre><code># \u4ecd\u7136\u652f\u6301\u539f\u59cb SQLAlchemy \u65b9\u5f0f\nasync with db_manager.session() as session:\n    async with session.begin():\n        repo = OrderRepository(session)\n        order = await repo.create({...})</code></pre>"},{"location":"12-database-complete/#_9","title":"\u4e8b\u52a1\u7279\u6027","text":"<p>\u81ea\u52a8\u63d0\u4ea4/\u56de\u6eda\uff1a <pre><code>@transactional\nasync def operation(session: AsyncSession):\n    repo = UserRepository(session)\n\n    # \u6210\u529f\u6267\u884c\uff1a\u81ea\u52a8 commit\n    user = await repo.create({\"username\": \"john\"})\n\n    # \u5f02\u5e38\u629b\u51fa\uff1a\u81ea\u52a8 rollback\n    if not user:\n        raise ValueError(\"\u521b\u5efa\u5931\u8d25\")\n\n    return user</code></pre></p> <p>\u5d4c\u5957\u4e8b\u52a1\u652f\u6301\uff1a <pre><code>@transactional\nasync def outer_transaction(session: AsyncSession):\n    repo1 = Repo1(session)\n    result1 = await repo1.create({...})\n\n    # \u5d4c\u5957\u8c03\u7528\u53e6\u4e00\u4e2a @transactional \u51fd\u6570\n    result2 = await inner_transaction(session)  # \u4e0d\u4f1a\u91cd\u590d\u5f00\u542f\u4e8b\u52a1\n\n    return result1, result2\n\n@transactional\nasync def inner_transaction(session: AsyncSession):\n    repo2 = Repo2(session)\n    return await repo2.create({...})</code></pre></p> <p>\u4e8b\u52a1\u68c0\u67e5\uff1a <pre><code>from aury.boot.domain.transaction import (\n    ensure_transaction,\n    requires_transaction\n)\n\n# \u68c0\u67e5\u662f\u5426\u5728\u4e8b\u52a1\u4e2d\nif ensure_transaction(session):\n    print(\"\u5df2\u5728\u4e8b\u52a1\u4e2d\")\n\n# \u5f3a\u5236\u8981\u6c42\u5728\u4e8b\u52a1\u4e2d\nclass UserRepository(BaseRepository):\n    @requires_transaction\n    async def sensitive_update(self, data):\n        # \u6b64\u65b9\u6cd5\u5fc5\u987b\u5728\u4e8b\u52a1\u4e2d\u8c03\u7528\n        # \u5426\u5219\u629b\u51fa TransactionRequiredError\n        return await self.update(data)</code></pre></p>"},{"location":"12-database-complete/#_10","title":"\u67e5\u8be2\u4f18\u5316","text":""},{"location":"12-database-complete/#n1","title":"\u907f\u514d N+1 \u67e5\u8be2","text":"<p>\u274c \u9519\u8bef\uff1a <pre><code>users = await repo.list()\nfor user in users:\n    posts = await post_repo.list(author_id=user.id)  # N \u6b21\u67e5\u8be2\uff01</code></pre></p> <p>\u2705 \u6b63\u786e\uff1a\u4f7f\u7528 <code>selectinload</code> <pre><code>from sqlalchemy.orm import selectinload\nfrom sqlalchemy import select\n\nclass UserRepository(BaseRepository[User]):\n    async def list_with_posts(self):\n        stmt = select(User).options(selectinload(User.posts))\n        result = await self.session.execute(stmt)\n        return result.scalars().all()\n\nusers = await repo.list_with_posts()\nfor user in users:\n    # posts \u5df2\u52a0\u8f7d\uff0c\u4e0d\u4f1a\u518d\u67e5\u8be2\n    print(len(user.posts))</code></pre></p>"},{"location":"12-database-complete/#_11","title":"\u6279\u91cf\u64cd\u4f5c","text":"<pre><code># \u6279\u91cf\u521b\u5efa\nusers_data = [\n    {\"username\": f\"user{i}\", \"email\": f\"user{i}@example.com\"}\n    for i in range(1000)\n]\nawait repo.bulk_create(users_data, batch_size=100)\n\n# \u6279\u91cf\u66f4\u65b0\nupdates = [\n    {\"id\": user_id, \"is_active\": False}\n    for user_id in inactive_ids\n]\nawait repo.bulk_update(updates)\n\n# \u6279\u91cf\u5220\u9664\nawait repo.bulk_delete(ids_to_delete)</code></pre>"},{"location":"12-database-complete/#_12","title":"\u9ad8\u7ea7\u7279\u6027","text":""},{"location":"12-database-complete/#select-for-update","title":"SELECT FOR UPDATE\uff08\u884c\u7ea7\u9501\uff09","text":"<p>\u5728\u5e76\u53d1\u573a\u666f\u4e0b\u9501\u5b9a\u67e5\u8be2\u7684\u884c\uff0c\u9632\u6b62\u5176\u4ed6\u4e8b\u52a1\u4fee\u6539\u3002</p> <pre><code>from aury.boot.domain.repository.query_builder import QueryBuilder\n\nclass AccountRepository(BaseRepository[Account]):\n    async def get_for_update(self, account_id: str) -&gt; Account | None:\n        \"\"\"\u83b7\u53d6\u5e76\u9501\u5b9a\u8d26\u6237\u8bb0\u5f55\"\"\"\n        qb = QueryBuilder(Account)\n        query = qb.filter(Account.id == account_id).for_update().build()\n        result = await self.session.execute(query)\n        return result.scalar_one_or_none()\n\n    async def get_for_update_nowait(self, account_id: str) -&gt; Account | None:\n        \"\"\"\u83b7\u53d6\u5e76\u9501\u5b9a\uff0c\u5982\u679c\u5df2\u88ab\u9501\u5b9a\u5219\u7acb\u5373\u5931\u8d25\"\"\"\n        qb = QueryBuilder(Account)\n        query = qb.filter(Account.id == account_id).for_update(nowait=True).build()\n        result = await self.session.execute(query)\n        return result.scalar_one_or_none()\n\n    async def get_for_update_skip_locked(self, account_ids: list[str]) -&gt; list[Account]:\n        \"\"\"\u83b7\u53d6\u5e76\u9501\u5b9a\uff0c\u8df3\u8fc7\u5df2\u88ab\u9501\u5b9a\u7684\u884c\"\"\"\n        qb = QueryBuilder(Account)\n        query = qb.filter(Account.id.in_(account_ids)).for_update(skip_locked=True).build()\n        result = await self.session.execute(query)\n        return list(result.scalars().all())</code></pre> <p>for_update \u53c2\u6570\uff1a</p> \u53c2\u6570 \u63cf\u8ff0 <code>nowait=True</code> \u5982\u679c\u884c\u5df2\u88ab\u9501\u5b9a\uff0c\u7acb\u5373\u62a5\u9519\u800c\u4e0d\u662f\u7b49\u5f85 <code>skip_locked=True</code> \u8df3\u8fc7\u5df2\u88ab\u9501\u5b9a\u7684\u884c\uff08\u5e38\u7528\u4e8e\u961f\u5217\u573a\u666f\uff09 <code>of=(Column,...)</code> \u6307\u5b9a\u9501\u5b9a\u7684\u5217\uff08\u7528\u4e8e JOIN \u573a\u666f\uff09 <p>\u5178\u578b\u7528\u4f8b\uff1a\u8f6c\u8d26\u64cd\u4f5c\uff1a</p> <pre><code>from aury.boot.domain.transaction import transactional\n\n@transactional\nasync def transfer_money(session: AsyncSession, from_id: str, to_id: str, amount: float):\n    \"\"\"\u8f6c\u8d26\uff1a\u4f7f\u7528\u884c\u9501\u9632\u6b62\u5e76\u53d1\u95ee\u9898\"\"\"\n    repo = AccountRepository(session)\n\n    # \u9501\u5b9a\u4e24\u4e2a\u8d26\u6237\uff08\u6309 ID \u987a\u5e8f\u9501\u5b9a\u907f\u514d\u6b7b\u9501\uff09\n    ids = sorted([from_id, to_id])\n\n    qb = QueryBuilder(Account)\n    query = qb.filter(Account.id.in_(ids)).for_update().build()\n    result = await session.execute(query)\n    accounts = {a.id: a for a in result.scalars().all()}\n\n    from_account = accounts[from_id]\n    to_account = accounts[to_id]\n\n    if from_account.balance &lt; amount:\n        raise InsufficientBalanceError()\n\n    from_account.balance -= amount\n    to_account.balance += amount\n\n    # \u4e8b\u52a1\u63d0\u4ea4\u540e\u91ca\u653e\u9501</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff1a - <code>nowait</code> \u548c <code>skip_locked</code> \u4e92\u65a5\uff0c\u4e0d\u80fd\u540c\u65f6\u4f7f\u7528 - FOR UPDATE \u5fc5\u987b\u5728\u4e8b\u52a1\u4e2d\u4f7f\u7528 - \u6309\u56fa\u5b9a\u987a\u5e8f\u9501\u5b9a\u591a\u884c\u4ee5\u907f\u514d\u6b7b\u9501</p>"},{"location":"12-database-complete/#_13","title":"\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\u914d\u7f6e","text":"<p>\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u6570\u636e\u5e93\u7684\u9ed8\u8ba4\u4e8b\u52a1\u9694\u79bb\u7ea7\u522b\uff1a</p> <pre><code># .env\nDATABASE_ISOLATION_LEVEL=REPEATABLE READ</code></pre> <p>\u652f\u6301\u7684\u9694\u79bb\u7ea7\u522b\uff1a</p> \u9694\u79bb\u7ea7\u522b \u8bf4\u660e <code>READ UNCOMMITTED</code> \u6700\u4f4e\u9694\u79bb\uff0c\u53ef\u8bfb\u672a\u63d0\u4ea4\u6570\u636e\uff08\u810f\u8bfb\uff09 <code>READ COMMITTED</code> \u53ea\u8bfb\u5df2\u63d0\u4ea4\u6570\u636e\uff08PostgreSQL/Oracle \u9ed8\u8ba4\uff09 <code>REPEATABLE READ</code> \u53ef\u91cd\u590d\u8bfb\uff0c\u540c\u4e00\u4e8b\u52a1\u5185\u8bfb\u53d6\u7ed3\u679c\u4e00\u81f4\uff08MySQL \u9ed8\u8ba4\uff09 <code>SERIALIZABLE</code> \u6700\u9ad8\u9694\u79bb\uff0c\u5b8c\u5168\u4e32\u884c\u5316\u6267\u884c <code>AUTOCOMMIT</code> \u6bcf\u6761\u8bed\u53e5\u81ea\u52a8\u63d0\u4ea4 <p>\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>from aury.boot.infrastructure.database import DatabaseConfig\n\n# \u901a\u8fc7\u914d\u7f6e\u5bf9\u8c61\n config = DatabaseConfig(\n    database_url=\"postgresql+asyncpg://...\",\n    isolation_level=\"REPEATABLE READ\"\n)\n\n# \u6216\u901a\u8fc7\u73af\u5883\u53d8\u91cf\nDATABASE_ISOLATION_LEVEL=SERIALIZABLE</code></pre> <p>\u9009\u62e9\u5efa\u8bae\uff1a - \u5927\u591a\u6570\u573a\u666f\uff1a<code>READ COMMITTED</code>\uff08\u5e73\u8861\u6027\u80fd\u548c\u4e00\u81f4\u6027\uff09 - \u62a5\u8868/\u7edf\u8ba1\u67e5\u8be2\uff1a<code>REPEATABLE READ</code>\uff08\u4fdd\u8bc1\u8bfb\u53d6\u4e00\u81f4\u6027\uff09 - \u91d1\u878d\u4ea4\u6613\uff1a<code>SERIALIZABLE</code>\uff08\u6700\u5f3a\u4e00\u81f4\u6027\uff0c\u6027\u80fd\u8f83\u4f4e\uff09</p>"},{"location":"12-database-complete/#_14","title":"\u81ea\u5b9a\u4e49\u67e5\u8be2\u6761\u4ef6","text":"<pre><code>from sqlalchemy import and_, or_\n\nasync def advanced_search(\n    repo: UserRepository,\n    keyword: str | None = None,\n    is_active: bool | None = None,\n    created_after: datetime | None = None\n):\n    conditions = []\n\n    if keyword:\n        conditions.append(\n            or_(\n                User.username.contains(keyword),\n                User.email.contains(keyword)\n            )\n        )\n\n    if is_active is not None:\n        conditions.append(User.is_active == is_active)\n\n    if created_after:\n        conditions.append(User.created_at &gt;= created_after)\n\n    if conditions:\n        result = await repo.list(and_(*conditions))\n    else:\n        result = await repo.list()\n\n    return result</code></pre>"},{"location":"12-database-complete/#_15","title":"\u805a\u5408\u67e5\u8be2","text":"<pre><code>from sqlalchemy import func\n\nasync def get_statistics(repo: UserRepository):\n    stmt = select(\n        func.count(User.id).label(\"total_users\"),\n        func.sum(User.id.notexists()).label(\"active_users\"),\n    )\n    result = await repo.session.execute(stmt)\n    return result.first()</code></pre>"},{"location":"12-database-complete/#_16","title":"\u6570\u636e\u5e93\u8fde\u63a5\u914d\u7f6e","text":""},{"location":"12-database-complete/#postgresql","title":"PostgreSQL","text":"<pre><code>DATABASE_URL=postgresql+asyncpg://user:password@localhost:5432/dbname\nDATABASE_POOL_SIZE=10\nDATABASE_MAX_OVERFLOW=20\nDATABASE_POOL_RECYCLE=3600\nDATABASE_ECHO=false  # \u662f\u5426\u6253\u5370 SQL</code></pre>"},{"location":"12-database-complete/#mysql","title":"MySQL","text":"<pre><code>DATABASE_URL=mysql+aiomysql://user:password@localhost:3306/dbname</code></pre>"},{"location":"12-database-complete/#sqlite","title":"SQLite\uff08\u5f00\u53d1\u7528\uff09","text":"<pre><code>DATABASE_URL=sqlite+aiosqlite:///./test.db</code></pre>"},{"location":"12-database-complete/#_17","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"12-database-complete/#q","title":"Q: \u5982\u4f55\u5904\u7406\u5927\u6279\u91cf\u6570\u636e\uff1f","text":"<p>A: \u5206\u6279\u5904\u7406\uff1a <pre><code>batch_size = 1000\nfor offset in range(0, total_count, batch_size):\n    batch = await repo.list(offset=offset, limit=batch_size)\n    await process_batch(batch)</code></pre></p>"},{"location":"12-database-complete/#q_1","title":"Q: \u5982\u4f55\u5904\u7406\u5e76\u53d1\u66f4\u65b0\u51b2\u7a81\uff1f","text":"<p>A: \u4f7f\u7528\u7248\u672c\u5b57\u6bb5\uff08\u4e50\u89c2\u9501\uff09\uff1a <pre><code>class Entity(Base):\n    version: Mapped[int] = mapped_column(Integer, default=1)\n\n# \u66f4\u65b0\u65f6\u68c0\u67e5\u7248\u672c\nasync def update_with_version(repo, id, data, expected_version):\n    entity = await repo.get(id)\n    if entity.version != expected_version:\n        raise VersionConflictError()\n\n    await repo.update(id, {**data, \"version\": expected_version + 1})</code></pre></p>"},{"location":"12-database-complete/#q_2","title":"Q: \u5982\u4f55\u5904\u7406\u65f6\u533a\u95ee\u9898\uff1f","text":"<p>A: \u603b\u662f\u4f7f\u7528 UTC\uff1a <pre><code>from datetime import datetime, timezone\n\ndef now() -&gt; datetime:\n    return datetime.now(timezone.utc)\n\nclass Entity(Base):\n    created_at: Mapped[datetime] = mapped_column(default=now)</code></pre></p>"},{"location":"12-database-complete/#_18","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 18-migration-guide.md \u5b66\u4e60\u6570\u636e\u5e93\u8fc1\u79fb</li> <li>\u67e5\u770b 20-best-practices.md \u67e5\u770b\u6700\u4f73\u5b9e\u8df5</li> </ul>"},{"location":"13-caching-advanced/","title":"12. \u7f13\u5b58\u7cfb\u7edf\u9ad8\u7ea7\u7528\u6cd5","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 12 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"13-caching-advanced/#_1","title":"\u9ad8\u7ea7\u7279\u6027","text":""},{"location":"13-caching-advanced/#_2","title":"\u83b7\u53d6\u7f13\u5b58\u5b9e\u4f8b","text":"<pre><code>from aury.boot.infrastructure.cache import CacheManager\n\n# \u9ed8\u8ba4\u5b9e\u4f8b\ncache = CacheManager.get_instance()\n\n# \u547d\u540d\u591a\u5b9e\u4f8b\uff08\u5982\u4f1a\u8bdd\u7f13\u5b58\u3001\u9650\u6d41\u7f13\u5b58\uff09\n# session_cache = CacheManager.get_instance(\"session\")\n# rate_limit_cache = CacheManager.get_instance(\"rate_limit\")</code></pre>"},{"location":"13-caching-advanced/#_3","title":"\u88c5\u9970\u5668\u7f13\u5b58","text":"<pre><code>cache = CacheManager.get_instance()\n\n# \u81ea\u52a8\u7f13\u5b58\u51fd\u6570\u7ed3\u679c\n@cache.cached(expire=60, key_prefix=\"user_profile\")\nasync def get_user_profile(user_id: str):\n    # \u7b2c\u4e00\u6b21\u8c03\u7528\u65f6\u6267\u884c\uff0c\u7ed3\u679c\u7f13\u5b58 60 \u79d2\n    # \u540e\u7eed\u8c03\u7528\u76f4\u63a5\u8fd4\u56de\u7f13\u5b58\u7ed3\u679c\n    return await db.get_user(user_id)</code></pre>"},{"location":"13-caching-advanced/#_4","title":"\u7f13\u5b58\u5931\u6548","text":"<pre><code># \u624b\u52a8\u6e05\u9664\u5355\u4e2a\u7f13\u5b58\nawait cache.delete(\"user:123\")\n\n# \u6e05\u9664\u591a\u4e2a\u7f13\u5b58\nawait cache.delete(\"user:123\", \"user:456\")\n\n# \u6e05\u9664\u6240\u6709\u7f13\u5b58\nawait cache.clear()</code></pre>"},{"location":"13-caching-advanced/#_5","title":"\u7f13\u5b58\u914d\u7f6e","text":"<p>\u5728 <code>.env</code> \u4e2d\u914d\u7f6e\uff1a</p> <pre><code># \u5185\u5b58\u7f13\u5b58\uff08\u5f00\u53d1\u73af\u5883\uff09\nCACHE_TYPE=memory\nCACHE_MAX_SIZE=1000\n\n# Redis\uff08\u751f\u4ea7\u73af\u5883\uff09\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0</code></pre>"},{"location":"13-caching-advanced/#_6","title":"\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<p>\u652f\u6301\u591a\u5b9e\u4f8b\uff0c\u73af\u5883\u53d8\u91cf\u683c\u5f0f\uff1a<code>CACHE_{INSTANCE}_{FIELD}</code></p> <pre><code># \u9ed8\u8ba4\u5b9e\u4f8b\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\n\n# \u4f1a\u8bdd\u7f13\u5b58\u5b9e\u4f8b\nCACHE_SESSION_TYPE=redis\nCACHE_SESSION_URL=redis://localhost:6379/2\nCACHE_SESSION_DEFAULT_TTL=3600\n\n# \u9650\u6d41\u7f13\u5b58\u5b9e\u4f8b\nCACHE_RATE_LIMIT_TYPE=memory\nCACHE_RATE_LIMIT_MAX_SIZE=10000</code></pre> <p>\u4ee3\u7801\u4e2d\u4f7f\u7528\uff1a</p> <pre><code># \u9ed8\u8ba4\u5b9e\u4f8b\ncache = CacheManager.get_instance()\n\n# \u547d\u540d\u5b9e\u4f8b\nsession_cache = CacheManager.get_instance(\"session\")\nrate_limit_cache = CacheManager.get_instance(\"rate_limit\")</code></pre>"},{"location":"13-caching-advanced/#_7","title":"\u7f13\u5b58\u7b56\u7565","text":""},{"location":"13-caching-advanced/#cache-aside","title":"Cache-Aside\uff08\u63a8\u8350\uff09","text":"<pre><code>async def get_user(user_id: str):\n    cache_key = f\"user:{user_id}\"\n\n    # 1. \u5c1d\u8bd5\u4ece\u7f13\u5b58\u83b7\u53d6\n    user = await cache.get(cache_key)\n    if user:\n        return user\n\n    # 2. \u7f13\u5b58\u672a\u547d\u4e2d\uff0c\u4ece\u6570\u636e\u5e93\u83b7\u53d6\n    user = await db.get_user(user_id)\n    if user:\n        # 3. \u5199\u5165\u7f13\u5b58\n        await cache.set(cache_key, user, expire=300)\n\n    return user</code></pre>"},{"location":"13-caching-advanced/#write-through","title":"Write-Through\uff08\u5f3a\u4e00\u81f4\u6027\uff09","text":"<pre><code>async def update_user(user_id: str, data: dict):\n    # 1. \u66f4\u65b0\u6570\u636e\u5e93\n    user = await db.update_user(user_id, data)\n\n    # 2. \u66f4\u65b0\u7f13\u5b58\n    cache_key = f\"user:{user_id}\"\n    await cache.set(cache_key, user, expire=300)\n\n    return user</code></pre>"},{"location":"13-caching-advanced/#write-behind","title":"Write-Behind\uff08\u9ad8\u6027\u80fd\uff09","text":"<pre><code>async def update_user_async(user_id: str, data: dict):\n    # 1. \u66f4\u65b0\u7f13\u5b58\n    cache_key = f\"user:{user_id}\"\n    await cache.set(cache_key, data, expire=300)\n\n    # 2. \u5f02\u6b65\u66f4\u65b0\u6570\u636e\u5e93\n    await task_queue.send(update_user_in_db_task, user_id=user_id, data=data)\n\n    return data</code></pre>"},{"location":"13-caching-advanced/#_8","title":"\u5e38\u89c1\u6a21\u5f0f","text":""},{"location":"13-caching-advanced/#_9","title":"\u5217\u8868\u7f13\u5b58","text":"<pre><code>async def get_user_list(page: int = 1, size: int = 20):\n    cache_key = f\"users:page:{page}:size:{size}\"\n\n    # \u5c1d\u8bd5\u4ece\u7f13\u5b58\u83b7\u53d6\n    result = await cache.get(cache_key)\n    if result:\n        return result\n\n    # \u4ece\u6570\u636e\u5e93\u83b7\u53d6\n    users, total = await db.list_users(page=page, size=size)\n    result = {\"users\": users, \"total\": total}\n\n    # \u7f13\u5b58 1 \u5c0f\u65f6\n    await cache.set(cache_key, result, expire=3600)\n    return result</code></pre>"},{"location":"13-caching-advanced/#_10","title":"\u8ba1\u6570\u7f13\u5b58","text":"<pre><code>async def get_user_count():\n    cache_key = \"users:count\"\n\n    count = await cache.get(cache_key)\n    if count is not None:\n        return count\n\n    count = await db.count_users()\n    await cache.set(cache_key, count, expire=300)\n    return count\n\nasync def update_user_count():\n    \"\"\"\u66f4\u65b0\u7528\u6237\u8ba1\u6570\u7f13\u5b58\u3002\"\"\"\n    cache_key = \"users:count\"\n\n    # \u91cd\u65b0\u8ba1\u7b97\u5e76\u66f4\u65b0\u7f13\u5b58\n    count = await db.count_users()\n    await cache.set(cache_key, count, expire=300)\n    return count</code></pre>"},{"location":"13-caching-advanced/#_11","title":"\u70ed\u6570\u636e\u9884\u70ed","text":"<pre><code>async def warm_cache():\n    \"\"\"\u5e94\u7528\u542f\u52a8\u65f6\u9884\u70ed\u7f13\u5b58\"\"\"\n\n    # \u52a0\u8f7d\u5e38\u7528\u6570\u636e\n    configs = await db.get_all_configs()\n    for config in configs:\n        cache_key = f\"config:{config.key}\"\n        await cache.set(cache_key, config, expire=3600)\n\n    logger.info(f\"\u5df2\u9884\u70ed {len(configs)} \u4e2a\u914d\u7f6e\u5230\u7f13\u5b58\")\n\n# \u5728\u7ec4\u4ef6\u4e2d\u8c03\u7528\nclass CacheWarmupComponent(Component):\n    name = \"cache_warmup\"\n    enabled = True\n    depends_on = [\"cache\"]\n\n    async def setup(self, app: FoundationApp, config):\n        await warm_cache()</code></pre>"},{"location":"13-caching-advanced/#_12","title":"\u6027\u80fd\u4f18\u5316","text":""},{"location":"13-caching-advanced/#cache-penetration","title":"\u7f13\u5b58\u7a7f\u900f\uff08Cache Penetration\uff09","text":"<p>\u95ee\u9898\uff1a\u67e5\u8be2\u4e0d\u5b58\u5728\u7684\u6570\u636e\uff0c\u9891\u7e41\u7ed5\u8fc7\u7f13\u5b58</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code>async def get_user_safe(user_id: str):\n    cache_key = f\"user:{user_id}\"\n\n    # \u4f7f\u7528\u7279\u6b8a\u503c\u6807\u8bb0\u4e0d\u5b58\u5728\u7684\u6570\u636e\n    user = await cache.get(cache_key)\n    if user == \"NOT_FOUND\":\n        return None\n    if user:\n        return user\n\n    user = await db.get_user(user_id)\n    if user:\n        await cache.set(cache_key, user, expire=300)\n    else:\n        # \u7f13\u5b58\u4e0d\u5b58\u5728\u7684\u6807\u8bb0\uff08\u8fc7\u671f\u65f6\u95f4\u77ed\uff09\n        await cache.set(cache_key, \"NOT_FOUND\", expire=60)\n\n    return user</code></pre>"},{"location":"13-caching-advanced/#cache-avalanche","title":"\u7f13\u5b58\u96ea\u5d29\uff08Cache Avalanche\uff09","text":"<p>\u95ee\u9898\uff1a\u5927\u91cf\u7f13\u5b58\u540c\u65f6\u8fc7\u671f</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code>async def get_user(user_id: str):\n    cache_key = f\"user:{user_id}\"\n\n    user = await cache.get(cache_key)\n    if user:\n        return user\n\n    user = await db.get_user(user_id)\n    if user:\n        # \u968f\u673a\u8fc7\u671f\u65f6\u95f4\uff0c\u907f\u514d\u540c\u65f6\u8fc7\u671f\n        import random\n        expire = 300 + random.randint(0, 60)\n        await cache.set(cache_key, user, expire=expire)\n\n    return user</code></pre>"},{"location":"13-caching-advanced/#cache-breakdown","title":"\u7f13\u5b58\u51fb\u7a7f\uff08Cache Breakdown\uff09","text":"<p>\u95ee\u9898\uff1a\u70ed\u70b9\u6570\u636e\u5931\u6548\u65f6\uff0c\u5e76\u53d1\u8bf7\u6c42\u51fb\u7a7f\u7f13\u5b58</p> <p>\u89e3\u51b3\u65b9\u6848\uff1a</p> <pre><code>import asyncio\n\nlock = asyncio.Lock()\n\nasync def get_hot_data(data_id: str):\n    cache_key = f\"hot:{data_id}\"\n\n    data = await cache.get(cache_key)\n    if data:\n        return data\n\n    # \u4f7f\u7528\u5206\u5e03\u5f0f\u9501\uff0c\u53ea\u6709\u4e00\u4e2a\u8fdb\u7a0b\u5237\u65b0\u7f13\u5b58\n    async with lock:\n        # \u518d\u6b21\u68c0\u67e5\u7f13\u5b58\uff08\u53cc\u91cd\u68c0\u67e5\uff09\n        data = await cache.get(cache_key)\n        if data:\n            return data\n\n        # \u4ece\u6570\u636e\u5e93\u83b7\u53d6\n        data = await db.get_hot_data(data_id)\n        await cache.set(cache_key, data, expire=300)\n\n    return data</code></pre>"},{"location":"13-caching-advanced/#_13","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"13-caching-advanced/#_14","title":"\u7f13\u5b58\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\nasync def get_user_with_logging(user_id: str):\n    cache_key = f\"user:{user_id}\"\n\n    user = await cache.get(cache_key)\n    if user:\n        logger.debug(f\"\u7f13\u5b58\u547d\u4e2d: {cache_key}\")\n        return user\n\n    logger.debug(f\"\u7f13\u5b58\u672a\u547d\u4e2d: {cache_key}\")\n    user = await db.get_user(user_id)\n    if user:\n        await cache.set(cache_key, user, expire=300)\n\n    return user</code></pre> <p>\u603b\u7ed3\uff1a\u5145\u5206\u5229\u7528\u7f13\u5b58\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u5e94\u7528\u6027\u80fd\u3002\u9009\u62e9\u5408\u9002\u7684\u7f13\u5b58\u7b56\u7565\u548c\u8fc7\u671f\u65f6\u95f4\uff0c\u6ce8\u610f\u7f13\u5b58\u7a7f\u900f\u3001\u96ea\u5d29\u3001\u51fb\u7a7f\u7b49\u95ee\u9898\uff0c\u624d\u80fd\u6784\u5efa\u7a33\u5b9a\u9ad8\u6548\u7684\u7cfb\u7edf\u3002</p>"},{"location":"14-async-tasks-guide/","title":"13. \u5f02\u6b65\u4efb\u52a1\u5b8c\u6574\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 13 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"14-async-tasks-guide/#_1","title":"\u4efb\u52a1\u5b9a\u4e49","text":""},{"location":"14-async-tasks-guide/#_2","title":"\u57fa\u7840\u4efb\u52a1","text":"<pre><code>from aury.boot.infrastructure.tasks.manager import TaskManager\n\ntm = TaskManager.get_instance()\n\n@tm.conditional_task(queue_name=\"default\", max_retries=3)\nasync def send_email(email: str, subject: str, content: str):\n    \"\"\"\u53d1\u9001\u90ae\u4ef6\u4efb\u52a1\"\"\"\n    # \u6a21\u62df\u53d1\u9001\u90ae\u4ef6\n    print(f\"\u53d1\u9001\u90ae\u4ef6\u5230: {email}\")</code></pre>"},{"location":"14-async-tasks-guide/#_3","title":"\u4efb\u52a1\u53c2\u6570","text":"<pre><code>@tm.conditional_task(\n    queue_name=\"emails\",      # \u961f\u5217\u540d\u79f0\n    max_retries=5,            # \u6700\u5927\u91cd\u8bd5\u6b21\u6570\n    timeout=600,              # \u8d85\u65f6\u65f6\u95f4\uff08\u79d2\uff09\n    retry_delay=30,           # \u91cd\u8bd5\u5ef6\u8fdf\uff08\u79d2\uff09\n)\nasync def process_report(report_id: str, format: str = \"pdf\"):\n    # \u5904\u7406\u62a5\u544a\n    pass</code></pre>"},{"location":"14-async-tasks-guide/#_4","title":"\u4efb\u52a1\u8c03\u7528","text":""},{"location":"14-async-tasks-guide/#_5","title":"\u53d1\u9001\u4efb\u52a1\uff08\u5f02\u6b65\uff09","text":"<pre><code># \u53d1\u9001\u4efb\u52a1\u5230\u961f\u5217\uff0c\u4e0d\u7b49\u5f85\u7ed3\u679c\ntask = send_email.send(\n    email=\"user@example.com\",\n    subject=\"Hello\",\n    content=\"Test message\"\n)</code></pre>"},{"location":"14-async-tasks-guide/#_6","title":"\u5ef6\u8fdf\u6267\u884c","text":"<pre><code>import asyncio\n\n# \u5ef6\u8fdf 30 \u79d2\u540e\u53d1\u9001\nawait asyncio.sleep(30)\nsend_email.send(email=\"user@example.com\", subject=\"Hello\", content=\"Message\")</code></pre>"},{"location":"14-async-tasks-guide/#worker","title":"\u542f\u52a8 Worker","text":""},{"location":"14-async-tasks-guide/#worker_1","title":"\u5355\u8fdb\u7a0b Worker","text":"<pre><code># \u542f\u52a8 worker \u5904\u7406\u9ed8\u8ba4\u961f\u5217\naum worker\n\n# \u542f\u52a8 worker \u5904\u7406\u7279\u5b9a\u961f\u5217\naum worker -q emails</code></pre>"},{"location":"14-async-tasks-guide/#worker_2","title":"\u591a\u8fdb\u7a0b Worker","text":"<pre><code># \u542f\u52a8 8 \u4e2a\u5e76\u53d1 worker\naum worker -c 8</code></pre>"},{"location":"14-async-tasks-guide/#_7","title":"\u9519\u8bef\u5904\u7406\u548c\u91cd\u8bd5","text":""},{"location":"14-async-tasks-guide/#_8","title":"\u5f02\u5e38\u5904\u7406","text":"<pre><code>@tm.conditional_task(max_retries=3)\nasync def risky_task(data: str):\n    try:\n        # \u53ef\u80fd\u5931\u8d25\u7684\u64cd\u4f5c\n        result = await external_api.call(data)\n        return result\n    except Exception as e:\n        logger.error(f\"\u4efb\u52a1\u5931\u8d25: {e}\")\n        raise  # \u91cd\u65b0\u629b\u51fa\u5f02\u5e38\u4ee5\u89e6\u53d1\u91cd\u8bd5</code></pre>"},{"location":"14-async-tasks-guide/#_9","title":"\u91cd\u8bd5\u7b56\u7565","text":"<pre><code>@tm.conditional_task(max_retries=3, retry_delay=60)\nasync def process_with_backoff(task_id: str):\n    \"\"\"\u7b2c 1 \u6b21\u91cd\u8bd5\u7b49\u5f85 60 \u79d2\uff0c\u7b2c 2 \u6b21\u7b49\u5f85 120 \u79d2\uff0cetc.\"\"\"\n    try:\n        await process_data(task_id)\n    except TemporaryError:\n        # \u4e34\u65f6\u9519\u8bef\u4f1a\u81ea\u52a8\u91cd\u8bd5\n        raise\n    except PermanentError:\n        # \u6c38\u4e45\u9519\u8bef\u4e0d\u91cd\u8bd5\n        logger.error(f\"\u6c38\u4e45\u9519\u8bef: {task_id}\")</code></pre>"},{"location":"14-async-tasks-guide/#_10","title":"\u5e38\u89c1\u6a21\u5f0f","text":""},{"location":"14-async-tasks-guide/#_11","title":"\u90ae\u4ef6\u53d1\u9001","text":"<pre><code>@tm.conditional_task(queue_name=\"emails\", max_retries=3)\nasync def send_welcome_email(user_id: str):\n    user = await db.get_user(user_id)\n    if not user:\n        return\n\n    await email_service.send(\n        to=user.email,\n        subject=\"\u6b22\u8fce\u52a0\u5165\",\n        template=\"welcome\"\n    )\n    logger.info(f\"\u6b22\u8fce\u90ae\u4ef6\u5df2\u53d1\u9001\u7ed9 {user.email}\")</code></pre>"},{"location":"14-async-tasks-guide/#_12","title":"\u6570\u636e\u5904\u7406","text":"<pre><code>@tm.conditional_task(queue_name=\"data\", max_retries=2, timeout=3600)\nasync def generate_report(report_id: str):\n    report = await db.get_report(report_id)\n\n    # \u5904\u7406\u5927\u91cf\u6570\u636e\n    data = await collect_data(report.filters)\n\n    # \u751f\u6210\u62a5\u544a\n    pdf = await generate_pdf(data)\n\n    # \u4fdd\u5b58\u62a5\u544a\n    await storage.upload_file(f\"reports/{report_id}.pdf\", pdf)\n\n    # \u66f4\u65b0\u72b6\u6001\n    await db.update_report(report_id, status=\"completed\")\n\n    logger.info(f\"\u62a5\u544a {report_id} \u5df2\u751f\u6210\")</code></pre>"},{"location":"14-async-tasks-guide/#_13","title":"\u5b9a\u65f6\u4efb\u52a1\u96c6\u6210","text":"<pre><code>from aury.boot.infrastructure.scheduler.manager import SchedulerManager\n\nscheduler = SchedulerManager.get_instance()\n\n@tm.conditional_task(queue_name=\"batch\")\nasync def daily_cleanup():\n    \"\"\"\u6bcf\u5929\u6e05\u7406\u8fc7\u671f\u6570\u636e\"\"\"\n    deleted = await db.delete_expired_records()\n    logger.info(f\"\u5df2\u6e05\u7406 {deleted} \u6761\u8fc7\u671f\u6570\u636e\")\n\n# \u5728\u5e94\u7528\u542f\u52a8\u65f6\u6ce8\u518c\nscheduler.add_job(\n    func=daily_cleanup.send,\n    trigger=\"cron\",\n    hour=2,  # \u6bcf\u5929\u51cc\u6668 2 \u70b9\n    id=\"daily_cleanup\"\n)</code></pre>"},{"location":"14-async-tasks-guide/#_14","title":"\u6279\u91cf\u5904\u7406","text":"<pre><code>@tm.conditional_task(queue_name=\"batch\", max_retries=2)\nasync def process_batch(batch_id: str):\n    # \u83b7\u53d6\u6279\u6b21\n    batch = await db.get_batch(batch_id)\n    items = batch.items\n\n    # \u6279\u91cf\u5904\u7406\n    results = []\n    for item in items:\n        result = await process_item(item)\n        results.append(result)\n\n    # \u4fdd\u5b58\u7ed3\u679c\n    await db.save_batch_results(batch_id, results)\n    logger.info(f\"\u6279\u6b21 {batch_id} \u5904\u7406\u5b8c\u6210\uff0c\u5171 {len(results)} \u6761\")</code></pre>"},{"location":"14-async-tasks-guide/#_15","title":"\u4efb\u52a1\u961f\u5217\u914d\u7f6e","text":"<p>\u5728 <code>.env</code> \u4e2d\u914d\u7f6e\uff1a</p> <pre><code># Redis \u4efb\u52a1\u961f\u5217\nTASK_BROKER_URL=redis://localhost:6379/0\nTASK_QUEUE_NAME=default\nTASK_MAX_WORKERS=4\nTASK_TIMEOUT=600</code></pre>"},{"location":"14-async-tasks-guide/#_16","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"14-async-tasks-guide/#_17","title":"\u4efb\u52a1\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\n@tm.conditional_task(max_retries=3)\nasync def monitored_task(data: str):\n    logger.info(f\"\u4efb\u52a1\u5f00\u59cb: {data}\")\n\n    try:\n        result = await process(data)\n        logger.info(f\"\u4efb\u52a1\u6210\u529f: {result}\")\n        return result\n    except Exception as e:\n        logger.error(f\"\u4efb\u52a1\u5931\u8d25: {e}\", exc_info=True)\n        raise</code></pre>"},{"location":"14-async-tasks-guide/#_18","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"14-async-tasks-guide/#1","title":"1. \u4efb\u52a1\u5e94\u8be5\u5e42\u7b49","text":"<pre><code># \u274c \u4e0d\u5e42\u7b49 - \u591a\u6b21\u8c03\u7528\u4f1a\u6709\u95ee\u9898\n@tm.conditional_task()\nasync def bad_task(user_id: str):\n    # \u6bcf\u6b21\u8c03\u7528\u90fd\u4f1a\u589e\u52a0\u91d1\u989d\n    await db.update(f\"UPDATE users SET balance = balance + 100 WHERE id = {user_id}\")\n\n# \u2705 \u5e42\u7b49 - \u591a\u6b21\u8c03\u7528\u7ed3\u679c\u76f8\u540c\n@tm.conditional_task()\nasync def good_task(user_id: str, transaction_id: str):\n    # \u68c0\u67e5\u4e8b\u52a1\u662f\u5426\u5df2\u5904\u7406\n    if await db.transaction_exists(transaction_id):\n        return\n\n    # \u5904\u7406\u4e8b\u52a1\n    await db.apply_transaction(user_id, transaction_id, amount=100)</code></pre>"},{"location":"14-async-tasks-guide/#2","title":"2. \u4efb\u52a1\u5e94\u8be5\u5feb\u901f\u5b8c\u6210","text":"<pre><code># \u274c \u8d85\u65f6\u98ce\u9669\n@tm.conditional_task(timeout=300)\nasync def slow_task():\n    result = await very_slow_operation()  # \u53ef\u80fd\u8d85\u8fc7 5 \u5206\u949f\n    return result\n\n# \u2705 \u5feb\u901f\u4efb\u52a1\n@tm.conditional_task(timeout=300)\nasync def fast_task():\n    # \u542f\u52a8\u540e\u53f0\u4efb\u52a1\n    await queue_slow_operation()\n    return {\"status\": \"processing\"}</code></pre>"},{"location":"14-async-tasks-guide/#3","title":"3. \u5408\u7406\u4f7f\u7528\u91cd\u8bd5","text":"<pre><code># \u53ea\u5bf9\u4e34\u65f6\u9519\u8bef\u91cd\u8bd5\n@tm.conditional_task(max_retries=3)\nasync def smart_retry_task(user_id: str):\n    try:\n        result = await external_api.fetch(user_id)\n        return result\n    except ConnectionError:\n        # \u4e34\u65f6\u8fde\u63a5\u9519\u8bef - \u4f1a\u91cd\u8bd5\n        raise\n    except NotFoundError:\n        # \u6c38\u4e45\u9519\u8bef - \u4e0d\u5e94\u8be5\u91cd\u8bd5\n        logger.error(f\"\u7528\u6237 {user_id} \u4e0d\u5b58\u5728\")\n        return None</code></pre> <p>\u603b\u7ed3\uff1a\u5f02\u6b65\u4efb\u52a1\u9002\u5408\u5904\u7406\u8017\u65f6\u64cd\u4f5c\uff08\u90ae\u4ef6\u3001\u62a5\u544a\u751f\u6210\u3001\u6570\u636e\u5904\u7406\uff09\uff0c\u5145\u5206\u5229\u7528\u4efb\u52a1\u961f\u5217\u53ef\u4ee5\u63d0\u5347\u5e94\u7528\u54cd\u5e94\u901f\u5ea6\uff0c\u6539\u5584\u7528\u6237\u4f53\u9a8c\u3002</p>"},{"location":"15-events-driven/","title":"14. \u4e8b\u4ef6\u9a71\u52a8\u67b6\u6784\u8be6\u89e3","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 14 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"15-events-driven/#_1","title":"\u4e8b\u4ef6\u5b9a\u4e49","text":""},{"location":"15-events-driven/#_2","title":"\u57fa\u7840\u4e8b\u4ef6","text":"<pre><code>from aury.boot.infrastructure.events import Event\n\nclass OrderCreatedEvent(Event):\n    \"\"\"\u8ba2\u5355\u521b\u5efa\u4e8b\u4ef6\"\"\"\n    order_id: str\n    amount: float\n    user_id: str\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"order.created\"</code></pre>"},{"location":"15-events-driven/#_3","title":"\u4e8b\u4ef6\u5b57\u6bb5","text":"<pre><code>from datetime import datetime\nfrom pydantic import Field\n\nclass OrderUpdatedEvent(Event):\n    \"\"\"\u8ba2\u5355\u66f4\u65b0\u4e8b\u4ef6\"\"\"\n    order_id: str\n    old_status: str\n    new_status: str\n    updated_at: datetime = Field(default_factory=datetime.now)\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"order.updated\"</code></pre>"},{"location":"15-events-driven/#_4","title":"\u4e8b\u4ef6\u8ba2\u9605","text":""},{"location":"15-events-driven/#_5","title":"\u57fa\u7840\u8ba2\u9605","text":"<pre><code>from aury.boot.infrastructure.events.bus import EventBus\n\nbus = EventBus.get_instance()\n\n@bus.subscribe(OrderCreatedEvent)\nasync def on_order_created(event: OrderCreatedEvent):\n    \"\"\"\u8ba2\u5355\u521b\u5efa\u65f6\u7684\u5904\u7406\"\"\"\n    logger.info(f\"\u8ba2\u5355\u521b\u5efa: {event.order_id}, \u91d1\u989d: {event.amount}\")\n\n    # \u53d1\u9001\u901a\u77e5\n    await notification_service.notify(\n        user_id=event.user_id,\n        title=\"\u8ba2\u5355\u5df2\u521b\u5efa\",\n        message=f\"\u8ba2\u5355\u91d1\u989d: \u00a5{event.amount}\"\n    )</code></pre>"},{"location":"15-events-driven/#_6","title":"\u591a\u4e2a\u8ba2\u9605\u8005","text":"<pre><code># \u8ba2\u9605\u8005 1: \u53d1\u9001\u90ae\u4ef6\n@bus.subscribe(OrderCreatedEvent)\nasync def send_order_email(event: OrderCreatedEvent):\n    user = await db.get_user(event.user_id)\n    await email_service.send(\n        to=user.email,\n        subject=\"\u8ba2\u5355\u786e\u8ba4\",\n        template=\"order_confirmation\",\n        context={\"order\": event}\n    )\n\n# \u8ba2\u9605\u8005 2: \u66f4\u65b0\u7edf\u8ba1\n@bus.subscribe(OrderCreatedEvent)\nasync def update_statistics(event: OrderCreatedEvent):\n    await analytics.record_event(\n        event_type=\"order.created\",\n        amount=event.amount\n    )\n\n# \u8ba2\u9605\u8005 3: \u89e6\u53d1\u540e\u7eed\u6d41\u7a0b\n@bus.subscribe(OrderCreatedEvent)\nasync def trigger_payment(event: OrderCreatedEvent):\n    await payment_service.initiate_payment(\n        order_id=event.order_id,\n        amount=event.amount\n    )</code></pre>"},{"location":"15-events-driven/#_7","title":"\u6761\u4ef6\u8ba2\u9605","text":"<pre><code>@bus.subscribe(OrderCreatedEvent)\nasync def process_high_value_orders(event: OrderCreatedEvent):\n    # \u53ea\u5904\u7406\u9ad8\u4ef7\u503c\u8ba2\u5355\n    if event.amount &gt;= 10000:\n        logger.info(f\"\u9ad8\u4ef7\u503c\u8ba2\u5355: {event.order_id}\")\n        await vip_service.process(event.order_id)</code></pre>"},{"location":"15-events-driven/#_8","title":"\u4e8b\u4ef6\u53d1\u5e03","text":""},{"location":"15-events-driven/#_9","title":"\u57fa\u7840\u53d1\u5e03","text":"<pre><code>@router.post(\"/orders\")\nasync def create_order(request: OrderCreateRequest):\n    # \u521b\u5efa\u8ba2\u5355\n    order = await order_service.create(request)\n\n    # \u53d1\u5e03\u4e8b\u4ef6\n    await bus.publish(OrderCreatedEvent(\n        order_id=order.id,\n        amount=order.amount,\n        user_id=order.user_id\n    ))\n\n    return BaseResponse(code=200, message=\"\u8ba2\u5355\u521b\u5efa\u6210\u529f\", data=order)</code></pre>"},{"location":"15-events-driven/#_10","title":"\u4e8b\u4ef6\u94fe","text":"<pre><code># \u4e8b\u4ef6 1: \u8ba2\u5355\u521b\u5efa\n@router.post(\"/orders\")\nasync def create_order(request: OrderCreateRequest):\n    order = await order_service.create(request)\n    await bus.publish(OrderCreatedEvent(...))\n    return order\n\n# \u8ba2\u9605\u8005\u53d1\u5e03\u65b0\u4e8b\u4ef6\n@bus.subscribe(OrderCreatedEvent)\nasync def on_order_created(event: OrderCreatedEvent):\n    # \u5904\u7406\u8ba2\u5355\u521b\u5efa\n    await process_order(event.order_id)\n\n    # \u53d1\u5e03\u540e\u7eed\u4e8b\u4ef6\n    await bus.publish(OrderProcessingStartedEvent(\n        order_id=event.order_id,\n        started_at=datetime.now()\n    ))</code></pre>"},{"location":"15-events-driven/#_11","title":"\u5e38\u89c1\u6a21\u5f0f","text":""},{"location":"15-events-driven/#_12","title":"\u7528\u6237\u751f\u547d\u5468\u671f","text":"<pre><code>class UserRegisteredEvent(Event):\n    user_id: str\n    email: str\n    @property\n    def event_name(self) -&gt; str:\n        return \"user.registered\"\n\nclass UserActivatedEvent(Event):\n    user_id: str\n    @property\n    def event_name(self) -&gt; str:\n        return \"user.activated\"\n\n# \u6ce8\u518c\u540e\u53d1\u9001\u6b22\u8fce\u90ae\u4ef6\n@bus.subscribe(UserRegisteredEvent)\nasync def send_welcome_email(event: UserRegisteredEvent):\n    await email_service.send_welcome(event.email)\n\n# \u6ce8\u518c\u540e\u521b\u5efa\u7528\u6237\u6863\u6848\n@bus.subscribe(UserRegisteredEvent)\nasync def create_profile(event: UserRegisteredEvent):\n    await profile_service.create(event.user_id)\n\n# \u6fc0\u6d3b\u540e\u5956\u52b1\u79ef\u5206\n@bus.subscribe(UserActivatedEvent)\nasync def award_signup_bonus(event: UserActivatedEvent):\n    await points_service.add_points(event.user_id, 100)</code></pre>"},{"location":"15-events-driven/#_13","title":"\u8ba2\u5355\u72b6\u6001\u53d8\u66f4","text":"<pre><code>class PaymentSuccessfulEvent(Event):\n    order_id: str\n    @property\n    def event_name(self) -&gt; str:\n        return \"payment.successful\"\n\n# \u652f\u4ed8\u6210\u529f\u540e\u542f\u52a8\u914d\u9001\n@bus.subscribe(PaymentSuccessfulEvent)\nasync def start_shipping(event: PaymentSuccessfulEvent):\n    await shipping_service.create_shipment(event.order_id)\n    await bus.publish(ShippingStartedEvent(order_id=event.order_id))\n\n# \u914d\u9001\u5b8c\u6210\u540e\u7559\u8a00\u63d0\u9192\nclass ShippingCompletedEvent(Event):\n    order_id: str\n    @property\n    def event_name(self) -&gt; str:\n        return \"shipping.completed\"\n\n@bus.subscribe(ShippingCompletedEvent)\nasync def request_review(event: ShippingCompletedEvent):\n    order = await db.get_order(event.order_id)\n    await notification_service.remind_review(order.user_id, event.order_id)</code></pre>"},{"location":"15-events-driven/#_14","title":"\u5e93\u5b58\u7ba1\u7406","text":"<pre><code>class ProductSoldEvent(Event):\n    product_id: str\n    quantity: int\n    @property\n    def event_name(self) -&gt; str:\n        return \"product.sold\"\n\n# \u66f4\u65b0\u5e93\u5b58\n@bus.subscribe(ProductSoldEvent)\nasync def update_inventory(event: ProductSoldEvent):\n    await inventory_service.decrease(event.product_id, event.quantity)\n\n# \u5e93\u5b58\u4e0d\u8db3\u65f6\u9884\u8b66\n@bus.subscribe(ProductSoldEvent)\nasync def check_low_stock(event: ProductSoldEvent):\n    stock = await inventory_service.get_stock(event.product_id)\n    if stock &lt; 10:\n        await alert_service.send_admin_alert(\n            f\"\u4ea7\u54c1 {event.product_id} \u5e93\u5b58\u4e0d\u8db3: {stock}\"\n        )\n\n# \u5e93\u5b58\u4e3a\u96f6\u65f6\u901a\u77e5\n@bus.subscribe(ProductSoldEvent)\nasync def notify_if_outofstock(event: ProductSoldEvent):\n    stock = await inventory_service.get_stock(event.product_id)\n    if stock == 0:\n        await notification_service.notify_outofstock(event.product_id)</code></pre>"},{"location":"15-events-driven/#_15","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"15-events-driven/#_16","title":"\u5f02\u5e38\u5904\u7406","text":"<pre><code>@bus.subscribe(OrderCreatedEvent)\nasync def safe_subscriber(event: OrderCreatedEvent):\n    try:\n        await external_service.process(event)\n    except Exception as e:\n        logger.error(f\"\u5904\u7406\u5931\u8d25: {e}\", exc_info=True)\n        # \u8bb0\u5f55\u9519\u8bef\uff0c\u4f46\u4e0d\u963b\u585e\u5176\u4ed6\u8ba2\u9605\u8005</code></pre>"},{"location":"15-events-driven/#_17","title":"\u91cd\u8bd5\u673a\u5236","text":"<pre><code>from tenacity import retry, stop_after_attempt, wait_fixed\n\n@bus.subscribe(OrderCreatedEvent)\n@retry(stop=stop_after_attempt(3), wait=wait_fixed(2))\nasync def retry_subscriber(event: OrderCreatedEvent):\n    # \u81ea\u52a8\u91cd\u8bd5\uff0c\u6700\u591a 3 \u6b21\uff0c\u95f4\u9694 2 \u79d2\n    await unreliable_service.process(event)</code></pre>"},{"location":"15-events-driven/#_18","title":"\u4e8b\u4ef6\u914d\u7f6e","text":""},{"location":"15-events-driven/#_19","title":"\u540e\u7aef\u7c7b\u578b","text":"<p>\u4e8b\u4ef6\u603b\u7ebf\u652f\u6301\u4e09\u79cd\u540e\u7aef\uff1a</p> <ul> <li><code>memory</code> - \u5355\u8fdb\u7a0b\u5185\u5b58\uff08\u9ed8\u8ba4\uff0c\u5f00\u53d1\u7528\uff09</li> <li><code>redis</code> - Redis Pub/Sub\uff08\u591a\u8fdb\u7a0b/\u5206\u5e03\u5f0f\uff09</li> <li><code>rabbitmq</code> - RabbitMQ\uff08\u751f\u4ea7\u63a8\u8350\uff09</li> </ul>"},{"location":"15-events-driven/#_20","title":"\u73af\u5883\u53d8\u91cf","text":"<pre><code># \u540e\u7aef\u7c7b\u578b\nEVENT_BACKEND=memory\n\n# Redis \u540e\u7aef\nEVENT_BACKEND=redis\nEVENT_URL=redis://localhost:6379/0\nEVENT_KEY_PREFIX=events:\n\n# RabbitMQ \u540e\u7aef\nEVENT_BACKEND=rabbitmq\nEVENT_URL=amqp://guest:guest@localhost:5672/\nEVENT_EXCHANGE_NAME=aury.events\nEVENT_EXCHANGE_TYPE=topic</code></pre>"},{"location":"15-events-driven/#_21","title":"\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<p>\u652f\u6301\u591a\u5b9e\u4f8b\uff0c\u73af\u5883\u53d8\u91cf\u683c\u5f0f\uff1a<code>EVENT_{INSTANCE}_{FIELD}</code></p> <pre><code># \u9ed8\u8ba4\u5b9e\u4f8b\nEVENT_DEFAULT_BACKEND=redis\nEVENT_DEFAULT_URL=redis://localhost:6379/5\n\n# domain \u5b9e\u4f8b\nEVENT_DOMAIN_BACKEND=rabbitmq\nEVENT_DOMAIN_URL=amqp://guest:guest@localhost:5672/\nEVENT_DOMAIN_EXCHANGE_NAME=domain.events</code></pre>"},{"location":"15-events-driven/#eventbusmanager","title":"\u4ee3\u7801\u4e2d\u914d\u7f6e\uff08EventBusManager\uff09","text":"<pre><code>from aury.boot.infrastructure.events import EventBusManager\n\n# \u83b7\u53d6\u5b9e\u4f8b\nbus = EventBusManager.get_instance()\ndomain_bus = EventBusManager.get_instance(\"domain\")\n\n# \u914d\u7f6e\nbus.configure(\n    backend=\"redis\",\n    url=\"redis://localhost:6379/0\",\n    key_prefix=\"events:\"\n)\n\nawait bus.initialize()</code></pre>"},{"location":"15-events-driven/#_22","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"15-events-driven/#_23","title":"\u4e8b\u4ef6\u8ffd\u8e2a","text":"<pre><code>from aury.boot.common.logging import get_trace_id, logger\n\n@bus.subscribe(OrderCreatedEvent)\nasync def traced_subscriber(event: OrderCreatedEvent):\n    trace_id = get_trace_id()\n    logger.info(f\"\u5904\u7406\u4e8b\u4ef6: {event.event_name}, Trace-ID: {trace_id}\")\n\n    await process_event(event)\n\n    logger.info(f\"\u4e8b\u4ef6\u5904\u7406\u5b8c\u6210: {event.event_name}, Trace-ID: {trace_id}\")</code></pre>"},{"location":"15-events-driven/#_24","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"15-events-driven/#1","title":"1. \u4e8b\u4ef6\u5e94\u8be5\u662f\u4e0d\u53ef\u53d8\u7684","text":"<pre><code># \u274c \u4e0d\u597d - \u4e8b\u4ef6\u53ef\u53d8\nclass BadEvent(Event):\n    data: dict  # \u53ef\u4ee5\u88ab\u4fee\u6539\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"bad.event\"\n\n# \u2705 \u597d - \u4e8b\u4ef6\u4e0d\u53ef\u53d8\nfrom pydantic import Field\n\nclass GoodEvent(Event):\n    data: dict = Field(frozen=True)\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"good.event\"</code></pre>"},{"location":"15-events-driven/#2","title":"2. \u8ba2\u9605\u8005\u5e94\u8be5\u5feb\u901f\u5b8c\u6210","text":"<pre><code># \u274c \u6162 - \u8ba2\u9605\u8005\u963b\u585e\n@bus.subscribe(OrderCreatedEvent)\nasync def slow_subscriber(event: OrderCreatedEvent):\n    await very_slow_report_generation(event)\n\n# \u2705 \u5feb - \u4f7f\u7528\u4efb\u52a1\u961f\u5217\u5904\u7406\n@bus.subscribe(OrderCreatedEvent)\nasync def fast_subscriber(event: OrderCreatedEvent):\n    # \u53d1\u9001\u4efb\u52a1\u5230\u961f\u5217\n    await task_queue.send(process_report_task, order_id=event.order_id)</code></pre>"},{"location":"15-events-driven/#3","title":"3. \u907f\u514d\u5faa\u73af\u4e8b\u4ef6","text":"<pre><code># \u274c \u53ef\u80fd\u5bfc\u81f4\u5faa\u73af\n@bus.subscribe(OrderCreatedEvent)\nasync def circular_subscriber(event: OrderCreatedEvent):\n    await bus.publish(OrderCreatedEvent(...))  # \u53d1\u5e03\u76f8\u540c\u4e8b\u4ef6\n\n# \u2705 \u907f\u514d\u5faa\u73af\n@bus.subscribe(OrderCreatedEvent)\nasync def safe_subscriber(event: OrderCreatedEvent):\n    # \u53d1\u5e03\u4e0d\u540c\u7684\u4e8b\u4ef6\n    await bus.publish(OrderProcessingStartedEvent(order_id=event.order_id))</code></pre> <p>\u603b\u7ed3\uff1a\u4e8b\u4ef6\u9a71\u52a8\u67b6\u6784\u53ef\u4ee5\u5b9e\u73b0\u7cfb\u7edf\u89e3\u8026\uff0c\u63d0\u9ad8\u53ef\u7ef4\u62a4\u6027\u3002\u5408\u7406\u8bbe\u8ba1\u4e8b\u4ef6\u548c\u8ba2\u9605\u8005\uff0c\u53ef\u4ee5\u6784\u5efa\u7075\u6d3b\u3001\u53ef\u6269\u5c55\u7684\u5fae\u670d\u52a1\u7cfb\u7edf\u3002</p>"},{"location":"16-scheduler-guide/","title":"15. \u5b9a\u65f6\u8c03\u5ea6\u5b8c\u5168\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 15 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"16-scheduler-guide/#_1","title":"\u8c03\u5ea6\u5668\u521d\u59cb\u5316","text":"<pre><code>from aury.boot.infrastructure.scheduler.manager import SchedulerManager\n\nscheduler = SchedulerManager.get_instance()</code></pre>"},{"location":"16-scheduler-guide/#cron","title":"Cron \u4efb\u52a1","text":""},{"location":"16-scheduler-guide/#_2","title":"\u6bcf\u5929\u5b9a\u65f6\u6267\u884c","text":"<pre><code># \u6bcf\u5929\u51cc\u6668 2 \u70b9 30 \u5206\u6267\u884c\nscheduler.add_job(\n    func=daily_report,\n    trigger=\"cron\",\n    hour=2,\n    minute=30,\n    id=\"daily_report\",\n    name=\"\u6bcf\u65e5\u62a5\u544a\u751f\u6210\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_3","title":"\u6bcf\u5468\u6267\u884c","text":"<pre><code># \u6bcf\u5468\u4e00\u4e0a\u5348 9 \u70b9\u6267\u884c\nscheduler.add_job(\n    func=weekly_summary,\n    trigger=\"cron\",\n    day_of_week=\"mon\",\n    hour=9,\n    id=\"weekly_summary\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_4","title":"\u6bcf\u6708\u6267\u884c","text":"<pre><code># \u6bcf\u4e2a\u6708\u7684\u7b2c\u4e00\u5929\u6267\u884c\nscheduler.add_job(\n    func=monthly_cleanup,\n    trigger=\"cron\",\n    day=1,\n    hour=0,\n    id=\"monthly_cleanup\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_5","title":"\u5de5\u4f5c\u65e5\u6267\u884c","text":"<pre><code># \u5de5\u4f5c\u65e5\uff08\u5468\u4e00\u81f3\u5468\u4e94\uff09\u6bcf\u5c0f\u65f6\u6267\u884c\nscheduler.add_job(\n    func=check_status,\n    trigger=\"cron\",\n    day_of_week=\"mon-fri\",\n    hour=\"*\",\n    id=\"workday_check\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_6","title":"\u95f4\u9694\u4efb\u52a1","text":""},{"location":"16-scheduler-guide/#_7","title":"\u56fa\u5b9a\u95f4\u9694","text":"<pre><code># \u6bcf 30 \u79d2\u6267\u884c\u4e00\u6b21\nscheduler.add_job(\n    func=heartbeat,\n    trigger=\"interval\",\n    seconds=30,\n    id=\"heartbeat\"\n)\n\n# \u6bcf 5 \u5206\u949f\u6267\u884c\u4e00\u6b21\nscheduler.add_job(\n    func=sync_data,\n    trigger=\"interval\",\n    minutes=5,\n    id=\"sync_data\"\n)\n\n# \u6bcf\u5c0f\u65f6\u6267\u884c\u4e00\u6b21\nscheduler.add_job(\n    func=hourly_task,\n    trigger=\"interval\",\n    hours=1,\n    id=\"hourly_task\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_8","title":"\u4e00\u6b21\u6027\u4efb\u52a1","text":""},{"location":"16-scheduler-guide/#_9","title":"\u6307\u5b9a\u65f6\u95f4\u6267\u884c","text":"<pre><code>from datetime import datetime, timedelta\n\n# 10 \u79d2\u540e\u6267\u884c\u4e00\u6b21\nrun_time = datetime.now() + timedelta(seconds=10)\nscheduler.add_job(\n    func=delayed_task,\n    trigger=\"date\",\n    run_date=run_time,\n    id=\"delayed_task\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_10","title":"\u5e26\u53c2\u6570\u7684\u4efb\u52a1","text":""},{"location":"16-scheduler-guide/#_11","title":"\u4f20\u9012\u53c2\u6570","text":"<pre><code>async def process_user(user_id: str, action: str = \"default\"):\n    \"\"\"\u5904\u7406\u7528\u6237\"\"\"\n    logger.info(f\"\u5904\u7406\u7528\u6237 {user_id}\uff0c\u64cd\u4f5c: {action}\")\n\n# \u6dfb\u52a0\u4efb\u52a1\uff0c\u4f20\u9012\u53c2\u6570\nscheduler.add_job(\n    func=process_user,\n    trigger=\"cron\",\n    hour=3,\n    args=[\"user123\"],          # \u4f4d\u7f6e\u53c2\u6570\n    kwargs={\"action\": \"sync\"},  # \u5173\u952e\u5b57\u53c2\u6570\n    id=\"process_user_sync\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_12","title":"\u4efb\u52a1\u7ba1\u7406","text":""},{"location":"16-scheduler-guide/#_13","title":"\u83b7\u53d6\u4efb\u52a1","text":"<pre><code># \u83b7\u53d6\u6240\u6709\u4efb\u52a1\njobs = scheduler.get_jobs()\nfor job in jobs:\n    print(f\"\u4efb\u52a1: {job.id}, \u4e0b\u6b21\u6267\u884c: {job.next_run_time}\")\n\n# \u83b7\u53d6\u5355\u4e2a\u4efb\u52a1\njob = scheduler.get_job(\"daily_report\")\nif job:\n    print(f\"\u4efb\u52a1 {job.id} \u5df2\u5b58\u5728\")</code></pre>"},{"location":"16-scheduler-guide/#_14","title":"\u6682\u505c/\u6062\u590d\u4efb\u52a1","text":"<pre><code># \u6682\u505c\u4efb\u52a1\nscheduler.pause_job(\"daily_report\")\n\n# \u6062\u590d\u4efb\u52a1\nscheduler.resume_job(\"daily_report\")</code></pre>"},{"location":"16-scheduler-guide/#_15","title":"\u5220\u9664\u4efb\u52a1","text":"<pre><code># \u5220\u9664\u5355\u4e2a\u4efb\u52a1\nscheduler.remove_job(\"daily_report\")\n\n# \u5220\u9664\u6240\u6709\u4efb\u52a1\nscheduler.remove_all_jobs()</code></pre>"},{"location":"16-scheduler-guide/#_16","title":"\u66f4\u65b0\u4efb\u52a1","text":"<pre><code># \u91cd\u65b0\u5b89\u6392\u4efb\u52a1\nscheduler.reschedule_job(\n    \"daily_report\",\n    trigger=\"cron\",\n    hour=3,  # \u6539\u4e3a\u51cc\u6668 3 \u70b9\n    minute=0\n)</code></pre>"},{"location":"16-scheduler-guide/#_17","title":"\u5e38\u89c1\u573a\u666f","text":""},{"location":"16-scheduler-guide/#_18","title":"\u6570\u636e\u540c\u6b65","text":"<pre><code>@scheduler.scheduled_job(\"interval\", minutes=5)\nasync def sync_from_external_api():\n    \"\"\"\u6bcf 5 \u5206\u949f\u540c\u6b65\u5916\u90e8\u6570\u636e\"\"\"\n    try:\n        data = await external_api.fetch_updates()\n        await db.update_data(data)\n        logger.info(\"\u6570\u636e\u540c\u6b65\u5b8c\u6210\")\n    except Exception as e:\n        logger.error(f\"\u6570\u636e\u540c\u6b65\u5931\u8d25: {e}\")\n\n# \u6216\u4f7f\u7528 add_job\nscheduler.add_job(\n    func=sync_from_external_api,\n    trigger=\"interval\",\n    minutes=5,\n    id=\"data_sync\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_19","title":"\u6e05\u7406\u8fc7\u671f\u6570\u636e","text":"<pre><code>async def cleanup_expired_records():\n    \"\"\"\u6bcf\u5929\u51cc\u6668 2 \u70b9\u6e05\u7406\u8fc7\u671f\u6570\u636e\"\"\"\n    deleted = await db.delete_where(\n        \"records\",\n        expire_time__lt=datetime.now()\n    )\n    logger.info(f\"\u5df2\u6e05\u7406 {deleted} \u6761\u8fc7\u671f\u6570\u636e\")\n\nscheduler.add_job(\n    func=cleanup_expired_records,\n    trigger=\"cron\",\n    hour=2,\n    minute=0,\n    id=\"cleanup_expired\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_20","title":"\u5b9a\u671f\u5907\u4efd","text":"<pre><code>async def backup_database():\n    \"\"\"\u6bcf\u5929\u5907\u4efd\u6570\u636e\u5e93\"\"\"\n    timestamp = datetime.now().strftime(\"%Y%m%d_%H%M%S\")\n    filename = f\"backup_{timestamp}.sql\"\n\n    await backup_service.backup(filename)\n    logger.info(f\"\u5907\u4efd\u5b8c\u6210: {filename}\")\n\nscheduler.add_job(\n    func=backup_database,\n    trigger=\"cron\",\n    hour=1,  # \u6bcf\u5929\u51cc\u6668 1 \u70b9\n    id=\"db_backup\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_21","title":"\u6027\u80fd\u76d1\u63a7","text":"<pre><code>async def collect_metrics():\n    \"\"\"\u6bcf\u5206\u949f\u6536\u96c6\u4e00\u6b21\u6027\u80fd\u6307\u6807\"\"\"\n    metrics = await monitor.collect_metrics()\n\n    await db.save_metrics(metrics)\n\n    if metrics.cpu &gt; 80:\n        logger.warning(f\"CPU \u4f7f\u7528\u7387\u8fc7\u9ad8: {metrics.cpu}%\")\n\nscheduler.add_job(\n    func=collect_metrics,\n    trigger=\"interval\",\n    minutes=1,\n    id=\"collect_metrics\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_22","title":"\u72b6\u6001\u68c0\u67e5","text":"<pre><code>async def health_check():\n    \"\"\"\u6bcf 30 \u79d2\u68c0\u67e5\u4e00\u6b21\u5065\u5eb7\u72b6\u6001\"\"\"\n    checks = {\n        \"database\": await check_database(),\n        \"redis\": await check_redis(),\n        \"external_api\": await check_external_api(),\n    }\n\n    all_healthy = all(checks.values())\n\n    if not all_healthy:\n        logger.error(f\"\u5065\u5eb7\u68c0\u67e5\u5931\u8d25: {checks}\")\n        await alert_service.send_alert(checks)\n\nscheduler.add_job(\n    func=health_check,\n    trigger=\"interval\",\n    seconds=30,\n    id=\"health_check\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_23","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"16-scheduler-guide/#_24","title":"\u5f02\u5e38\u6355\u83b7","text":"<pre><code>async def safe_task():\n    \"\"\"\u5b89\u5168\u7684\u5b9a\u65f6\u4efb\u52a1\"\"\"\n    try:\n        await dangerous_operation()\n    except Exception as e:\n        logger.error(f\"\u4efb\u52a1\u6267\u884c\u5931\u8d25: {e}\", exc_info=True)\n        # \u4e0d\u91cd\u65b0\u629b\u51fa\u5f02\u5e38\uff0c\u907f\u514d\u8c03\u5ea6\u5668\u505c\u6b62\n\nscheduler.add_job(\n    func=safe_task,\n    trigger=\"interval\",\n    hours=1,\n    id=\"safe_task\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_25","title":"\u4efb\u52a1\u8d85\u65f6","text":"<pre><code>import asyncio\n\nasync def timeout_protected_task():\n    \"\"\"\u5e26\u8d85\u65f6\u4fdd\u62a4\u7684\u4efb\u52a1\"\"\"\n    try:\n        await asyncio.wait_for(long_operation(), timeout=300)\n    except asyncio.TimeoutError:\n        logger.error(\"\u4efb\u52a1\u6267\u884c\u8d85\u65f6\")\n\nscheduler.add_job(\n    func=timeout_protected_task,\n    trigger=\"cron\",\n    hour=2,\n    id=\"timeout_protected\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_26","title":"\u4efb\u52a1\u914d\u7f6e","text":"<p>\u5728 <code>.env</code> \u4e2d\u914d\u7f6e\uff1a</p> <pre><code># \u8c03\u5ea6\u5668\u6a21\u5f0f\nSCHEDULER_MODE=embedded  # embedded, standalone, disabled\n\n# \u5e76\u53d1\u6267\u884c\u6570\nSCHEDULER_MAX_WORKERS=5</code></pre>"},{"location":"16-scheduler-guide/#_27","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"16-scheduler-guide/#_28","title":"\u67e5\u770b\u8c03\u5ea6\u5668\u72b6\u6001","text":"<pre><code># \u83b7\u53d6\u6240\u6709\u4efb\u52a1\njobs = scheduler.get_jobs()\nlogger.info(f\"\u5df2\u5b89\u6392\u4efb\u52a1\u6570: {len(jobs)}\")\n\nfor job in jobs:\n    logger.info(\n        f\"\u4efb\u52a1: {job.id}, \"\n        f\"\u4e0b\u6b21\u6267\u884c: {job.next_run_time}, \"\n        f\"\u72b6\u6001: {'\u6682\u505c' if job.paused else '\u8fd0\u884c\u4e2d'}\"\n    )</code></pre>"},{"location":"16-scheduler-guide/#_29","title":"\u4efb\u52a1\u6267\u884c\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\nasync def logged_task():\n    logger.info(\"\u4efb\u52a1\u5f00\u59cb\u6267\u884c\")\n\n    try:\n        result = await do_work()\n        logger.info(f\"\u4efb\u52a1\u6267\u884c\u6210\u529f: {result}\")\n    except Exception as e:\n        logger.error(f\"\u4efb\u52a1\u6267\u884c\u5931\u8d25: {e}\", exc_info=True)\n\nscheduler.add_job(\n    func=logged_task,\n    trigger=\"interval\",\n    hours=1,\n    id=\"logged_task\"\n)</code></pre>"},{"location":"16-scheduler-guide/#_30","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"16-scheduler-guide/#1-id","title":"1. \u4f7f\u7528\u660e\u786e\u7684 ID","text":"<pre><code># \u274c \u4e0d\u6e05\u695a\nscheduler.add_job(func=my_task, trigger=\"interval\", minutes=5)\n\n# \u2705 \u6e05\u695a\nscheduler.add_job(\n    func=my_task,\n    trigger=\"interval\",\n    minutes=5,\n    id=\"sync_user_data\",\n    name=\"\u540c\u6b65\u7528\u6237\u6570\u636e\"\n)</code></pre>"},{"location":"16-scheduler-guide/#2","title":"2. \u5408\u7406\u8bbe\u7f6e\u6267\u884c\u95f4\u9694","text":"<pre><code># \u274c \u592a\u9891\u7e41\nscheduler.add_job(func=heavy_task, trigger=\"interval\", seconds=1)\n\n# \u2705 \u5408\u7406\u95f4\u9694\nscheduler.add_job(func=heavy_task, trigger=\"interval\", minutes=5)</code></pre>"},{"location":"16-scheduler-guide/#3","title":"3. \u5904\u7406\u4efb\u52a1\u5931\u8d25","text":"<pre><code># \u2705 \u4f18\u96c5\u5904\u7406\nasync def resilient_task():\n    try:\n        await external_api.call()\n    except ConnectionError:\n        logger.warning(\"\u8fde\u63a5\u5931\u8d25\uff0c\u5c06\u5728\u4e0b\u6b21\u91cd\u8bd5\")\n    except Exception as e:\n        logger.error(f\"\u672a\u9884\u671f\u7684\u9519\u8bef: {e}\")</code></pre>"},{"location":"16-scheduler-guide/#4","title":"4. \u907f\u514d\u91cd\u590d\u6267\u884c","text":"<pre><code>import asyncio\n\n_lock = asyncio.Lock()\n\nasync def protected_task():\n    \"\"\"\u786e\u4fdd\u540c\u4e00\u65f6\u523b\u53ea\u6709\u4e00\u4e2a\u4efb\u52a1\u5b9e\u4f8b\u8fd0\u884c\"\"\"\n    async with _lock:\n        if some_condition_is_running:\n            logger.info(\"\u4efb\u52a1\u5df2\u5728\u8fd0\u884c\uff0c\u8df3\u8fc7\u672c\u6b21\u6267\u884c\")\n            return\n\n        await do_work()</code></pre> <p>\u603b\u7ed3\uff1a\u5b9a\u65f6\u8c03\u5ea6\u9002\u5408\u6267\u884c\u5468\u671f\u6027\u4efb\u52a1\uff0c\u5982\u6570\u636e\u540c\u6b65\u3001\u5907\u4efd\u3001\u6e05\u7406\u3001\u76d1\u63a7\u7b49\u3002\u4f7f\u7528\u5408\u7406\u7684\u95f4\u9694\u548c\u9519\u8bef\u5904\u7406\uff0c\u53ef\u4ee5\u6784\u5efa\u7a33\u5b9a\u7684\u540e\u53f0\u4efb\u52a1\u7cfb\u7edf\u3002</p>"},{"location":"17-rpc-microservices/","title":"16. RPC \u548c\u5fae\u670d\u52a1\u901a\u4fe1","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 16 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"17-rpc-microservices/#_1","title":"\u670d\u52a1\u914d\u7f6e","text":""},{"location":"17-rpc-microservices/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<pre><code># \u914d\u7f6e RPC \u670d\u52a1\nRPC_CLIENT_SERVICES={\"order-service\": \"http://order-service:8000\", \"user-service\": \"http://user-service:8001\"}\n\n# \u8d85\u65f6\u914d\u7f6e\nRPC_CLIENT_TIMEOUT=30\n\n# \u91cd\u8bd5\u914d\u7f6e\nRPC_CLIENT_RETRIES=3\nRPC_CLIENT_RETRY_DELAY=1</code></pre>"},{"location":"17-rpc-microservices/#dns","title":"\u81ea\u52a8 DNS \u89e3\u6790","text":"<pre><code># \u4e0d\u914d\u7f6e\u663e\u5f0f\u6620\u5c04\uff0c\u4f7f\u7528 DNS \u81ea\u52a8\u89e3\u6790\n# \u76f4\u63a5\u4f7f\u7528\u670d\u52a1\u540d\uff0c\u5982 http://order-service</code></pre>"},{"location":"17-rpc-microservices/#rpc","title":"\u521b\u5efa RPC \u5ba2\u6237\u7aef","text":""},{"location":"17-rpc-microservices/#_3","title":"\u57fa\u7840\u7528\u6cd5","text":"<pre><code>from aury.boot.application.rpc.client import create_rpc_client\n\n# \u521b\u5efa\u5ba2\u6237\u7aef\nclient = create_rpc_client(service_name=\"order-service\")\n\n# \u53d1\u8d77 GET \u8bf7\u6c42\nresponse = await client.get(\"/api/v1/orders/123\")\norder = response.data\n\n# \u53d1\u8d77 POST \u8bf7\u6c42\nresponse = await client.post(\n    \"/api/v1/orders\",\n    json={\"user_id\": \"user123\", \"amount\": 100}\n)\nnew_order = response.data</code></pre>"},{"location":"17-rpc-microservices/#_4","title":"\u8bf7\u6c42\u53c2\u6570","text":"<pre><code># \u67e5\u8be2\u53c2\u6570\nresponse = await client.get(\n    \"/api/v1/orders\",\n    params={\"page\": 1, \"size\": 10, \"status\": \"pending\"}\n)\n\n# \u8bf7\u6c42\u5934\nresponse = await client.get(\n    \"/api/v1/orders/123\",\n    headers={\"Authorization\": \"Bearer token\"}\n)\n\n# \u8bf7\u6c42\u4f53\nresponse = await client.post(\n    \"/api/v1/orders\",\n    json={\"user_id\": \"user123\", \"amount\": 100}\n)</code></pre>"},{"location":"17-rpc-microservices/#http","title":"\u5e38\u89c1 HTTP \u65b9\u6cd5","text":"<pre><code># GET \u8bf7\u6c42\nresponse = await client.get(\"/api/v1/users/123\")\n\n# POST \u8bf7\u6c42\nresponse = await client.post(\"/api/v1/users\", json={\"name\": \"John\"})\n\n# PUT \u8bf7\u6c42\nresponse = await client.put(\"/api/v1/users/123\", json={\"name\": \"Jane\"})\n\n# PATCH \u8bf7\u6c42\nresponse = await client.patch(\"/api/v1/users/123\", json={\"status\": \"active\"})\n\n# DELETE \u8bf7\u6c42\nresponse = await client.delete(\"/api/v1/users/123\")</code></pre>"},{"location":"17-rpc-microservices/#_5","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"17-rpc-microservices/#_6","title":"\u57fa\u7840\u9519\u8bef\u5904\u7406","text":"<pre><code>from aury.boot.application.rpc.exceptions import (\n    RPCConnectionError,\n    RPCTimeoutError,\n    RPCResponseError,\n)\n\ntry:\n    response = await client.get(\"/api/v1/orders/123\")\nexcept RPCTimeoutError:\n    logger.error(\"\u8bf7\u6c42\u8d85\u65f6\uff0c\u670d\u52a1\u54cd\u5e94\u7f13\u6162\")\nexcept RPCConnectionError:\n    logger.error(\"\u8fde\u63a5\u5931\u8d25\uff0c\u670d\u52a1\u4e0d\u53ef\u7528\")\nexcept RPCResponseError as e:\n    logger.error(f\"\u670d\u52a1\u8fd4\u56de\u9519\u8bef: {e.status_code} - {e.message}\")\nexcept Exception as e:\n    logger.error(f\"\u672a\u77e5\u9519\u8bef: {e}\")</code></pre>"},{"location":"17-rpc-microservices/#_7","title":"\u91cd\u8bd5\u673a\u5236","text":"<pre><code>import asyncio\n\nasync def call_with_retry(client, endpoint: str, max_retries: int = 3):\n    \"\"\"\u5e26\u91cd\u8bd5\u7684 RPC \u8c03\u7528\"\"\"\n\n    for attempt in range(max_retries):\n        try:\n            return await client.get(endpoint)\n        except (RPCConnectionError, RPCTimeoutError):\n            if attempt &lt; max_retries - 1:\n                wait_time = 2 ** attempt  # \u6307\u6570\u9000\u907f\n                logger.warning(f\"\u91cd\u8bd5 {attempt + 1}/{max_retries}\uff0c\u7b49\u5f85 {wait_time}s\")\n                await asyncio.sleep(wait_time)\n            else:\n                raise</code></pre>"},{"location":"17-rpc-microservices/#_8","title":"\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a","text":""},{"location":"17-rpc-microservices/#_9","title":"\u81ea\u52a8\u8ffd\u8e2a","text":"<pre><code>from aury.boot.common.logging import get_trace_id, logger\n\n# RPC \u8c03\u7528\u4f1a\u81ea\u52a8\u6dfb\u52a0 X-Trace-ID \u8bf7\u6c42\u5934\n@router.get(\"/orders/{order_id}\")\nasync def get_order(order_id: str):\n    trace_id = get_trace_id()\n    logger.info(f\"\u83b7\u53d6\u8ba2\u5355\uff0cTrace-ID: {trace_id}\")\n\n    # \u8c03\u7528\u5176\u4ed6\u670d\u52a1\uff0c\u81ea\u52a8\u4f20\u9012 Trace-ID\n    order_client = create_rpc_client(\"order-service\")\n    response = await order_client.get(f\"/api/v1/orders/{order_id}\")\n\n    # \u4e0b\u6e38\u670d\u52a1\u7684\u65e5\u5fd7\u4f1a\u5305\u542b\u76f8\u540c\u7684 Trace-ID\n    return response</code></pre>"},{"location":"17-rpc-microservices/#trace-id","title":"\u624b\u52a8\u8bbe\u7f6e Trace-ID","text":"<pre><code>from aury.boot.common.logging import set_trace_id, get_trace_id\n\nasync def process_task(task_id: str, custom_trace_id: str = None):\n    \"\"\"\u5f02\u6b65\u4efb\u52a1\u4e2d\u4f7f\u7528\u81ea\u5b9a\u4e49 Trace-ID\"\"\"\n\n    # \u8bbe\u7f6e Trace-ID\uff08\u53ef\u9009\uff0c\u901a\u5e38\u81ea\u52a8\u751f\u6210\uff09\n    if custom_trace_id:\n        set_trace_id(custom_trace_id)\n\n    trace_id = get_trace_id()\n    logger.info(f\"\u5904\u7406\u4efb\u52a1 {task_id}\uff0cTrace-ID: {trace_id}\")\n\n    # \u8c03\u7528\u670d\u52a1\n    client = create_rpc_client(\"service-name\")\n    await client.post(\"/api/v1/process\", json={\"task_id\": task_id})</code></pre>"},{"location":"17-rpc-microservices/#_10","title":"\u5e38\u89c1\u573a\u666f","text":""},{"location":"17-rpc-microservices/#_11","title":"\u83b7\u53d6\u7528\u6237\u4fe1\u606f","text":"<pre><code>async def get_user_with_details(user_id: str):\n    \"\"\"\u4ece\u7528\u6237\u670d\u52a1\u83b7\u53d6\u7528\u6237\u8be6\u7ec6\u4fe1\u606f\"\"\"\n\n    user_client = create_rpc_client(\"user-service\")\n\n    response = await user_client.get(f\"/api/v1/users/{user_id}\")\n\n    if response.code != 200:\n        raise NotFoundError(f\"\u7528\u6237 {user_id} \u4e0d\u5b58\u5728\")\n\n    return response.data</code></pre>"},{"location":"17-rpc-microservices/#_12","title":"\u9a8c\u8bc1\u6743\u9650","text":"<pre><code>async def verify_permission(user_id: str, resource: str, action: str):\n    \"\"\"\u8c03\u7528\u6743\u9650\u670d\u52a1\u9a8c\u8bc1\u7528\u6237\u6743\u9650\"\"\"\n\n    auth_client = create_rpc_client(\"auth-service\")\n\n    response = await auth_client.post(\n        \"/api/v1/permissions/verify\",\n        json={\n            \"user_id\": user_id,\n            \"resource\": resource,\n            \"action\": action\n        }\n    )\n\n    if response.code != 200:\n        raise ForbiddenError(\"\u6ca1\u6709\u6743\u9650\u8bbf\u95ee\u8be5\u8d44\u6e90\")\n\n    return response.data</code></pre>"},{"location":"17-rpc-microservices/#_13","title":"\u521b\u5efa\u76f8\u5173\u8d44\u6e90","text":"<pre><code>async def create_order_with_notification(order_data: dict):\n    \"\"\"\u521b\u5efa\u8ba2\u5355\u5e76\u53d1\u9001\u901a\u77e5\"\"\"\n\n    order_client = create_rpc_client(\"order-service\")\n    notify_client = create_rpc_client(\"notification-service\")\n\n    # 1. \u521b\u5efa\u8ba2\u5355\n    order_response = await order_client.post(\n        \"/api/v1/orders\",\n        json=order_data\n    )\n\n    if order_response.code != 200:\n        raise Exception(\"\u521b\u5efa\u8ba2\u5355\u5931\u8d25\")\n\n    order = order_response.data\n\n    # 2. \u53d1\u9001\u901a\u77e5\n    await notify_client.post(\n        \"/api/v1/notifications/send\",\n        json={\n            \"type\": \"order_created\",\n            \"order_id\": order[\"id\"],\n            \"user_id\": order[\"user_id\"]\n        }\n    )\n\n    return order</code></pre>"},{"location":"17-rpc-microservices/#_14","title":"\u805a\u5408\u591a\u4e2a\u670d\u52a1","text":"<pre><code>async def get_user_profile(user_id: str):\n    \"\"\"\u805a\u5408\u591a\u4e2a\u670d\u52a1\u6570\u636e\u6784\u5efa\u7528\u6237\u6863\u6848\"\"\"\n\n    user_client = create_rpc_client(\"user-service\")\n    order_client = create_rpc_client(\"order-service\")\n    wallet_client = create_rpc_client(\"wallet-service\")\n\n    # \u5e76\u53d1\u8c03\u7528\u591a\u4e2a\u670d\u52a1\n    import asyncio\n\n    user_resp, orders_resp, wallet_resp = await asyncio.gather(\n        user_client.get(f\"/api/v1/users/{user_id}\"),\n        order_client.get(f\"/api/v1/users/{user_id}/orders\"),\n        wallet_client.get(f\"/api/v1/users/{user_id}/wallet\"),\n        return_exceptions=True\n    )\n\n    profile = {\n        \"user\": user_resp.data if not isinstance(user_resp, Exception) else None,\n        \"orders\": orders_resp.data if not isinstance(orders_resp, Exception) else [],\n        \"wallet\": wallet_resp.data if not isinstance(wallet_resp, Exception) else None,\n    }\n\n    return profile</code></pre>"},{"location":"17-rpc-microservices/#_15","title":"\u670d\u52a1\u53d1\u73b0","text":""},{"location":"17-rpc-microservices/#_16","title":"\u663e\u5f0f\u6620\u5c04","text":"<pre><code># .env \u4e2d\u914d\u7f6e\nRPC_CLIENT_SERVICES={\"order-service\": \"http://192.168.1.10:8000\", \"user-service\": \"http://192.168.1.11:8001\"}</code></pre>"},{"location":"17-rpc-microservices/#dns_1","title":"DNS \u81ea\u52a8\u89e3\u6790","text":"<pre><code># \u5728 Kubernetes \u4e2d\u81ea\u52a8\u4f7f\u7528 DNS \u89e3\u6790\n# \u670d\u52a1\u540d\u4f1a\u89e3\u6790\u5230\u5bf9\u5e94\u7684\u96c6\u7fa4 IP\nRPC_CLIENT_SERVICES={}  # \u7a7a\u914d\u7f6e</code></pre> <p>\u4f7f\u7528\u65f6\u76f4\u63a5\u4f7f\u7528\u670d\u52a1\u540d\uff1a</p> <pre><code># Kubernetes \u4e2d\u81ea\u52a8\u89e3\u6790\nclient = create_rpc_client(\"order-service\")\n# \u4f1a\u89e3\u6790\u5230 order-service.default.svc.cluster.local</code></pre>"},{"location":"17-rpc-microservices/#_17","title":"\u8d1f\u8f7d\u5747\u8861","text":""},{"location":"17-rpc-microservices/#round-robin","title":"\u8f6e\u8be2\uff08Round Robin\uff09","text":"<pre><code># Kit \u9ed8\u8ba4\u652f\u6301\nclient = create_rpc_client(\"order-service\")\n# \u5982\u679c\u914d\u7f6e\u4e86\u591a\u4e2a\u5730\u5740\uff0c\u4f1a\u81ea\u52a8\u8f6e\u8be2</code></pre>"},{"location":"17-rpc-microservices/#_18","title":"\u76d1\u63a7\u548c\u8c03\u8bd5","text":""},{"location":"17-rpc-microservices/#_19","title":"\u8bf7\u6c42\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\nasync def logged_rpc_call():\n    logger.info(\"\u53d1\u8d77 RPC \u8c03\u7528: order-service\")\n\n    client = create_rpc_client(\"order-service\")\n    response = await client.get(\"/api/v1/orders/123\")\n\n    logger.info(f\"RPC \u8c03\u7528\u5b8c\u6210\uff0c\u72b6\u6001\u7801: {response.code}\")</code></pre>"},{"location":"17-rpc-microservices/#_20","title":"\u6027\u80fd\u76d1\u63a7","text":"<pre><code>import time\nfrom aury.boot.common.logging import logger\n\nasync def monitored_rpc_call():\n    start_time = time.time()\n\n    try:\n        client = create_rpc_client(\"order-service\")\n        response = await client.get(\"/api/v1/orders/123\")\n    finally:\n        duration = time.time() - start_time\n        logger.info(f\"RPC \u8c03\u7528\u8017\u65f6: {duration:.3f}s\")</code></pre>"},{"location":"17-rpc-microservices/#_21","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"17-rpc-microservices/#1","title":"1. \u4f7f\u7528\u8d85\u65f6\u4fdd\u62a4","text":"<pre><code># \u2705 \u8bbe\u7f6e\u5408\u7406\u7684\u8d85\u65f6\nclient = create_rpc_client(\"order-service\", timeout=30)</code></pre>"},{"location":"17-rpc-microservices/#2","title":"2. \u5b9e\u73b0\u65ad\u8def\u5668","text":"<pre><code>from circuitbreaker import circuit\n\n@circuit(failure_threshold=5, recovery_timeout=60)\nasync def call_order_service():\n    client = create_rpc_client(\"order-service\")\n    return await client.get(\"/api/v1/orders\")</code></pre>"},{"location":"17-rpc-microservices/#3","title":"3. \u7f13\u5b58\u7ed3\u679c","text":"<pre><code>from aury.boot.infrastructure.cache import CacheManager\n\ncache = CacheManager.get_instance()\n\n@cache.cached(expire=300)\nasync def get_order_cached(order_id: str):\n    client = create_rpc_client(\"order-service\")\n    response = await client.get(f\"/api/v1/orders/{order_id}\")\n    return response.data</code></pre>"},{"location":"17-rpc-microservices/#4","title":"4. \u4f18\u96c5\u964d\u7ea7","text":"<pre><code>async def get_order_with_fallback(order_id: str):\n    try:\n        client = create_rpc_client(\"order-service\")\n        response = await client.get(f\"/api/v1/orders/{order_id}\", timeout=5)\n        return response.data\n    except Exception as e:\n        logger.error(f\"\u8c03\u7528 order-service \u5931\u8d25: {e}\")\n\n        # \u8fd4\u56de\u7f13\u5b58\u6570\u636e\u6216\u964d\u7ea7\u65b9\u6848\n        cached_order = await cache.get(f\"order:{order_id}\")\n        if cached_order:\n            logger.info(\"\u4f7f\u7528\u7f13\u5b58\u6570\u636e\")\n            return cached_order\n\n        # \u6216\u8fd4\u56de\u9ed8\u8ba4\u503c\n        return {\"id\": order_id, \"status\": \"unknown\"}</code></pre> <p>\u603b\u7ed3\uff1aRPC \u662f\u5fae\u670d\u52a1\u95f4\u901a\u4fe1\u7684\u5173\u952e\u3002\u5408\u7406\u4f7f\u7528\u9519\u8bef\u5904\u7406\u3001\u91cd\u8bd5\u673a\u5236\u3001\u94fe\u8def\u8ffd\u8e2a\uff0c\u53ef\u4ee5\u6784\u5efa\u53ef\u9760\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u3002</p>"},{"location":"18-websocket-guide/","title":"17. WebSocket \u957f\u8fde\u63a5\u5b8c\u5168\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 17 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"18-websocket-guide/#_1","title":"\u57fa\u672c\u8fde\u63a5","text":""},{"location":"18-websocket-guide/#websocket","title":"\u7b80\u5355\u7684 WebSocket \u670d\u52a1\u5668","text":"<pre><code>from fastapi import APIRouter, WebSocket\nfrom aury.boot.infrastructure.database import DatabaseManager\nfrom aury.boot.common.logging import logger\n\nrouter = APIRouter()\ndb_manager = DatabaseManager.get_instance()\n\n@router.websocket(\"/ws/chat/{room_id}\")\nasync def websocket_endpoint(websocket: WebSocket, room_id: str):\n    await websocket.accept()\n    logger.info(f\"\u5ba2\u6237\u7aef\u52a0\u5165\u623f\u95f4: {room_id}\")\n\n    try:\n        while True:\n            # \u63a5\u6536\u5ba2\u6237\u7aef\u6d88\u606f\n            data = await websocket.receive_text()\n\n            # \u4fdd\u5b58\u5230\u6570\u636e\u5e93\n            async with db_manager.session() as session:\n                message = Message(\n                    room_id=room_id,\n                    content=data,\n                    created_at=datetime.now()\n                )\n                session.add(message)\n                await session.commit()\n\n            # \u53d1\u9001\u786e\u8ba4\n            await websocket.send_json({\n                \"status\": \"ok\",\n                \"message_id\": message.id\n            })\n\n    except Exception as e:\n        logger.error(f\"WebSocket \u9519\u8bef: {e}\")\n        await websocket.close(code=1011, reason=str(e))</code></pre>"},{"location":"18-websocket-guide/#_2","title":"\u8fde\u63a5\u7ba1\u7406","text":""},{"location":"18-websocket-guide/#_3","title":"\u591a\u5ba2\u6237\u7aef\u5e7f\u64ad","text":"<pre><code>class ConnectionManager:\n    \"\"\"\u7ba1\u7406\u6240\u6709 WebSocket \u8fde\u63a5\"\"\"\n\n    def __init__(self):\n        self.active_connections: dict[str, list[WebSocket]] = {}\n\n    async def connect(self, room_id: str, websocket: WebSocket):\n        await websocket.accept()\n        if room_id not in self.active_connections:\n            self.active_connections[room_id] = []\n        self.active_connections[room_id].append(websocket)\n        logger.info(f\"\u5ba2\u6237\u7aef\u5df2\u8fde\u63a5\u5230\u623f\u95f4 {room_id}\")\n\n    def disconnect(self, room_id: str, websocket: WebSocket):\n        if room_id in self.active_connections:\n            self.active_connections[room_id].remove(websocket)\n        logger.info(f\"\u5ba2\u6237\u7aef\u5df2\u79bb\u5f00\u623f\u95f4 {room_id}\")\n\n    async def broadcast(self, room_id: str, message: dict):\n        \"\"\"\u5e7f\u64ad\u6d88\u606f\u7ed9\u623f\u95f4\u5185\u6240\u6709\u5ba2\u6237\u7aef\"\"\"\n        if room_id in self.active_connections:\n            disconnected = []\n            for connection in self.active_connections[room_id]:\n                try:\n                    await connection.send_json(message)\n                except Exception as e:\n                    logger.error(f\"\u53d1\u9001\u6d88\u606f\u5931\u8d25: {e}\")\n                    disconnected.append(connection)\n\n            # \u6e05\u7406\u65ad\u5f00\u7684\u8fde\u63a5\n            for conn in disconnected:\n                self.active_connections[room_id].remove(conn)\n\nmanager = ConnectionManager()\n\n@router.websocket(\"/ws/chat/{room_id}\")\nasync def chat_endpoint(websocket: WebSocket, room_id: str):\n    await manager.connect(room_id, websocket)\n\n    try:\n        while True:\n            data = await websocket.receive_text()\n\n            # \u5e7f\u64ad\u7ed9\u623f\u95f4\u5185\u6240\u6709\u5ba2\u6237\u7aef\n            await manager.broadcast(room_id, {\n                \"type\": \"message\",\n                \"content\": data,\n                \"timestamp\": datetime.now().isoformat()\n            })\n\n    except Exception:\n        manager.disconnect(room_id, websocket)</code></pre>"},{"location":"18-websocket-guide/#_4","title":"\u6d88\u606f\u7c7b\u578b","text":""},{"location":"18-websocket-guide/#_5","title":"\u7ed3\u6784\u5316\u6d88\u606f","text":"<pre><code>from pydantic import BaseModel\n\nclass ChatMessage(BaseModel):\n    type: str  # \"text\", \"image\", \"notification\"\n    content: str\n    sender_id: str\n    timestamp: datetime\n\n@router.websocket(\"/ws/advanced/{room_id}\")\nasync def advanced_ws(websocket: WebSocket, room_id: str):\n    await websocket.accept()\n\n    try:\n        while True:\n            data = await websocket.receive_json()\n\n            # \u89e3\u6790\u6d88\u606f\n            message = ChatMessage(**data)\n\n            # \u6839\u636e\u7c7b\u578b\u5904\u7406\n            if message.type == \"text\":\n                await handle_text_message(message)\n            elif message.type == \"image\":\n                await handle_image_message(message)\n            elif message.type == \"notification\":\n                await handle_notification(message)\n\n    except Exception as e:\n        logger.error(f\"\u5904\u7406\u6d88\u606f\u9519\u8bef: {e}\")\n        await websocket.close(code=1011)</code></pre>"},{"location":"18-websocket-guide/#_6","title":"\u5b9e\u65f6\u901a\u77e5","text":""},{"location":"18-websocket-guide/#_7","title":"\u8ba2\u5355\u72b6\u6001\u66f4\u65b0","text":"<pre><code># \u7ef4\u62a4\u7528\u6237 ID \u5230 WebSocket \u7684\u6620\u5c04\nuser_connections: dict[str, WebSocket] = {}\n\n@router.websocket(\"/ws/notifications/{user_id}\")\nasync def notifications_endpoint(websocket: WebSocket, user_id: str):\n    await websocket.accept()\n\n    user_connections[user_id] = websocket\n    logger.info(f\"\u7528\u6237 {user_id} \u5df2\u8fde\u63a5\u901a\u77e5\")\n\n    try:\n        # \u4fdd\u6301\u8fde\u63a5\n        while True:\n            data = await websocket.receive_text()\n            # \u53ef\u4ee5\u5904\u7406\u6765\u81ea\u5ba2\u6237\u7aef\u7684\u5fc3\u8df3\u6216\u5176\u4ed6\u6d88\u606f\n\n    except Exception:\n        del user_connections[user_id]\n        logger.info(f\"\u7528\u6237 {user_id} \u5df2\u65ad\u5f00\u901a\u77e5\u8fde\u63a5\")\n\n# \u5728\u5176\u4ed6\u5730\u65b9\u53d1\u9001\u901a\u77e5\nasync def notify_user(user_id: str, message: dict):\n    if user_id in user_connections:\n        try:\n            await user_connections[user_id].send_json(message)\n        except Exception as e:\n            logger.error(f\"\u53d1\u9001\u901a\u77e5\u5931\u8d25: {e}\")\n            del user_connections[user_id]</code></pre>"},{"location":"18-websocket-guide/#_8","title":"\u8ba2\u5355\u72b6\u6001\u63a8\u9001","text":"<pre><code>async def push_order_status(order_id: str, status: str):\n    \"\"\"\u5f53\u8ba2\u5355\u72b6\u6001\u6539\u53d8\u65f6\u63a8\u9001\u7ed9\u7528\u6237\"\"\"\n\n    order = await db.get_order(order_id)\n    if not order:\n        return\n\n    await notify_user(order.user_id, {\n        \"type\": \"order_status_changed\",\n        \"order_id\": order_id,\n        \"status\": status,\n        \"timestamp\": datetime.now().isoformat()\n    })</code></pre>"},{"location":"18-websocket-guide/#_9","title":"\u5fc3\u8df3\u548c\u8fde\u63a5\u4fdd\u6d3b","text":""},{"location":"18-websocket-guide/#_10","title":"\u5ba2\u6237\u7aef\u5fc3\u8df3","text":"<pre><code>import asyncio\n\n@router.websocket(\"/ws/with_heartbeat/{room_id}\")\nasync def ws_with_heartbeat(websocket: WebSocket, room_id: str):\n    await websocket.accept()\n\n    async def send_heartbeat():\n        \"\"\"\u6bcf 30 \u79d2\u53d1\u9001\u4e00\u6b21\u5fc3\u8df3\"\"\"\n        try:\n            while True:\n                await asyncio.sleep(30)\n                await websocket.send_json({\"type\": \"heartbeat\"})\n        except Exception:\n            pass\n\n    # \u542f\u52a8\u5fc3\u8df3\u4efb\u52a1\n    heartbeat_task = asyncio.create_task(send_heartbeat())\n\n    try:\n        while True:\n            data = await websocket.receive_json()\n\n            # \u5904\u7406\u5fc3\u8df3\u54cd\u5e94\n            if data.get(\"type\") == \"pong\":\n                logger.debug(\"\u6536\u5230\u5fc3\u8df3\u54cd\u5e94\")\n            else:\n                # \u5904\u7406\u5176\u4ed6\u6d88\u606f\n                pass\n\n    except Exception as e:\n        logger.error(f\"WebSocket \u9519\u8bef: {e}\")\n\n    finally:\n        heartbeat_task.cancel()</code></pre>"},{"location":"18-websocket-guide/#_11","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"18-websocket-guide/#_12","title":"\u8fde\u63a5\u9519\u8bef","text":"<pre><code>from starlette.websockets import WebSocketState\n\n@router.websocket(\"/ws/resilient/{room_id}\")\nasync def resilient_ws(websocket: WebSocket, room_id: str):\n    try:\n        await websocket.accept()\n    except Exception as e:\n        logger.error(f\"\u63a5\u53d7\u8fde\u63a5\u5931\u8d25: {e}\")\n        return\n\n    try:\n        while True:\n            try:\n                data = await websocket.receive_text()\n                # \u5904\u7406\u6d88\u606f\n            except Exception as e:\n                logger.error(f\"\u63a5\u6536\u6d88\u606f\u9519\u8bef: {e}\")\n                break\n\n    except Exception as e:\n        logger.error(f\"WebSocket \u5f02\u5e38: {e}\")\n\n    finally:\n        try:\n            await websocket.close()\n        except Exception:\n            pass</code></pre>"},{"location":"18-websocket-guide/#_13","title":"\u91cd\u8fde\u673a\u5236","text":"<pre><code># \u5ba2\u6237\u7aef\uff08JavaScript/TypeScript\uff09\u5e94\u8be5\u5b9e\u73b0\u91cd\u8fde\n# \u5f53\u8fde\u63a5\u65ad\u5f00\u65f6\uff0c\u81ea\u52a8\u91cd\u8fde\n\n# \u670d\u52a1\u7aef\u53ea\u9700\u8981\u63a5\u53d7\u65b0\u8fde\u63a5\n@router.websocket(\"/ws/reconnect/{session_id}\")\nasync def ws_with_session(websocket: WebSocket, session_id: str):\n    await websocket.accept()\n\n    # \u53ef\u4ee5\u6062\u590d\u4e4b\u524d\u7684\u4f1a\u8bdd\n    session = await db.get_session(session_id)\n\n    try:\n        while True:\n            data = await websocket.receive_json()\n            # \u5904\u7406\u6d88\u606f\n    except Exception:\n        # \u5173\u95ed\u8fde\u63a5\n        pass</code></pre>"},{"location":"18-websocket-guide/#_14","title":"\u6570\u636e\u5e93\u64cd\u4f5c","text":""},{"location":"18-websocket-guide/#_15","title":"\u4e8b\u52a1\u5904\u7406","text":"<pre><code>@router.websocket(\"/ws/db/{user_id}\")\nasync def ws_with_db(websocket: WebSocket, user_id: str):\n    await websocket.accept()\n    db_manager = DatabaseManager.get_instance()\n\n    try:\n        while True:\n            data = await websocket.receive_json()\n\n            # \u4f7f\u7528\u6570\u636e\u5e93\u4f1a\u8bdd\n            async with db_manager.session() as session:\n                # \u4fdd\u5b58\u6d88\u606f\n                message = Message(\n                    user_id=user_id,\n                    content=data.get(\"content\"),\n                    created_at=datetime.now()\n                )\n                session.add(message)\n                await session.commit()\n\n                # \u53d1\u9001\u786e\u8ba4\n                await websocket.send_json({\n                    \"status\": \"saved\",\n                    \"message_id\": message.id\n                })\n\n    except Exception as e:\n        logger.error(f\"\u6570\u636e\u5e93\u9519\u8bef: {e}\")\n        await websocket.close(code=1011)</code></pre>"},{"location":"18-websocket-guide/#_16","title":"\u5e38\u89c1\u573a\u666f","text":""},{"location":"18-websocket-guide/#_17","title":"\u5b9e\u65f6\u804a\u5929","text":"<pre><code>manager = ConnectionManager()\n\n@router.websocket(\"/ws/chat/rooms/{room_id}\")\nasync def chat_room(websocket: WebSocket, room_id: str):\n    await manager.connect(room_id, websocket)\n\n    try:\n        while True:\n            message_data = await websocket.receive_json()\n\n            message = {\n                \"type\": \"chat\",\n                \"room_id\": room_id,\n                \"content\": message_data.get(\"content\"),\n                \"sender\": message_data.get(\"sender\"),\n                \"timestamp\": datetime.now().isoformat()\n            }\n\n            # \u5e7f\u64ad\u7ed9\u623f\u95f4\u5185\u6240\u6709\u5ba2\u6237\u7aef\n            await manager.broadcast(room_id, message)\n\n    except Exception:\n        manager.disconnect(room_id, websocket)</code></pre>"},{"location":"18-websocket-guide/#_18","title":"\u5b9e\u65f6\u6570\u636e\u63a8\u9001","text":"<pre><code># \u6570\u636e\u66f4\u65b0\u65f6\u63a8\u9001\u7ed9\u5ba2\u6237\u7aef\n@app.on_event(\"startup\")\nasync def setup_data_pusher():\n    \"\"\"\u5e94\u7528\u542f\u52a8\u65f6\u8bbe\u7f6e\u6570\u636e\u63a8\u9001\u4efb\u52a1\"\"\"\n\n    async def push_data_updates():\n        while True:\n            try:\n                updates = await get_data_updates()\n\n                # \u63a8\u9001\u7ed9\u6240\u6709\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\n                for user_id, ws in user_connections.items():\n                    try:\n                        await ws.send_json(updates)\n                    except Exception:\n                        del user_connections[user_id]\n\n                await asyncio.sleep(5)  # \u6bcf 5 \u79d2\u63a8\u9001\u4e00\u6b21\n\n            except Exception as e:\n                logger.error(f\"\u63a8\u9001\u6570\u636e\u5931\u8d25: {e}\")\n\n    asyncio.create_task(push_data_updates())</code></pre>"},{"location":"18-websocket-guide/#_19","title":"\u6027\u80fd\u4f18\u5316","text":""},{"location":"18-websocket-guide/#_20","title":"\u6d88\u606f\u6279\u5904\u7406","text":"<pre><code>class BatchedConnectionManager:\n    def __init__(self, batch_size=10, flush_interval=1):\n        self.batch_size = batch_size\n        self.flush_interval = flush_interval\n        self.message_queue = {}\n\n    async def queue_message(self, room_id: str, message: dict):\n        if room_id not in self.message_queue:\n            self.message_queue[room_id] = []\n\n        self.message_queue[room_id].append(message)\n\n        # \u6279\u91cf\u53d1\u9001\n        if len(self.message_queue[room_id]) &gt;= self.batch_size:\n            await self.flush(room_id)\n\n    async def flush(self, room_id: str):\n        if room_id in self.message_queue and self.message_queue[room_id]:\n            messages = self.message_queue[room_id]\n            # \u6279\u91cf\u53d1\u9001\n            await manager.broadcast(room_id, {\n                \"type\": \"batch\",\n                \"messages\": messages\n            })\n            self.message_queue[room_id] = []</code></pre> <p>\u603b\u7ed3\uff1aWebSocket \u9002\u5408\u5b9e\u65f6\u901a\u4fe1\u573a\u666f\uff0c\u5982\u804a\u5929\u3001\u901a\u77e5\u3001\u6570\u636e\u63a8\u9001\u3002\u5408\u7406\u7ba1\u7406\u8fde\u63a5\u548c\u5904\u7406\u9519\u8bef\uff0c\u53ef\u4ee5\u6784\u5efa\u7a33\u5b9a\u7684\u5b9e\u65f6\u7cfb\u7edf\u3002</p>"},{"location":"19-storage-guide/","title":"19. \u5bf9\u8c61\u5b58\u50a8\u6307\u5357","text":"<p>\u5bf9\u8c61\u5b58\u50a8\u6a21\u5757\u57fa\u4e8e aury-sdk-storage \u5b9e\u73b0\uff0c\u652f\u6301 S3 \u517c\u5bb9\u5b58\u50a8\uff08AWS S3\u3001\u817e\u8baf\u4e91 COS\u3001\u963f\u91cc\u4e91 OSS\u3001MinIO \u7b49\uff09\u548c STS \u4e34\u65f6\u51ed\u8bc1\u7b7e\u53d1\u3002</p>"},{"location":"19-storage-guide/#_1","title":"\u5b89\u88c5","text":"<pre><code># \u5b8c\u6574\u5b89\u88c5\uff08S3/COS/OSS + STS \u652f\u6301\uff09\nuv add \"aury-sdk-storage[aws]\"\n# \u6216\npip install \"aury-sdk-storage[aws]\"</code></pre>"},{"location":"19-storage-guide/#storagemanager","title":"\u57fa\u672c\u7528\u6cd5\uff08StorageManager\uff09","text":"<p>\u6846\u67b6\u63d0\u4f9b <code>StorageManager</code> \u5355\u4f8b\u7ba1\u7406\u5668\uff0c\u652f\u6301\u547d\u540d\u591a\u5b9e\u4f8b\uff1a</p> <pre><code>from io import BytesIO\nfrom aury.boot.infrastructure.storage import (\n    StorageManager, StorageConfig, StorageBackend, StorageFile,\n)\n\n# \u83b7\u53d6\u9ed8\u8ba4\u5b9e\u4f8b\nstorage = StorageManager.get_instance()\n\n# \u547d\u540d\u5b9e\u4f8b\uff08\u5982\u6e90\u5b58\u50a8\u548c\u76ee\u6807\u5b58\u50a8\uff09\nsource = StorageManager.get_instance(\"source\")\ntarget = StorageManager.get_instance(\"target\")\n\n# \u521d\u59cb\u5316\uff08\u4e00\u822c\u7531 StorageComponent \u81ea\u52a8\u5b8c\u6210\uff0c\u4ee5\u4e0b\u4ec5\u6f14\u793a\u624b\u52a8\u8c03\u7528\uff09\nawait storage.init(StorageConfig(\n    backend=StorageBackend.COS,\n    bucket_name=\"my-bucket-1250000000\",\n    region=\"ap-guangzhou\",\n    endpoint=\"https://cos.ap-guangzhou.myqcloud.com\",\n    access_key_id=\"AKIDxxxxx\",\n    access_key_secret=\"xxxxx\",\n))\n\n# \u4e0a\u4f20\u6587\u4ef6\uff08\u8fd4\u56de URL\uff09\nurl = await storage.upload_file(\n    StorageFile(\n        object_name=\"user/123/avatar.png\",\n        data=BytesIO(image_bytes),\n        content_type=\"image/png\",\n    )\n)\n\n# \u6279\u91cf\u4e0a\u4f20\nurls = await storage.upload_files([\n    StorageFile(object_name=\"img/1.jpg\", data=b\"...\"),\n    StorageFile(object_name=\"img/2.jpg\", data=b\"...\"),\n])\n\n# \u4e0b\u8f7d\u6587\u4ef6\ncontent = await storage.download_file(\"user/123/avatar.png\")\n\n# \u83b7\u53d6\u9884\u7b7e\u540d URL\uff08\u6709\u6548\u671f 1 \u5c0f\u65f6\uff09\nurl = await storage.get_file_url(\"user/123/avatar.png\", expires_in=3600)\n\n# \u68c0\u67e5\u6587\u4ef6\u662f\u5426\u5b58\u5728\nexists = await storage.file_exists(\"user/123/avatar.png\")\n\n# \u5220\u9664\u6587\u4ef6\nawait storage.delete_file(\"user/123/avatar.png\")</code></pre>"},{"location":"19-storage-guide/#_2","title":"\u672c\u5730\u5b58\u50a8\uff08\u5f00\u53d1\u6d4b\u8bd5\uff09","text":"<pre><code>from aury.boot.infrastructure.storage import (\n    StorageManager, StorageConfig, StorageBackend, StorageFile,\n)\n\nstorage = StorageManager.get_instance()\nawait storage.init(StorageConfig(\n    backend=StorageBackend.LOCAL,\n    base_path=\"./dev_storage\",\n))\n\nurl = await storage.upload_file(\n    StorageFile(object_name=\"test.txt\", data=b\"hello\")\n)\n# url: file:///path/to/dev_storage/default/test.txt</code></pre>"},{"location":"19-storage-guide/#sts","title":"STS \u4e34\u65f6\u51ed\u8bc1\uff08\u524d\u7aef\u76f4\u4f20\uff09","text":"<p>STS\uff08Security Token Service\uff09\u7528\u4e8e\u751f\u6210\u4e34\u65f6\u8bbf\u95ee\u51ed\u8bc1\uff0c\u9002\u5408\u4ee5\u4e0b\u573a\u666f\uff1a - \u524d\u7aef\u76f4\u4f20\uff1a\u540e\u7aef\u7b7e\u53d1\u4e34\u65f6\u51ed\u8bc1\uff0c\u524d\u7aef\u4f7f\u7528 S3 SDK \u76f4\u63a5\u4e0a\u4f20 - \u6743\u9650\u9694\u79bb\uff1a\u6bcf\u4e2a\u7528\u6237\u53ea\u80fd\u8bbf\u95ee\u81ea\u5df1\u7684\u76ee\u5f55 - \u6700\u5c0f\u6743\u9650\uff1a\u53ea\u6388\u4e88\u5fc5\u8981\u7684\u64cd\u4f5c\u6743\u9650</p> <pre><code>from aury.sdk.storage.sts import (\n    STSProviderFactory, ProviderType, STSRequest, ActionType,\n)\n\n# \u521b\u5efa\u817e\u8baf\u4e91 STS Provider\nprovider = STSProviderFactory.create(\n    ProviderType.TENCENT,\n    secret_id=\"AKIDxxxxx\",\n    secret_key=\"xxxxx\",\n)\n\n# \u7b7e\u53d1\u4e34\u65f6\u4e0a\u4f20\u51ed\u8bc1\ncredentials = await provider.get_credentials(\n    STSRequest(\n        bucket=\"my-bucket-1250000000\",\n        region=\"ap-guangzhou\",\n        allow_path=\"user/123/\",  # \u53ea\u5141\u8bb8\u8bbf\u95ee\u8be5\u76ee\u5f55\n        action_type=ActionType.WRITE,\n        duration_seconds=900,  # 15 \u5206\u949f\n    )\n)\n\n# \u8fd4\u56de\u7ed9\u524d\u7aef\nreturn {\n    \"accessKeyId\": credentials.access_key_id,\n    \"secretAccessKey\": credentials.secret_access_key,\n    \"sessionToken\": credentials.session_token,\n    \"expiration\": credentials.expiration.isoformat(),\n    \"bucket\": credentials.bucket,\n    \"region\": credentials.region,\n    \"endpoint\": credentials.endpoint,\n}</code></pre>"},{"location":"19-storage-guide/#_3","title":"\u64cd\u4f5c\u7c7b\u578b","text":"<pre><code>from aury.sdk.storage.sts import ActionType\n\n# \u53ea\u8bfb\u6743\u9650\uff08\u4e0b\u8f7d/\u67e5\u770b\uff09\nActionType.READ\n\n# \u53ea\u5199\u6743\u9650\uff08\u4e0a\u4f20\uff09\nActionType.WRITE\n\n# \u8bfb\u5199\u5168\u90e8\u6743\u9650\nActionType.ALL</code></pre>"},{"location":"19-storage-guide/#api","title":"API \u96c6\u6210\u793a\u4f8b","text":""},{"location":"19-storage-guide/#_4","title":"\u5934\u50cf\u4e0a\u4f20","text":"<pre><code>from io import BytesIO\nfrom fastapi import File, UploadFile\nfrom aury.boot.application.interfaces.egress import BaseResponse\nfrom aury.boot.infrastructure.storage import StorageManager, StorageFile\n\nstorage = StorageManager.get_instance()\n\n@router.post(\"/users/{user_id}/avatar\")\nasync def upload_avatar(\n    user_id: str,\n    file: UploadFile = File(...)\n):\n    \"\"\"\u7528\u6237\u4e0a\u4f20\u5934\u50cf\"\"\"\n\n    # \u9a8c\u8bc1\u6587\u4ef6\u7c7b\u578b\n    if file.content_type not in [\"image/jpeg\", \"image/png\"]:\n        raise ValueError(\"\u53ea\u652f\u6301 JPG \u548c PNG \u683c\u5f0f\")\n\n    # \u9a8c\u8bc1\u6587\u4ef6\u5927\u5c0f\uff08\u6700\u5927 5MB\uff09\n    content = await file.read()\n    if len(content) &gt; 5 * 1024 * 1024:\n        raise ValueError(\"\u6587\u4ef6\u8fc7\u5927\")\n\n    # \u4e0a\u4f20\u5230\u5b58\u50a8\n    ext = file.filename.split(\".\")[-1] if file.filename else \"jpg\"\n    url = await storage.upload_file(\n        StorageFile(\n            object_name=f\"avatars/{user_id}.{ext}\",\n            data=BytesIO(content),\n            content_type=file.content_type,\n        )\n    )\n\n    return BaseResponse(code=200, message=\"\u5934\u50cf\u4e0a\u4f20\u6210\u529f\", data={\"url\": url})</code></pre>"},{"location":"19-storage-guide/#api_1","title":"\u83b7\u53d6\u4e0a\u4f20\u51ed\u8bc1 API","text":"<pre><code>from pydantic import BaseModel\nfrom aury.sdk.storage.sts import (\n    STSProviderFactory, ProviderType, STSRequest, ActionType, STSRequestError,\n)\n\n# \u5168\u5c40 Provider\uff08\u590d\u7528 HTTP \u8fde\u63a5\uff09\nsts_provider = STSProviderFactory.create(\n    ProviderType.TENCENT,\n    secret_id=\"your-secret-id\",\n    secret_key=\"your-secret-key\",\n)\n\nclass UploadCredentialsResponse(BaseModel):\n    access_key_id: str\n    secret_access_key: str\n    session_token: str\n    expiration: str\n    bucket: str\n    region: str\n    endpoint: str\n\n@router.get(\"/upload-credentials\")\nasync def get_upload_credentials(user_id: str) -&gt; BaseResponse[UploadCredentialsResponse]:\n    \"\"\"\u83b7\u53d6\u524d\u7aef\u76f4\u4f20\u51ed\u8bc1\"\"\"\n    try:\n        credentials = await sts_provider.get_credentials(\n            STSRequest(\n                bucket=\"my-bucket-1250000000\",\n                region=\"ap-guangzhou\",\n                allow_path=f\"user/{user_id}/\",\n                action_type=ActionType.WRITE,\n                duration_seconds=1800,\n            )\n        )\n        return BaseResponse(\n            code=200,\n            message=\"\u83b7\u53d6\u6210\u529f\",\n            data=UploadCredentialsResponse(\n                access_key_id=credentials.access_key_id,\n                secret_access_key=credentials.secret_access_key,\n                session_token=credentials.session_token,\n                expiration=credentials.expiration.isoformat(),\n                bucket=credentials.bucket,\n                region=credentials.region,\n                endpoint=credentials.endpoint,\n            ),\n        )\n    except STSRequestError as e:\n        raise HTTPException(status_code=500, detail=f\"STS error: {e.message}\")</code></pre>"},{"location":"19-storage-guide/#_5","title":"\u6587\u4ef6\u4e0b\u8f7d","text":"<pre><code>from fastapi.responses import StreamingResponse\n\n@router.get(\"/files/{file_id}/download\")\nasync def download_file(file_id: str):\n    \"\"\"\u4e0b\u8f7d\u6587\u4ef6\"\"\"\n\n    # \u83b7\u53d6\u6587\u4ef6\u4fe1\u606f\n    file_info = await db.get_file(file_id)\n    if not file_info:\n        raise NotFoundError(\"\u6587\u4ef6\u4e0d\u5b58\u5728\")\n\n    # \u4ece\u5b58\u50a8\u4e0b\u8f7d\n    content = await storage.download_file(file_info.object_name)\n\n    return StreamingResponse(\n        iter([content]),\n        media_type=\"application/octet-stream\",\n        headers={\"Content-Disposition\": f\"attachment; filename={file_info.filename}\"}\n    )</code></pre>"},{"location":"19-storage-guide/#sdk","title":"\u76f4\u63a5\u4f7f\u7528 SDK","text":"<p>\u5982\u679c\u4e0d\u9700\u8981 <code>StorageManager</code>\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 SDK\uff1a</p> <pre><code>from aury.sdk.storage.storage import (\n    S3Storage, StorageConfig, StorageBackend, StorageFile,\n)\n\nconfig = StorageConfig(\n    backend=StorageBackend.COS,\n    bucket_name=\"my-bucket-1250000000\",\n    region=\"ap-guangzhou\",\n    endpoint=\"https://cos.ap-guangzhou.myqcloud.com\",\n    access_key_id=\"your-access-key\",\n    access_key_secret=\"your-secret-key\",\n)\n\nstorage = S3Storage(config)\n\n# \u4e0a\u4f20\nresult = await storage.upload_file(\n    StorageFile(\n        object_name=\"user/123/test.txt\",\n        data=b\"Hello, World!\",\n        content_type=\"text/plain\",\n    )\n)\nprint(f\"Uploaded: {result.url}\")</code></pre>"},{"location":"19-storage-guide/#_6","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e","text":"<pre><code># .env\n\n# \u662f\u5426\u542f\u7528\u5b58\u50a8\u7ec4\u4ef6\nSTORAGE_ENABLED=true\n\n# \u5b58\u50a8\u7c7b\u578b: local / s3 / cos / oss\nSTORAGE_TYPE=cos\n\n# === \u672c\u5730\u5b58\u50a8\uff08\u5f00\u53d1\u73af\u5883\uff09===\n# STORAGE_TYPE=local\n# STORAGE_BASE_PATH=./storage\n\n# === S3/COS/OSS \u901a\u7528\u914d\u7f6e ===\nSTORAGE_ACCESS_KEY_ID=AKIDxxxxx\nSTORAGE_ACCESS_KEY_SECRET=xxxxx\nSTORAGE_ENDPOINT=https://cos.ap-guangzhou.myqcloud.com\nSTORAGE_REGION=ap-guangzhou\nSTORAGE_BUCKET_NAME=my-bucket-1250000000\n\n# \u53ef\u9009\uff1a\u4e34\u65f6\u51ed\u8bc1 Session Token\n# STORAGE_SESSION_TOKEN=\n\n# \u53ef\u9009\uff1aSTS AssumeRole\uff08\u670d\u52a1\u7aef\u81ea\u52a8\u5237\u65b0\u51ed\u8bc1\uff09\n# STORAGE_ROLE_ARN=qcs::cam::uin/100000000001:roleName/my-role\n# STORAGE_ROLE_SESSION_NAME=aurimyth-storage\n# STORAGE_STS_DURATION_SECONDS=3600</code></pre>"},{"location":"19-storage-guide/#_7","title":"\u652f\u6301\u7684\u5b58\u50a8\u540e\u7aef","text":"\u540e\u7aef StorageBackend \u8bf4\u660e \u672c\u5730\u5b58\u50a8 <code>LOCAL</code> \u5f00\u53d1\u6d4b\u8bd5\u7528\uff0c\u6587\u4ef6\u4fdd\u5b58\u5230\u672c\u5730\u76ee\u5f55 AWS S3 <code>S3</code> Amazon S3 \u817e\u8baf\u4e91 COS <code>COS</code> S3 \u517c\u5bb9\u534f\u8bae \u963f\u91cc\u4e91 OSS <code>OSS</code> S3 \u517c\u5bb9\u534f\u8bae MinIO <code>MINIO</code> \u79c1\u6709\u5316\u90e8\u7f72\uff0cS3 \u517c\u5bb9"},{"location":"19-storage-guide/#_8","title":"\u9519\u8bef\u5904\u7406","text":"<pre><code>from aury.sdk.storage import (\n    StorageSDKError,\n    STSError,\n    STSRequestError,\n    StorageError,\n    StorageBackendError,\n)\n\ntry:\n    credentials = await provider.get_credentials(request)\nexcept STSRequestError as e:\n    # API \u8c03\u7528\u5931\u8d25\uff08\u51ed\u8bc1\u9519\u8bef\u3001\u6743\u9650\u4e0d\u8db3\u7b49\uff09\n    print(f\"API \u9519\u8bef: [{e.code}] {e.message}\")\n    print(f\"RequestId: {e.request_id}\")  # \u7528\u4e8e\u5411\u4e91\u5382\u5546\u63d0\u5de5\u5355\nexcept STSError as e:\n    # \u5176\u4ed6 STS \u9519\u8bef\uff08\u7f51\u7edc\u9519\u8bef\u7b49\uff09\n    print(f\"STS \u9519\u8bef: {e}\")\n\ntry:\n    await storage.upload_file(file)\nexcept StorageBackendError as e:\n    print(f\"\u5b58\u50a8\u540e\u7aef\u9519\u8bef: {e}\")\nexcept StorageError as e:\n    print(f\"\u5b58\u50a8\u9519\u8bef: {e}\")</code></pre> <p>\u603b\u7ed3\uff1a - \u4f7f\u7528 <code>StorageManager.get_instance()</code> \u83b7\u53d6\u5b58\u50a8\u7ba1\u7406\u5668\uff08\u652f\u6301\u547d\u540d\u591a\u5b9e\u4f8b\uff09 - \u672c\u5730\u5f00\u53d1\u4f7f\u7528 <code>StorageBackend.LOCAL</code>\uff0c\u751f\u4ea7\u4f7f\u7528 S3 \u517c\u5bb9\u5b58\u50a8 - \u524d\u7aef\u76f4\u4f20\u573a\u666f\u4f7f\u7528 STS \u4e34\u65f6\u51ed\u8bc1\uff0c\u5b9e\u73b0\u6743\u9650\u9694\u79bb\u548c\u6700\u5c0f\u6743\u9650\u539f\u5219</p>"},{"location":"20-i18n-guide/","title":"19. \u56fd\u9645\u5316\u5b8c\u6574\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 19 \u7ae0\u7684\u57fa\u7840\u7528\u6cd5\u3002</p>"},{"location":"20-i18n-guide/#_1","title":"\u7ffb\u8bd1\u52a0\u8f7d","text":""},{"location":"20-i18n-guide/#_2","title":"\u57fa\u7840\u7ffb\u8bd1","text":"<pre><code>from aury.boot.common.i18n.translator import translate, load_translations\n\n# \u52a0\u8f7d\u7ffb\u8bd1\nload_translations({\n    \"zh_CN\": {\n        \"hello\": \"\u4f60\u597d\",\n        \"goodbye\": \"\u518d\u89c1\",\n        \"error.not_found\": \"\u8d44\u6e90 {name} \u672a\u627e\u5230\",\n    },\n    \"en_US\": {\n        \"hello\": \"Hello\",\n        \"goodbye\": \"Goodbye\",\n        \"error.not_found\": \"Resource {name} not found\",\n    },\n    \"ja_JP\": {\n        \"hello\": \"\u3053\u3093\u306b\u3061\u306f\",\n        \"goodbye\": \"\u3055\u3088\u3046\u306a\u3089\",\n        \"error.not_found\": \"\u30ea\u30bd\u30fc\u30b9 {name} \u304c\u898b\u3064\u304b\u308a\u307e\u305b\u3093\",\n    }\n})</code></pre>"},{"location":"20-i18n-guide/#_3","title":"\u4ece\u6587\u4ef6\u52a0\u8f7d","text":"<pre><code>import json\nimport yaml\n\n# \u4ece JSON \u6587\u4ef6\ndef load_translations_from_json():\n    with open(\"translations/zh_CN.json\", \"r\", encoding=\"utf-8\") as f:\n        zh_translations = json.load(f)\n\n    with open(\"translations/en_US.json\", \"r\", encoding=\"utf-8\") as f:\n        en_translations = json.load(f)\n\n    load_translations({\n        \"zh_CN\": zh_translations,\n        \"en_US\": en_translations,\n    })\n\n# \u4ece YAML \u6587\u4ef6\ndef load_translations_from_yaml():\n    with open(\"translations/zh_CN.yaml\", \"r\", encoding=\"utf-8\") as f:\n        zh_translations = yaml.safe_load(f)\n\n    load_translations({\"zh_CN\": zh_translations})</code></pre>"},{"location":"20-i18n-guide/#_4","title":"\u7ffb\u8bd1\u4f7f\u7528","text":""},{"location":"20-i18n-guide/#_5","title":"\u7b80\u5355\u7ffb\u8bd1","text":"<pre><code># \u4e2d\u6587\nmsg = translate(\"hello\", locale=\"zh_CN\")\n# \u8f93\u51fa: \"\u4f60\u597d\"\n\n# \u82f1\u6587\nmsg = translate(\"hello\", locale=\"en_US\")\n# \u8f93\u51fa: \"Hello\"</code></pre>"},{"location":"20-i18n-guide/#_6","title":"\u5e26\u53c2\u6570\u7684\u7ffb\u8bd1","text":"<pre><code># \u4e2d\u6587 - \u8d44\u6e90 User \u672a\u627e\u5230\nmsg = translate(\"error.not_found\", locale=\"zh_CN\", name=\"User\")\n# \u8f93\u51fa: \"\u8d44\u6e90 User \u672a\u627e\u5230\"\n\n# \u82f1\u6587 - Resource User not found\nmsg = translate(\"error.not_found\", locale=\"en_US\", name=\"User\")\n# \u8f93\u51fa: \"Resource User not found\"</code></pre>"},{"location":"20-i18n-guide/#_7","title":"\u9ed8\u8ba4\u8bed\u8a00","text":"<pre><code># \u8bbe\u7f6e\u9ed8\u8ba4\u8bed\u8a00\u4e3a\u4e2d\u6587\nmsg = translate(\"hello\")  # \u4f7f\u7528\u9ed8\u8ba4\u8bed\u8a00</code></pre>"},{"location":"20-i18n-guide/#api","title":"API \u96c6\u6210","text":""},{"location":"20-i18n-guide/#_8","title":"\u6839\u636e\u8bf7\u6c42\u8bed\u8a00\u8fd4\u56de","text":"<pre><code>from fastapi import APIRouter, Header\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\nrouter = APIRouter()\n\n@router.get(\"/data\")\nasync def get_data(accept_language: str = Header(default=\"zh-CN\")):\n    \"\"\"\u6839\u636e\u8bf7\u6c42\u7684\u8bed\u8a00\u8fd4\u56de\u6570\u636e\"\"\"\n\n    # \u8f6c\u6362\u8bed\u8a00\u4ee3\u7801 (en-US -&gt; en_US)\n    locale = accept_language.replace(\"-\", \"_\")\n\n    message = translate(\"hello\", locale=locale)\n\n    return BaseResponse(\n        code=200,\n        message=message,\n        data={\"greeting\": message}\n    )\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str, accept_language: str = Header(default=\"zh-CN\")):\n    \"\"\"\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff0c\u8fd4\u56de\u672c\u5730\u5316\u9519\u8bef\"\"\"\n\n    locale = accept_language.replace(\"-\", \"_\")\n\n    user = await db.get_user(user_id)\n    if not user:\n        error_msg = translate(\"error.not_found\", locale=locale, name=\"User\")\n        return BaseResponse(code=404, message=error_msg)\n\n    return BaseResponse(code=200, message=\"Success\", data=user)</code></pre>"},{"location":"20-i18n-guide/#_9","title":"\u9519\u8bef\u6d88\u606f\u56fd\u9645\u5316","text":"<pre><code>from aury.boot.application.errors import NotFoundError\n\ndef get_locale_from_request(request):\n    \"\"\"\u4ece\u8bf7\u6c42\u4e2d\u63d0\u53d6\u8bed\u8a00\"\"\"\n    language = request.headers.get(\"accept-language\", \"zh-CN\")\n    return language.replace(\"-\", \"_\")\n\n@router.get(\"/items/{item_id}\")\nasync def get_item(item_id: str, request):\n    locale = get_locale_from_request(request)\n\n    item = await db.get_item(item_id)\n    if not item:\n        # \u4f7f\u7528\u672c\u5730\u5316\u9519\u8bef\u6d88\u606f\n        error_msg = translate(\"error.not_found\", locale=locale, name=\"Item\")\n        raise NotFoundError(error_msg)\n\n    return BaseResponse(code=200, message=\"Success\", data=item)</code></pre>"},{"location":"20-i18n-guide/#_10","title":"\u5e38\u89c1\u573a\u666f","text":""},{"location":"20-i18n-guide/#_11","title":"\u8868\u5355\u9a8c\u8bc1\u6d88\u606f","text":"<pre><code>from pydantic import BaseModel, field_validator\n\nclass UserRegisterRequest(BaseModel):\n    username: str\n    email: str\n    password: str\n\n    @field_validator(\"username\")\n    def validate_username(cls, v):\n        if len(v) &lt; 3:\n            # \u8fd4\u56de\u672c\u5730\u5316\u9519\u8bef\u4fe1\u606f\n            raise ValueError(\"username_too_short\")\n        return v\n\n@router.post(\"/auth/register\")\nasync def register(request: UserRegisterRequest, accept_language: str = Header()):\n    locale = accept_language.replace(\"-\", \"_\")\n\n    try:\n        # \u9a8c\u8bc1\u7528\u6237\n        user = await user_service.register(request)\n        success_msg = translate(\"auth.register_success\", locale=locale)\n        return BaseResponse(code=200, message=success_msg, data={\"user_id\": user.id})\n\n    except ValueError as e:\n        error_msg = translate(f\"error.{str(e)}\", locale=locale)\n        return BaseResponse(code=400, message=error_msg)</code></pre>"},{"location":"20-i18n-guide/#_12","title":"\u90ae\u4ef6\u6a21\u677f\u56fd\u9645\u5316","text":"<pre><code>class EmailService:\n    def get_template(self, template_name: str, locale: str):\n        \"\"\"\u83b7\u53d6\u672c\u5730\u5316\u7684\u90ae\u4ef6\u6a21\u677f\"\"\"\n\n        templates = {\n            \"zh_CN\": {\n                \"welcome\": \"\u6b22\u8fce {name}\uff01\",\n                \"reset_password\": \"\u70b9\u51fb\u94fe\u63a5\u91cd\u7f6e\u5bc6\u7801: {link}\",\n            },\n            \"en_US\": {\n                \"welcome\": \"Welcome {name}!\",\n                \"reset_password\": \"Click the link to reset password: {link}\",\n            }\n        }\n\n        return templates.get(locale, templates[\"en_US\"]).get(template_name, \"\")\n\n    async def send_welcome_email(self, user: User, locale: str):\n        \"\"\"\u53d1\u9001\u6b22\u8fce\u90ae\u4ef6\"\"\"\n\n        subject = translate(\"email.welcome_subject\", locale=locale)\n        template = self.get_template(\"welcome\", locale)\n        content = template.format(name=user.name)\n\n        await self.send(\n            to=user.email,\n            subject=subject,\n            content=content\n        )</code></pre>"},{"location":"20-i18n-guide/#_13","title":"\u65e5\u671f\u548c\u65f6\u95f4\u672c\u5730\u5316","text":"<pre><code>from datetime import datetime\n\ndef format_datetime(dt: datetime, locale: str):\n    \"\"\"\u672c\u5730\u5316\u65e5\u671f\u65f6\u95f4\u683c\u5f0f\"\"\"\n\n    formats = {\n        \"zh_CN\": \"%Y\u5e74%m\u6708%d\u65e5 %H:%M:%S\",\n        \"en_US\": \"%m/%d/%Y %I:%M:%S %p\",\n        \"ja_JP\": \"%Y\u5e74%m\u6708%d\u65e5 %H:%M:%S\",\n    }\n\n    fmt = formats.get(locale, formats[\"en_US\"])\n    return dt.strftime(fmt)\n\n# \u4f7f\u7528\ndt = datetime.now()\nprint(format_datetime(dt, \"zh_CN\"))  # 2024\u5e7401\u670815\u65e5 14:30:45\nprint(format_datetime(dt, \"en_US\"))  # 01/15/2024 02:30:45 PM</code></pre>"},{"location":"20-i18n-guide/#_14","title":"\u6570\u5b57\u548c\u8d27\u5e01\u672c\u5730\u5316","text":"<pre><code>from decimal import Decimal\n\ndef format_currency(amount: Decimal, locale: str, currency: str = \"USD\"):\n    \"\"\"\u672c\u5730\u5316\u8d27\u5e01\u683c\u5f0f\"\"\"\n\n    if locale == \"zh_CN\":\n        if currency == \"CNY\":\n            return f\"\u00a5{amount:.2f}\"\n        return f\"${amount:.2f}\"\n    elif locale == \"en_US\":\n        return f\"{currency} {amount:.2f}\"\n    elif locale == \"ja_JP\":\n        if currency == \"JPY\":\n            return f\"\u00a5{int(amount)}\"\n        return f\"{currency} {amount:.2f}\"\n\n    return f\"{currency} {amount:.2f}\"\n\n# \u4f7f\u7528\nprice = Decimal(\"100.50\")\nprint(format_currency(price, \"zh_CN\", \"CNY\"))  # \u00a5100.50\nprint(format_currency(price, \"en_US\", \"USD\"))  # USD 100.50\nprint(format_currency(price, \"ja_JP\", \"JPY\"))  # \u00a5101</code></pre>"},{"location":"20-i18n-guide/#_15","title":"\u6587\u4ef6\u7ec4\u7ec7","text":""},{"location":"20-i18n-guide/#_16","title":"\u63a8\u8350\u7684\u76ee\u5f55\u7ed3\u6784","text":"<pre><code>app/\n\u251c\u2500\u2500 i18n/\n\u2502   \u251c\u2500\u2500 translations/\n\u2502   \u2502   \u251c\u2500\u2500 zh_CN.json\n\u2502   \u2502   \u251c\u2500\u2500 en_US.json\n\u2502   \u2502   \u2514\u2500\u2500 ja_JP.json\n\u2502   \u2514\u2500\u2500 loader.py\n\u2514\u2500\u2500 main.py\n</code></pre>"},{"location":"20-i18n-guide/#translationszh_cnjson","title":"translations/zh_CN.json","text":"<pre><code>{\n  \"hello\": \"\u4f60\u597d\",\n  \"goodbye\": \"\u518d\u89c1\",\n  \"auth\": {\n    \"login_success\": \"\u767b\u5f55\u6210\u529f\",\n    \"logout_success\": \"\u9000\u51fa\u6210\u529f\"\n  },\n  \"error\": {\n    \"not_found\": \"\u8d44\u6e90 {name} \u672a\u627e\u5230\",\n    \"unauthorized\": \"\u672a\u6388\u6743\",\n    \"forbidden\": \"\u7981\u6b62\u8bbf\u95ee\"\n  },\n  \"email\": {\n    \"welcome_subject\": \"\u6b22\u8fce\u52a0\u5165\",\n    \"reset_password_subject\": \"\u91cd\u7f6e\u5bc6\u7801\"\n  }\n}\n</code></pre>"},{"location":"20-i18n-guide/#_17","title":"\u6027\u80fd\u4f18\u5316","text":""},{"location":"20-i18n-guide/#_18","title":"\u7f13\u5b58\u7ffb\u8bd1","text":"<pre><code>from functools import lru_cache\n\n@lru_cache(maxsize=1024)\ndef get_translation(key: str, locale: str):\n    \"\"\"\u7f13\u5b58\u7ffb\u8bd1\u7ed3\u679c\"\"\"\n    return translate(key, locale=locale)</code></pre>"},{"location":"20-i18n-guide/#_19","title":"\u9884\u52a0\u8f7d\u7ffb\u8bd1","text":"<pre><code># \u5728\u5e94\u7528\u542f\u52a8\u65f6\u52a0\u8f7d\u6240\u6709\u7ffb\u8bd1\n@app.on_event(\"startup\")\nasync def load_i18n():\n    \"\"\"\u9884\u52a0\u8f7d\u56fd\u9645\u5316\u8d44\u6e90\"\"\"\n\n    translations = {}\n\n    for locale in [\"zh_CN\", \"en_US\", \"ja_JP\"]:\n        with open(f\"translations/{locale}.json\", \"r\", encoding=\"utf-8\") as f:\n            translations[locale] = json.load(f)\n\n    load_translations(translations)\n    logger.info(\"\u56fd\u9645\u5316\u8d44\u6e90\u5df2\u52a0\u8f7d\")</code></pre> <p>\u603b\u7ed3\uff1a\u56fd\u9645\u5316\u652f\u6301\u591a\u8bed\u8a00\u7528\u6237\uff0c\u901a\u8fc7\u7ffb\u8bd1\u548c\u683c\u5f0f\u5316\u5b9e\u73b0\u66f4\u597d\u7684\u7528\u6237\u4f53\u9a8c\u3002\u8bbe\u8ba1\u597d\u7684\u56fd\u9645\u5316\u65b9\u6848\u53ef\u4ee5\u8ba9\u5e94\u7528\u8f7b\u677e\u652f\u6301\u5168\u7403\u7528\u6237\u3002</p>"},{"location":"21-migration-guide/","title":"20. \u6570\u636e\u5e93\u8fc1\u79fb\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 20 \u7ae0\u7684\u5feb\u901f\u5f00\u59cb\u3002</p>"},{"location":"21-migration-guide/#kit","title":"Kit \u63d0\u4f9b\u7684\u8fc1\u79fb\u547d\u4ee4","text":"<p>Aury Boot \u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u8fc1\u79fb\u7ba1\u7406\u547d\u4ee4\uff0c\u7c7b\u4f3c Django \u7684 <code>migrate</code> \u547d\u4ee4\uff1a</p> <pre><code># \u751f\u6210\u8fc1\u79fb\u6587\u4ef6\naury migrate make -m \"Add users table\"\n\n# \u6267\u884c\u8fc1\u79fb\naury migrate up\n\n# \u56de\u6eda\u8fc1\u79fb\naury migrate down -1\n\n# \u67e5\u770b\u8fc1\u79fb\u72b6\u6001\naury migrate status\n\n# \u663e\u793a\u6240\u6709\u8fc1\u79fb\naury migrate show\n\n# \u68c0\u67e5\u8fc1\u79fb\u95ee\u9898\naury migrate check</code></pre>"},{"location":"21-migration-guide/#_1","title":"\u81ea\u52a8\u8fc1\u79fb\uff08\u63a8\u8350\uff09","text":"<p>Kit \u63d0\u4f9b\u4e86 <code>MigrationComponent</code>\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\uff1a</p> <pre><code>from aury.boot.application.app.base import FoundationApp\nfrom aury.boot.application.config import BaseConfig\nfrom aury.boot.application.app.components import MigrationComponent\n\nclass AppConfig(BaseConfig):\n    pass\n\napp = FoundationApp(\n    title=\"My Service\",\n    version=\"0.1.0\",\n    config=AppConfig()\n)\n\n# MigrationComponent \u4f1a\u5728\u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\nclass MyApp(FoundationApp):\n    items = [\n        # ... \u5176\u4ed6\u7ec4\u4ef6 ...\n        MigrationComponent,  # \u5e94\u7528\u542f\u52a8\u65f6\u81ea\u52a8\u6267\u884c\u8fc1\u79fb\n    ]</code></pre> <p>\u5e94\u7528\u542f\u52a8\u65f6\u8f93\u51fa\uff1a <pre><code>\ud83d\udd04 \u68c0\u67e5\u6570\u636e\u5e93\u8fc1\u79fb...\n\ud83d\udcca \u6570\u636e\u5e93\u8fc1\u79fb\u72b6\u6001\uff1a\n   \u5df2\u6267\u884c: 5 \u4e2a\u8fc1\u79fb\n   \u5f85\u6267\u884c: 2 \u4e2a\u8fc1\u79fb\n\u23f3 \u6267\u884c\u6570\u636e\u5e93\u8fc1\u79fb...\n\u2705 \u6570\u636e\u5e93\u8fc1\u79fb\u5b8c\u6210\n</code></pre></p>"},{"location":"21-migration-guide/#_2","title":"\u7981\u7528\u81ea\u52a8\u8fc1\u79fb","text":"<p>\u5982\u679c\u9700\u8981\u624b\u52a8\u63a7\u5236\u8fc1\u79fb\uff0c\u53ef\u4ee5\u7981\u7528\u81ea\u52a8\u8fc1\u79fb\uff1a</p> <pre><code>class MyApp(FoundationApp):\n    items = [\n        # \u4e0d\u5305\u542b MigrationComponent\n        DatabaseComponent,\n        CacheComponent,\n        # ...\n    ]\n\n# \u7136\u540e\u624b\u52a8\u6267\u884c\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_3","title":"\u521d\u59cb\u5316\u9879\u76ee","text":""},{"location":"21-migration-guide/#1-alembic","title":"\u6b65\u9aa4 1\uff1a\u521d\u59cb\u5316 Alembic","text":"<pre><code># \u521d\u59cb\u5316 Alembic\uff08\u5f02\u6b65\u652f\u6301\uff09\nalembic init -t async alembic</code></pre> <p>\u8fd9\u4f1a\u521b\u5efa <code>alembic/</code> \u76ee\u5f55\u7ed3\u6784\uff1a <pre><code>alembic/\n\u251c\u2500\u2500 versions/           # \u8fc1\u79fb\u6587\u4ef6\u76ee\u5f55\n\u251c\u2500\u2500 env.py             # \u73af\u5883\u914d\u7f6e\n\u251c\u2500\u2500 script.py.mako     # \u8fc1\u79fb\u6a21\u677f\n\u2514\u2500\u2500 alembic.ini        # Alembic \u914d\u7f6e\n</code></pre></p>"},{"location":"21-migration-guide/#2-alembic","title":"\u6b65\u9aa4 2\uff1a\u914d\u7f6e Alembic","text":"<p>\u7f16\u8f91 <code>alembic/env.py</code>\uff0c\u914d\u7f6e\u6570\u636e\u5e93\u8fde\u63a5\u548c SQLAlchemy \u5143\u6570\u636e\uff1a</p> <pre><code>from sqlalchemy.ext.asyncio import create_async_engine, AsyncEngine\nimport asyncio\nfrom app.config import Config\nfrom app.models import Base  # \u4f60\u7684 Base \u7c7b\n\nconfig = Config()\nsqlalchemy_url = config.database.url\n\ndef run_migrations_online():\n    \"\"\"\u5728\u4e0e\u6570\u636e\u5e93\u8fde\u63a5\u7684\u60c5\u51b5\u4e0b\u6267\u884c\u8fc1\u79fb\u3002\"\"\"\n\n    connectable = create_async_engine(sqlalchemy_url, echo=False)\n\n    async with connectable.begin() as connection:\n        await connection.run_sync(run_migrations)\n\n    await connectable.dispose()\n\ndef run_migrations_offline():\n    \"\"\"\u5728\u79bb\u7ebf\u6a21\u5f0f\u4e0b\u6267\u884c\u8fc1\u79fb\u3002\"\"\"\n    context.configure(\n        url=sqlalchemy_url,\n        version_table_schema=target_metadata.schema,\n        literal_binds=True,\n        dialect_opts={\"paramstyle\": \"named\"},\n    )\n\n    with context.begin_transaction():\n        context.run_migrations()\n\nif context.is_offline_mode():\n    run_migrations_offline()\nelse:\n    asyncio.run(run_migrations_online())</code></pre>"},{"location":"21-migration-guide/#_4","title":"\u5e38\u89c1\u5de5\u4f5c\u6d41","text":""},{"location":"21-migration-guide/#1","title":"1. \u81ea\u52a8\u751f\u6210\u8fc1\u79fb\uff08\u63a8\u8350\uff09","text":""},{"location":"21-migration-guide/#1_1","title":"\u6b65\u9aa4 1\uff1a\u4fee\u6539\u6a21\u578b","text":"<pre><code># models/user.py\nfrom sqlalchemy.orm import Mapped, mapped_column\nfrom sqlalchemy import String\nfrom aury.boot.domain.models.base import Base, GUID\n\nclass User(Base):\n    __tablename__ = \"users\"\n\n    id: Mapped[str] = mapped_column(GUID, primary_key=True)\n    username: Mapped[str] = mapped_column(String(50), unique=True)\n    email: Mapped[str] = mapped_column(String(100), unique=True)\n    # Base \u81ea\u52a8\u5305\u542b\uff1acreated_at, updated_at</code></pre>"},{"location":"21-migration-guide/#2","title":"\u6b65\u9aa4 2\uff1a\u68c0\u67e5\u53d8\u66f4\uff08\u5e72\u8fd0\u884c\uff09","text":"<pre><code># \u53ea\u68c0\u6d4b\u53d8\u66f4\uff0c\u4e0d\u751f\u6210\u6587\u4ef6\naury migrate make -m \"Add users table\" --dry-run</code></pre> <p>\u8f93\u51fa\uff1a <pre><code>\ud83d\udcdd \u68c0\u6d4b\u5230 3 \u4e2a\u53d8\u66f4:\n  - create_table: users\n  - create_unique_constraint: users.username\n  - create_unique_constraint: users.email\n</code></pre></p>"},{"location":"21-migration-guide/#3","title":"\u6b65\u9aa4 3\uff1a\u751f\u6210\u8fc1\u79fb\u6587\u4ef6","text":"<pre><code># \u81ea\u52a8\u751f\u6210\u8fc1\u79fb\u811a\u672c\naury migrate make -m \"Add users table\"\n\n# \u8f93\u51fa: \u2705 \u8fc1\u79fb\u6587\u4ef6\u5df2\u751f\u6210: alembic/versions/2024_01_01_120000_add_users_table.py</code></pre> <p>\u751f\u6210\u7684\u8fc1\u79fb\u6587\u4ef6\u81ea\u52a8\u5305\u542b\u6240\u6709\u5fc5\u8981\u7684 SQL \u64cd\u4f5c\u3002</p>"},{"location":"21-migration-guide/#4","title":"\u6b65\u9aa4 4\uff1a\u6267\u884c\u8fc1\u79fb","text":"<pre><code># \u6267\u884c\u5230\u6700\u65b0\u7248\u672c\naury migrate up\n\n# \u6216\u6307\u5b9a\u7248\u672c\naury migrate up -r \"2024_01_01_120000\"</code></pre>"},{"location":"21-migration-guide/#2_1","title":"2. \u67e5\u770b\u8fc1\u79fb\u72b6\u6001","text":"<pre><code># \u67e5\u770b\u5f53\u524d\u72b6\u6001\naury migrate status\n\n# \u8f93\u51fa:\n# \ud83d\udcca \u8fc1\u79fb\u72b6\u6001:\n#   \u5f53\u524d\u7248\u672c: 2024_01_01_120000\n#   \u6700\u65b0\u7248\u672c: 2024_01_02_140000\n#\n# \u23f3 \u5f85\u6267\u884c\u8fc1\u79fb (1):\n#   - 2024_01_02_140000</code></pre>"},{"location":"21-migration-guide/#3_1","title":"3. \u663e\u793a\u6240\u6709\u8fc1\u79fb","text":"<pre><code># \u663e\u793a\u8fc1\u79fb\u5217\u8868\naury migrate show\n\n# \u8f93\u51fa\u8868\u683c\u663e\u793a\u6240\u6709\u8fc1\u79fb</code></pre>"},{"location":"21-migration-guide/#4_1","title":"4. \u56de\u6eda\u8fc1\u79fb","text":"<pre><code># \u56de\u6eda\u4e00\u4e2a\u7248\u672c\naury migrate down -1\n\n# \u56de\u6eda\u5230\u524d\u4e00\u4e2a\u7248\u672c\naury migrate down previous\n\n# \u56de\u6eda\u5230\u6307\u5b9a\u7248\u672c\naury migrate down \"2024_01_01_100000\"\n\n# \u5e72\u8fd0\u884c\uff08\u53ea\u663e\u793a\u4f1a\u56de\u6eda\u7684\u8fc1\u79fb\uff0c\u4e0d\u5b9e\u9645\u6267\u884c\uff09\naury migrate down -1 --dry-run</code></pre>"},{"location":"21-migration-guide/#5","title":"5. \u68c0\u67e5\u8fc1\u79fb\u95ee\u9898","text":"<pre><code># \u68c0\u67e5\u8fc1\u79fb\u6587\u4ef6\u662f\u5426\u6709\u95ee\u9898\naury migrate check\n\n# \u8f93\u51fa:\n# \u2705 \u8fc1\u79fb\u68c0\u67e5\u901a\u8fc7\n#\n# \ud83d\udcca \u7edf\u8ba1:\n#   \u8fc1\u79fb\u603b\u6570: 5\n#   Head \u6570\u91cf: 1</code></pre>"},{"location":"21-migration-guide/#6","title":"6. \u67e5\u770b\u8fc1\u79fb\u5386\u53f2","text":"<pre><code># \u663e\u793a\u8fc1\u79fb\u5386\u53f2\naury migrate history\n\n# \u8be6\u7ec6\u6a21\u5f0f\naury migrate history --verbose</code></pre>"},{"location":"21-migration-guide/#_5","title":"\u5e38\u89c1\u573a\u666f","text":""},{"location":"21-migration-guide/#_6","title":"\u6dfb\u52a0\u65b0\u5217","text":"<pre><code># 1. \u4fee\u6539\u6a21\u578b\n# class User(Base):\n#     new_field: Mapped[str] = mapped_column(String(100), nullable=True)\n\n# 2. \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Add new_field to users\"\n\n# 3. \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_7","title":"\u5220\u9664\u5217","text":"<pre><code># 1. \u4ece\u6a21\u578b\u5220\u9664\u5b57\u6bb5\n# class User(Base):\n#     # \u5220\u9664 new_field\n\n# 2. \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Remove new_field from users\"\n\n# 3. \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_8","title":"\u6dfb\u52a0\u7d22\u5f15","text":"<pre><code># 1. \u4fee\u6539\u6a21\u578b\n# class User(Base):\n#     email: Mapped[str] = mapped_column(String(100), index=True)\n\n# 2. \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Add index on users.email\"\n\n# 3. \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_9","title":"\u6dfb\u52a0\u5173\u8054\u5b57\u6bb5","text":"<p>\u6700\u4f73\u5b9e\u8df5\uff1a\u4e0d\u5efa\u8bae\u4f7f\u7528\u6570\u636e\u5e93\u5916\u952e\uff0c\u901a\u8fc7\u7a0b\u5e8f\u63a7\u5236\u5173\u7cfb\u3002</p> <pre><code># 1. \u4fee\u6539\u6a21\u578b\uff08\u4e0d\u4f7f\u7528 ForeignKey\uff09\n# import uuid\n# class User(Base):\n#     profile_id: Mapped[uuid.UUID | None] = mapped_column(index=True)\n\n# 2. \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Add profile_id to users\"\n\n# 3. \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_10","title":"\u4fee\u6539\u5217\u7c7b\u578b","text":"<pre><code># 1. \u4fee\u6539\u6a21\u578b\n# class User(Base):\n#     username: Mapped[str] = mapped_column(String(100))  # \u4ece 50 \u6539\u4e3a 100\n\n# 2. \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"Increase username length\"\n\n# 3. \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"21-migration-guide/#_11","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e","text":"<p>\u5728 <code>.env</code> \u4e2d\u914d\u7f6e\u6570\u636e\u5e93 URL\uff1a</p> <pre><code># \u5f00\u53d1\u73af\u5883\nDATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/mydb_dev\n\n# \u6d4b\u8bd5\u73af\u5883\nDATABASE_URL=postgresql+asyncpg://user:pass@testdb:5432/mydb_test\n\n# \u751f\u4ea7\u73af\u5883\nDATABASE_URL=postgresql+asyncpg://user:pass@proddb:5432/mydb_prod</code></pre>"},{"location":"21-migration-guide/#_12","title":"\u624b\u52a8\u7f16\u5199\u8fc1\u79fb","text":"<p>\u5982\u679c\u9700\u8981\u624b\u52a8\u7f16\u5199\u8fc1\u79fb\uff08\u4e0d\u81ea\u52a8\u751f\u6210\uff09\uff1a</p> <pre><code># \u521b\u5efa\u7a7a\u8fc1\u79fb\u6587\u4ef6\naury migrate make -m \"Custom migration\" --no-autogenerate\n\n# \u7f16\u8f91\u751f\u6210\u7684\u6587\u4ef6\uff1aalembic/versions/xxx_custom_migration.py</code></pre> <p>\u7f16\u8f91\u8fc1\u79fb\u6587\u4ef6\uff1a</p> <pre><code>def upgrade():\n    # \u7f16\u5199\u5347\u7ea7\u903b\u8f91\n    op.execute(\"CREATE INDEX idx_users_email ON users(email)\")\n\ndef downgrade():\n    # \u7f16\u5199\u56de\u6eda\u903b\u8f91\n    op.execute(\"DROP INDEX idx_users_email\")</code></pre>"},{"location":"21-migration-guide/#_13","title":"\u7248\u672c\u63a7\u5236","text":""},{"location":"21-migration-guide/#_14","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li> <p>\u2705 \u63d0\u4ea4\u8fc1\u79fb\u6587\u4ef6\u5230 Git <pre><code>git add alembic/versions/\ngit commit -m \"Add migration: add users table\"</code></pre></p> </li> <li> <p>\u2705 \u547d\u540d\u8fc1\u79fb\u6587\u4ef6</p> </li> <li>\u4f7f\u7528\u6709\u610f\u4e49\u7684\u540d\u5b57\uff1a<code>add_users_table</code>\u3001<code>add_index_on_email</code></li> <li> <p>\u907f\u514d\u4f7f\u7528\uff1a<code>fix_bug</code>\u3001<code>temp_migration</code></p> </li> <li> <p>\u2705 \u56e2\u961f\u534f\u4f5c</p> </li> <li>\u6bcf\u4e2a\u7279\u6027\u5206\u652f\u4e00\u4e2a\u8fc1\u79fb</li> <li>\u4f7f\u7528 <code>aury migrate merge</code> \u5408\u5e76\u51b2\u7a81\u7684\u8fc1\u79fb</li> <li> <p>\u5b9a\u671f\u5408\u5e76\u8fc1\u79fb</p> </li> <li> <p>\u2705 \u751f\u4ea7\u90e8\u7f72 <pre><code># \u90e8\u7f72\u524d\u5148\u5728\u6d4b\u8bd5\u73af\u5883\u9a8c\u8bc1\naury migrate status         # \u67e5\u770b\u5f85\u6267\u884c\u8fc1\u79fb\naury migrate up --dry-run   # \u68c0\u67e5\u4f1a\u6267\u884c\u7684\u8fc1\u79fb\naury migrate up             # \u6267\u884c\u8fc1\u79fb</code></pre></p> </li> </ol>"},{"location":"21-migration-guide/#_15","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"21-migration-guide/#q-sql","title":"Q: \u5982\u4f55\u67e5\u770b\u5f85\u6267\u884c\u7684 SQL\uff1f","text":"<pre><code># \u68c0\u67e5\u72b6\u6001\naury migrate status\n\n# \u5e72\u8fd0\u884c\naury migrate up --dry-run</code></pre>"},{"location":"21-migration-guide/#q","title":"Q: \u8fc1\u79fb\u5931\u8d25\u4e86\u600e\u4e48\u529e\uff1f","text":"<pre><code># 1. \u67e5\u770b\u5f53\u524d\u72b6\u6001\naury migrate status\n\n# 2. \u67e5\u770b\u9519\u8bef\u65e5\u5fd7\n# 3. \u4fee\u590d\u95ee\u9898\u540e\u91cd\u8bd5\naury migrate up</code></pre>"},{"location":"21-migration-guide/#q_1","title":"Q: \u5982\u4f55\u89e3\u51b3\u8fc1\u79fb\u51b2\u7a81\uff1f","text":"<pre><code># \u5f53\u6709\u591a\u4e2a\u5206\u652f\u7684\u8fc1\u79fb\u65f6\uff0c\u4f7f\u7528 merge \u5408\u5e76\naury migrate merge \"abc123,def456\" -m \"merge branches\"</code></pre>"},{"location":"21-migration-guide/#q_2","title":"Q: \u5982\u4f55\u68c0\u67e5\u8fc1\u79fb\u7684\u6709\u6548\u6027\uff1f","text":"<pre><code># \u68c0\u67e5\u8fc1\u79fb\u6587\u4ef6\naury migrate check\n\n# \u663e\u793a\u6240\u6709\u8fc1\u79fb\naury migrate show\n\n# \u663e\u793a\u5386\u53f2\naury migrate history --verbose</code></pre> <p>\u603b\u7ed3\uff1a\u4f7f\u7528 <code>aury migrate make -m \"description\"</code> \u81ea\u52a8\u751f\u6210\u8fc1\u79fb\uff0cKit \u4f1a\u81ea\u52a8\u68c0\u6d4b\u6a21\u578b\u53d8\u66f4\u5e76\u751f\u6210\u5fc5\u8981\u7684 SQL\u3002\u65e0\u9700\u624b\u52a8\u7f16\u5199 SQL\uff0c\u5b89\u5168\u4e14\u9ad8\u6548\uff01</p>"},{"location":"22-logging-complete/","title":"21. \u65e5\u5fd7\u7cfb\u7edf\u5b8c\u6574\u6307\u5357","text":"<p>\u8bf7\u53c2\u8003 00-quick-start.md \u7b2c 21 \u7ae0\u7684\u5feb\u901f\u5f00\u59cb\u3002</p>"},{"location":"22-logging-complete/#_1","title":"\u65e5\u5fd7\u914d\u7f6e","text":""},{"location":"22-logging-complete/#_2","title":"\u73af\u5883\u53d8\u91cf","text":"<pre><code># \u57fa\u7840\u914d\u7f6e\nLOG_LEVEL=INFO                          # \u65e5\u5fd7\u7ea7\u522b (DEBUG, INFO, WARNING, ERROR, CRITICAL)\nLOG_DIR=log                             # \u65e5\u5fd7\u6587\u4ef6\u76ee\u5f55\n\n# \u6587\u4ef6\u8f6e\u8f6c\u914d\u7f6e\nLOG_ROTATION_TIME=00:00                 # \u6bcf\u5929\u5b9a\u65f6\u8f6e\u8f6c\u65f6\u95f4\nLOG_ROTATION_SIZE=100 MB                # \u57fa\u4e8e\u5927\u5c0f\u7684\u8f6e\u8f6c\u9608\u503c\nLOG_RETENTION_DAYS=7                    # \u65e5\u5fd7\u4fdd\u7559\u5929\u6570\n\n# \u8f93\u51fa\u914d\u7f6e\nLOG_ENABLE_FILE_ROTATION=true           # \u542f\u7528\u6587\u4ef6\u8f6e\u8f6c\nLOG_ENABLE_CLASSIFY=true                # \u6309\u6a21\u5757/\u7ea7\u522b\u5206\u7c7b\nLOG_ENABLE_CONSOLE=true                 # \u8f93\u51fa\u5230\u63a7\u5236\u53f0</code></pre>"},{"location":"22-logging-complete/#_3","title":"\u7a0b\u5e8f\u5316\u914d\u7f6e","text":"<pre><code>from aury.boot.common.logging import setup_logging\n\nsetup_logging(\n    log_level=\"INFO\",\n    log_dir=\"log\",\n    enable_file_rotation=True,\n    rotation_time=\"00:00\",\n    rotation_size=\"100 MB\",\n    retention_days=7,\n    enable_classify=True,\n    enable_console=True,\n)</code></pre>"},{"location":"22-logging-complete/#_4","title":"\u57fa\u7840\u65e5\u5fd7","text":""},{"location":"22-logging-complete/#_5","title":"\u65e5\u5fd7\u7ea7\u522b","text":"<pre><code>from aury.boot.common.logging import logger\n\n# DEBUG - \u8be6\u7ec6\u7684\u8bca\u65ad\u4fe1\u606f\nlogger.debug(\"\u8c03\u8bd5\u4fe1\u606f\")\n\n# INFO - \u4e00\u822c\u4fe1\u606f\nlogger.info(\"\u5e94\u7528\u5df2\u542f\u52a8\")\n\n# WARNING - \u8b66\u544a\u4fe1\u606f\nlogger.warning(\"\u7f13\u5b58\u8fde\u63a5\u7f13\u6162\")\n\n# ERROR - \u9519\u8bef\u4fe1\u606f\nlogger.error(\"\u6570\u636e\u5e93\u8fde\u63a5\u5931\u8d25\")\n\n# CRITICAL - \u4e25\u91cd\u9519\u8bef\nlogger.critical(\"\u7cfb\u7edf\u5373\u5c06\u5d29\u6e83\")</code></pre>"},{"location":"22-logging-complete/#_6","title":"\u5e26\u4e0a\u4e0b\u6587\u7684\u65e5\u5fd7","text":"<pre><code>logger.info(\"\u7528\u6237\u767b\u5f55\", extra={\"user_id\": \"123\", \"ip\": \"192.168.1.1\"})\n\nlogger.error(\"\u5904\u7406\u5931\u8d25\", extra={\n    \"request_id\": \"req_123\",\n    \"retry_count\": 3,\n    \"error_code\": \"DB_ERROR\"\n})</code></pre>"},{"location":"22-logging-complete/#_7","title":"\u5f02\u5e38\u65e5\u5fd7","text":"<pre><code>try:\n    risky_operation()\nexcept Exception as e:\n    # \u81ea\u52a8\u8bb0\u5f55\u5f02\u5e38\u5806\u6808\n    logger.error(f\"\u64cd\u4f5c\u5931\u8d25: {e}\", exc_info=True)</code></pre>"},{"location":"22-logging-complete/#_8","title":"\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a","text":""},{"location":"22-logging-complete/#trace-id","title":"\u81ea\u52a8 Trace ID","text":"<pre><code>from aury.boot.common.logging import get_trace_id, logger\n\n@router.get(\"/users/{user_id}\")\nasync def get_user(user_id: str):\n    # \u81ea\u52a8\u751f\u6210\u548c\u4f20\u9012 Trace ID\n    trace_id = get_trace_id()\n    logger.info(f\"\u83b7\u53d6\u7528\u6237 | Trace-ID: {trace_id}\")\n\n    user = await db.get_user(user_id)\n    logger.info(f\"\u7528\u6237\u5df2\u83b7\u53d6 | Trace-ID: {trace_id}\")\n\n    return user</code></pre>"},{"location":"22-logging-complete/#rpc","title":"RPC \u8c03\u7528\u4e2d\u7684\u8ffd\u8e2a","text":"<pre><code>from aury.boot.application.rpc.client import create_rpc_client\n\n@router.get(\"/orders/{order_id}\")\nasync def get_order(order_id: str):\n    trace_id = get_trace_id()\n    logger.info(f\"\u83b7\u53d6\u8ba2\u5355 | Trace-ID: {trace_id}\")\n\n    # RPC \u8c03\u7528\u4f1a\u81ea\u52a8\u6dfb\u52a0 X-Trace-ID \u8bf7\u6c42\u5934\n    client = create_rpc_client(\"order-service\")\n    response = await client.get(f\"/api/v1/orders/{order_id}\")\n\n    logger.info(f\"\u8ba2\u5355\u5df2\u83b7\u53d6 | Trace-ID: {trace_id}\")\n\n    return response.data</code></pre>"},{"location":"22-logging-complete/#_9","title":"\u5f02\u6b65\u4efb\u52a1\u4e2d\u7684\u8ffd\u8e2a","text":"<pre><code>from aury.boot.common.logging import set_trace_id, get_trace_id\n\n@tm.conditional_task()\nasync def process_order(order_id: str, trace_id: str = None):\n    \"\"\"\u5904\u7406\u8ba2\u5355\u4efb\u52a1\"\"\"\n\n    # \u8bbe\u7f6e Trace ID\uff08\u4fdd\u6301\u94fe\u8def\u8fde\u8d2f\uff09\n    if trace_id:\n        set_trace_id(trace_id)\n\n    trace_id = get_trace_id()\n    logger.info(f\"\u5f00\u59cb\u5904\u7406\u8ba2\u5355 | Order ID: {order_id} | Trace-ID: {trace_id}\")\n\n    try:\n        await process_payment(order_id)\n        await send_notification(order_id)\n        logger.info(f\"\u8ba2\u5355\u5904\u7406\u5b8c\u6210 | Trace-ID: {trace_id}\")\n    except Exception as e:\n        logger.error(f\"\u8ba2\u5355\u5904\u7406\u5931\u8d25 | Trace-ID: {trace_id}: {e}\", exc_info=True)\n\n# \u521b\u5efa\u4efb\u52a1\u65f6\u4f20\u9012 Trace ID\ntrace_id = get_trace_id()\nprocess_order.send(order_id=\"order123\", trace_id=trace_id)</code></pre>"},{"location":"22-logging-complete/#_10","title":"\u6027\u80fd\u76d1\u63a7","text":""},{"location":"22-logging-complete/#_11","title":"\u6267\u884c\u65f6\u95f4\u8bb0\u5f55","text":"<pre><code>import time\nfrom aury.boot.common.logging import logger\n\nasync def slow_operation():\n    start_time = time.time()\n\n    try:\n        # \u6267\u884c\u64cd\u4f5c\n        result = await db.heavy_query()\n        return result\n    finally:\n        duration = time.time() - start_time\n        if duration &gt; 1:  # \u8d85\u8fc7 1 \u79d2\u65f6\u8bb0\u5f55\u8b66\u544a\n            logger.warning(f\"\u64cd\u4f5c\u8017\u65f6\u8fc7\u957f: {duration:.3f}s\")\n        else:\n            logger.debug(f\"\u64cd\u4f5c\u8017\u65f6: {duration:.3f}s\")</code></pre>"},{"location":"22-logging-complete/#_12","title":"\u88c5\u9970\u5668\u65b9\u5f0f","text":"<pre><code>from functools import wraps\n\ndef log_performance(threshold: float = 1.0):\n    \"\"\"\u8bb0\u5f55\u8d85\u8fc7\u9608\u503c\u7684\u51fd\u6570\u6267\u884c\u65f6\u95f4\"\"\"\n    def decorator(func):\n        @wraps(func)\n        async def wrapper(*args, **kwargs):\n            start_time = time.time()\n            try:\n                return await func(*args, **kwargs)\n            finally:\n                duration = time.time() - start_time\n                if duration &gt; threshold:\n                    logger.warning(\n                        f\"\u51fd\u6570 {func.__name__} \u8017\u65f6: {duration:.3f}s\"\n                    )\n        return wrapper\n    return decorator\n\n@log_performance(threshold=2.0)\nasync def expensive_operation():\n    await asyncio.sleep(3)</code></pre>"},{"location":"22-logging-complete/#_13","title":"\u5f02\u5e38\u65e5\u5fd7","text":""},{"location":"22-logging-complete/#_14","title":"\u7ed3\u6784\u5316\u5f02\u5e38\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\ntry:\n    await external_api.call()\nexcept ConnectionError as e:\n    logger.error(\n        \"API \u8fde\u63a5\u5931\u8d25\",\n        exc_info=True,\n        extra={\n            \"error_type\": type(e).__name__,\n            \"retry_count\": 3,\n            \"service\": \"external_api\"\n        }\n    )\nexcept Exception as e:\n    logger.error(f\"\u672a\u77e5\u9519\u8bef: {e}\", exc_info=True)</code></pre>"},{"location":"22-logging-complete/#_15","title":"\u94fe\u63a5\u5f02\u5e38","text":"<pre><code>import logging\n\ntry:\n    try:\n        result = await operation1()\n    except OperationError as e:\n        logger.error(f\"\u64cd\u4f5c 1 \u5931\u8d25: {e}\")\n        raise\nexcept Exception as e:\n    logger.error(f\"\u6700\u7ec8\u5931\u8d25: {e}\", exc_info=True)</code></pre>"},{"location":"22-logging-complete/#_16","title":"\u65e5\u5fd7\u5206\u7c7b","text":""},{"location":"22-logging-complete/#_17","title":"\u6309\u6a21\u5757\u5206\u7c7b","text":"<p>\u5f53 <code>LOG_ENABLE_CLASSIFY=true</code> \u65f6\uff0c\u65e5\u5fd7\u4f1a\u81ea\u52a8\u6309\u6a21\u5757\u5206\u7c7b\uff1a</p> <pre><code>log/\n\u251c\u2500\u2500 app/\n\u2502   \u251c\u2500\u2500 api.log          # API \u8def\u7531\u65e5\u5fd7\n\u2502   \u251c\u2500\u2500 service.log      # \u4e1a\u52a1\u670d\u52a1\u65e5\u5fd7\n\u2502   \u2514\u2500\u2500 repository.log   # \u6570\u636e\u8bbf\u95ee\u65e5\u5fd7\n\u251c\u2500\u2500 framework/\n\u2502   \u251c\u2500\u2500 database.log     # \u6570\u636e\u5e93\u65e5\u5fd7\n\u2502   \u2514\u2500\u2500 cache.log        # \u7f13\u5b58\u65e5\u5fd7\n\u2514\u2500\u2500 system.log           # \u7cfb\u7edf\u65e5\u5fd7\n</code></pre>"},{"location":"22-logging-complete/#_18","title":"\u6309\u7ea7\u522b\u5206\u7c7b","text":"<pre><code>log/\n\u251c\u2500\u2500 debug/\n\u2502   \u251c\u2500\u2500 2024-01-15.log\n\u2502   \u2514\u2500\u2500 2024-01-16.log\n\u251c\u2500\u2500 info/\n\u251c\u2500\u2500 warning/\n\u251c\u2500\u2500 error/\n\u2514\u2500\u2500 critical/\n</code></pre>"},{"location":"22-logging-complete/#_19","title":"\u5b9e\u9645\u5e94\u7528","text":""},{"location":"22-logging-complete/#api","title":"API \u8bf7\u6c42\u65e5\u5fd7","text":"<pre><code>from fastapi import Request\nfrom aury.boot.common.logging import logger, get_trace_id\n\n@app.middleware(\"http\")\nasync def log_requests(request: Request, call_next):\n    trace_id = get_trace_id()\n\n    logger.info(\n        f\"\u8bf7\u6c42\u6765\u4e34\",\n        extra={\n            \"method\": request.method,\n            \"path\": request.url.path,\n            \"trace_id\": trace_id\n        }\n    )\n\n    start_time = time.time()\n    response = await call_next(request)\n    duration = time.time() - start_time\n\n    logger.info(\n        f\"\u8bf7\u6c42\u5b8c\u6210\",\n        extra={\n            \"method\": request.method,\n            \"path\": request.url.path,\n            \"status_code\": response.status_code,\n            \"duration\": f\"{duration:.3f}s\",\n            \"trace_id\": trace_id\n        }\n    )\n\n    return response</code></pre>"},{"location":"22-logging-complete/#_20","title":"\u4e1a\u52a1\u64cd\u4f5c\u65e5\u5fd7","text":"<pre><code>async def create_order(request: OrderCreateRequest):\n    trace_id = get_trace_id()\n\n    logger.info(f\"\u5f00\u59cb\u521b\u5efa\u8ba2\u5355 | Trace-ID: {trace_id}\")\n\n    try:\n        # \u9a8c\u8bc1\n        logger.debug(f\"\u9a8c\u8bc1\u8ba2\u5355\u6570\u636e | Trace-ID: {trace_id}\")\n        validate_order(request)\n\n        # \u521b\u5efa\n        logger.info(f\"\u5728\u6570\u636e\u5e93\u4e2d\u521b\u5efa\u8ba2\u5355 | Trace-ID: {trace_id}\")\n        order = await db.create_order(request)\n\n        # \u540e\u7eed\u5904\u7406\n        logger.info(f\"\u53d1\u9001\u8ba2\u5355\u786e\u8ba4 | Trace-ID: {trace_id}\")\n        await notification_service.send_confirmation(order)\n\n        logger.info(f\"\u8ba2\u5355\u521b\u5efa\u6210\u529f | Order ID: {order.id} | Trace-ID: {trace_id}\")\n        return order\n\n    except ValidationError as e:\n        logger.warning(f\"\u8ba2\u5355\u9a8c\u8bc1\u5931\u8d25: {e} | Trace-ID: {trace_id}\")\n        raise\n\n    except Exception as e:\n        logger.error(\n            f\"\u8ba2\u5355\u521b\u5efa\u5931\u8d25: {e}\",\n            exc_info=True,\n            extra={\"trace_id\": trace_id}\n        )\n        raise</code></pre>"},{"location":"22-logging-complete/#_21","title":"\u6570\u636e\u5e93\u64cd\u4f5c\u65e5\u5fd7","text":"<pre><code>class UserRepository(BaseRepository):\n    async def get_by_email(self, email: str):\n        logger.debug(f\"\u67e5\u8be2\u7528\u6237 by email: {email}\")\n\n        try:\n            user = await self.get_by(email=email)\n\n            if user:\n                logger.debug(f\"\u7528\u6237\u5df2\u627e\u5230: {user.id}\")\n            else:\n                logger.debug(f\"\u7528\u6237\u672a\u627e\u5230: {email}\")\n\n            return user\n        except Exception as e:\n            logger.error(f\"\u6570\u636e\u5e93\u67e5\u8be2\u5931\u8d25: {e}\", exc_info=True)\n            raise</code></pre>"},{"location":"22-logging-complete/#_22","title":"\u65e5\u5fd7\u67e5\u770b\u548c\u5206\u6790","text":""},{"location":"22-logging-complete/#_23","title":"\u67e5\u770b\u5b9e\u65f6\u65e5\u5fd7","text":"<pre><code># \u67e5\u770b\u65e5\u5fd7\u6587\u4ef6\ntail -f log/app/info.log\n\n# \u8fc7\u6ee4\u7279\u5b9a Trace ID \u7684\u65e5\u5fd7\ngrep \"trace_id: abc123\" log/app/info.log\n\n# \u67e5\u770b\u9519\u8bef\u65e5\u5fd7\ntail -f log/error/2024-01-15.log</code></pre>"},{"location":"22-logging-complete/#_24","title":"\u65e5\u5fd7\u805a\u5408","text":"<pre><code># \u4f7f\u7528 ELK Stack\n# 1. \u914d\u7f6e Filebeat \u6536\u96c6\u65e5\u5fd7\n# 2. \u63a8\u9001\u5230 Elasticsearch\n# 3. \u5728 Kibana \u4e2d\u53ef\u89c6\u5316\u548c\u5206\u6790</code></pre>"},{"location":"22-logging-complete/#_25","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"22-logging-complete/#1","title":"1. \u4f7f\u7528\u5408\u9002\u7684\u65e5\u5fd7\u7ea7\u522b","text":"<pre><code># \u274c \u4e0d\u597d - \u6240\u6709\u4fe1\u606f\u90fd\u7528 info\nlogger.info(\"\u6267\u884c SQL: SELECT * FROM users\")\n\n# \u2705 \u597d - \u8be6\u7ec6\u4fe1\u606f\u7528 debug\nlogger.debug(\"\u6267\u884c SQL: SELECT * FROM users\")\nlogger.info(\"\u7528\u6237\u5217\u8868\u5df2\u83b7\u53d6\")</code></pre>"},{"location":"22-logging-complete/#2","title":"2. \u4e0d\u8981\u8fc7\u5ea6\u8bb0\u5f55","text":"<pre><code># \u274c \u8fc7\u5ea6 - \u6bcf\u6b21\u90fd\u8bb0\u5f55\nfor user in users:\n    logger.info(f\"\u5904\u7406\u7528\u6237: {user.id}\")  # \u5728\u5faa\u73af\u4e2d\n\n# \u2705 \u597d - \u53ea\u8bb0\u5f55\u91cd\u8981\u4fe1\u606f\nlogger.info(f\"\u5904\u7406 {len(users)} \u4e2a\u7528\u6237\")</code></pre>"},{"location":"22-logging-complete/#3","title":"3. \u5305\u542b\u8db3\u591f\u7684\u4e0a\u4e0b\u6587","text":"<pre><code># \u274c \u4e0d\u597d - \u7f3a\u5c11\u4e0a\u4e0b\u6587\nlogger.error(\"\u64cd\u4f5c\u5931\u8d25\")\n\n# \u2705 \u597d - \u5305\u542b\u8db3\u591f\u4e0a\u4e0b\u6587\nlogger.error(\n    \"\u521b\u5efa\u7528\u6237\u5931\u8d25\",\n    extra={\n        \"email\": user.email,\n        \"error_code\": \"EMAIL_DUPLICATE\"\n    }\n)</code></pre>"},{"location":"22-logging-complete/#4","title":"4. \u4f7f\u7528\u7ed3\u6784\u5316\u65e5\u5fd7","text":"<pre><code># \u2705 \u63a8\u8350 - \u4fbf\u4e8e\u65e5\u5fd7\u5206\u6790\u5de5\u5177\u89e3\u6790\nlogger.info(\n    \"\u8ba2\u5355\u5df2\u521b\u5efa\",\n    extra={\n        \"order_id\": \"order_123\",\n        \"user_id\": \"user_456\",\n        \"amount\": 100,\n        \"trace_id\": \"abc123\"\n    }\n)</code></pre> <p>\u603b\u7ed3\uff1a\u5b8c\u5584\u7684\u65e5\u5fd7\u7cfb\u7edf\u5bf9\u4e8e\u95ee\u9898\u8bca\u65ad\u3001\u6027\u80fd\u76d1\u63a7\u548c\u7cfb\u7edf\u5ba1\u8ba1\u81f3\u5173\u91cd\u8981\u3002\u4f7f\u7528\u5206\u5e03\u5f0f\u94fe\u8def\u8ffd\u8e2a\u53ef\u4ee5\u8f7b\u677e\u8ddf\u8e2a\u8bf7\u6c42\u7684\u5b8c\u6574\u8def\u5f84\uff0c\u5927\u5927\u63d0\u9ad8\u6545\u969c\u6392\u67e5\u6548\u7387\u3002</p>"},{"location":"23-best-practices/","title":"20. \u6700\u4f73\u5b9e\u8df5\u5b8c\u5168\u6307\u5357","text":""},{"location":"23-best-practices/#1","title":"1. \u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"23-best-practices/#_1","title":"\u5206\u5c42\u539f\u5219","text":"<p>\u9075\u5faa\u6807\u51c6\u7684\u4e09\u5c42\u67b6\u6784\uff1a</p> <pre><code>API \u5c42 \u2500\u2500\u2500\u2500\u2192 Service \u5c42 \u2500\u2500\u2500\u2500\u2192 Repository \u5c42 \u2500\u2500\u2500\u2500\u2192 Database\n           \uff08\u4e1a\u52a1\u903b\u8f91\uff09     \uff08\u6570\u636e\u8bbf\u95ee\uff09\n</code></pre> <p>\u6bcf\u5c42\u7684\u804c\u8d23\uff1a</p> <ul> <li>API \u5c42\uff1a</li> <li>HTTP \u8bf7\u6c42\u5904\u7406\u548c\u53c2\u6570\u9a8c\u8bc1</li> <li>\u8c03\u7528 Service \u6267\u884c\u4e1a\u52a1\u903b\u8f91</li> <li>\u9519\u8bef\u5904\u7406\u548c\u54cd\u5e94\u683c\u5f0f\u5316</li> <li> <p>\u4e0d\u5305\u542b\u4e1a\u52a1\u903b\u8f91</p> </li> <li> <p>Service \u5c42\uff1a</p> </li> <li>\u4e1a\u52a1\u903b\u8f91\u5b9e\u73b0</li> <li>\u4e8b\u52a1\u7ba1\u7406</li> <li>\u8de8 Repository \u64cd\u4f5c\u534f\u8c03</li> <li> <p>\u4e0d\u5305\u542b HTTP \u76f8\u5173\u4ee3\u7801</p> </li> <li> <p>Repository \u5c42\uff1a</p> </li> <li>\u6570\u636e\u8bbf\u95ee\u5b9e\u73b0</li> <li>\u67e5\u8be2\u4f18\u5316</li> <li>\u4e0d\u5305\u542b\u4e1a\u52a1\u903b\u8f91</li> </ul>"},{"location":"23-best-practices/#_2","title":"\u4ee3\u7801\u793a\u4f8b","text":"<pre><code># \u274c \u53cd\u6a21\u5f0f\uff1a\u4e1a\u52a1\u903b\u8f91\u5728 API \u5c42\n@router.post(\"/orders\")\nasync def create_order(request: OrderRequest, session=Depends(...)):\n    order = await session.query(Order).filter(...).first()\n    if order.total &gt; 1000:\n        order.discount = 0.1\n    order.final_price = order.total * (1 - order.discount)\n    session.add(order)\n    await session.commit()\n\n# \u2705 \u6b63\u786e\u505a\u6cd5\nfrom aury.boot.application.interfaces.egress import BaseResponse\n\n@router.post(\"/orders\")\nasync def create_order(\n    request: OrderRequest,\n    service: OrderService = Depends(get_order_service)\n):\n    order = await service.create_with_discount(request)\n    return BaseResponse(code=200, message=\"\u8ba2\u5355\u521b\u5efa\u6210\u529f\", data=order)\n\nclass OrderService:\n    def __init__(self, repo: OrderRepository):\n        self.repo = repo\n\n    async def create_with_discount(self, request: OrderRequest):\n        order = await self.repo.create({\n            \"total\": request.total,\n            \"discount\": self.calculate_discount(request.total)\n        })\n        order.final_price = order.total * (1 - order.discount)\n        return order\n\n    def calculate_discount(self, total: float) -&gt; float:\n        if total &gt; 1000:\n            return 0.1\n        return 0</code></pre>"},{"location":"23-best-practices/#2","title":"2. \u6570\u636e\u5e93\u6027\u80fd","text":""},{"location":"23-best-practices/#n1","title":"\u907f\u514d N+1 \u67e5\u8be2","text":"<pre><code># \u274c N+1 \u67e5\u8be2\u95ee\u9898\nusers = await repo.list()  # 1 \u6b21\u67e5\u8be2\nfor user in users:\n    posts = await post_repo.list(author_id=user.id)  # N \u6b21\u67e5\u8be2\n\n# \u2705 \u4f7f\u7528 selectinload\nfrom sqlalchemy.orm import selectinload\nfrom sqlalchemy import select\n\nstmt = select(User).options(selectinload(User.posts))\nresult = await session.execute(stmt)\nusers = result.scalars().all()  # \u53ea\u9700 1-2 \u6b21\u67e5\u8be2</code></pre>"},{"location":"23-best-practices/#_3","title":"\u67e5\u8be2\u4f18\u5316\u6e05\u5355","text":"<ul> <li> \u4f7f\u7528 <code>selectinload()</code> \u6216 <code>joinedload()</code> \u5904\u7406\u5173\u7cfb</li> <li> \u6dfb\u52a0\u7d22\u5f15\u5230\u9891\u7e41\u67e5\u8be2\u7684\u5217</li> <li> \u4f7f\u7528 <code>limit</code> \u548c <code>offset</code> \u5206\u9875\uff0c\u907f\u514d\u4e00\u6b21\u52a0\u8f7d\u6240\u6709\u6570\u636e</li> <li> \u4f7f\u7528 <code>only()</code> \u4ec5\u67e5\u8be2\u9700\u8981\u7684\u5217</li> <li> \u907f\u514d\u5728\u5faa\u73af\u4e2d\u6267\u884c\u67e5\u8be2</li> <li> \u4f7f\u7528\u6570\u636e\u5e93\u89c6\u56fe\u5904\u7406\u590d\u6742\u67e5\u8be2</li> <li> \u542f\u7528 <code>DATABASE_ECHO=false</code>\uff08\u751f\u4ea7\u73af\u5883\uff09</li> </ul>"},{"location":"23-best-practices/#_4","title":"\u8fde\u63a5\u6c60\u914d\u7f6e","text":"<pre><code># \u5f00\u53d1\u73af\u5883\nDATABASE_POOL_SIZE=5\nDATABASE_MAX_OVERFLOW=10\n\n# \u751f\u4ea7\u73af\u5883\uff08\u6839\u636e\u5e76\u53d1\u91cf\u8c03\u6574\uff09\nDATABASE_POOL_SIZE=20\nDATABASE_MAX_OVERFLOW=30\nDATABASE_POOL_RECYCLE=3600  # \u4e00\u5c0f\u65f6\u56de\u6536\u8fde\u63a5</code></pre>"},{"location":"23-best-practices/#3","title":"3. \u4f9d\u8d56\u6ce8\u5165\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"23-best-practices/#vs","title":"\u4f9d\u8d56\u5355\u4f8b vs \u4f5c\u7528\u57df","text":"<pre><code># SINGLETON\uff1a\u6570\u636e\u5e93\u8fde\u63a5\u6c60\u3001\u7f13\u5b58\u3001\u914d\u7f6e\ncontainer.register_singleton(DatabaseManager)\ncontainer.register_singleton(CacheManager)\ncontainer.register_singleton(BaseConfig)\n\n# SCOPED\uff1a\u6570\u636e\u5e93\u4f1a\u8bdd\uff08\u6bcf\u4e2a\u8bf7\u6c42\u4e00\u4e2a\uff09\ncontainer.register_scoped(DatabaseSession)\n\n# TRANSIENT\uff1aService\uff08\u65e0\u72b6\u6001\uff09\ncontainer.register_transient(UserService)\ncontainer.register_transient(OrderService)</code></pre>"},{"location":"23-best-practices/#_5","title":"\u4f9d\u8d56\u63a5\u53e3\uff0c\u4e0d\u4f9d\u8d56\u5b9e\u73b0","text":"<pre><code># \u274c \u4e0d\u597d\nclass UserService:\n    def __init__(self, repo: MySQLUserRepository):\n        self.repo = repo\n\n# \u2705 \u597d\nclass UserService:\n    def __init__(self, repo: IUserRepository):  # \u4f9d\u8d56\u63a5\u53e3\n        self.repo = repo\n\n# \u751f\u4ea7\uff1a\u6ce8\u5165 MySQLUserRepository\n# \u6d4b\u8bd5\uff1a\u6ce8\u5165 MockUserRepository</code></pre>"},{"location":"23-best-practices/#4","title":"4. \u9519\u8bef\u5904\u7406","text":""},{"location":"23-best-practices/#_6","title":"\u4f7f\u7528\u7ed3\u6784\u5316\u5f02\u5e38","text":"<pre><code>from aury.boot.application.errors import (\n    NotFoundError,\n    AlreadyExistsError,\n    UnauthorizedError,\n    ForbiddenError,\n)\n\n# \u274c \u4f7f\u7528\u901a\u7528 Exception\nraise Exception(\"\u7528\u6237\u4e0d\u5b58\u5728\")\n\n# \u2705 \u4f7f\u7528\u5177\u4f53\u5f02\u5e38\nraise NotFoundError(\"\u7528\u6237\u4e0d\u5b58\u5728\")\n\n# \u6846\u67b6\u81ea\u52a8\u8f6c\u6362\u4e3a\uff1a\n# {\n#   \"code\": 404,\n#   \"message\": \"\u7528\u6237\u4e0d\u5b58\u5728\",\n#   \"error_code\": \"NOT_FOUND\",\n#   \"timestamp\": \"...\"\n# }</code></pre>"},{"location":"23-best-practices/#_7","title":"\u9519\u8bef\u4ee3\u7801\u7ba1\u7406","text":"<pre><code># \u5b9a\u4e49\u9519\u8bef\u4ee3\u7801\u5e38\u91cf\nERROR_USER_NOT_FOUND = \"USER_NOT_FOUND\"\nERROR_EMAIL_DUPLICATE = \"EMAIL_DUPLICATE\"\nERROR_PASSWORD_WEAK = \"PASSWORD_WEAK\"\n\n# \u5728\u5f02\u5e38\u4e2d\u4f7f\u7528\nraise NotFoundError(\n    message=\"\u7528\u6237\u4e0d\u5b58\u5728\",\n    error_code=ERROR_USER_NOT_FOUND\n)</code></pre>"},{"location":"23-best-practices/#5","title":"5. \u5e76\u53d1\u548c\u6027\u80fd","text":""},{"location":"23-best-practices/#_8","title":"\u4f7f\u7528\u5f02\u6b65\u64cd\u4f5c","text":"<pre><code># \u274c \u963b\u585e\u64cd\u4f5c\nresponse = requests.get(\"http://api.example.com\")  # \u963b\u585e\n\n# \u2705 \u5f02\u6b65\u64cd\u4f5c\nasync with aiohttp.ClientSession() as session:\n    async with session.get(\"http://api.example.com\") as resp:\n        data = await resp.json()</code></pre>"},{"location":"23-best-practices/#_9","title":"\u6279\u91cf\u64cd\u4f5c","text":"<pre><code># \u274c \u5faa\u73af\u521b\u5efa\uff08N \u4e2a\u6570\u636e\u5e93\u64cd\u4f5c\uff09\nfor item in items:\n    await repo.create(item)\n\n# \u2705 \u6279\u91cf\u521b\u5efa\uff081 \u4e2a\u6570\u636e\u5e93\u64cd\u4f5c\uff09\nawait repo.bulk_create(items, batch_size=1000)</code></pre>"},{"location":"23-best-practices/#_10","title":"\u7f13\u5b58\u7b56\u7565","text":"<pre><code># \u7f13\u5b58\u70ed\u6570\u636e\n@cache.cached(expire=3600, key_prefix=\"user_profile\")\nasync def get_user_profile(user_id: str):\n    return await db.get_user(user_id)\n\n# \u7f13\u5b58\u5217\u8868\n@cache.cached(expire=300, key_prefix=\"user_list\")\nasync def list_active_users():\n    return await db.list_users(is_active=True)\n\n# \u7f13\u5b58\u5931\u6548\nawait cache.delete(f\"user_profile:{user_id}\")</code></pre>"},{"location":"23-best-practices/#6","title":"6. \u65e5\u5fd7\u548c\u76d1\u63a7","text":""},{"location":"23-best-practices/#_11","title":"\u7ed3\u6784\u5316\u65e5\u5fd7","text":"<pre><code>from aury.boot.common.logging import logger\n\n# \u2705 \u597d\u7684\u65e5\u5fd7\nlogger.info(\"\u7528\u6237\u767b\u5f55\u6210\u529f\", extra={\n    \"user_id\": user.id,\n    \"ip\": request.client.host,\n    \"user_agent\": request.headers.get(\"user-agent\")\n})\n\n# \u274c \u4e0d\u597d\u7684\u65e5\u5fd7\nlogger.info(f\"User {user.id} logged in from {request.client.host}\")</code></pre>"},{"location":"23-best-practices/#_12","title":"\u5206\u5e03\u5f0f\u8ffd\u8e2a","text":"<pre><code>from aury.boot.common.logging import get_trace_id, logger\n\n@app.get(\"/users/{user_id}\")\nasync def get_user(user_id: str):\n    trace_id = get_trace_id()\n    logger.info(f\"\u83b7\u53d6\u7528\u6237 {user_id}\")\n\n    # \u6240\u6709\u65e5\u5fd7\u81ea\u52a8\u5305\u542b trace_id\n    # \u8de8\u670d\u52a1\u8c03\u7528\u65f6 trace_id \u81ea\u52a8\u4f20\u9012\n    user = await service.get_user(user_id)\n\n    logger.info(f\"\u83b7\u53d6\u6210\u529f\")\n    return user</code></pre>"},{"location":"23-best-practices/#_13","title":"\u6027\u80fd\u76d1\u63a7","text":"<pre><code>from aury.boot.common.logging import log_performance\n\n@log_performance(threshold=0.5)  # \u8d85\u8fc7 0.5 \u79d2\u8bb0\u5f55\u8b66\u544a\nasync def slow_operation():\n    await expensive_query()</code></pre>"},{"location":"23-best-practices/#7","title":"7. \u6d4b\u8bd5\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"23-best-practices/#_14","title":"\u5355\u5143\u6d4b\u8bd5","text":"<pre><code>import pytest\nfrom unittest.mock import AsyncMock\n\n@pytest.mark.asyncio\nasync def test_get_user():\n    # \u521b\u5efa Mock \u4ed3\u50a8\n    mock_repo = AsyncMock(spec=UserRepository)\n    mock_repo.get.return_value = {\"id\": \"1\", \"username\": \"test\"}\n\n    # \u6ce8\u5165 Mock\n    service = UserService(mock_repo)\n\n    # \u6d4b\u8bd5\n    result = await service.get_user(\"1\")\n\n    assert result[\"username\"] == \"test\"\n    mock_repo.get.assert_called_once_with(\"1\")</code></pre>"},{"location":"23-best-practices/#_15","title":"\u96c6\u6210\u6d4b\u8bd5","text":"<pre><code>@pytest.mark.asyncio\nasync def test_create_user_integration(db_session):\n    # \u4f7f\u7528\u771f\u5b9e\u6570\u636e\u5e93\u4f1a\u8bdd\n    repo = UserRepository(db_session)\n    service = UserService(repo)\n\n    # \u521b\u5efa\u7528\u6237\n    user = await service.create({\n        \"username\": \"testuser\",\n        \"email\": \"test@example.com\"\n    })\n\n    assert user.id is not None\n    assert user.username == \"testuser\"</code></pre>"},{"location":"23-best-practices/#8","title":"8. \u5fae\u670d\u52a1\u901a\u4fe1","text":""},{"location":"23-best-practices/#rpc","title":"RPC \u8c03\u7528\u6700\u4f73\u5b9e\u8df5","text":"<pre><code>from aury.boot.application.rpc.client import create_rpc_client\n\n@app.get(\"/orders/{order_id}\")\nasync def get_order_details(order_id: str):\n    # \u672c\u5730\u670d\u52a1\n    order = await order_service.get_order(order_id)\n\n    # \u8c03\u7528\u7528\u6237\u670d\u52a1\n    user_client = create_rpc_client(service_name=\"user-service\")\n    user = await user_client.get(f\"/api/users/{order.user_id}\")\n\n    # \u8c03\u7528\u652f\u4ed8\u670d\u52a1\n    payment_client = create_rpc_client(service_name=\"payment-service\")\n    payment = await payment_client.get(f\"/api/payments/{order.payment_id}\")\n\n    return {\n        \"order\": order,\n        \"user\": user.data,\n        \"payment\": payment.data\n    }</code></pre>"},{"location":"23-best-practices/#_16","title":"\u670d\u52a1\u53d1\u73b0","text":"<pre><code># \u65b9\u5f0f 1\uff1a\u663e\u5f0f\u6620\u5c04\nRPC_CLIENT_SERVICES={\"user-service\": \"http://10.0.0.5:8000\", \"payment-service\": \"http://10.0.0.6:8000\"}\n\n# \u65b9\u5f0f 2\uff1aDNS \u81ea\u52a8\u89e3\u6790\uff08Kubernetes\uff09\n# user-service \u81ea\u52a8\u89e3\u6790\u5230 http://user-service:8000</code></pre>"},{"location":"23-best-practices/#9","title":"9. \u90e8\u7f72\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"23-best-practices/#_17","title":"\u73af\u5883\u9694\u79bb","text":"<pre><code># \u5f00\u53d1\u73af\u5883\nLOG_LEVEL=DEBUG\nDATABASE_POOL_SIZE=5\nCACHE_TYPE=memory\n\n# \u751f\u4ea7\u73af\u5883\nLOG_LEVEL=INFO\nDATABASE_POOL_SIZE=20\nCACHE_TYPE=redis</code></pre>"},{"location":"23-best-practices/#_18","title":"\u5065\u5eb7\u68c0\u67e5","text":"<pre><code>@app.get(\"/health\")\nasync def health_check():\n    return {\n        \"status\": \"ok\",\n        \"database\": await check_database(),\n        \"cache\": await check_cache(),\n        \"timestamp\": datetime.utcnow()\n    }</code></pre>"},{"location":"23-best-practices/#_19","title":"\u4f18\u96c5\u5173\u95ed","text":"<pre><code>@app.on_event(\"shutdown\")\nasync def shutdown_event():\n    # \u7b49\u5f85\u73b0\u6709\u8bf7\u6c42\u5b8c\u6210\n    # \u5173\u95ed\u6570\u636e\u5e93\u8fde\u63a5\n    # \u5173\u95ed\u7f13\u5b58\u8fde\u63a5\n    logger.info(\"\u5e94\u7528\u5df2\u5173\u95ed\")</code></pre>"},{"location":"23-best-practices/#10","title":"10. \u4ee3\u7801\u5ba1\u67e5\u6e05\u5355","text":"<ul> <li> \u662f\u5426\u6709\u672a\u5904\u7406\u7684\u5f02\u5e38\uff1f</li> <li> \u662f\u5426\u907f\u514d\u4e86 N+1 \u67e5\u8be2\uff1f</li> <li> \u662f\u5426\u6709\u5185\u5b58\u6cc4\u6f0f\uff08\u957f\u8fde\u63a5\u672a\u5173\u95ed\uff09\uff1f</li> <li> \u662f\u5426\u6709 SQL \u6ce8\u5165\u98ce\u9669\uff08\u4f7f\u7528 ORM \u53c2\u6570\u5316\u67e5\u8be2\uff09\uff1f</li> <li> \u662f\u5426\u6709\u7ade\u6001\u6761\u4ef6\uff1f</li> <li> \u662f\u5426\u6709\u9002\u5f53\u7684\u65e5\u5fd7\u548c\u76d1\u63a7\uff1f</li> <li> \u662f\u5426\u6709\u5355\u5143\u6d4b\u8bd5\uff1f</li> <li> \u662f\u5426\u6709 API \u6587\u6863\uff1f</li> <li> \u662f\u5426\u6709\u6027\u80fd\u4f18\u5316\u7a7a\u95f4\uff1f</li> <li> \u662f\u5426\u7b26\u5408\u547d\u540d\u89c4\u8303\uff1f</li> </ul>"},{"location":"23-best-practices/#_20","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u53c2\u8003 05-di-container-complete.md \u4f18\u5316\u4f9d\u8d56\u6ce8\u5165</li> <li>\u53c2\u8003 06-components-detailed.md \u4f18\u5316\u7ec4\u4ef6\u7ba1\u7406</li> <li>\u53c2\u8003 09-database-complete.md \u4f18\u5316\u6570\u636e\u5e93\u67e5\u8be2</li> </ul>"},{"location":"24-cli-commands/","title":"24. CLI \u547d\u4ee4\u53c2\u8003","text":"<p>Aury Boot \u63d0\u4f9b\u7edf\u4e00\u7684\u547d\u4ee4\u884c\u5de5\u5177 <code>aury</code>\uff0c\u6574\u5408\u4e86\u9879\u76ee\u811a\u624b\u67b6\u3001\u4ee3\u7801\u751f\u6210\u3001\u670d\u52a1\u5668\u7ba1\u7406\u548c\u6570\u636e\u5e93\u8fc1\u79fb\u529f\u80fd\u3002</p>"},{"location":"24-cli-commands/#_1","title":"\u5b89\u88c5\u547d\u4ee4\u884c\u8865\u5168","text":"<pre><code># \u5b89\u88c5 shell \u8865\u5168\uff08\u652f\u6301 bash/zsh/fish/powershell\uff09\naum --install-completion\n\n# \u663e\u793a\u8865\u5168\u811a\u672c\uff08\u4e0d\u5b89\u88c5\uff09\naum --show-completion</code></pre>"},{"location":"24-cli-commands/#_2","title":"\u547d\u4ee4\u6982\u89c8","text":"<pre><code>aum [OPTIONS] COMMAND [ARGS]...\n\nCommands:\n  init       \ud83c\udfaf \u521d\u59cb\u5316\u9879\u76ee\u811a\u624b\u67b6\n  generate   \u26a1 \u4ee3\u7801\u751f\u6210\u5668\n  server     \ud83d\udda5\ufe0f  \u670d\u52a1\u5668\u7ba1\u7406\n  scheduler  \ud83d\udd50 \u72ec\u7acb\u8fd0\u884c\u8c03\u5ea6\u5668\n  worker     \u2699\ufe0f  \u8fd0\u884c\u4efb\u52a1\u961f\u5217 Worker\n  migrate    \ud83d\uddc3\ufe0f  \u6570\u636e\u5e93\u8fc1\u79fb\n  docker     \ud83d\udc33 Docker \u914d\u7f6e\u751f\u6210\n\nOptions:\n  -v, --version  \u663e\u793a\u7248\u672c\u4fe1\u606f\n  --help         \u663e\u793a\u5e2e\u52a9\u4fe1\u606f</code></pre>"},{"location":"24-cli-commands/#aury-init","title":"aury init","text":"<p>\u5728\u5f53\u524d\u9879\u76ee\u4e2d\u521d\u59cb\u5316 Aury \u811a\u624b\u67b6\u3002</p> <p>\u524d\u7f6e\u6761\u4ef6\uff1a\u5df2\u8fd0\u884c <code>uv init</code> \u521b\u5efa\u9879\u76ee\u5e76\u5b89\u88c5 aury-boot\u3002</p> <pre><code># \u524d\u7f6e\u6b65\u9aa4\uff08\u5fc5\u987b\u5148\u6267\u884c\uff09\nuv init . --name my_service --no-package --python 3.13\nuv add \"aury-boot[recommended]\"\n\n# \u7136\u540e\u521d\u59cb\u5316\u811a\u624b\u67b6\naury init [PACKAGE_NAME] [OPTIONS]\n\nArguments:\n  PACKAGE_NAME        \u53ef\u9009\uff0c\u9876\u5c42\u5305\u540d\uff08\u5982 my_package\uff09\n\nOptions:\n  -y, --no-interactive  \u8df3\u8fc7\u4ea4\u4e92\uff0c\u7eaf\u9ed8\u8ba4\u914d\u7f6e\n  -f, --force           \u5f3a\u5236\u8986\u76d6\u5df2\u5b58\u5728\u7684\u6587\u4ef6\n  --docker              \u540c\u65f6\u751f\u6210 Docker \u914d\u7f6e\n  --help                \u663e\u793a\u5e2e\u52a9\u4fe1\u606f</code></pre> <p>\u6ce8\u610f\uff1a<code>init</code> \u4f1a\u8986\u76d6 <code>uv init</code> \u521b\u5efa\u7684\u9ed8\u8ba4 <code>main.py</code>\uff0c\u8fd9\u662f\u6b63\u5e38\u884c\u4e3a\u3002</p>"},{"location":"24-cli-commands/#_3","title":"\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09","text":"<p>\u9ed8\u8ba4\u4f7f\u7528\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff0c\u4f1a\u8be2\u95ee\u4ee5\u4e0b\u914d\u7f6e\uff1a</p> <ul> <li>\u9879\u76ee\u7ed3\u6784\uff1a\u5e73\u94fa\u7ed3\u6784 vs \u9876\u5c42\u5305\u7ed3\u6784</li> <li>\u6570\u636e\u5e93\u7c7b\u578b\uff1aPostgreSQL\uff08\u63a8\u8350\uff09/ MySQL / SQLite</li> <li>\u7f13\u5b58\u7c7b\u578b\uff1a\u5185\u5b58\u7f13\u5b58\uff08\u5f00\u53d1\uff09/ Redis\uff08\u751f\u4ea7\uff09</li> <li>\u670d\u52a1\u6a21\u5f0f\uff1aAPI / API+\u8c03\u5ea6\u5668 / \u5b8c\u6574\uff08API+\u8c03\u5ea6\u5668+\u4efb\u52a1\uff09</li> <li>\u53ef\u9009\u529f\u80fd\uff1a\u5bf9\u8c61\u5b58\u50a8\u3001\u4e8b\u4ef6\u603b\u7ebf\u3001\u56fd\u9645\u5316</li> <li>\u5f00\u53d1\u5de5\u5177\uff1apytest, ruff, mypy</li> <li>Docker \u914d\u7f6e\uff1aDockerfile + docker-compose.yml</li> </ul> <p>\u4f7f\u7528 <code>-y</code> \u6216 <code>--no-interactive</code> \u8df3\u8fc7\u4ea4\u4e92\uff0c\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\u3002</p>"},{"location":"24-cli-commands/#_4","title":"\u751f\u6210\u5185\u5bb9","text":"<p>\u6587\u4ef6\uff1a - <code>main.py</code> - \u5e94\u7528\u5165\u53e3 - <code>config.py</code> - \u914d\u7f6e\u7c7b - <code>.env.example</code> - \u73af\u5883\u53d8\u91cf\u6a21\u677f - <code>README.md</code> - \u9879\u76ee\u8bf4\u660e\uff08\u5982\u4e0d\u5b58\u5728\uff09 - <code>tests/conftest.py</code> - pytest \u914d\u7f6e</p> <p>\u76ee\u5f55\uff1a - <code>api/</code> - API \u8def\u7531 - <code>services/</code> - \u4e1a\u52a1\u903b\u8f91 - <code>models/</code> - SQLAlchemy \u6a21\u578b - <code>repositories/</code> - \u6570\u636e\u8bbf\u95ee\u5c42 - <code>schemas/</code> - Pydantic \u6a21\u578b - <code>tests/</code> - \u6d4b\u8bd5</p> <p>pyproject.toml \u914d\u7f6e\uff1a - <code>[tool.ruff]</code> - Ruff \u4ee3\u7801\u68c0\u67e5\u914d\u7f6e - <code>[tool.pytest.ini_options]</code> - pytest \u914d\u7f6e</p>"},{"location":"24-cli-commands/#_5","title":"\u793a\u4f8b","text":"<pre><code># \u524d\u7f6e\u6b65\u9aa4\nuv init . --name my_service --no-package --python 3.13\nuv add \"aury-boot[recommended]\"\n\n# \u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09\naury init\n\n# \u8df3\u8fc7\u4ea4\u4e92\uff0c\u7eaf\u9ed8\u8ba4\u914d\u7f6e\naury init -y\n\n# \u4f7f\u7528\u9876\u5c42\u5305\u7ed3\u6784\naury init my_package\n\n# \u5305\u542b Docker \u914d\u7f6e\naury init --docker\n\n# \u5f3a\u5236\u8986\u76d6\u5df2\u5b58\u5728\u7684\u6587\u4ef6\naury init --force</code></pre>"},{"location":"24-cli-commands/#aury-generate","title":"aury generate","text":"<p>\u4ee3\u7801\u751f\u6210\u5668\uff0c\u751f\u6210\u7b26\u5408 Aury \u89c4\u8303\u7684\u4ee3\u7801\u6587\u4ef6\u3002</p> <pre><code>aury generate COMMAND [ARGS]...\n\nCommands:\n  model    \u751f\u6210 SQLAlchemy \u6a21\u578b\n  repo     \u751f\u6210 Repository \u6570\u636e\u8bbf\u95ee\u5c42\n  service  \u751f\u6210 Service \u4e1a\u52a1\u903b\u8f91\u5c42\n  api      \u751f\u6210 FastAPI \u8def\u7531\n  schema   \u751f\u6210 Pydantic Schema\n  crud     \u4e00\u952e\u751f\u6210\u5b8c\u6574 CRUD</code></pre>"},{"location":"24-cli-commands/#_6","title":"\u5b57\u6bb5\u5b9a\u4e49\u8bed\u6cd5","text":"<p>\u4ee3\u7801\u751f\u6210\u5668\u652f\u6301\u901a\u8fc7\u547d\u4ee4\u884c\u53c2\u6570\u5b9a\u4e49\u5b57\u6bb5\uff08AI \u53cb\u597d\uff09\u6216\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u4eba\u7c7b\u53cb\u597d\uff09\u3002</p> <p>\u5b57\u6bb5\u683c\u5f0f\uff1a<code>name:type:modifiers</code></p> <p>\u652f\u6301\u7684\u7c7b\u578b\uff1a</p> \u7c7b\u578b \u8bf4\u660e <code>str</code>, <code>string</code> \u5b57\u7b26\u4e32\uff08\u9ed8\u8ba4 255\uff09 <code>str(100)</code> \u6307\u5b9a\u957f\u5ea6\u7684\u5b57\u7b26\u4e32 <code>text</code> \u957f\u6587\u672c <code>int</code>, <code>integer</code> \u6574\u6570 <code>bigint</code> \u5927\u6574\u6570 <code>float</code> \u6d6e\u70b9\u6570 <code>decimal</code> \u7cbe\u786e\u5c0f\u6570 <code>bool</code>, <code>boolean</code> \u5e03\u5c14\u503c <code>datetime</code> \u65e5\u671f\u65f6\u95f4 <code>date</code> \u65e5\u671f <code>time</code> \u65f6\u95f4 <code>json</code>, <code>dict</code> JSON \u5bf9\u8c61 <p>\u4fee\u9970\u7b26\uff1a</p> \u4fee\u9970\u7b26 \u8bf4\u660e \u793a\u4f8b <code>?</code> \u6216 <code>nullable</code> \u53ef\u7a7a <code>age:int?</code> <code>unique</code> \u552f\u4e00\u7ea6\u675f <code>email:str:unique</code> <code>index</code> \u7d22\u5f15 <code>name:str:index</code> <code>=value</code> \u9ed8\u8ba4\u503c <code>status:str=active</code> <p>\u793a\u4f8b\uff1a</p> <pre><code># \u5b8c\u6574\u793a\u4f8b\naury generate crud user email:str:unique age:int? status:str=active\n\n# \u6587\u7ae0\u6a21\u578b\naury generate crud article title:str(200) content:text status:str=draft\n\n# \u5546\u54c1\u6a21\u578b\naury generate crud product name:str:unique price:decimal stock:int=0</code></pre>"},{"location":"24-cli-commands/#generate-model","title":"generate model","text":"<pre><code>aury generate model NAME [FIELDS...] [OPTIONS]\n\nArguments:\n  NAME       \u6a21\u578b\u540d\u79f0\uff08\u5982 user, UserProfile\uff09\n  FIELDS...  \u5b57\u6bb5\u5b9a\u4e49\uff08\u53ef\u9009\uff09\n\nOptions:\n  -i, --interactive   \u4ea4\u4e92\u5f0f\u6dfb\u52a0\u5b57\u6bb5\n  -b, --base TEXT     \u6a21\u578b\u57fa\u7c7b\uff08\u9ed8\u8ba4 UUIDAuditableStateModel\uff09\n  -f, --force         \u5f3a\u5236\u8986\u76d6\n  --no-soft-delete    \u7981\u7528\u8f6f\u5220\u9664\n  --no-timestamps     \u7981\u7528\u65f6\u95f4\u6233</code></pre> <p>\u53ef\u7528\u57fa\u7c7b\uff1aIDOnlyModel, UUIDOnlyModel, Model, AuditableStateModel, UUIDModel, UUIDAuditableStateModel, VersionedModel, VersionedTimestampedModel, VersionedUUIDModel, FullFeaturedModel, FullFeaturedUUIDModel\u3002</p> <p>\u751f\u6210 <code>models/{name}.py</code>\uff0c\u9ed8\u8ba4\u7ee7\u627f <code>UUIDAuditableStateModel</code>\u3002</p> <pre><code># \u57fa\u672c\u7528\u6cd5\naury generate model user\n\n# \u5e26\u5b57\u6bb5\u5b9a\u4e49\naury generate model user email:str:unique age:int? status:str=active\n\n# \u4ea4\u4e92\u5f0f\naury generate model user -i</code></pre>"},{"location":"24-cli-commands/#generate-repo","title":"generate repo","text":"<pre><code>aury generate repo NAME [FIELDS...] [OPTIONS]</code></pre> <p>\u751f\u6210 <code>repositories/{name}_repository.py</code>\u3002\u5982\u679c\u6307\u5b9a\u4e86 <code>unique</code> \u5b57\u6bb5\uff0c\u4f1a\u81ea\u52a8\u751f\u6210 <code>get_by_xxx</code> \u65b9\u6cd5\u3002</p> <pre><code>aury generate repo user email:str:unique  # \u751f\u6210 get_by_email \u65b9\u6cd5</code></pre>"},{"location":"24-cli-commands/#generate-service","title":"generate service","text":"<pre><code>aury generate service NAME [FIELDS...] [OPTIONS]</code></pre> <p>\u751f\u6210 <code>services/{name}_service.py</code>\u3002\u5982\u679c\u6307\u5b9a\u4e86 <code>unique</code> \u5b57\u6bb5\uff0c\u4f1a\u81ea\u52a8\u751f\u6210\u91cd\u590d\u68c0\u6d4b\u903b\u8f91\u3002</p> <pre><code>aury generate service user email:str:unique  # \u521b\u5efa\u65f6\u68c0\u67e5 email \u91cd\u590d</code></pre>"},{"location":"24-cli-commands/#generate-api","title":"generate api","text":"<pre><code>aury generate api NAME [OPTIONS]</code></pre> <p>\u751f\u6210 <code>api/{name}.py</code>\uff0c\u5305\u542b\u5b8c\u6574\u7684 CRUD \u8def\u7531\u3002</p>"},{"location":"24-cli-commands/#generate-schema","title":"generate schema","text":"<pre><code>aury generate schema NAME [FIELDS...] [OPTIONS]\n\nOptions:\n  -i, --interactive  \u4ea4\u4e92\u5f0f\u6dfb\u52a0\u5b57\u6bb5\n  -f, --force        \u5f3a\u5236\u8986\u76d6</code></pre> <p>\u751f\u6210 <code>schemas/{name}.py</code>\uff0c\u5305\u542b Create/Update/Response \u6a21\u578b\u3002</p>"},{"location":"24-cli-commands/#generate-crud","title":"generate crud","text":"<pre><code>aury generate crud NAME [FIELDS...] [OPTIONS]\n\nOptions:\n  -i, --interactive   \u4ea4\u4e92\u5f0f\u6dfb\u52a0\u5b57\u6bb5\n  -b, --base TEXT     \u6a21\u578b\u57fa\u7c7b\uff08\u9ed8\u8ba4 UUIDAuditableStateModel\uff09\n  -f, --force         \u5f3a\u5236\u8986\u76d6\n  --no-soft-delete    \u7981\u7528\u8f6f\u5220\u9664\n  --no-timestamps     \u7981\u7528\u65f6\u95f4\u6233</code></pre> <p>\u4e00\u952e\u751f\u6210\u5b8c\u6574 CRUD\uff1amodel + repo + service + schema + api\u3002</p>"},{"location":"24-cli-commands/#_7","title":"\u793a\u4f8b","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\uff08\u65e0\u5b57\u6bb5\uff09\naury generate crud user\n\n# \u5e26\u5b57\u6bb5\u5b9a\u4e49\uff08AI \u53cb\u597d\uff09\naury generate crud user email:str:unique age:int? status:str=active\naury generate crud article title:str(200) content:text published:bool=false\n\n# \u4ea4\u4e92\u5f0f\uff08\u4eba\u7c7b\u53cb\u597d\uff09\naury generate crud user -i\n\n# \u5f3a\u5236\u8986\u76d6\naury generate crud user --force\n\n# \u7981\u7528\u8f6f\u5220\u9664\naury generate crud user --no-soft-delete</code></pre>"},{"location":"24-cli-commands/#aury-server","title":"aury server","text":"<p>\u670d\u52a1\u5668\u7ba1\u7406\u547d\u4ee4\u3002</p> <pre><code>aury server COMMAND [ARGS]...\n\nCommands:\n  dev   \u542f\u52a8\u5f00\u53d1\u670d\u52a1\u5668\uff08\u70ed\u91cd\u8f7d\uff09\n  prod  \u542f\u52a8\u751f\u4ea7\u670d\u52a1\u5668\uff08\u591a\u8fdb\u7a0b\uff09\n  run   \u901a\u7528\u8fd0\u884c\u547d\u4ee4</code></pre>"},{"location":"24-cli-commands/#server-dev","title":"server dev","text":"<pre><code>aury server dev [OPTIONS]\n\nOptions:\n  -a, --app TEXT   \u5e94\u7528\u6a21\u5757\u8def\u5f84\uff08\u9ed8\u8ba4\u81ea\u52a8\u68c0\u6d4b\uff09\n  -h, --host TEXT  \u76d1\u542c\u5730\u5740\n  -p, --port INT   \u76d1\u542c\u7aef\u53e3</code></pre> <p>\u7279\u70b9\uff1a\u81ea\u52a8\u542f\u7528\u70ed\u91cd\u8f7d\u548c\u8c03\u8bd5\u6a21\u5f0f\u3002</p>"},{"location":"24-cli-commands/#server-prod","title":"server prod","text":"<pre><code>aury server prod [OPTIONS]\n\nOptions:\n  -a, --app TEXT      \u5e94\u7528\u6a21\u5757\u8def\u5f84\n  -h, --host TEXT     \u76d1\u542c\u5730\u5740\uff08\u9ed8\u8ba4: 0.0.0.0\uff09\n  -p, --port INT      \u76d1\u542c\u7aef\u53e3\n  -w, --workers INT   \u5de5\u4f5c\u8fdb\u7a0b\u6570\uff08\u9ed8\u8ba4: CPU \u6838\u5fc3\u6570\uff09</code></pre> <p>\u7279\u70b9\uff1a\u591a\u8fdb\u7a0b\uff0c\u7981\u7528\u70ed\u91cd\u8f7d\u3002</p>"},{"location":"24-cli-commands/#server-run","title":"server run","text":"<pre><code>aury server run [OPTIONS]\n\nOptions:\n  -a, --app TEXT         \u5e94\u7528\u6a21\u5757\u8def\u5f84\n  -h, --host TEXT        \u76d1\u542c\u5730\u5740\n  -p, --port INT         \u76d1\u542c\u7aef\u53e3\n  -w, --workers INT      \u5de5\u4f5c\u8fdb\u7a0b\u6570\n  --reload               \u542f\u7528\u70ed\u91cd\u8f7d\n  --reload-dir TEXT      \u70ed\u91cd\u8f7d\u76d1\u63a7\u76ee\u5f55\uff08\u53ef\u591a\u6b21\u6307\u5b9a\uff09\n  --debug                \u8c03\u8bd5\u6a21\u5f0f\n  --loop TEXT            \u4e8b\u4ef6\u5faa\u73af\uff08auto/asyncio/uvloop\uff09\n  --http TEXT            HTTP \u534f\u8bae\uff08auto/h11/httptools\uff09\n  --ssl-keyfile TEXT     SSL \u5bc6\u94a5\u6587\u4ef6\n  --ssl-certfile TEXT    SSL \u8bc1\u4e66\u6587\u4ef6\n  --no-access-log        \u7981\u7528\u8bbf\u95ee\u65e5\u5fd7</code></pre>"},{"location":"24-cli-commands/#_8","title":"\u793a\u4f8b","text":"<pre><code># \u5f00\u53d1\u6a21\u5f0f\naury server dev\naury server dev --port 9000\n\n# \u751f\u4ea7\u6a21\u5f0f\naury server prod\naury server prod --workers 8\n\n# \u81ea\u5b9a\u4e49\u8fd0\u884c\naury server run --reload --workers 4\naury server run --ssl-keyfile key.pem --ssl-certfile cert.pem</code></pre>"},{"location":"24-cli-commands/#aum-scheduler","title":"aum scheduler","text":"<p>\u72ec\u7acb\u8fd0\u884c\u8c03\u5ea6\u5668\u8fdb\u7a0b\u3002</p> <pre><code>aum scheduler [OPTIONS]\n\nOptions:\n  -a, --app TEXT   \u5e94\u7528\u6a21\u5757\u8def\u5f84\uff08\u9ed8\u8ba4\u81ea\u52a8\u68c0\u6d4b\uff09\n  --help           \u663e\u793a\u5e2e\u52a9\u4fe1\u606f</code></pre> <p>\u8c03\u5ea6\u5668\u4f1a\u52a0\u8f7d\u5e94\u7528\u4e2d\u5b9a\u4e49\u7684\u6240\u6709\u5b9a\u65f6\u4efb\u52a1\uff0c\u72ec\u7acb\u8fd0\u884c\uff08\u4e0d\u542f\u52a8 HTTP \u670d\u52a1\uff09\u3002</p> <pre><code># \u57fa\u672c\u7528\u6cd5\naum scheduler\n\n# \u6307\u5b9a\u5e94\u7528\u6a21\u5757\naum scheduler --app mypackage.main:app</code></pre>"},{"location":"24-cli-commands/#aum-worker","title":"aum worker","text":"<p>\u8fd0\u884c\u4efb\u52a1\u961f\u5217 Worker \u8fdb\u7a0b\u3002</p> <pre><code>aum worker [OPTIONS]\n\nOptions:\n  -a, --app TEXT        \u5e94\u7528\u6a21\u5757\u8def\u5f84\uff08\u9ed8\u8ba4\u81ea\u52a8\u68c0\u6d4b\uff09\n  -c, --concurrency INT \u5e76\u53d1 worker \u6570\u91cf\uff08\u9ed8\u8ba4: 4\uff09\n  -q, --queues TEXT     \u8981\u5904\u7406\u7684\u961f\u5217\u540d\u79f0\uff08\u9017\u53f7\u5206\u9694\uff09\n  --help                \u663e\u793a\u5e2e\u52a9\u4fe1\u606f</code></pre> <p>Worker \u4f1a\u6d88\u8d39\u4efb\u52a1\u961f\u5217\u4e2d\u7684\u5f02\u6b65\u4efb\u52a1\u5e76\u6267\u884c\u3002</p> <pre><code># \u57fa\u672c\u7528\u6cd5\naum worker\n\n# \u6307\u5b9a\u5e76\u53d1\u6570\naum worker -c 8\n\n# \u53ea\u5904\u7406\u6307\u5b9a\u961f\u5217\naum worker -q high,default\n\n# \u6307\u5b9a\u5e94\u7528\u6a21\u5757\naum worker --app mypackage.main:app</code></pre>"},{"location":"24-cli-commands/#aury-migrate","title":"aury migrate","text":"<p>\u6570\u636e\u5e93\u8fc1\u79fb\u547d\u4ee4\u3002</p> <pre><code>aury migrate COMMAND [ARGS]...\n\nCommands:\n  make     \u751f\u6210\u8fc1\u79fb\u6587\u4ef6\n  up       \u6267\u884c\u8fc1\u79fb\n  down     \u56de\u6eda\u8fc1\u79fb\n  status   \u67e5\u770b\u8fc1\u79fb\u72b6\u6001\n  show     \u663e\u793a\u6240\u6709\u8fc1\u79fb\n  check    \u68c0\u67e5\u8fc1\u79fb\n  history  \u663e\u793a\u8fc1\u79fb\u5386\u53f2\n  merge    \u5408\u5e76\u8fc1\u79fb</code></pre>"},{"location":"24-cli-commands/#migrate-make","title":"migrate make","text":"<pre><code>aury migrate make [OPTIONS]\n\nOptions:\n  -m, --message TEXT           \u8fc1\u79fb\u6d88\u606f\uff08\u5fc5\u9700\uff09\n  --autogenerate/--no-autogenerate  \u662f\u5426\u81ea\u52a8\u751f\u6210\n  --dry-run                    \u5e72\u8fd0\u884c\n  --config TEXT                Alembic \u914d\u7f6e\u6587\u4ef6\u8def\u5f84</code></pre>"},{"location":"24-cli-commands/#migrate-up","title":"migrate up","text":"<pre><code>aury migrate up [OPTIONS]\n\nOptions:\n  -r, --revision TEXT  \u76ee\u6807\u7248\u672c\uff08\u9ed8\u8ba4: head\uff09\n  --dry-run            \u5e72\u8fd0\u884c\n  --config TEXT        Alembic \u914d\u7f6e\u6587\u4ef6\u8def\u5f84</code></pre>"},{"location":"24-cli-commands/#migrate-down","title":"migrate down","text":"<pre><code>aury migrate down REVISION [OPTIONS]\n\nArguments:\n  REVISION  \u76ee\u6807\u7248\u672c\uff08previous, -1, \u6216\u5177\u4f53\u7248\u672c\u53f7\uff09\n\nOptions:\n  --dry-run      \u5e72\u8fd0\u884c\n  --config TEXT  Alembic \u914d\u7f6e\u6587\u4ef6\u8def\u5f84</code></pre>"},{"location":"24-cli-commands/#migrate-status","title":"migrate status","text":"<pre><code>aury migrate status [OPTIONS]</code></pre> <p>\u663e\u793a\u5f53\u524d\u8fc1\u79fb\u72b6\u6001\u3001\u5f85\u6267\u884c\u8fc1\u79fb\u548c\u5df2\u6267\u884c\u8fc1\u79fb\u3002</p>"},{"location":"24-cli-commands/#_9","title":"\u793a\u4f8b","text":"<pre><code># \u751f\u6210\u8fc1\u79fb\naury migrate make -m \"add user table\"\naury migrate make -m \"check changes\" --dry-run\n\n# \u6267\u884c\u8fc1\u79fb\naury migrate up\naury migrate up -r \"abc123\"\n\n# \u56de\u6eda\u8fc1\u79fb\naury migrate down previous\naury migrate down -1\n\n# \u67e5\u770b\u72b6\u6001\naury migrate status\naury migrate show</code></pre>"},{"location":"24-cli-commands/#_10","title":"\u73af\u5883\u53d8\u91cf","text":"<p>\u6240\u6709\u547d\u4ee4\u90fd\u652f\u6301\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff1a</p> <pre><code># \u670d\u52a1\u914d\u7f6e\nSERVICE_NAME=my-service\nSERVICE_TYPE=api  # api, worker\n\n# \u670d\u52a1\u5668\nSERVER_HOST=0.0.0.0\nSERVER_PORT=8000\nSERVER_WORKERS=4\n\n# \u5e94\u7528\u6a21\u5757\nAPP_MODULE=main:app\n\n# \u8c03\u5ea6\u5668\uff08\u5185\u5d4c\u5728 API \u670d\u52a1\u4e2d\uff09\nSCHEDULER_ENABLED=true  # \u9ed8\u8ba4 true\uff0c\u8bbe\u4e3a false \u53ef\u7981\u7528</code></pre> <p>\u670d\u52a1\u8fd0\u884c\u6a21\u5f0f\u8bf4\u660e\uff1a</p> <ul> <li><code>SERVICE_TYPE=api</code> + <code>SCHEDULER_ENABLED=true</code>\uff08\u9ed8\u8ba4\uff09\uff1aAPI \u670d\u52a1 + \u5185\u5d4c\u8c03\u5ea6\u5668</li> <li><code>SERVICE_TYPE=api</code> + <code>SCHEDULER_ENABLED=false</code>\uff1a\u7eaf API \u670d\u52a1</li> <li><code>aum scheduler</code>\uff1a\u72ec\u7acb\u8c03\u5ea6\u5668\u8fdb\u7a0b\uff08\u65e0\u9700\u914d\u7f6e\uff09</li> <li><code>aum worker</code>\uff1a\u72ec\u7acb Worker \u8fdb\u7a0b\uff08\u65e0\u9700\u914d\u7f6e\uff09</li> </ul>"},{"location":"24-cli-commands/#_11","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 25-scaffold-guide.md \u4e86\u89e3\u811a\u624b\u67b6\u4f7f\u7528\u6307\u5357</li> <li>\u67e5\u770b 03-server-deployment.md \u4e86\u89e3\u670d\u52a1\u5668\u90e8\u7f72</li> <li>\u67e5\u770b 21-migration-guide.md \u4e86\u89e3\u6570\u636e\u5e93\u8fc1\u79fb</li> </ul>"},{"location":"25-scaffold-guide/","title":"25. \u811a\u624b\u67b6\u4f7f\u7528\u6307\u5357","text":"<p>\u672c\u6307\u5357\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528 Aury Boot \u7684\u811a\u624b\u67b6\u5feb\u901f\u521b\u5efa\u9879\u76ee\u548c\u751f\u6210\u4ee3\u7801\u3002</p>"},{"location":"25-scaffold-guide/#_1","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"25-scaffold-guide/#1","title":"1. \u521b\u5efa\u65b0\u9879\u76ee","text":"<pre><code># 1. \u521b\u5efa\u9879\u76ee\u76ee\u5f55\u5e76\u521d\u59cb\u5316\nmkdir my-service &amp;&amp; cd my-service\nuv init . --name my_service --no-package --python 3.13\n\n# 2. \u5b89\u88c5 Aury Boot\nuv add \"aury-boot[recommended]\"\n\n# 3. \u521d\u59cb\u5316\u811a\u624b\u67b6\naury init                 # \u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09\uff0c\u4f1a\u8be2\u95ee\u914d\u7f6e\u9009\u9879\naury init -y              # \u8df3\u8fc7\u4ea4\u4e92\uff0c\u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\naury init my_package      # \u4f7f\u7528\u9876\u5c42\u5305\u7ed3\u6784\naury init --docker        # \u540c\u65f6\u751f\u6210 Docker \u914d\u7f6e\n\n# 4. \u914d\u7f6e\u73af\u5883\u53d8\u91cf\ncp .env.example .env\n# \u7f16\u8f91 .env \u6587\u4ef6\u914d\u7f6e\u6570\u636e\u5e93\u7b49\n\n# 5. \u542f\u52a8\u5f00\u53d1\u670d\u52a1\u5668\naury server dev</code></pre> <p>\u6ce8\u610f\uff1a<code>init</code> \u4f1a\u8986\u76d6 <code>uv init</code> \u521b\u5efa\u7684\u9ed8\u8ba4 <code>main.py</code>\uff0c\u8fd9\u662f\u6b63\u5e38\u884c\u4e3a\u3002</p> <p>\u8bbf\u95ee http://localhost:8000 \u67e5\u770b\u6548\u679c\u3002</p>"},{"location":"25-scaffold-guide/#2-crud","title":"2. \u751f\u6210 CRUD \u4ee3\u7801","text":"<pre><code># \u4e00\u952e\u751f\u6210\u5b8c\u6574 CRUD\uff08\u5e26\u5b57\u6bb5\u5b9a\u4e49\uff09\naury generate crud user email:str:unique age:int? status:str=active\n\n# \u5728 main.py \u4e2d\u6ce8\u518c\u8def\u7531\n# from api import user\n# app.include_router(user.router, prefix=\"/api/users\", tags=[\"User\"])\n\n# \u751f\u6210\u6570\u636e\u5e93\u8fc1\u79fb\naury migrate make -m \"add user table\"\n\n# \u6267\u884c\u8fc1\u79fb\naury migrate up</code></pre>"},{"location":"25-scaffold-guide/#_2","title":"\u5b57\u6bb5\u8bed\u6cd5","text":"<pre><code># \u683c\u5f0f: name:type:modifiers\n# \u7c7b\u578b: str, str(100), text, int, bigint, float, decimal, bool, datetime, date, time, json\n# \u4fee\u9970\u7b26: ? (\u53ef\u7a7a), unique, index, =\u9ed8\u8ba4\u503c\n\n# \u66f4\u591a\u793a\u4f8b\naury generate crud article title:str(200) content:text status:str=draft\naury generate crud product name:str:unique price:decimal stock:int=0\n\n# \u4ea4\u4e92\u5f0f\u6a21\u5f0f\naury generate crud user -i</code></pre>"},{"location":"25-scaffold-guide/#_3","title":"\u4ea4\u4e92\u5f0f\u6a21\u5f0f\u8be6\u89e3","text":"<p><code>aury init</code> \u9ed8\u8ba4\u4f7f\u7528\u4ea4\u4e92\u5f0f\u6a21\u5f0f\uff0c\u4f1a\u4f9d\u6b21\u8be2\u95ee\uff1a</p> <ol> <li>\u9879\u76ee\u7ed3\u6784</li> <li>\u5e73\u94fa\u7ed3\u6784\uff1a\u6587\u4ef6\u76f4\u63a5\u5728\u9879\u76ee\u6839\u76ee\u5f55\uff08\u7b80\u5355\u9879\u76ee\uff09</li> <li> <p>\u9876\u5c42\u5305\u7ed3\u6784\uff1a\u4ee3\u7801\u5728 <code>my_package/</code> \u76ee\u5f55\u4e0b\uff08\u63a8\u8350\u5927\u578b\u9879\u76ee\uff09</p> </li> <li> <p>\u6570\u636e\u5e93\u7c7b\u578b</p> </li> <li>PostgreSQL\uff08\u63a8\u8350\u751f\u4ea7\u73af\u5883\uff09</li> <li>MySQL</li> <li> <p>SQLite\uff08\u5f00\u53d1/\u6d4b\u8bd5\uff09</p> </li> <li> <p>\u7f13\u5b58\u7c7b\u578b</p> </li> <li>\u5185\u5b58\u7f13\u5b58\uff08\u5f00\u53d1\u7528\uff09</li> <li> <p>Redis\uff08\u751f\u4ea7\u63a8\u8350\uff09</p> </li> <li> <p>\u670d\u52a1\u6a21\u5f0f</p> </li> <li><code>api</code> - \u7eaf API \u670d\u52a1</li> <li><code>api+scheduler</code> - API + \u5185\u5d4c\u5b9a\u65f6\u4efb\u52a1</li> <li> <p><code>full</code> - API + \u5b9a\u65f6\u4efb\u52a1 + \u5f02\u6b65\u4efb\u52a1\u961f\u5217</p> </li> <li> <p>\u53ef\u9009\u529f\u80fd</p> </li> <li>\u5bf9\u8c61\u5b58\u50a8\uff08S3/\u672c\u5730\uff09</li> <li>\u4e8b\u4ef6\u603b\u7ebf</li> <li> <p>\u56fd\u9645\u5316\uff08i18n\uff09</p> </li> <li> <p>\u5f00\u53d1\u5de5\u5177\uff08pytest, ruff, mypy\uff09</p> </li> <li> <p>Docker \u914d\u7f6e\uff08Dockerfile + docker-compose.yml\uff09</p> </li> </ol> <p>\u914d\u7f6e\u5b8c\u6210\u540e\u4f1a\u663e\u793a\u6458\u8981\u548c\u63a8\u8350\u7684\u4f9d\u8d56\u5b89\u88c5\u547d\u4ee4\u3002</p>"},{"location":"25-scaffold-guide/#_4","title":"\u9879\u76ee\u7ed3\u6784","text":""},{"location":"25-scaffold-guide/#_5","title":"\u5e73\u94fa\u7ed3\u6784\uff08\u9ed8\u8ba4\uff09","text":"<p>\u6267\u884c <code>aury init</code> \u540e\uff1a</p> <pre><code>my-service/\n\u251c\u2500\u2500 main.py              # \u5e94\u7528\u5165\u53e3\n\u251c\u2500\u2500 config.py            # \u914d\u7f6e\u5b9a\u4e49\n\u251c\u2500\u2500 alembic.ini          # Alembic \u914d\u7f6e\n\u251c\u2500\u2500 pyproject.toml       # \u9879\u76ee\u914d\u7f6e\uff08\u5df2\u6dfb\u52a0 ruff/pytest/aum \u914d\u7f6e\uff09\n\u251c\u2500\u2500 .env.example         # \u73af\u5883\u53d8\u91cf\u6a21\u677f\n\u251c\u2500\u2500 README.md            # \u9879\u76ee\u8bf4\u660e\n\u2502\n\u251c\u2500\u2500 api/                 # API \u5c42\n\u2502   \u2514\u2500\u2500 __init__.py\n\u2502\n\u251c\u2500\u2500 services/            # Service \u5c42\uff08\u4e1a\u52a1\u903b\u8f91\uff09\n\u2502   \u2514\u2500\u2500 __init__.py\n\u2502\n\u251c\u2500\u2500 models/              # Model \u5c42\uff08SQLAlchemy\uff09\n\u2502   \u2514\u2500\u2500 __init__.py\n\u2502\n\u251c\u2500\u2500 repositories/        # Repository \u5c42\uff08\u6570\u636e\u8bbf\u95ee\uff09\n\u2502   \u2514\u2500\u2500 __init__.py\n\u2502\n\u251c\u2500\u2500 schemas/             # Schema \u5c42\uff08Pydantic\uff09\n\u2502   \u2514\u2500\u2500 __init__.py\n\u2502\n\u251c\u2500\u2500 migrations/          # \u6570\u636e\u5e93\u8fc1\u79fb\n\u2502   \u251c\u2500\u2500 env.py\n\u2502   \u251c\u2500\u2500 script.py.mako\n\u2502   \u2514\u2500\u2500 versions/\n\u2502\n\u2514\u2500\u2500 tests/               # \u6d4b\u8bd5\n    \u2514\u2500\u2500 conftest.py\n</code></pre>"},{"location":"25-scaffold-guide/#_6","title":"\u9876\u5c42\u5305\u7ed3\u6784","text":"<p>\u6267\u884c <code>aury init my_package</code> \u540e\uff1a</p> <pre><code>my-service/\n\u251c\u2500\u2500 my_package/          # \u9876\u5c42\u5305\n\u2502   \u251c\u2500\u2500 __init__.py\n\u2502   \u251c\u2500\u2500 main.py\n\u2502   \u251c\u2500\u2500 config.py\n\u2502   \u251c\u2500\u2500 api/\n\u2502   \u251c\u2500\u2500 services/\n\u2502   \u251c\u2500\u2500 models/\n\u2502   \u251c\u2500\u2500 repositories/\n\u2502   \u251c\u2500\u2500 schemas/\n\u2502   \u2514\u2500\u2500 tests/\n\u251c\u2500\u2500 migrations/\n\u251c\u2500\u2500 alembic.ini\n\u251c\u2500\u2500 pyproject.toml\n\u251c\u2500\u2500 .env.example\n\u2514\u2500\u2500 README.md\n</code></pre>"},{"location":"25-scaffold-guide/#_7","title":"\u5206\u5c42\u67b6\u6784","text":"<p>Aury \u91c7\u7528\u5206\u5c42\u67b6\u6784\uff0c\u4ee3\u7801\u751f\u6210\u5668\u4f1a\u6309\u89c4\u8303\u751f\u6210\u4ee3\u7801\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   API \u5c42                     \u2502\n\u2502        FastAPI Router / \u8bf7\u6c42\u5904\u7406            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 Service \u5c42                   \u2502\n\u2502             \u4e1a\u52a1\u903b\u8f91 / \u4e8b\u52a1\u7ba1\u7406              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               Repository \u5c42                  \u2502\n\u2502            \u6570\u636e\u8bbf\u95ee / CRUD \u64cd\u4f5c             \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                      \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 Model \u5c42                     \u2502\n\u2502           SQLAlchemy ORM \u6a21\u578b               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"25-scaffold-guide/#_8","title":"\u4ee3\u7801\u751f\u6210\u8be6\u89e3","text":""},{"location":"25-scaffold-guide/#model","title":"\u751f\u6210 Model","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\naury generate model user\n\n# \u5e26\u5b57\u6bb5\u5b9a\u4e49\naury generate model user email:str:unique age:int? status:str=active</code></pre> <p>\u751f\u6210 <code>models/user.py</code>\uff1a</p> <pre><code>from sqlalchemy import Integer, String\nfrom sqlalchemy.orm import Mapped, mapped_column\n\nfrom aury.boot.domain.models import UUIDAuditableStateModel\n\n\nclass User(UUIDAuditableStateModel):\n    \"\"\"User \u6a21\u578b\u3002\n\n    \u7ee7\u627f UUIDAuditableStateModel \u81ea\u52a8\u83b7\u5f97\uff1a\n    - id: UUID \u4e3b\u952e\n    - created_at: \u521b\u5efa\u65f6\u95f4\n    - updated_at: \u66f4\u65b0\u65f6\u95f4\n    - deleted_at: \u8f6f\u5220\u9664\u65f6\u95f4\u6233\n    \"\"\"\n\n    __tablename__ = \"users\"\n\n    email: Mapped[str] = mapped_column(String(255), unique=True)\n    age: Mapped[int | None] = mapped_column(Integer, nullable=True)\n    status: Mapped[str] = mapped_column(String(255), default=\"active\")</code></pre>"},{"location":"25-scaffold-guide/#repository","title":"\u751f\u6210 Repository","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\naury generate repo user\n\n# \u5e26 unique \u5b57\u6bb5\uff08\u81ea\u52a8\u751f\u6210 get_by_xxx \u65b9\u6cd5\uff09\naury generate repo user email:str:unique</code></pre> <p>\u751f\u6210 <code>repositories/user_repository.py</code>\uff1a</p> <pre><code>from aury.boot.domain.repository.impl import BaseRepository\n\nfrom models.user import User\n\n\nclass UserRepository(BaseRepository[User]):\n    \"\"\"User \u4ed3\u50a8\u3002\n\n    \u7ee7\u627f BaseRepository \u81ea\u52a8\u83b7\u5f97\uff1a\n    - get(id): \u6309 ID \u83b7\u53d6\n    - get_by(**filters): \u6309\u6761\u4ef6\u83b7\u53d6\u5355\u4e2a\n    - list(skip, limit, **filters): \u83b7\u53d6\u5217\u8868\n    - paginate(params, **filters): \u5206\u9875\u83b7\u53d6\n    - create(data): \u521b\u5efa\n    - update(entity, data): \u66f4\u65b0\n    - delete(entity, soft=True): \u5220\u9664\n    \"\"\"\n\n    async def get_by_email(self, email: str) -&gt; User | None:\n        \"\"\"\u6309 email \u83b7\u53d6\u3002\"\"\"\n        return await self.get_by(email=email)</code></pre>"},{"location":"25-scaffold-guide/#service","title":"\u751f\u6210 Service","text":"<pre><code># \u57fa\u672c\u7528\u6cd5\naury generate service user\n\n# \u5e26 unique \u5b57\u6bb5\uff08\u81ea\u52a8\u751f\u6210\u91cd\u590d\u68c0\u6d4b\uff09\naury generate service user email:str:unique</code></pre> <p>\u751f\u6210 <code>services/user_service.py</code>\uff1a</p> <pre><code>from sqlalchemy.ext.asyncio import AsyncSession\n\nfrom aury.boot.application.errors import AlreadyExistsError, NotFoundError\nfrom aury.boot.domain.service.base import BaseService\nfrom aury.boot.domain.transaction import transactional\n\nfrom models.user import User\nfrom repositories.user_repository import UserRepository\nfrom schemas.user import UserCreate, UserUpdate\n\n\nclass UserService(BaseService):\n    \"\"\"User \u670d\u52a1\u3002\"\"\"\n\n    def __init__(self, session: AsyncSession) -&gt; None:\n        super().__init__(session)\n        self.repo = UserRepository(session, User)\n\n    async def get(self, id: str) -&gt; User:\n        \"\"\"\u83b7\u53d6 User\u3002\"\"\"\n        entity = await self.repo.get(id)\n        if not entity:\n            raise NotFoundError(f\"User \u4e0d\u5b58\u5728\", resource=id)\n        return entity\n\n    @transactional\n    async def create(self, data: UserCreate) -&gt; User:\n        \"\"\"\u521b\u5efa User\u3002\"\"\"\n        # \u68c0\u67e5 email \u662f\u5426\u5df2\u5b58\u5728\uff08\u81ea\u52a8\u751f\u6210\uff09\n        existing = await self.repo.get_by_email(data.email)\n        if existing:\n            raise AlreadyExistsError(f\"User \u5df2\u5b58\u5728: {data.email}\")\n\n        return await self.repo.create(data.model_dump())\n\n    # ... \u66f4\u591a\u65b9\u6cd5</code></pre>"},{"location":"25-scaffold-guide/#schema","title":"\u751f\u6210 Schema","text":"<pre><code>aury generate schema user</code></pre> <p>\u751f\u6210 <code>schemas/user.py</code>\uff1a</p> <pre><code>from datetime import datetime\n\nfrom pydantic import BaseModel, ConfigDict, Field\n\n\nclass UserBase(BaseModel):\n    \"\"\"User \u57fa\u7840\u6a21\u578b\u3002\"\"\"\n\n    name: str = Field(..., min_length=1, max_length=100, description=\"\u540d\u79f0\")\n\n\nclass UserCreate(UserBase):\n    \"\"\"\u521b\u5efa User \u8bf7\u6c42\u3002\"\"\"\n    pass\n\n\nclass UserUpdate(BaseModel):\n    \"\"\"\u66f4\u65b0 User \u8bf7\u6c42\u3002\"\"\"\n\n    name: str | None = Field(None, min_length=1, max_length=100, description=\"\u540d\u79f0\")\n\n\nclass UserResponse(UserBase):\n    \"\"\"User \u54cd\u5e94\u3002\"\"\"\n\n    id: str = Field(..., description=\"ID\")\n    created_at: datetime = Field(..., description=\"\u521b\u5efa\u65f6\u95f4\")\n    updated_at: datetime = Field(..., description=\"\u66f4\u65b0\u65f6\u95f4\")\n\n    model_config = ConfigDict(from_attributes=True)</code></pre>"},{"location":"25-scaffold-guide/#api","title":"\u751f\u6210 API","text":"<pre><code>aury generate api user</code></pre> <p>\u751f\u6210 <code>api/user.py</code>\uff0c\u5305\u542b\u5b8c\u6574\u7684 CRUD \u8def\u7531\uff1a</p> <ul> <li><code>GET /</code> - \u5217\u8868</li> <li><code>GET /{id}</code> - \u8be6\u60c5</li> <li><code>POST /</code> - \u521b\u5efa</li> <li><code>PUT /{id}</code> - \u66f4\u65b0</li> <li><code>DELETE /{id}</code> - \u5220\u9664</li> </ul>"},{"location":"25-scaffold-guide/#crud","title":"\u4e00\u952e\u751f\u6210 CRUD","text":"<pre><code># \u65e0\u5b57\u6bb5\naury generate crud user\n\n# \u5e26\u5b57\u6bb5\u5b9a\u4e49\uff08\u63a8\u8350\uff09\naury generate crud user email:str:unique age:int? status:str=active\n\n# \u4ea4\u4e92\u5f0f\naury generate crud user -i</code></pre> <p>\u7b49\u540c\u4e8e\u4f9d\u6b21\u6267\u884c\uff1a</p> <pre><code>aury generate model user email:str:unique age:int? status:str=active\naury generate repo user email:str:unique\naury generate service user email:str:unique\naury generate schema user email:str:unique age:int? status:str=active\naury generate api user</code></pre>"},{"location":"25-scaffold-guide/#_9","title":"\u6ce8\u518c\u8def\u7531","text":"<p>\u751f\u6210 API \u540e\uff0c\u9700\u8981\u5728 <code>main.py</code> \u4e2d\u6ce8\u518c\u8def\u7531\uff1a</p> <pre><code># main.py\nfrom api import user\n\napp.include_router(user.router, prefix=\"/api/users\", tags=[\"User\"])</code></pre>"},{"location":"25-scaffold-guide/#_10","title":"\u6570\u636e\u5e93\u8fc1\u79fb","text":"<p>\u751f\u6210 Model \u540e\uff0c\u6267\u884c\u6570\u636e\u5e93\u8fc1\u79fb\uff1a</p> <pre><code># \u751f\u6210\u8fc1\u79fb\u6587\u4ef6\naury migrate make -m \"add user table\"\n\n# \u6267\u884c\u8fc1\u79fb\naury migrate up\n\n# \u67e5\u770b\u72b6\u6001\naury migrate status</code></pre>"},{"location":"25-scaffold-guide/#_11","title":"\u81ea\u5b9a\u4e49\u751f\u6210\u7684\u4ee3\u7801","text":"<p>\u751f\u6210\u7684\u4ee3\u7801\u662f\u8d77\u70b9\uff0c\u4f60\u53ef\u4ee5\u6839\u636e\u9700\u8981\u4fee\u6539\uff1a</p>"},{"location":"25-scaffold-guide/#_12","title":"\u6dfb\u52a0\u5b57\u6bb5","text":"<pre><code># models/user.py\nclass User(UUIDAuditableStateModel):\n    __tablename__ = \"users\"\n\n    name: Mapped[str] = mapped_column(String(100))\n    email: Mapped[str] = mapped_column(String(200), unique=True)  # \u65b0\u589e\n    age: Mapped[int | None] = mapped_column(nullable=True)  # \u65b0\u589e</code></pre>"},{"location":"25-scaffold-guide/#_13","title":"\u6dfb\u52a0\u81ea\u5b9a\u4e49\u67e5\u8be2","text":"<pre><code># repositories/user_repository.py\nclass UserRepository(BaseRepository[User]):\n\n    async def get_by_email(self, email: str) -&gt; User | None:\n        \"\"\"\u6309\u90ae\u7bb1\u83b7\u53d6\u3002\"\"\"\n        return await self.get_by(email=email)\n\n    async def list_active(self) -&gt; list[User]:\n        \"\"\"\u83b7\u53d6\u6d3b\u8dc3\u7528\u6237\u3002\"\"\"\n        return await self.list(is_active=True)</code></pre>"},{"location":"25-scaffold-guide/#_14","title":"\u6dfb\u52a0\u4e1a\u52a1\u903b\u8f91","text":"<pre><code># services/user_service.py\nclass UserService(BaseService):\n\n    @transactional\n    async def register(self, data: UserRegister) -&gt; User:\n        \"\"\"\u7528\u6237\u6ce8\u518c\u3002\"\"\"\n        # \u68c0\u67e5\u90ae\u7bb1\n        if await self.repo.get_by_email(data.email):\n            raise AlreadyExistsError(\"\u90ae\u7bb1\u5df2\u5b58\u5728\")\n\n        # \u52a0\u5bc6\u5bc6\u7801\n        hashed_password = hash_password(data.password)\n\n        # \u521b\u5efa\u7528\u6237\n        return await self.repo.create({\n            **data.model_dump(exclude={\"password\"}),\n            \"password_hash\": hashed_password,\n        })</code></pre>"},{"location":"25-scaffold-guide/#_15","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"25-scaffold-guide/#1_1","title":"1. \u547d\u540d\u89c4\u8303","text":"<ul> <li>Model: <code>PascalCase</code>\uff08\u5982 <code>User</code>, <code>UserProfile</code>\uff09</li> <li>\u6587\u4ef6: <code>snake_case</code>\uff08\u5982 <code>user.py</code>, <code>user_profile.py</code>\uff09</li> <li>\u8868\u540d: <code>snake_case</code> \u590d\u6570\uff08\u5982 <code>users</code>, <code>user_profiles</code>\uff09</li> </ul>"},{"location":"25-scaffold-guide/#2","title":"2. \u5206\u5c42\u804c\u8d23","text":"<ul> <li>API \u5c42\uff1a\u53ea\u5904\u7406 HTTP \u8bf7\u6c42/\u54cd\u5e94\uff0c\u4e0d\u5305\u542b\u4e1a\u52a1\u903b\u8f91</li> <li>Service \u5c42\uff1a\u4e1a\u52a1\u903b\u8f91\u3001\u4e8b\u52a1\u7ba1\u7406\u3001\u8de8 Repository \u64cd\u4f5c</li> <li>Repository \u5c42\uff1a\u6570\u636e\u8bbf\u95ee\u3001CRUD \u64cd\u4f5c\u3001\u67e5\u8be2\u4f18\u5316</li> <li>Model \u5c42\uff1a\u6570\u636e\u7ed3\u6784\u5b9a\u4e49\u3001\u5b57\u6bb5\u9a8c\u8bc1</li> </ul>"},{"location":"25-scaffold-guide/#3","title":"3. \u9519\u8bef\u5904\u7406","text":"<p>\u4f7f\u7528\u6846\u67b6\u63d0\u4f9b\u7684\u5f02\u5e38\u7c7b\uff1a</p> <pre><code>from aury.boot.application.errors import (\n    NotFoundError,\n    AlreadyExistsError,\n    ValidationError,\n    UnauthorizedError,\n    ForbiddenError,\n)</code></pre>"},{"location":"25-scaffold-guide/#4","title":"4. \u4e8b\u52a1\u7ba1\u7406","text":"<p>\u4f7f\u7528 <code>@transactional</code> \u88c5\u9970\u5668\uff1a</p> <pre><code>from aury.boot.domain.transaction import transactional\n\n@transactional\nasync def create_user_with_profile(self, data):\n    user = await self.user_repo.create(data.user)\n    profile = await self.profile_repo.create({\n        \"user_id\": user.id,\n        **data.profile,\n    })\n    return user, profile</code></pre>"},{"location":"25-scaffold-guide/#_16","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"25-scaffold-guide/#q","title":"Q: \u5982\u4f55\u8986\u76d6\u5df2\u5b58\u5728\u7684\u6587\u4ef6\uff1f","text":"<p>\u4f7f\u7528 <code>--force</code> \u9009\u9879\uff1a</p> <pre><code>aury generate crud user --force</code></pre>"},{"location":"25-scaffold-guide/#q_1","title":"Q: \u5982\u4f55\u751f\u6210\u4e0d\u540c\u7c7b\u578b\u7684\u4e3b\u952e\uff1f","text":"<p>\u4f7f\u7528 <code>--base</code> \u9009\u9879\u6307\u5b9a\u57fa\u7c7b\uff1a</p> <pre><code># UUID \u4e3b\u952e + \u8f6f\u5220\u9664\uff08\u9ed8\u8ba4\u63a8\u8350\uff09\naury generate crud user -b UUIDAuditableStateModel\n\n# int \u4e3b\u952e + \u65f6\u95f4\u6233\naury generate crud user -b Model\n\n# int \u4e3b\u952e + \u8f6f\u5220\u9664\naury generate crud user -b AuditableStateModel\n\n# UUID \u4e3b\u952e + \u4e50\u89c2\u9501\naury generate crud user -b VersionedUUIDModel</code></pre> <p>\u53ef\u7528\u57fa\u7c7b\uff1a - <code>IDOnlyModel</code> - \u7eaf int \u4e3b\u952e\uff08\u65e0\u65f6\u95f4\u6233\uff09 - <code>UUIDOnlyModel</code> - \u7eaf UUID \u4e3b\u952e\uff08\u65e0\u65f6\u95f4\u6233\uff09 - <code>Model</code> - int \u4e3b\u952e + \u65f6\u95f4\u6233 - <code>AuditableStateModel</code> - int \u4e3b\u952e + \u8f6f\u5220\u9664 - <code>UUIDModel</code> - UUID \u4e3b\u952e + \u65f6\u95f4\u6233 - <code>UUIDAuditableStateModel</code> - UUID \u4e3b\u952e + \u8f6f\u5220\u9664\uff08\u9ed8\u8ba4\u63a8\u8350\uff09 - <code>VersionedModel</code> - int \u4e3b\u952e + \u4e50\u89c2\u9501 - <code>VersionedTimestampedModel</code> - int \u4e3b\u952e + \u4e50\u89c2\u9501 + \u65f6\u95f4\u6233 - <code>VersionedUUIDModel</code> - UUID \u4e3b\u952e + \u4e50\u89c2\u9501 - <code>FullFeaturedModel</code> - int \u4e3b\u952e + \u5168\u529f\u80fd - <code>FullFeaturedUUIDModel</code> - UUID \u4e3b\u952e + \u5168\u529f\u80fd</p>"},{"location":"25-scaffold-guide/#q_2","title":"Q: \u5982\u4f55\u81ea\u5b9a\u4e49\u6a21\u677f\uff1f","text":"<p>\u76ee\u524d\u4e0d\u652f\u6301\u81ea\u5b9a\u4e49\u6a21\u677f\u3002\u5982\u6709\u9700\u6c42\uff0c\u53ef\u4ee5\uff1a 1. \u751f\u6210\u540e\u624b\u52a8\u4fee\u6539 2. \u63d0\u4ea4 Issue \u6216 PR</p>"},{"location":"25-scaffold-guide/#_17","title":"\u4e0b\u4e00\u6b65","text":"<ul> <li>\u67e5\u770b 24-cli-commands.md \u4e86\u89e3\u5b8c\u6574\u547d\u4ee4\u53c2\u8003</li> <li>\u67e5\u770b 12-database-complete.md \u4e86\u89e3\u6570\u636e\u5e93\u64cd\u4f5c</li> <li>\u67e5\u770b 11-transaction-management.md \u4e86\u89e3\u4e8b\u52a1\u7ba1\u7406</li> </ul>"},{"location":"26-infrastructure-advanced/","title":"25. \u57fa\u7840\u8bbe\u65bd\u9ad8\u7ea7\u529f\u80fd","text":"<p>\u672c\u7ae0\u4ecb\u7ecd v0.3.x \u65b0\u589e\u7684\u57fa\u7840\u8bbe\u65bd\u6a21\u5757\uff1a\u5ba2\u6237\u7aef\u7ba1\u7406\u3001\u6d41\u5f0f\u901a\u9053\u3001\u6d88\u606f\u961f\u5217\u548c\u591a\u5b9e\u4f8b\u914d\u7f6e\u3002</p>"},{"location":"26-infrastructure-advanced/#_1","title":"\u591a\u5b9e\u4f8b\u914d\u7f6e","text":"<p>\u6240\u6709\u57fa\u7840\u8bbe\u65bd\u7ec4\u4ef6\u5747\u652f\u6301\u591a\u5b9e\u4f8b\u914d\u7f6e\uff0c\u683c\u5f0f\uff1a<code>{PREFIX}_{INSTANCE}_{FIELD}</code>\u3002</p>"},{"location":"26-infrastructure-advanced/#_2","title":"\u73af\u5883\u53d8\u91cf\u683c\u5f0f","text":"<pre><code># \u6570\u636e\u5e93\u591a\u5b9e\u4f8b\nDATABASE_URL=sqlite+aiosqlite:///./dev.db          # \u9ed8\u8ba4\u5b9e\u4f8b\nDATABASE_DEFAULT_URL=sqlite+aiosqlite:///./dev.db  # \u7b49\u540c\u4e8e\u9ed8\u8ba4\nDATABASE_READONLY_URL=postgresql+asyncpg://...      # \u53ea\u8bfb\u5b9e\u4f8b\n\n# \u7f13\u5b58\u591a\u5b9e\u4f8b\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\nCACHE_SESSION_TYPE=redis\nCACHE_SESSION_URL=redis://localhost:6379/2\n\n# \u6d41\u5f0f\u901a\u9053\u591a\u5b9e\u4f8b\nCHANNEL_BACKEND=memory\nCHANNEL_DEFAULT_BACKEND=redis\nCHANNEL_DEFAULT_URL=redis://localhost:6379/3</code></pre>"},{"location":"26-infrastructure-advanced/#_3","title":"\u5728\u4ee3\u7801\u4e2d\u4f7f\u7528","text":"<pre><code>from aury.boot.application.config import BaseConfig\n\nconfig = BaseConfig()\n\n# \u83b7\u53d6\u6240\u6709\u6570\u636e\u5e93\u5b9e\u4f8b\u914d\u7f6e\ndb_configs = config.get_database_instances()\n# \u8fd4\u56de: {\"default\": DatabaseInstanceConfig(...), \"readonly\": DatabaseInstanceConfig(...)}\n\n# \u83b7\u53d6\u6240\u6709\u7f13\u5b58\u5b9e\u4f8b\u914d\u7f6e\ncache_configs = config.get_cache_instances()\n# \u8fd4\u56de: {\"default\": CacheInstanceConfig(...), \"session\": CacheInstanceConfig(...)}</code></pre>"},{"location":"26-infrastructure-advanced/#clients","title":"\u5ba2\u6237\u7aef\u7ba1\u7406 (clients)","text":"<p>\u7edf\u4e00\u7ba1\u7406\u5916\u90e8\u670d\u52a1\u8fde\u63a5\uff0c\u652f\u6301\u591a\u5b9e\u4f8b\u3002</p>"},{"location":"26-infrastructure-advanced/#redis","title":"Redis \u5ba2\u6237\u7aef","text":"<pre><code>from aury.boot.infrastructure.clients import RedisClient\n\n# \u83b7\u53d6\u5b9e\u4f8b\uff08\u5355\u4f8b\u6a21\u5f0f\uff09\nclient = RedisClient.get_instance()  # \u9ed8\u8ba4\u5b9e\u4f8b\ncache_client = RedisClient.get_instance(\"cache\")  # \u547d\u540d\u5b9e\u4f8b\n\n# \u914d\u7f6e\u5e76\u521d\u59cb\u5316\nawait client.configure(\n    url=\"redis://localhost:6379/0\",\n    max_connections=10,\n    decode_responses=True\n).initialize()\n\n# \u4f7f\u7528\u8fde\u63a5\nredis = client.connection\nawait redis.set(\"key\", \"value\")\nvalue = await redis.get(\"key\")\n\n# \u6216\u4f7f\u7528 execute\nawait client.execute(\"set\", \"key\", \"value\")\n\n# \u5065\u5eb7\u68c0\u67e5\nis_healthy = await client.health_check()\n\n# \u6e05\u7406\nawait client.cleanup()</code></pre>"},{"location":"26-infrastructure-advanced/#rabbitmq","title":"RabbitMQ \u5ba2\u6237\u7aef","text":"<pre><code>from aury.boot.infrastructure.clients import RabbitMQClient\n\n# \u83b7\u53d6\u5b9e\u4f8b\nclient = RabbitMQClient.get_instance()\nevents_mq = RabbitMQClient.get_instance(\"events\")\n\n# \u914d\u7f6e\u5e76\u521d\u59cb\u5316\nawait client.configure(\n    url=\"amqp://guest:guest@localhost:5672/\",\n    heartbeat=60,\n    prefetch_count=10\n).initialize()\n\n# \u83b7\u53d6\u901a\u9053\nchannel = await client.get_channel()\n\n# \u53d1\u5e03\u6d88\u606f\nfrom aio_pika import Message\nawait channel.default_exchange.publish(\n    Message(body=b\"hello\"),\n    routing_key=\"test_queue\"\n)\n\n# \u83b7\u53d6\u65b0\u901a\u9053\uff08\u7528\u4e8e\u6d88\u8d39\u8005\uff09\nconsumer_channel = await client.get_channel(new=True)\n\n# \u5065\u5eb7\u68c0\u67e5\nis_healthy = await client.health_check()\n\n# \u6e05\u7406\nawait client.cleanup()</code></pre>"},{"location":"26-infrastructure-advanced/#channel","title":"\u6d41\u5f0f\u901a\u9053 (Channel)","text":"<p>\u7528\u4e8e SSE\uff08Server-Sent Events\uff09\u548c\u5b9e\u65f6\u901a\u4fe1\u573a\u666f\u3002</p>"},{"location":"26-infrastructure-advanced/#_4","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>from aury.boot.infrastructure.channel import ChannelManager\n\n# \u83b7\u53d6\u5b9e\u4f8b\nchannel = ChannelManager.get_instance()\nnotifications = ChannelManager.get_instance(\"notifications\")\n\n# \u914d\u7f6e - Memory \u540e\u7aef\uff08\u5355\u8fdb\u7a0b\uff09\nchannel.configure(backend=\"memory\")\n\n# \u914d\u7f6e - Redis \u540e\u7aef\uff08\u591a\u8fdb\u7a0b/\u5206\u5e03\u5f0f\uff09\nchannel.configure(\n    backend=\"redis\",\n    redis_url=\"redis://localhost:6379/0\",\n    key_prefix=\"channel:\",\n    ttl=86400\n)\n\n# \u521d\u59cb\u5316\nawait channel.initialize()</code></pre>"},{"location":"26-infrastructure-advanced/#_5","title":"\u53d1\u5e03\u548c\u8ba2\u9605","text":"<pre><code># \u53d1\u5e03\u6d88\u606f\u5230\u9891\u9053\nawait channel.publish(\"user:123\", {\"event\": \"message\", \"data\": \"hello\"})\n\n# \u8ba2\u9605\u9891\u9053\uff08\u7528\u4e8e SSE\uff09\nasync def sse_endpoint(user_id: str):\n    async for message in channel.subscribe(f\"user:{user_id}\"):\n        yield f\"data: {json.dumps(message)}\\n\\n\"</code></pre>"},{"location":"26-infrastructure-advanced/#fastapi-sse","title":"FastAPI SSE \u793a\u4f8b","text":"<pre><code>from fastapi import APIRouter\nfrom fastapi.responses import StreamingResponse\n\nrouter = APIRouter()\n\n@router.get(\"/sse/{user_id}\")\nasync def sse_stream(user_id: str):\n    async def event_generator():\n        async for message in channel.subscribe(f\"user:{user_id}\"):\n            yield f\"data: {json.dumps(message)}\\n\\n\"\n\n    return StreamingResponse(\n        event_generator(),\n        media_type=\"text/event-stream\"\n    )\n\n@router.post(\"/notify/{user_id}\")\nasync def send_notification(user_id: str, message: str):\n    await channel.publish(f\"user:{user_id}\", {\"message\": message})\n    return {\"status\": \"sent\"}</code></pre>"},{"location":"26-infrastructure-advanced/#mq","title":"\u6d88\u606f\u961f\u5217 (MQ)","text":"<p>\u652f\u6301 Redis \u548c RabbitMQ \u540e\u7aef\u7684\u6d88\u606f\u961f\u5217\u3002</p>"},{"location":"26-infrastructure-advanced/#_6","title":"\u914d\u7f6e","text":"<pre><code>from aury.boot.infrastructure.mq import MQManager\n\n# \u83b7\u53d6\u5b9e\u4f8b\nmq = MQManager.get_instance()\norders_mq = MQManager.get_instance(\"orders\")\n\n# Redis \u540e\u7aef\nmq.configure(\n    backend=\"redis\",\n    url=\"redis://localhost:6379/0\",\n    max_connections=10\n)\n\n# RabbitMQ \u540e\u7aef\nmq.configure(\n    backend=\"rabbitmq\",\n    url=\"amqp://guest:guest@localhost:5672/\",\n    prefetch_count=10\n)\n\nawait mq.initialize()</code></pre>"},{"location":"26-infrastructure-advanced/#_7","title":"\u751f\u4ea7\u8005","text":"<pre><code># \u53d1\u9001\u6d88\u606f\nawait mq.publish(\n    queue=\"orders\",\n    message={\"order_id\": \"123\", \"action\": \"created\"}\n)\n\n# \u6279\u91cf\u53d1\u9001\nawait mq.publish_batch(\n    queue=\"orders\",\n    messages=[\n        {\"order_id\": \"1\", \"action\": \"created\"},\n        {\"order_id\": \"2\", \"action\": \"updated\"},\n    ]\n)</code></pre>"},{"location":"26-infrastructure-advanced/#_8","title":"\u6d88\u8d39\u8005","text":"<pre><code># \u6d88\u8d39\u6d88\u606f\nasync def process_order(message: dict):\n    print(f\"\u5904\u7406\u8ba2\u5355: {message['order_id']}\")\n\nawait mq.consume(\"orders\", process_order)\n\n# \u5e26\u786e\u8ba4\u7684\u6d88\u8d39\nasync def process_with_ack(message: dict, ack, nack):\n    try:\n        await process_order(message)\n        await ack()\n    except Exception:\n        await nack(requeue=True)\n\nawait mq.consume(\"orders\", process_with_ack, auto_ack=False)</code></pre>"},{"location":"26-infrastructure-advanced/#events","title":"\u4e8b\u4ef6\u603b\u7ebf (Events)","text":"<p>\u91cd\u6784\u540e\u7684\u4e8b\u4ef6\u603b\u7ebf\u652f\u6301\u591a\u540e\u7aef\u548c\u591a\u5b9e\u4f8b\u3002</p>"},{"location":"26-infrastructure-advanced/#_9","title":"\u914d\u7f6e","text":"<pre><code>from aury.boot.infrastructure.events import EventBusManager\n\n# \u83b7\u53d6\u5b9e\u4f8b\nbus = EventBusManager.get_instance()\ndomain_bus = EventBusManager.get_instance(\"domain\")\n\n# Memory \u540e\u7aef\uff08\u5355\u8fdb\u7a0b\uff09\nbus.configure(backend=\"memory\")\n\n# Redis Pub/Sub \u540e\u7aef\nbus.configure(\n    backend=\"redis\",\n    url=\"redis://localhost:6379/0\",\n    key_prefix=\"events:\"\n)\n\n# RabbitMQ \u540e\u7aef\nbus.configure(\n    backend=\"rabbitmq\",\n    url=\"amqp://guest:guest@localhost:5672/\",\n    exchange_name=\"app.events\",\n    exchange_type=\"topic\"\n)\n\nawait bus.initialize()</code></pre>"},{"location":"26-infrastructure-advanced/#_10","title":"\u5b9a\u4e49\u4e8b\u4ef6","text":"<pre><code>from aury.boot.infrastructure.events import Event\n\nclass OrderCreatedEvent(Event):\n    order_id: str\n    amount: float\n    user_id: str\n\n    @property\n    def event_name(self) -&gt; str:\n        return \"order.created\"</code></pre>"},{"location":"26-infrastructure-advanced/#_11","title":"\u53d1\u5e03\u548c\u8ba2\u9605","text":"<pre><code># \u8ba2\u9605\u4e8b\u4ef6\n@bus.subscribe(OrderCreatedEvent)\nasync def on_order_created(event: OrderCreatedEvent):\n    print(f\"\u8ba2\u5355\u521b\u5efa: {event.order_id}\")\n\n# \u53d1\u5e03\u4e8b\u4ef6\nawait bus.publish(OrderCreatedEvent(\n    order_id=\"123\",\n    amount=99.99,\n    user_id=\"user_1\"\n))</code></pre>"},{"location":"26-infrastructure-advanced/#api","title":"\u65e7 API \u517c\u5bb9","text":"<p>\u4e3a\u4fdd\u6301\u5411\u540e\u517c\u5bb9\uff0c\u539f\u6709\u7684 <code>EventBus</code> API \u4ecd\u53ef\u4f7f\u7528\uff1a</p> <pre><code>from aury.boot.infrastructure.events import EventBus\n\nbus = EventBus.get_instance()\n\n@bus.subscribe(OrderCreatedEvent)\nasync def handler(event):\n    pass\n\nawait bus.publish(event)</code></pre>"},{"location":"26-infrastructure-advanced/#_12","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u6c47\u603b","text":"<pre><code># =============================================================================\n# \u7f13\u5b58 (CACHE_)\n# =============================================================================\nCACHE_TYPE=redis\nCACHE_URL=redis://localhost:6379/0\nCACHE_SESSION_TYPE=redis\nCACHE_SESSION_URL=redis://localhost:6379/2\n\n# =============================================================================\n# \u6d41\u5f0f\u901a\u9053 (CHANNEL_)\n# =============================================================================\nCHANNEL_BACKEND=memory\nCHANNEL_DEFAULT_BACKEND=redis\nCHANNEL_DEFAULT_URL=redis://localhost:6379/3\nCHANNEL_DEFAULT_KEY_PREFIX=channel:\nCHANNEL_DEFAULT_TTL=86400\n\n# =============================================================================\n# \u6d88\u606f\u961f\u5217 (MQ_)\n# =============================================================================\nMQ_BACKEND=redis\nMQ_DEFAULT_URL=redis://localhost:6379/4\nMQ_ORDERS_BACKEND=rabbitmq\nMQ_ORDERS_URL=amqp://guest:guest@localhost:5672/\n\n# =============================================================================\n# \u4e8b\u4ef6\u603b\u7ebf (EVENT_)\n# =============================================================================\nEVENT_BACKEND=memory\nEVENT_DEFAULT_BACKEND=redis\nEVENT_DEFAULT_URL=redis://localhost:6379/5\nEVENT_DOMAIN_BACKEND=rabbitmq\nEVENT_DOMAIN_URL=amqp://guest:guest@localhost:5672/\nEVENT_DOMAIN_EXCHANGE_NAME=domain.events</code></pre>"},{"location":"26-infrastructure-advanced/#manager","title":"Manager \u94fe\u5f0f\u8c03\u7528","text":"<p>\u6240\u6709 Manager \u90fd\u652f\u6301\u94fe\u5f0f\u8c03\u7528\uff1a</p> <pre><code># \u6570\u636e\u5e93\nawait DatabaseManager.get_instance().configure(url=...).initialize()\n\n# \u7f13\u5b58\nawait CacheManager.get_instance().init_app(config).initialize()\n\n# \u5b58\u50a8\nawait StorageManager.get_instance().init(config)\n\n# \u8c03\u5ea6\u5668\nawait SchedulerManager.get_instance().initialize()\n\n# \u4efb\u52a1\u961f\u5217\nawait TaskManager.get_instance().initialize()\n\n# Channel\nawait ChannelManager.get_instance().configure(...).initialize()\n\n# MQ\nawait MQManager.get_instance().configure(...).initialize()\n\n# EventBus\nawait EventBusManager.get_instance().configure(...).initialize()</code></pre>"},{"location":"26-infrastructure-advanced/#_13","title":"\u5065\u5eb7\u68c0\u67e5","text":"<p>\u6240\u6709\u7ec4\u4ef6\u90fd\u652f\u6301\u5065\u5eb7\u68c0\u67e5\uff0c\u81ea\u52a8\u96c6\u6210\u5230 <code>/api/health</code> \u7aef\u70b9\uff1a</p> <pre><code># \u624b\u52a8\u5065\u5eb7\u68c0\u67e5\nis_healthy = await RedisClient.get_instance().health_check()\nis_healthy = await RabbitMQClient.get_instance().health_check()\nis_healthy = await ChannelManager.get_instance().health_check()\nis_healthy = await MQManager.get_instance().health_check()\nis_healthy = await EventBusManager.get_instance().health_check()</code></pre> <p>\u603b\u7ed3\uff1a\u65b0\u7684\u57fa\u7840\u8bbe\u65bd\u6a21\u5757\u63d0\u4f9b\u4e86\u7edf\u4e00\u7684\u591a\u5b9e\u4f8b\u7ba1\u7406\u3001\u94fe\u5f0f\u914d\u7f6e\u548c\u5065\u5eb7\u68c0\u67e5\u80fd\u529b\uff0c\u9002\u7528\u4e8e\u4ece\u5355\u4f53\u5e94\u7528\u5230\u5206\u5e03\u5f0f\u5fae\u670d\u52a1\u7684\u5404\u79cd\u573a\u666f\u3002</p>"}]}